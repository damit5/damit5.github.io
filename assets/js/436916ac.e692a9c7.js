"use strict";(self.webpackChunkblog_source_2025=self.webpackChunkblog_source_2025||[]).push([[586],{2704:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/image-20220618191526478-a53b547128ff7c59c8e0fe00514738cc.png"},6750:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/image-20220618190929692-7815b810cf1280766375bb1aaa3c8a72.png"},28453:(e,n,t)=>{t.d(n,{R:()=>c,x:()=>a});var o=t(96540);const r={},s=o.createContext(r);function c(e){const n=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),o.createElement(s.Provider,{value:n},e.children)}},70824:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/image-20220618172849772-36ec780ae8bb231dc70dd514501cf1b0.png"},86215:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/image-20220618190828103-c5222f9188f51f20d9fe2ff580328b31.png"},88700:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>a,default:()=>d,frontMatter:()=>c,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"\u7f16\u7a0b\u5f00\u53d1/GO/GO\u5b9e\u4f8b/goproxy\u88ab\u52a8\u4ee3\u7406","title":"goproxy\u88ab\u52a8\u4ee3\u7406","description":"\u4ecb\u7ecd","source":"@site/docs/03.\u7f16\u7a0b\u5f00\u53d1/GO/02.GO\u5b9e\u4f8b/07.goproxy\u88ab\u52a8\u4ee3\u7406.md","sourceDirName":"03.\u7f16\u7a0b\u5f00\u53d1/GO/02.GO\u5b9e\u4f8b","slug":"/\u7f16\u7a0b\u5f00\u53d1/GO/GO\u5b9e\u4f8b/goproxy\u88ab\u52a8\u4ee3\u7406","permalink":"/docs/\u7f16\u7a0b\u5f00\u53d1/GO/GO\u5b9e\u4f8b/goproxy\u88ab\u52a8\u4ee3\u7406","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedBy":"d4m1ts","lastUpdatedAt":1748751271000,"sidebarPosition":7,"frontMatter":{},"sidebar":"knowledgeBaseSidebar","previous":{"title":"\u4f7f\u7528GO\u4e0a\u4f20\u56fe\u7247","permalink":"/docs/\u7f16\u7a0b\u5f00\u53d1/GO/GO\u5b9e\u4f8b/\u4f7f\u7528GO\u4e0a\u4f20\u56fe\u7247"},"next":{"title":"beego\u6846\u67b6","permalink":"/docs/category/beego\u6846\u67b6"}}');var r=t(74848),s=t(28453);const c={},a=void 0,i={},l=[{value:"\u4ecb\u7ecd",id:"\u4ecb\u7ecd",level:2},{value:"\u5b89\u88c5",id:"\u5b89\u88c5",level:2},{value:"\u5feb\u901f\u5165\u95e8",id:"\u5feb\u901f\u5165\u95e8",level:2},{value:"\u5e38\u89c1\u7528\u6cd5",id:"\u5e38\u89c1\u7528\u6cd5",level:2},{value:"\u4ee3\u7406HTTPS",id:"\u4ee3\u7406https",level:2},{value:"\u751f\u6210\u81ea\u7b7e\u540d\u8bc1\u4e66",id:"\u751f\u6210\u81ea\u7b7e\u540d\u8bc1\u4e66",level:3},{value:"\u8bbe\u7f6e\u4ee3\u7406\u8bc1\u4e66",id:"\u8bbe\u7f6e\u4ee3\u7406\u8bc1\u4e66",level:3}];function p(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"\u4ecb\u7ecd",children:"\u4ecb\u7ecd"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://github.com/elazarl/goproxy",children:"goproxy"})," - An HTTP proxy library for Go"]}),"\n",(0,r.jsxs)(n.p,{children:["\u53ef\u53c2\u8003\u6587\u6863\uff1a",(0,r.jsx)(n.a,{href:"https://pkg.go.dev/gopkg.in/elazarl/goproxy.v1?utm_source=godoc#section-readme",children:"goproxy"})]}),"\n",(0,r.jsxs)(n.p,{children:["\u7b80\u5355\u6765\u8bf4\uff0c\u5c31\u662fGO\u5b9e\u73b0\u7684http\u4ee3\u7406\uff0c\u53ef\u4ee5\u4ece\u4e2d\u95f4\u64cd\u4f5c\u7ecf\u8fc7\u7684\u6570\u636e\u5305\uff1b\u52ab\u6301\u5230\u7684\u6570\u636e\u5305\u5c31\u662f\u4e00\u4e2a",(0,r.jsx)(n.code,{children:"net/http"}),"\u7684\u5b9e\u4f8b"]}),"\n",(0,r.jsx)(n.h2,{id:"\u5b89\u88c5",children:"\u5b89\u88c5"}),"\n",(0,r.jsxs)(n.p,{children:["\u6211\u76f4\u63a5\u7528",(0,r.jsx)(n.code,{children:"go get"}),"\u641e\u4e0d\u4e0b\u6765\u4e86\uff0c\u4e0d\u77e5\u9053\u662f\u4e0d\u662fGO1.18\u7684\u95ee\u9898\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u76f4\u63a5",(0,r.jsx)(n.code,{children:"git clone"}),"\u4e0b\u6765\uff0c\u653e\u5230\u5bf9\u5e94\u7684src\u76ee\u5f55\u5373\u53ef"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"mkdir $GOPATH/src/github.com/elazarl\ncd elazarl\ngit clone https://github.com/elazarl/goproxy\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u5feb\u901f\u5165\u95e8",children:"\u5feb\u901f\u5165\u95e8"}),"\n",(0,r.jsxs)(n.p,{children:["\u76f4\u63a5\u7528readme\u4e2d\u7684\u4f8b\u5b50\uff0c\u5176\u4e2d",(0,r.jsx)(n.code,{children:"DoFunc"}),"\u662f\u5bf9\u6570\u636e\u5305\u8fdb\u884c\u4e8c\u6b21\u5904\u7406\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'package main\n\nimport (\n\t"github.com/elazarl/goproxy"\n\t"log"\n\t"net/http"\n)\n\nfunc main() {\n\tproxy := goproxy.NewProxyHttpServer()\n\tproxy.Verbose = true\n\n\tproxy.OnRequest().DoFunc(\n\t\tfunc(r *http.Request,ctx *goproxy.ProxyCtx)(*http.Request,*http.Response) {\n\t\t\t// \u6dfb\u52a0Header\u5934\n\t\t\tr.Header.Set("X-GoProxy","yxorPoG-X")\n\t\t\treturn r,nil\n\t\t})\n\n\tlog.Fatal(http.ListenAndServe(":8080", proxy))\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u8dd1\u8d77\u6765\uff0c\u672c\u5730\u76d1\u542c80\u7aef\u53e3\uff0c\u7136\u540e\u7528curl\u53d1\u8d77\u8bf7\u6c42"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"curl -x http://127.0.0.1:8080 http://127.0.0.1\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u67e5\u770b\u6536\u5230\u7684\u6570\u636e\u5305\uff0c\u662f\u6211\u60f3\u8981\u7684\u6548\u679c\uff0c\u5927\u529f\u544a\u6210\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"image-20220618172849772",src:t(70824).A+"",width:"492",height:"322"})}),"\n",(0,r.jsx)(n.h2,{id:"\u5e38\u89c1\u7528\u6cd5",children:"\u5e38\u89c1\u7528\u6cd5"}),"\n",(0,r.jsxs)(n.p,{children:["\u5404\u79cd\u4f8b\u5b50\uff1a",(0,r.jsx)(n.a,{href:"https://github.com/elazarl/goproxy/tree/master/examples",children:"examples"})]}),"\n",(0,r.jsxs)(n.p,{children:["\u4e0a\u9762\u7528\u4e86\u4e00\u4e2a",(0,r.jsx)(n.code,{children:"proxy.OnRequest()"}),"\uff0c\u5176\u4ed6\u7684\u76f4\u63a5\u4ece\u6587\u6863\u91cc\u9762\u590d\u5236\u8fc7\u6765\u4e86"]}),"\n",(0,r.jsx)(n.p,{children:"There are 3 kinds of useful handlers to manipulate the behavior, as follows:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:"// handler called after receiving HTTP CONNECT from the client, and before proxy establish connection \n// with destination host\nhttpsHandlers   []HttpsHandler\n    \n// handler called before proxy send HTTP request to destination host\nreqHandlers     []ReqHandler \n    \n// handler called after proxy receives HTTP Response from destination host, and before proxy forward \n// the Response to the client.\nrespHandlers    []RespHandler \n"})}),"\n",(0,r.jsx)(n.p,{children:"Depending on what you want to manipulate, the ways to add handlers to each handler list are:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:"// Add handlers to httpsHandlers \nproxy.OnRequest(Some ReqConditions).HandleConnect(YourHandlerFunc())\n\n// Add handlers to reqHandlers\nproxy.OnRequest(Some ReqConditions).Do(YourReqHandlerFunc())\n\n// Add handlers to respHandlers\nproxy.OnResponse(Some RespConditions).Do(YourRespHandlerFunc())\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u200b"}),"\n",(0,r.jsx)(n.p,{children:"For example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'// This rejects the HTTPS request to *.reddit.com during HTTP CONNECT phase\nproxy.OnRequest(goproxy.ReqHostMatches(regexp.MustCompile("reddit.*:443$"))).HandleConnect(goproxy.AlwaysReject)\n\n// This will NOT reject the HTTPS request with URL ending with gif, due to the fact that proxy \n// only got the URL.Hostname and URL.Port during the HTTP CONNECT phase if the scheme is HTTPS, which is\n// quiet common these days.\nproxy.OnRequest(goproxy.UrlMatches(regexp.MustCompile(`.*gif$`))).HandleConnect(goproxy.AlwaysReject)\n\n// The correct way to manipulate the HTTP request using URL.Path as condition is:\nproxy.OnRequest(goproxy.UrlMatches(regexp.MustCompile(`.*gif$`))).Do(YourReqHandlerFunc())\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u4ee3\u7406https",children:"\u4ee3\u7406HTTPS"}),"\n",(0,r.jsx)(n.p,{children:"\u8981\u83b7\u53d6\u5230https\u6d41\u91cf\uff0c\u90fd\u9700\u8981\u5728\u5ba2\u6237\u7aef\u5b89\u88c5\u4fe1\u4efb CA \u8bc1\u4e66"}),"\n",(0,r.jsx)(n.h3,{id:"\u751f\u6210\u81ea\u7b7e\u540d\u8bc1\u4e66",children:"\u751f\u6210\u81ea\u7b7e\u540d\u8bc1\u4e66"}),"\n",(0,r.jsxs)(n.p,{children:["\u4f7f\u7528",(0,r.jsx)(n.code,{children:"goproxy"}),"\u81ea\u5e26\u7684\u751f\u6210\u811a\u672c\uff0c\u8def\u5f84\u4e3a",(0,r.jsx)(n.code,{children:"github.com/elazarl/goproxy/certs"}),"\uff0c\u53ef\u4ee5\u81ea\u5df1\u4fee\u6539",(0,r.jsx)(n.code,{children:"openssl.cnf"}),"\u7684\u914d\u7f6e"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"sh openssl-gen.sh\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"image-20220618190828103",src:t(86215).A+"",width:"2246",height:"1106"})}),"\n",(0,r.jsxs)(n.p,{children:["\u4f1a\u5728\u5f53\u524d\u76ee\u5f55\u751f\u6210",(0,r.jsx)(n.code,{children:"ca.pem"}),"\u548c",(0,r.jsx)(n.code,{children:"ca.key.pem"}),"\uff0cmacos\u76f4\u63a5\u53cc\u51fb\u5b89\u88c5",(0,r.jsx)(n.code,{children:"ca.pem"}),"\u5230\u94a5\u5319\u4e32\u5e76\u5b8c\u5168\u4fe1\u4efb\uff0cwindows\u540e\u7f00\u540d\u6539\u4e3a",(0,r.jsx)(n.code,{children:".crt"}),"\u53cc\u51fb\u5b89\u88c5\u5e76\u5206\u7c7b\u5230\u7cfb\u7edf\u6839\u8bc1\u4e66"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"image-20220618190929692",src:t(6750).A+"",width:"1026",height:"864"})}),"\n",(0,r.jsx)(n.h3,{id:"\u8bbe\u7f6e\u4ee3\u7406\u8bc1\u4e66",children:"\u8bbe\u7f6e\u4ee3\u7406\u8bc1\u4e66"}),"\n",(0,r.jsxs)(n.p,{children:["\u8bbe\u7f6e\u8bc1\u4e66\u4ee3\u7801\u53c2\u8003\uff1a",(0,r.jsx)(n.code,{children:"github.com/elazarl/goproxy/examples/goproxy-customca/cert.go"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'package main\n\nimport (\n\t"crypto/tls"\n\t"crypto/x509"\n\t"github.com/elazarl/goproxy"\n\t"io/ioutil"\n\t"log"\n\t"net/http"\n\t"os"\n)\n\n/*\n\u8bbe\u7f6e\u4ee3\u7406\u8bc1\u4e66\uff0ccaCert\u548ccaKey\u5c31\u662f\u521a\u624d\u751f\u6210\u7684pem\u6587\u4ef6\u5185\u5bb9\n */\nfunc setCA(caCert, caKey []byte) error {\n\tgoproxyCa, err := tls.X509KeyPair(caCert, caKey)\n\tif err != nil {\n\t\treturn err\n\t}\n\tif goproxyCa.Leaf, err = x509.ParseCertificate(goproxyCa.Certificate[0]); err != nil {\n\t\treturn err\n\t}\n\tgoproxy.GoproxyCa = goproxyCa\n\tgoproxy.OkConnect = &goproxy.ConnectAction{Action: goproxy.ConnectAccept, TLSConfig: goproxy.TLSConfigFromCA(&goproxyCa)}\n\tgoproxy.MitmConnect = &goproxy.ConnectAction{Action: goproxy.ConnectMitm, TLSConfig: goproxy.TLSConfigFromCA(&goproxyCa)}\n\tgoproxy.HTTPMitmConnect = &goproxy.ConnectAction{Action: goproxy.ConnectHTTPMitm, TLSConfig: goproxy.TLSConfigFromCA(&goproxyCa)}\n\tgoproxy.RejectConnect = &goproxy.ConnectAction{Action: goproxy.ConnectReject, TLSConfig: goproxy.TLSConfigFromCA(&goproxyCa)}\n\treturn nil\n}\n\nfunc main() {\n\tpwd, _ := os.Getwd()\n\tcaCert, _ := ioutil.ReadFile(pwd + "/ca.pem") // \u8bbe\u7f6e\u4e3a\u4f60\u521a\u624d\u751f\u6210\u7684 ca.pem \u8def\u5f84\n\tcaKey, _ := ioutil.ReadFile(pwd + "/ca.key.pem")  // \u8bbe\u7f6e\u4e3a\u4f60\u521a\u624d\u751f\u6210\u7684 ca.key.pem \u8def\u5f84\n\tsetCA(caCert, caKey)\n\n\tproxy := goproxy.NewProxyHttpServer()\n\tproxy.Verbose = true\n\n\tproxy.OnRequest().HandleConnect(goproxy.AlwaysMitm)\n\tproxy.OnRequest().DoFunc(\n\t\tfunc(r *http.Request,ctx *goproxy.ProxyCtx)(*http.Request,*http.Response) {\n\t\t\t// \u6dfb\u52a0Header\u5934\n\t\t\tr.Header.Set("X-GoProxy","yxorPoG-X")\n\t\t\treturn r,nil\n\t\t})\n\tproxy.OnResponse().DoFunc(\n\t\tfunc(resp *http.Response, ctx *goproxy.ProxyCtx) *http.Response {\n\t\t\t// \u8fd4\u56de\u5305\u72b6\u6001\u7801\u4fee\u6539\n\t\t\tresp.StatusCode = 404\n\t\t\treturn resp\n\t})\n\tlog.Fatal(http.ListenAndServe(":8080", proxy))\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u542f\u52a8\u540ecurl\u8bd5\u8bd5\uff0c\u53d1\u73b0\u5df2\u7ecfOK\u4e86"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"curl -x http://127.0.0.1:8080 https://blog.gm7.org/\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"image-20220618191526478",src:t(2704).A+"",width:"2270",height:"688"})})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(p,{...e})}):p(e)}}}]);